<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoyalPark - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüè¢%3C/text%3E%3C/svg%3E">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Material Design Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.3.67/css/materialdesignicons.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/dark-theme.css">

    <!-- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø SIDEBAR - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢ -->
    <style>
        /* –£–±–∏—Ä–∞–µ–º –±–µ–ª—É—é –ø–æ–ª–æ—Å—É —Å–≤–µ—Ä—Ö—É */
        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            background-color: #1a1d2e !important;
        }

        body {
            min-height: 100vh !important;
        }

        .admin-container {
            margin: 0 !important;
            padding: 0 !important;
        }

        .sidebar {
            width: 280px !important;
            transition: width 0.3s ease !important;
            display: flex !important;
            flex-direction: column !important;
            height: 100vh !important;
            overflow: hidden !important;
            /* —Å–∫—Ä–æ–ª–ª —É–±–∏—Ä–∞–µ–º —Å –≤—Å–µ–≥–æ —Å–∞–π–¥–±–∞—Ä–∞ */
        }

        .sidebar.collapsed {
            width: 80px !important;
            min-width: 80px !important;
            max-width: 80px !important;
        }

        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .nav-badge,
        .sidebar.collapsed .nav-section-title {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center !important;
        }

        .sidebar-header {
            flex-shrink: 0 !important;
            padding: 20px !important;
        }

        .sidebar-scroll {
            flex: 1 1 auto !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding-bottom: 20px !important;
        }

        .nav-menu {
            padding-top: 10px !important;
            /* —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –Ω–∞—á–∏–Ω–∞–ª—Å—è —Å—Ä–∞–∑—É –ø–æ–¥ header */
        }

        .main-content {
            margin-left: 280px !important;
            width: calc(100vw - 280px) !important;
            transition: all 0.3s ease !important;
        }

        .sidebar.collapsed~.main-content {
            margin-left: 80px !important;
            width: calc(100vw - 80px) !important;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-text">
                        <h2>RoyalPark</h2>
                        <p>Admin Panel</p>
                    </div>
                </div>
                <button class="toggle-sidebar" id="toggleSidebar">
                    <svg width="20" height="20" fill="currentColor">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                    </svg>
                </button>
            </div>

            <div class="sidebar-scroll">
                <nav class="nav-menu">
                    <div class="nav-section">
                        <div class="nav-section-title">–ì–ª–∞–≤–Ω–æ–µ</div>
                        <a href="/dashboard" class="nav-item" data-route="/dashboard">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-dashboard"></use>
                                </svg>
                            </span>
                            <span class="nav-text">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                        </a>
                        <!-- <a href="/analytics" class="nav-item" data-route="/analytics">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-analytics"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                    </a>
                    <a href="/reports" class="nav-item" data-route="/reports">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-reports"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–û—Ç—á–µ—Ç—ã</span>
                    </a> -->
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                        <a href="/blocks" class="nav-item" data-route="/blocks">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-buildings"></use>
                                </svg>
                            </span>
                            <span class="nav-text" data-i18n="nav_blocks">–ë–ª–æ–∫–∏</span>
                        </a>
                        <a href="/tariffs" class="nav-item" data-route="/tariffs">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-payments"></use>
                                </svg>
                            </span>
                            <span class="nav-text" data-i18n="nav_tariffs">–¢–∞—Ä–∏—Ñ—ã</span>
                        </a>
                        <a href="/residents" class="nav-item" data-route="/residents">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-users"></use>
                                </svg>
                            </span>
                            <span class="nav-text" data-i18n="nav_residents">–†–µ–∑–∏–¥–µ–Ω—Ç—ã</span>
                            <!-- <span class="nav-badge">245</span> -->
                        </a>
                        <a href="/tenants" class="nav-item" data-route="/tenants">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-apartments"></use>
                                </svg>
                            </span>
                            <span class="nav-text" data-i18n="nav_tenants">–ñ–∏—Ç–µ–ª–∏</span>
                        </a>
                        <a href="/readings" class="nav-item" data-route="/readings">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-meters"></use>
                                </svg>
                            </span>
                            <span class="nav-text" data-i18n="nav_readings">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏</span>
                        </a>
                        <a href="/users" class="nav-item" data-route="/users">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-users"></use>
                                </svg>
                            </span>
                            <span class="nav-text" data-i18n="nav_users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                        </a>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">–§–∏–Ω–∞–Ω—Å—ã</div>
                        <a href="/payments" class="nav-item" data-route="/payments">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-payments"></use>
                                </svg>
                            </span>
                            <span class="nav-text">–ü–ª–∞—Ç–µ–∂–∏</span>
                        </a>
                        <a href="/invoices" class="nav-item" data-route="/invoices">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-bills"></use>
                                </svg>
                            </span>
                            <span class="nav-text">–°—á–µ—Ç–∞</span>
                            <!-- <span class="nav-badge">12</span> -->
                        </a>
                        <!-- <a href="/debts" class="nav-item" data-route="/debts">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-debts"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–û–±—Ä–∞—â–µ–Ω–∏—è</span>
                    </a> -->
                        <a href="/appeals2" class="nav-item" data-route="/appeals2">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-debts"></use>
                                </svg>
                            </span>
                            <span class="nav-text">–û–±—Ä–∞—â–µ–Ω–∏—è</span>
                            <span class="nav-badge" style="display: none;">0</span>
                        </a>
                    </div>

                    <!-- <div class="nav-section">
                    <div class="nav-section-title">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
                    <a href="/repair-requests" class="nav-item" data-route="/repair-requests">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-maintenance"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</span>
                        <span class="nav-badge">8</span>
                    </a>
                    <a href="/inspections" class="nav-item" data-route="/inspections">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-inspections"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–ü—Ä–æ–≤–µ—Ä–∫–∏</span>
                    </a>
                    <a href="/staff" class="nav-item" data-route="/staff">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-personnel"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–ü–µ—Ä—Å–æ–Ω–∞–ª</span>
                    </a>
                </div> -->

                    <div class="nav-section">
                        <div class="nav-section-title">–°–∏—Å—Ç–µ–º–∞</div>
                        <!-- <a href="/settings" class="nav-item" data-route="/settings">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-settings"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a> -->
                        <a href="/logs" class="nav-item" data-route="/logs">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-reports"></use>
                                </svg>
                            </span>
                            <span class="nav-text">–õ–æ–≥–∏</span>
                        </a>
                        <!-- <a href="/backup" class="nav-item" data-route="/backup">
                        <span class="nav-icon">
                            <svg width="20" height="20" fill="currentColor">
                                <use href="/images/icons.svg#icon-reports"></use>
                            </svg>
                        </span>
                        <span class="nav-text">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                    </a> -->
                        <a href="/login.html" class="nav-item logout-btn" id="logoutBtn">
                            <span class="nav-icon">
                                <svg width="20" height="20" fill="currentColor">
                                    <use href="/images/icons.svg#icon-logout"></use>
                                </svg>
                            </span>
                            <span class="nav-text">–í—ã—Ö–æ–¥</span>
                        </a>
                    </div>
                </nav>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title" id="page-title-container">
                    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                    <div class="page-breadcrumb">
                        <span class="breadcrumb-item">
                            <svg width="14" height="14" fill="currentColor"
                                style="margin-right: 0.25rem; vertical-align: middle;">
                                <use href="/images/icons.svg#icon-apartments"></use>
                            </svg>
                            –ì–ª–∞–≤–Ω–∞—è
                        </span>
                        <span>‚Ä∫</span>
                        <span class="breadcrumb-item">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                    </div>
                </div>

                <div class="top-bar-actions">
                    <button class="notification-btn" id="openNotifications" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path
                                d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2z" />
                        </svg>
                        <span class="notification-badge" id="notificationsCount">3</span>
                    </button>

                    <!-- Language Selector -->
                    <div class="language-selector">
                        <button class="lang-btn active" data-lang="ru" title="–†—É—Å—Å–∫–∏–π">RU</button>
                        <button class="lang-btn" data-lang="az" title="Az…ôrbaycan">AZ</button>
                        <button class="lang-btn" data-lang="en" title="English">EN</button>
                    </div>

                    <div class="user-profile" id="accountProfileBtn">
                        <div class="user-avatar">–ê–î</div>
                        <div class="user-info">
                            <div class="user-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                            <div class="user-role">–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SPA Content Container -->
            <div id="spa-content">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </main>
    </div>

    <!-- Account Settings Modal (same structure as user dashboard) -->
    <div class="account-modal-overlay" id="accountModal">
        <div class="account-modal">
            <div class="account-modal-header">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
                <button class="account-modal-close" id="accountModalClose">&times;</button>
            </div>
            <div class="account-modal-body">
                <!-- Tabs -->
                <div class="account-tabs">
                    <button class="account-tab-btn active" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="account-tab-btn" data-tab="password">–ü–∞—Ä–æ–ª—å</button>
                </div>

                <!-- Profile tab -->
                <div class="account-tab-panel active" id="accountTabProfile">
                    <div class="account-profile-grid">
                        <div class="account-profile-form">
                            <div class="account-form-group">
                                <label>–§.–ò.–û.</label>
                                <input type="text" id="accountFullName" placeholder="–í–≤–µ–¥–∏—Ç–µ –§.–ò.–û.">
                            </div>
                            <div class="account-form-row">
                                <div class="account-form-group">
                                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input type="tel" id="accountPhoneInput" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                                </div>
                                <div class="account-form-group">
                                    <label>E-mail</label>
                                    <input type="email" id="accountEmailInput" placeholder="E-mail">
                                </div>
                            </div>
                            <div class="account-form-row">
                                <div class="account-form-group">
                                    <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
                                    <select id="accountLanguage">
                                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                                        <option value="az">Az…ôrbaycan</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                            <p class="account-hint">PNG/JPG/WebP, –¥–æ 4 –ú–ë.</p>
                        </div>

                        <div class="account-profile-avatar">
                            <div class="account-avatar-large" id="accountModalAvatar">CA</div>
                            <div class="account-form-group">
                                <label for="accountAvatarInput">–ê–≤–∞—Ç–∞—Ä</label>
                                <input type="file" id="accountAvatarInput" accept="image/*">
                            </div>
                        </div>
                        <button class="account-btn account-btn-primary" id="accountModalSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </div>
                </div>

                <!-- Password tab -->
                <div class="account-tab-panel" id="accountTabPassword">
                    <form id="changePasswordForm" onsubmit="event.preventDefault();">
                        <div class="account-info-section">
                            <div class="account-form-group">
                                <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="currentPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"
                                    autocomplete="current-password">
                            </div>
                            <div class="account-form-group">
                                <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="newPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                                    autocomplete="new-password">
                            </div>
                            <div class="account-form-group">
                                <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="confirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                                    autocomplete="new-password">
                            </div>
                            <button class="account-btn account-btn-primary" type="button"
                                id="changePasswordBtn">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="account-modal-footer">
                <button class="account-btn account-btn-secondary" id="accountModalCancel">–û—Ç–º–µ–Ω–∞</button>
                <!-- <button class="account-btn account-btn-primary" id="accountModalSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button> -->
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div class="account-modal-overlay" id="notificationsModal">
        <div class="account-modal" style="max-width:680px;">
            <div class="account-modal-header">
                <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <button class="account-modal-close" id="notificationsClose">&times;</button>
            </div>
            <div class="account-modal-body">
                <div class="account-info-section" style="margin-bottom:1rem;">
                    <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
                        <button class="account-btn account-btn-secondary" id="notifFilterAll"
                            style="display:none;">–í—Å–µ</button>
                        <button class="account-btn account-btn-secondary active"
                            id="notifFilterImportant">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</button>
                        <button class="account-btn account-btn-secondary" id="notifFilterSystem"
                            style="display:none;">–°–∏—Å—Ç–µ–º–Ω—ã–µ</button>
                    </div>
                </div>
                <div id="notificationsList"></div>
            </div>
            <div class="account-modal-footer">
                <button class="account-btn account-btn-secondary" id="notificationsMarkRead">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ
                    –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>

    <!-- Notifications System -->
    <script src="/js/notifications.js"></script>

    <!-- Test Data (mock data for SPA pages) -->
    <script src="/js/test-data.js"></script>

    <!-- Sidebar Toggle (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏) -->
    <script src="/js/sidebar-toggle.js"></script>

    <!-- Theme Management -->
    <script src="/js/theme.js"></script>

    <!-- Language Management -->
    <script src="/js/i18n.js"></script>
    <script src="/js/i18n-auto.js"></script>

    <!-- Custom JS -->
    <script src="/js/admin.js"></script>

    <!-- SPA Router -->
    <script src="/js/spa-router.js"></script>

    <!-- Initialize Theme Toggle and Language Selector -->
    <script>
        // Global function to hide plan tooltip from blocks page
        function hidePlanTooltip() {
            const tooltip = document.getElementById('planTooltip');
            if (tooltip) {
                tooltip.classList.add('hidden');
                tooltip.style.display = 'none';
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }
        }

        // Hide tooltip on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', hidePlanTooltip);
        } else {
            hidePlanTooltip();
        }

        // Hide tooltip on hash change (navigation)
        window.addEventListener('hashchange', hidePlanTooltip);

        // Hide tooltip on popstate (browser back/forward)
        window.addEventListener('popstate', hidePlanTooltip);

        // Make function globally accessible
        window.hidePlanTooltip = hidePlanTooltip;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
        function setAppealsBadge(unreadCount) {
            const appealsNavItem = document.querySelector('a[data-route="/appeals2"]');
            if (!appealsNavItem) return;
            let badge = appealsNavItem.querySelector('.nav-badge');
            if (unreadCount > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'nav-badge';
                    appealsNavItem.appendChild(badge);
                }
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        }

        async function updateAppealsBadge() {
            try {
                const response = await fetch('http://localhost:8000/api/notifications/unread-count');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const unreadCount = data.count || 0;
                setAppealsBadge(unreadCount);
            } catch (error) {
                console.error('Error updating appeals badge:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Ç–µ–º–Ω—ã–º)
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');

            // –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ Account Settings Modal

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
            updateAppealsBadge();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(updateAppealsBadge, 30000);

            // Language Selector Buttons
            const langButtons = document.querySelectorAll('.lang-btn');
            langButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const lang = this.getAttribute('data-lang');

                    // Remove active from all buttons
                    langButtons.forEach(b => b.classList.remove('active'));

                    // Add active to clicked button
                    this.classList.add('active');

                    // Apply language if i18n is available
                    if (window.i18n) {
                        window.i18n.applyLanguage(lang);
                        localStorage.setItem('language', lang);

                        // Show notification
                        if (window.showSuccess) {
                            const langNames = { ru: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π', az: 'üá¶üáø Az…ôrbaycan', en: 'üá¨üáß English' };
                            showSuccess(`${langNames[lang] || lang} —è–∑—ã–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω`);
                        }
                    }
                });
            });

            // Initialize language on load
            const savedLang = localStorage.getItem('language') || 'ru';
            const activeLangBtn = document.querySelector(`.lang-btn[data-lang="${savedLang}"]`);
            if (activeLangBtn) {
                langButtons.forEach(b => b.classList.remove('active'));
                activeLangBtn.classList.add('active');
            }

            // Apply saved language
            if (window.i18n) {
                window.i18n.applyLanguage(savedLang);
            }

            // Sidebar Toggle Button - FIXED VERSION
            let toggleSidebarBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar') || document.querySelector('.sidebar');

            console.log('=== SIDEBAR DEBUG ===');
            console.log('Toggle button found:', !!toggleSidebarBtn);
            console.log('Sidebar found:', !!sidebar);

            if (toggleSidebarBtn && sidebar) {
                // Remove any existing event listeners by cloning the button
                const newToggleBtn = toggleSidebarBtn.cloneNode(true);
                toggleSidebarBtn.parentNode.replaceChild(newToggleBtn, toggleSidebarBtn);
                toggleSidebarBtn = newToggleBtn;

                // Add tooltips to nav items
                const navItems = sidebar.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    const textEl = item.querySelector('.nav-text');
                    if (textEl && textEl.textContent.trim()) {
                        item.setAttribute('data-tooltip', textEl.textContent.trim());
                    }
                });

                // Load saved state
                let storedSidebarState = localStorage.getItem('sidebarCollapsed');
                if (storedSidebarState === null) {
                    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é sidebar –æ—Ç–∫—Ä—ã—Ç
                    storedSidebarState = 'false';
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
                const sidebarCollapsed = storedSidebarState === 'true';
                console.log('Saved collapsed state:', sidebarCollapsed);

                if (sidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                    console.log('Applied collapsed class from saved state');
                } else {
                    sidebar.classList.remove('collapsed');
                    console.log('Sidebar is open by default');
                }

                // Elements for mobile overlay
                const sidebarOverlay = document.getElementById('sidebarOverlay');

                const handleToggleClick = function (e) {
                    console.log('=== CLICK EVENT FIRED ===');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        const willOpen = !sidebar.classList.contains('open');
                        sidebar.classList.toggle('open', willOpen);
                        sidebar.classList.toggle('collapsed', !willOpen);
                        localStorage.setItem('sidebarCollapsed', willOpen ? 'false' : 'true');
                        if (sidebarOverlay) sidebarOverlay.classList.toggle('show', willOpen);
                        return;
                    }

                    const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
                    console.log('Current collapsed state:', isCurrentlyCollapsed);

                    if (isCurrentlyCollapsed) {
                        console.log('Expanding sidebar...');
                        sidebar.classList.remove('collapsed');
                        localStorage.setItem('sidebarCollapsed', 'false');
                    } else {
                        console.log('Collapsing sidebar...');
                        sidebar.classList.add('collapsed');
                        localStorage.setItem('sidebarCollapsed', 'true');
                    }

                    console.log('New collapsed state:', sidebar.classList.contains('collapsed'));
                };

                toggleSidebarBtn.addEventListener('click', function (e) {
                    handleToggleClick(e);
                }, true);

                // Close on overlay click (mobile)
                if (sidebarOverlay) {
                    sidebarOverlay.addEventListener('click', function () {
                        sidebar.classList.remove('open');
                        sidebarOverlay.classList.remove('show');
                    });
                }

                // ESC to toggle sidebar (works on both mobile and desktop)
                document.addEventListener('keydown', function (ev) {
                    if (ev.key === 'Escape' || ev.keyCode === 27) {
                        const isMobile = window.innerWidth <= 768;
                        if (isMobile) {
                            // On mobile, close sidebar if open
                            if (sidebar.classList.contains('open')) {
                                sidebar.classList.remove('open');
                                if (sidebarOverlay) sidebarOverlay.classList.remove('show');
                            }
                        } else {
                            // On desktop, toggle collapsed state
                            const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
                            if (isCurrentlyCollapsed) {
                                sidebar.classList.remove('collapsed');
                                localStorage.setItem('sidebarCollapsed', 'false');
                            } else {
                                sidebar.classList.add('collapsed');
                                localStorage.setItem('sidebarCollapsed', 'true');
                            }
                        }
                    }
                });

                // Handle resize - cleanup mobile classes when returning to desktop
                window.addEventListener('resize', function () {
                    if (window.innerWidth > 768) {
                        sidebar.classList.remove('open');
                        if (sidebarOverlay) sidebarOverlay.classList.remove('show');
                    }
                });

                // Debug: log current state
                console.log('Sidebar initialized successfully');
                console.log('Initial collapsed state:', sidebar.classList.contains('collapsed'));
                console.log('Initial width:', sidebar.offsetWidth);

                // Add global function for debugging
                window.debugSidebar = function () {
                    console.log('=== SIDEBAR DEBUG INFO ===');
                    console.log('Has collapsed class:', sidebar.classList.contains('collapsed'));
                    console.log('Current width:', sidebar.offsetWidth);
                    console.log('Computed width:', window.getComputedStyle(sidebar).width);
                    console.log('localStorage value:', localStorage.getItem('sidebarCollapsed'));
                    console.log('All classes:', Array.from(sidebar.classList));
                };

                window.resetSidebar = function () {
                    localStorage.removeItem('sidebarCollapsed');
                    sidebar.classList.remove('collapsed');
                    console.log('‚úÖ Sidebar reset! Reload the page.');
                };

                console.log('üí° Type debugSidebar() to see current state');
                console.log('üí° Type resetSidebar() to reset and reload');
            } else {
                console.error('‚ùå ERROR: Sidebar or toggle button not found!');
                if (!toggleSidebarBtn) {
                    console.error('Toggle button element is missing!');
                }
                if (!sidebar) console.error('Sidebar element is missing!');
            }

            // Logout Button Handler
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Clear all session data
                    localStorage.clear();
                    sessionStorage.clear();

                    // Show notification
                    if (window.showInfo) {
                        showInfo('üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!');
                    }

                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 500);
                });
            }

            // Notifications Modal logic
            const openNotificationsBtn = document.getElementById('openNotifications');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsClose = document.getElementById('notificationsClose');
            const notificationsList = document.getElementById('notificationsList');
            const notificationsCount = document.getElementById('notificationsCount');
            const notifFilterAll = document.getElementById('notifFilterAll');
            const notifFilterImportant = document.getElementById('notifFilterImportant');
            const notifFilterSystem = document.getElementById('notifFilterSystem');
            const notificationsMarkRead = document.getElementById('notificationsMarkRead');

            const API_BASE = 'http://localhost:8000';
            let notifications = [];
            let activeFilter = 'unread'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
            function formatTime(dateStr) {
                if (!dateStr) return '‚Äî';
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
                if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
                if (diffDays === 1) return '–í—á–µ—Ä–∞, ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
            async function fetchUnreadCount() {
                try {
                    const resp = await fetch(`${API_BASE}/api/notifications/unread-count`);
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const data = await resp.json();
                    return data.count || 0;
                } catch (e) {
                    console.error('Error fetching unread count:', e);
                    // fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç
                    return notifications.filter(n => n.unread).length;
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞ (—Å–ø–∏—Å–æ–∫) + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞
            async function loadNotifications() {
                try {
                    const url = `${API_BASE}/notifications/json?page=1&per_page=200`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    notifications = (data.notifications || []).map(n => ({
                        id: n.id,
                        title: '–û–±—Ä–∞—â–µ–Ω–∏–µ –∂–∏—Ç–µ–ª—è',
                        text: n.message || '‚Äî',
                        time: formatTime(n.created_at),
                        unread: n.status === 'UNREAD',
                        status: n.status
                    }));

                    renderNotifications();
                    const unread = await fetchUnreadCount();
                    updateNotificationCount(unread);
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    notifications = [];
                    renderNotifications();
                    const unread = await fetchUnreadCount();
                    updateNotificationCount(unread);
                }
            }

            async function markNotificationRead(id) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                let changed = false;
                notifications = notifications.map(n => {
                    if (n.id === Number(id) && n.unread) {
                        changed = true;
                        return { ...n, unread: false, status: 'READ' };
                    }
                    return n;
                });
                if (changed) {
                    const unreadLocal = notifications.filter(n => n.unread).length;
                    renderNotifications(false);
                    updateNotificationCount(unreadLocal);
                    setAppealsBadge(unreadLocal);
                }
                // –î—ë—Ä–≥–∞–µ–º —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è
                try {
                    await fetch(`${API_BASE}/notifications/${id}/json`, { method: 'GET' });
                    // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —É—Ç–æ—á–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                    const unread = await fetchUnreadCount();
                    updateNotificationCount(unread);
                    setAppealsBadge(unread);
                } catch (e) {
                    console.error('Error marking notification as read:', e);
                }
            }

            function renderNotifications(rebind = true) {
                if (!notificationsList) return;

                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å—É - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                let filtered = notifications;
                if (activeFilter === 'unread') {
                    filtered = notifications.filter(n => n.unread);
                }
                // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä 'all', –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ

                const items = filtered.map(n => {
                    const color = '#8b5cf6'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    return `
                        <div class="notification-item" data-id="${n.id}" style="display:flex; gap:12px; align-items:flex-start; padding:12px 14px; border:1px solid rgba(0,0,0,.08); border-radius:12px; margin-bottom:10px; background:${n.unread ? 'rgba(102,126,234,0.08)' : 'transparent'}; cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='rgba(102,126,234,0.15)'" onmouseout="this.style.background='${n.unread ? 'rgba(102,126,234,0.08)' : 'transparent'}'">
                            <div style="width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; background:${color}; box-shadow:0 6px 16px rgba(0,0,0,.15)">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2z"/>
                                </svg>
                            </div>
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                                    <strong style="color:var(--text-primary)">${n.title}</strong>
                                    <span style="font-size:.8rem; color:var(--text-secondary)">${n.time}</span>
                                </div>
                                <div style="margin-top:4px; color:var(--text-secondary)">${n.text}</div>
                            </div>
                            ${n.unread ? '<span class="badge" style="background:#10b981; height:22px; display:flex; align-items:center;">–ù–û–í–ê–Ø</span>' : ''}
                        </div>`;
                }).join('');

                notificationsList.innerHTML = items || '<div class="empty-state" style="text-align:center; padding:2rem; color:var(--text-secondary);">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';

                if (rebind) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    notificationsList.querySelectorAll('.notification-item').forEach(item => {
                        item.addEventListener('click', async function () {
                            const notificationId = this.dataset.id;
                            // –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ —Å—Ä–∞–∑—É
                            await markNotificationRead(notificationId);
                            closeNotifications();
                            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ appeals2 —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º id
                            if (window.spaRouter) {
                                window.spaRouter.navigate(`/appeals2?id=${notificationId}`);
                            } else {
                                window.location.hash = `#/appeals2?id=${notificationId}`;
                            }
                        });
                    });
                }
            }

            async function updateNotificationCount(unreadFromApi) {
                const unread = typeof unreadFromApi === 'number'
                    ? unreadFromApi
                    : notifications.filter(n => n.unread).length;
                if (notificationsCount) {
                    notificationsCount.textContent = String(unread);
                    notificationsCount.style.display = unread > 0 ? 'flex' : 'none';
                }
            }

            function openNotifications() {
                if (!notificationsModal) return;
                notificationsModal.classList.add('show');
                document.body.style.overflow = 'hidden';
                loadNotifications(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            }

            function closeNotifications() {
                if (!notificationsModal) return;
                if (notificationsModal.classList.contains('hiding')) return;

                notificationsModal.classList.add('hiding');

                const onAnimationEnd = (e) => {
                    if (e.target !== notificationsModal) return;
                    notificationsModal.classList.remove('show', 'hiding');
                    document.body.style.overflow = '';
                    notificationsModal.removeEventListener('animationend', onAnimationEnd);
                };

                notificationsModal.addEventListener('animationend', onAnimationEnd);
            }

            if (openNotificationsBtn) openNotificationsBtn.addEventListener('click', openNotifications);
            if (notificationsClose) notificationsClose.addEventListener('click', closeNotifications);
            if (notificationsModal) notificationsModal.addEventListener('click', (e) => { if (e.target === notificationsModal) closeNotifications(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && notificationsModal && notificationsModal.classList.contains('show')) closeNotifications(); });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã - —É–±–∏—Ä–∞–µ–º —Ç–∏–ø—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ "–í—Å–µ" –∏ "–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ"
            if (notifFilterAll) {
                notifFilterAll.addEventListener('click', function () {
                    activeFilter = 'all';
                    notifFilterAll.classList.add('active');
                    notifFilterImportant?.classList.remove('active');
                    notifFilterSystem?.classList.remove('active');
                    renderNotifications();
                });
            }
            if (notifFilterImportant) {
                notifFilterImportant.addEventListener('click', function () {
                    activeFilter = 'unread';
                    notifFilterAll?.classList.remove('active');
                    notifFilterImportant.classList.add('active');
                    notifFilterSystem?.classList.remove('active');
                    renderNotifications();
                });
            }
            if (notifFilterSystem) {
                notifFilterSystem.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            }

            if (notificationsMarkRead) {
                notificationsMarkRead.addEventListener('click', async () => {
                    // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    const unreadIds = notifications.filter(n => n.unread).map(n => n.id);
                    // –õ–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
                    notifications = notifications.map(n => ({ ...n, unread: false, status: 'READ' }));
                    renderNotifications(false);
                    updateNotificationCount(0);
                    setAppealsBadge(0);

                    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–µ—Ä–≥–∞–µ–º —Å–µ—Ä–≤–µ—Ä (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI)
                    Promise.all(unreadIds.map(id => fetch(`${API_BASE}/notifications/${id}/json`, { method: 'GET' }).catch(() => null)))
                        .finally(async () => {
                            const unread = await fetchUnreadCount();
                            updateNotificationCount(unread);
                            setAppealsBadge(unread);
                        });
                });
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadNotifications();
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadNotifications, 30000);

            // Expose API
            window.AdminNotifications = {
                load: loadNotifications,
                updateCount: updateNotificationCount,
                getUnreadCount: () => notifications.filter(n => n.unread).length
            };

            // –î–µ–ª–∞–µ–º loadUserProfile –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.loadUserProfile = loadUserProfile;

            // Account Settings Modal (copied logic from user dashboard)
            const accountProfileBtn = document.getElementById('accountProfileBtn');
            const accountModal = document.getElementById('accountModal');
            const accountModalClose = document.getElementById('accountModalClose');
            const accountModalCancel = document.getElementById('accountModalCancel');
            const accountModalSave = document.getElementById('accountModalSave');

            let currentUserData = null;
            let initialAccountState = null;

            async function loadUserProfile() {
                try {
                    const response = await fetch(`${API_BASE}/api/users/me/public`, {
                        credentials: 'include' // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies –¥–ª—è —Å–µ—Å—Å–∏–∏
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const user = await response.json();
                    currentUserData = user;

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                    const fullNameInput = document.getElementById('accountFullName');
                    const phoneInput = document.getElementById('accountPhoneInput');
                    const emailInput = document.getElementById('accountEmailInput');
                    const avatarPreview = document.getElementById('accountModalAvatar');

                    if (fullNameInput) fullNameInput.value = user.full_name || '';
                    if (phoneInput) phoneInput.value = user.phone || '';
                    if (emailInput) emailInput.value = user.email || '';

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
                    if (avatarPreview) {
                        const initials = (user.full_name || user.username || 'U').substring(0, 2).toUpperCase();
                        
                        if (user.avatar_path) {
                            // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                            const img = new Image();
                            img.onload = function() {
                                avatarPreview.style.backgroundImage = `url('${API_BASE}${user.avatar_path}')`;
                                avatarPreview.style.background = 'none'; // –£–±–∏—Ä–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                                avatarPreview.style.backgroundSize = 'cover';
                                avatarPreview.style.backgroundPosition = 'center';
                                avatarPreview.textContent = '';
                            };
                            img.onerror = function() {
                                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
                                avatarPreview.textContent = initials;
                                avatarPreview.style.backgroundImage = 'none';
                                avatarPreview.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                                avatarPreview.style.backgroundSize = '';
                                avatarPreview.style.backgroundPosition = '';
                            };
                            img.src = `${API_BASE}${user.avatar_path}`;
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –µ—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞
                            avatarPreview.textContent = initials;
                            avatarPreview.style.backgroundImage = 'none';
                            avatarPreview.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                            avatarPreview.style.backgroundSize = '';
                            avatarPreview.style.backgroundPosition = '';
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –∏ –∏–º—è –≤ —à–∞–ø–∫–µ
                    updateHeaderUserInfo(user);

                    initialAccountState = getAccountState();
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    if (window.showError) {
                        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
                    }
                }
            }

            function updateHeaderUserInfo(user) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ —à–∞–ø–∫–µ
                const headerAvatar = document.querySelector('.user-avatar');
                if (headerAvatar) {
                    const initials = (user.full_name || user.username || 'U').substring(0, 2).toUpperCase();
                    
                    if (user.avatar_path) {
                        // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                        const img = new Image();
                        img.onload = function() {
                            headerAvatar.style.backgroundImage = `url('${API_BASE}${user.avatar_path}')`;
                            headerAvatar.style.background = 'none'; // –£–±–∏—Ä–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                            headerAvatar.style.backgroundSize = 'cover';
                            headerAvatar.style.backgroundPosition = 'center';
                            headerAvatar.textContent = '';
                        };
                        img.onerror = function() {
                            // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
                            headerAvatar.textContent = initials;
                            headerAvatar.style.backgroundImage = 'none';
                            headerAvatar.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                            headerAvatar.style.backgroundSize = '';
                            headerAvatar.style.backgroundPosition = '';
                        };
                        img.src = `${API_BASE}${user.avatar_path}`;
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –µ—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞
                        headerAvatar.textContent = initials;
                        headerAvatar.style.backgroundImage = 'none';
                        headerAvatar.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                        headerAvatar.style.backgroundSize = '';
                        headerAvatar.style.backgroundPosition = '';
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ —à–∞–ø–∫–µ
                const userNameEl = document.querySelector('.user-name');
                if (userNameEl) {
                    userNameEl.textContent = user.full_name || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –≤ —à–∞–ø–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                const userRoleEl = document.querySelector('.user-role');
                if (userRoleEl) {
                    const roleNames = {
                        'ROOT': '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                        'ADMIN': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                        'OPERATOR': '–û–ø–µ—Ä–∞—Ç–æ—Ä',
                        'RESIDENT': '–ñ–∏—Ç–µ–ª—å'
                    };
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º role –∫–∞–∫ —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å value
                    const roleValue = typeof user.role === 'string' ? user.role : (user.role?.value || user.role);
                    userRoleEl.textContent = roleNames[roleValue] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                }
            }

            function getAccountState() {
                const fullName = document.getElementById('accountFullName')?.value || '';
                const phone = document.getElementById('accountPhoneInput')?.value || '';
                const email = document.getElementById('accountEmailInput')?.value || '';
                const lang = document.getElementById('accountLanguage')?.value || '';
                const currentPassword = document.getElementById('currentPassword')?.value || '';
                const newPassword = document.getElementById('newPassword')?.value || '';
                const confirmPassword = document.getElementById('confirmPassword')?.value || '';
                const avatar = document.getElementById('accountAvatarInput')?.files?.length > 0 ? 'has-file' : '';

                return {
                    fullName,
                    phone,
                    email,
                    lang,
                    currentPassword,
                    newPassword,
                    confirmPassword,
                    avatar
                };
            }

            function hasUnsavedAccountChanges() {
                if (!initialAccountState) return false;
                const currentState = getAccountState();
                return Object.keys(initialAccountState).some(
                    key => initialAccountState[key] !== currentState[key]
                );
            }

            function closeAccountModal() {
                if (!accountModal) return;
                if (accountModal.classList.contains('hiding')) return;

                accountModal.classList.add('hiding');

                const onAnimationEnd = (e) => {
                    if (e.target !== accountModal) return;
                    accountModal.classList.remove('show', 'hiding');
                    document.body.style.overflow = '';
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞
                    const avatarInput = document.getElementById('accountAvatarInput');
                    if (avatarInput) avatarInput.value = '';

                    accountModal.removeEventListener('animationend', onAnimationEnd);
                };

                accountModal.addEventListener('animationend', onAnimationEnd);
            }

            function requestCloseAccountModal() {
                if (!hasUnsavedAccountChanges()) {
                    closeAccountModal();
                    return;
                }

                const message = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.';

                if (window.showConfirm) {
                    showConfirm(message, () => {
                        closeAccountModal();
                    });
                } else if (confirm(message)) {
                    closeAccountModal();
                }
            }

            async function openAccountModal() {
                if (accountModal) {
                    accountModal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                    const savedLang = localStorage.getItem('language') || 'ru';
                    const langSelect = document.getElementById('accountLanguage');
                    if (langSelect) langSelect.value = savedLang;

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await loadUserProfile();
                }
            }

            if (accountProfileBtn) {
                accountProfileBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    openAccountModal();
                });
            }

            if (accountModalClose) accountModalClose.addEventListener('click', requestCloseAccountModal);
            if (accountModalCancel) accountModalCancel.addEventListener('click', requestCloseAccountModal);

            if (accountModal) {
                accountModal.addEventListener('click', function (e) {
                    if (e.target === accountModal) requestCloseAccountModal();
                });
            }

            // Tabs switching
            const tabButtons = document.querySelectorAll('.account-tab-btn');
            const tabPanels = document.querySelectorAll('.account-tab-panel');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-tab');
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    btn.classList.add('active');
                    const panel = document.getElementById(
                        target === 'profile' ? 'accountTabProfile' : 'accountTabPassword'
                    );
                    if (panel) panel.classList.add('active');
                });
            });

            // Avatar preview
            const avatarInput = document.getElementById('accountAvatarInput');
            const avatarPreview = document.getElementById('accountModalAvatar');
            if (avatarInput && avatarPreview) {
                avatarInput.addEventListener('change', function () {
                    const file = this.files && this.files[0];
                    if (!file) {
                        // –ï—Å–ª–∏ —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const userNameEl = document.querySelector('.user-name');
                        const userName = userNameEl ? userNameEl.textContent : 'U';
                        const initials = userName.substring(0, 2).toUpperCase();
                        avatarPreview.textContent = initials;
                        avatarPreview.style.backgroundImage = 'none';
                        avatarPreview.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                        avatarPreview.style.backgroundSize = '';
                        avatarPreview.style.backgroundPosition = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        avatarPreview.style.backgroundImage = `url('${e.target.result}')`;
                        avatarPreview.style.background = 'none'; // –£–±–∏—Ä–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                        avatarPreview.style.backgroundSize = 'cover';
                        avatarPreview.style.backgroundPosition = 'center';
                        avatarPreview.textContent = '';
                    };
                    reader.onerror = function() {
                        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
                        const userNameEl = document.querySelector('.user-name');
                        const userName = userNameEl ? userNameEl.textContent : 'U';
                        const initials = userName.substring(0, 2).toUpperCase();
                        avatarPreview.textContent = initials;
                        avatarPreview.style.backgroundImage = 'none';
                        avatarPreview.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                        avatarPreview.style.backgroundSize = '';
                        avatarPreview.style.backgroundPosition = '';
                    };
                    reader.readAsDataURL(file);
                });
            }

            const changePasswordBtn = document.getElementById('changePasswordBtn');
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', async function () {
                    const currentPassword = document.getElementById('currentPassword')?.value || '';
                    const newPassword = document.getElementById('newPassword')?.value || '';
                    const confirmPassword = document.getElementById('confirmPassword')?.value || '';

                    if (!currentPassword || !newPassword || !confirmPassword) {
                        if (window.showError) {
                            showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è.');
                        } else {
                            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è.');
                        }
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        if (window.showError) {
                            showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                        } else {
                            alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                        }
                        return;
                    }

                    if (newPassword.length < 6) {
                        if (window.showError) {
                            showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤!');
                        } else {
                            alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤!');
                        }
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE}/api/users/me/change-password/public`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include', // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies –¥–ª—è —Å–µ—Å—Å–∏–∏
                            body: JSON.stringify({
                                current_password: currentPassword,
                                new_password: newPassword,
                                confirm_password: confirmPassword
                            })
                        });

                        if (!response.ok) {
                            let errorMessage = '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è';
                            try {
                                const errorData = await response.json();
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—à–∏–±–æ–∫
                                if (errorData.detail) {
                                    errorMessage = typeof errorData.detail === 'string'
                                        ? errorData.detail
                                        : JSON.stringify(errorData.detail);
                                } else if (errorData.message) {
                                    errorMessage = errorData.message;
                                } else if (typeof errorData === 'string') {
                                    errorMessage = errorData;
                                } else {
                                    errorMessage = JSON.stringify(errorData);
                                }
                            } catch (e) {
                                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å
                                errorMessage = `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                            }
                            throw new Error(errorMessage);
                        }

                        const result = await response.json();

                        if (window.showSuccess) {
                            showSuccess(result.message || '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!');
                        } else {
                            alert(result.message || '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!');
                        }

                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmPassword').value = '';
                    } catch (error) {
                        console.error('Error changing password:', error);
                        let errorMessage = '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è';
                        if (error instanceof Error) {
                            errorMessage = error.message;
                        } else if (typeof error === 'string') {
                            errorMessage = error;
                        } else {
                            errorMessage = JSON.stringify(error);
                        }
                        if (window.showError) {
                            showError(errorMessage);
                        } else {
                            alert(errorMessage);
                        }
                    }
                });
            }

            if (accountModalSave) {
                accountModalSave.addEventListener('click', async function () {
                    const fullName = document.getElementById('accountFullName')?.value || '';
                    const phone = document.getElementById('accountPhoneInput')?.value || '';
                    const email = document.getElementById('accountEmailInput')?.value || '';
                    const avatarInput = document.getElementById('accountAvatarInput');
                    const langSelect = document.getElementById('accountLanguage');

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —è–∑—ã–∫
                    if (langSelect) {
                        const lang = langSelect.value;
                        const previousLang = localStorage.getItem('language') || (window.i18n && window.i18n.currentLanguage) || 'ru';
                        if (lang !== previousLang) {
                            localStorage.setItem('language', lang);
                            if (window.i18n) {
                                if (typeof window.i18n.changeLanguage === 'function') {
                                    window.i18n.changeLanguage(lang);
                                } else if (typeof window.i18n.applyLanguage === 'function') {
                                    window.i18n.applyLanguage(lang);
                                }
                            }
                        }
                    }

                    // –¢–µ–º–∞ –≤—Å–µ–≥–¥–∞ —Ç–µ–º–Ω–∞—è
                    localStorage.setItem('theme', 'dark');
                    document.documentElement.setAttribute('data-theme', 'dark');

                    try {
                        // –§–æ—Ä–º–∏—Ä—É–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞
                        const formData = new FormData();
                        formData.append('full_name', fullName);
                        formData.append('phone', phone);
                        formData.append('email', email);

                        if (avatarInput && avatarInput.files && avatarInput.files[0]) {
                            formData.append('avatar', avatarInput.files[0]);
                        }

                        const response = await fetch(`${API_BASE}/api/users/me/public`, {
                            method: 'PUT',
                            credentials: 'include', // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies –¥–ª—è —Å–µ—Å—Å–∏–∏
                            body: formData
                        });

                        if (!response.ok) {
                            let errorMessage = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è';
                            try {
                                const errorData = await response.json();
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—à–∏–±–æ–∫
                                if (errorData.detail) {
                                    errorMessage = typeof errorData.detail === 'string'
                                        ? errorData.detail
                                        : JSON.stringify(errorData.detail);
                                } else if (errorData.message) {
                                    errorMessage = errorData.message;
                                } else if (typeof errorData === 'string') {
                                    errorMessage = errorData;
                                } else {
                                    errorMessage = JSON.stringify(errorData);
                                }
                            } catch (e) {
                                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å
                                errorMessage = `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                            }
                            throw new Error(errorMessage);
                        }

                        const updatedUser = await response.json();
                        currentUserData = updatedUser;

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –ø—Ä–µ–≤—å—é
                        const avatarPreview = document.getElementById('accountModalAvatar');
                        if (avatarPreview) {
                            const initials = (updatedUser.full_name || updatedUser.username || 'U').substring(0, 2).toUpperCase();
                            
                            if (updatedUser.avatar_path) {
                                // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                                const img = new Image();
                                img.onload = function() {
                                    avatarPreview.style.backgroundImage = `url('${API_BASE}${updatedUser.avatar_path}')`;
                                    avatarPreview.style.background = 'none'; // –£–±–∏—Ä–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                                    avatarPreview.style.backgroundSize = 'cover';
                                    avatarPreview.style.backgroundPosition = 'center';
                                    avatarPreview.textContent = '';
                                };
                                img.onerror = function() {
                                    // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
                                    avatarPreview.textContent = initials;
                                    avatarPreview.style.backgroundImage = 'none';
                                    avatarPreview.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                                    avatarPreview.style.backgroundSize = '';
                                    avatarPreview.style.backgroundPosition = '';
                                };
                                img.src = `${API_BASE}${updatedUser.avatar_path}`;
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –µ—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞
                                avatarPreview.textContent = initials;
                                avatarPreview.style.backgroundImage = 'none';
                                avatarPreview.style.background = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS
                                avatarPreview.style.backgroundSize = '';
                                avatarPreview.style.backgroundPosition = '';
                            }
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —à–∞–ø–∫–µ
                        updateHeaderUserInfo(updatedUser);

                        if (window.showSuccess) {
                            showSuccess('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                        } else {
                            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        initialAccountState = getAccountState();
                        closeAccountModal();
                    } catch (error) {
                        console.error('Error saving profile:', error);
                        let errorMessage = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è';
                        if (error instanceof Error) {
                            errorMessage = error.message;
                        } else if (typeof error === 'string') {
                            errorMessage = error;
                        } else {
                            errorMessage = JSON.stringify(error);
                        }
                        if (window.showError) {
                            showError(errorMessage);
                        } else {
                            alert(errorMessage);
                        }
                    }
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && accountModal && accountModal.classList.contains('show')) {
                    requestCloseAccountModal();
                }
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // –í—ã–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã DOM –±—ã–ª –≥–æ—Ç–æ–≤
            setTimeout(() => {
                loadUserProfile();
            }, 200);
        });
    </script>
</body>

</html>