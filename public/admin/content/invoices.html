<link rel="stylesheet" href="/admin/content_css/invoice.css">
<div class="content-wrapper invoices-page" style="padding-top: 0 !important;">
    <!-- Actions Section -->
    <div class="invoices-actions">
        <div class="invoices-actions-row">
            <div class="invoices-actions-group">
                <label>Блок (для «по блоку»)</label>
                <select id="invoiceBlock">
                    <option value="">— выберите блок —</option>
                    <option value="A">Блок A</option>
                    <option value="B">Блок B</option>
                    <option value="K">Блок K</option>
                    <option value="X">Блок X</option>
                    <option value="Z">Блок Z</option>
                </select>
            </div>
            
            <div class="invoices-actions-group">
                <label>Срок оплаты (due date)</label>
                <div class="date-input-wrapper">
                    <input type="date" id="invoiceDueDate" class="date-picker-input">
                    <button type="button" class="btn-calendar" onclick="openDatePicker('invoiceDueDate')" title="Открыть календарь">
                        <i class="bi bi-calendar"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="invoices-actions-row">
            <div class="invoices-actions-buttons">
                <button class="btn btn-outline-primary" onclick="issueInvoiceByBlock()">
                    Выставить счёт по блоку
                </button>
                <button class="btn btn-primary" onclick="issueAllInvoices()">
                    Выставить все счета
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="invoices-filters">
        <div class="invoices-filters-row">
            <div class="invoices-filters-group">
                <label>Год</label>
                <input type="number" id="filterYear" min="2000" max="2100" step="1" value="2024">
            </div>
            
            <div class="invoices-filters-group">
                <label>Месяц</label>
                <input type="number" id="filterMonth" min="1" max="12" step="1" placeholder="1-12">
            </div>
            
            <div class="invoices-filters-group">
                <label>Резидент</label>
                <select id="filterResident">
                    <option value="all">Все</option>
                    <option value="1">Резидент 1</option>
                    <option value="2">Резидент 2</option>
                </select>
            </div>
            
            <div class="invoices-filters-group">
                <label>Статус</label>
                <select id="filterStatus">
                    <option value="all">Все</option>
                    <option value="paid">Оплачен</option>
                    <option value="unpaid">Не оплачен</option>
                    <option value="overdue">Просрочен</option>
                </select>
            </div>
            
            <div class="invoices-filters-group">
                <label>Поиск</label>
                <input type="text" id="filterSearch" placeholder="№ или примечание">
            </div>
        </div>
        
        <div class="invoices-filters-actions">
            <button class="btn btn-outline-secondary" onclick="applyInvoiceFilters()">
                <i class="bi bi-funnel"></i> Фильтр
            </button>
            <button class="btn btn-outline-warning" onclick="clearInvoiceFilters()">
                <i class="bi bi-x-circle"></i> Очистить
            </button>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Период</th>
                            <th>Резидент</th>
                            <th>№ счета</th>
                            <th>Статус</th>
                            <th>Начислено</th>
                            <th>Срок оплаты</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="table-pagination">
                <div class="pagination-controls">
                    <button class="btn-pagination" onclick="goToInvoicePage('prev')" disabled id="invoicePrevBtn">
                        <i class="bi bi-chevron-double-left"></i>
                    </button>
                    <button class="btn-pagination active" onclick="goToInvoicePage(1)" id="invoiceCurrentPageBtn">1</button>
                    <button class="btn-pagination" onclick="goToInvoicePage('next')" disabled id="invoiceNextBtn">
                        <i class="bi bi-chevron-double-right"></i>
                    </button>
                </div>
                <div class="pagination-info">
                    <span>Стр. <span id="invoiceCurrentPage">1</span> из <span id="invoiceTotalPages">1</span> · всего <span id="invoiceTotalItems">0</span></span>
                </div>
                <div class="pagination-per-page">
                    <span>На</span>
                    <span>странице:</span>
                    <div class="custom-pag-select" id="customInvoiceItemsPerPage">
                        <select id="invoiceItemsPerPage" onchange="changeInvoiceItemsPerPage()" style="display: none;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <div class="select-btn">
                            <span class="select-text">25</span>
                            <span class="arrow">▾</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="10">10</div>
                            <div class="select-option selected" data-value="25">25</div>
                            <div class="select-option" data-value="50">50</div>
                            <div class="select-option" data-value="100">100</div>
                        </div>
            </div>
        </div>
    </div>
    </div>
</div>

<script>
(function(){
    // ПРИНУДИТЕЛЬНО ПРИМЕНИТЬ СЕРЫЙ ФОН В DARK THEME
    function applyDarkThemeStyles() {
        if (document.documentElement.getAttribute('data-theme') === 'dark' || 
            document.body.getAttribute('data-theme') === 'dark') {
            const actionsSection = document.querySelector('.invoices-actions');
            const filtersSection = document.querySelector('.invoices-filters');
            
            if (actionsSection) {
                actionsSection.style.setProperty('background', '#242831', 'important');
                actionsSection.style.setProperty('background-color', '#242831', 'important');
                actionsSection.style.setProperty('border', '1px solid rgba(255, 255, 255, 0.08)', 'important');
                actionsSection.style.setProperty('color', '#e4e6eb', 'important');
            }
            
            if (filtersSection) {
                filtersSection.style.setProperty('background', '#242831', 'important');
                filtersSection.style.setProperty('background-color', '#242831', 'important');
                filtersSection.style.setProperty('border', '1px solid rgba(255, 255, 255, 0.08)', 'important');
                filtersSection.style.setProperty('color', '#e4e6eb', 'important');
            }

            // Применить серый фон к select и option элементам
            const selectElements = document.querySelectorAll('.invoices-actions-group select, .invoices-filters-group select');
            selectElements.forEach(select => {
                select.style.setProperty('background', 'rgba(255, 255, 255, 0.05)', 'important');
                select.style.setProperty('background-color', 'rgba(255, 255, 255, 0.05)', 'important');
                select.style.setProperty('color', '#fefefe', 'important');
                
                // Применить стили к option элементам
                const options = select.querySelectorAll('option');
                options.forEach(option => {
                    option.style.setProperty('background', '#242831', 'important');
                    option.style.setProperty('background-color', '#242831', 'important');
                    option.style.setProperty('color', '#f6f7ff', 'important');
                });
            });

            // Инъекция CSS для белого плейсхолдера date input
            const dateInputStyleId = 'date-input-placeholder-white';
            if (!document.getElementById(dateInputStyleId)) {
                const style = document.createElement('style');
                style.id = dateInputStyleId;
                style.textContent = `
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-text,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-month-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-day-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-year-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-text,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-month-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-day-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-year-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-text,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-month-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-day-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-year-field {
                        color: #ffffff !important;
                    }
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-text,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-month-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-day-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-year-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-text,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-month-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-day-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-year-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-text,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-month-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-day-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-year-field {
                        color: #ffffff !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }
    }
    
    // Применить сразу
    applyDarkThemeStyles();
    
    // Применить после загрузки DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyDarkThemeStyles);
    }
    
    // Применить с задержкой на случай, если стили загружаются асинхронно
    setTimeout(applyDarkThemeStyles, 100);
    setTimeout(applyDarkThemeStyles, 500);
    setTimeout(applyDarkThemeStyles, 1000);

    // Повторно применять стили при открытии select (для выпадающих списков)
    document.addEventListener('DOMContentLoaded', function() {
        const selectElements = document.querySelectorAll('.invoices-actions-group select, .invoices-filters-group select');
        selectElements.forEach(select => {
            // Применить стили при клике (открытие dropdown)
            select.addEventListener('mousedown', function() {
                setTimeout(applyDarkThemeStyles, 10);
            });
            // Применить стили при фокусе
            select.addEventListener('focus', function() {
                setTimeout(applyDarkThemeStyles, 10);
            });
            // Применить стили при изменении
            select.addEventListener('change', function() {
                setTimeout(applyDarkThemeStyles, 10);
            });
        });
    });
    
    const statuses = {
        paid: {text: 'Оплачен', cls: 'success'}, 
        unpaid: {text: 'Не оплачен', cls: 'warning'}, 
        overdue: {text: 'Просрочен', cls: 'danger'},
        draft: {text: 'DRAFT', cls: 'secondary'},
        issued: {text: 'Выставлен', cls: 'info'}
    };
    
    // Store original data
    let allInvoices = [];
    let filteredInvoices = [];
    
    // Initialize data
    if (typeof TestData !== 'undefined' && TestData.invoices) {
        allInvoices = [...TestData.invoices];
        filteredInvoices = [...TestData.invoices];
    }
    
    // Pagination state
    let paginationState = {
        currentPage: 1,
        itemsPerPage: 25,
        totalItems: 0,
        totalPages: 1
    };
    
    // Render table function
    function renderTable(invoices) {
    const tbody = document.getElementById('invoicesTable');
        if (!tbody) return;
        
        // Update pagination state
        paginationState.totalItems = invoices.length;
        paginationState.totalPages = Math.max(1, Math.ceil(paginationState.totalItems / paginationState.itemsPerPage));
        
        if (paginationState.currentPage > paginationState.totalPages) {
            paginationState.currentPage = paginationState.totalPages || 1;
        }
        
        // Get paginated data
        const startIndex = (paginationState.currentPage - 1) * paginationState.itemsPerPage;
        const endIndex = startIndex + paginationState.itemsPerPage;
        const pageInvoices = invoices.slice(startIndex, endIndex);
        
        if (pageInvoices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Нет данных по текущим фильтрам</td></tr>';
        } else {
            tbody.innerHTML = pageInvoices.map(i => {
                const invoiceNumber = i.invoiceNumber || i.number || `INV-${String(i.id).padStart(4, '0')}`;
                const resident = i.userName || i.residentName || '—';
                const period = i.period || '—';
                const amount = typeof i.amount === 'number' ? i.amount.toFixed(2) : (i.amount || '0.00');
                const dueDate = i.dueDate || '—';
                const statusConfig = statuses[i.status] || { text: i.status || 'Неизвестно', cls: 'secondary' };
                
                // Данные об оплате
                const paid = typeof i.paid === 'number' ? i.paid.toFixed(2) : '0.00';
                const remaining = typeof i.remaining === 'number' ? i.remaining.toFixed(2) : amount;
                const totalAmount = typeof i.amount === 'number' ? i.amount.toFixed(2) : amount;
                
                return `<tr>
                    <td>${period}</td>
                    <td><strong>${resident}</strong></td>
                    <td>${invoiceNumber}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span class="badge bg-${statusConfig.cls}">${statusConfig.text}</span>
                            <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); background: rgba(255, 255, 255, 0.05); padding: 4px 8px; border-radius: 4px; margin-top: 4px;">
                                Оплачено ${paid} / Остаток ${remaining}
                            </div>
                        </div>
                    </td>
                    <td><strong style="color: #ff6b6b;">${totalAmount} ₼</strong></td>
                    <td>${dueDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice(${i.id})">Открыть</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="printInvoice(${i.id})" title="Печать">
                            <i class="bi bi-printer"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        updatePaginationUI();
    }
    
    // Update pagination UI
    function updatePaginationUI() {
        const currentPageEl = document.getElementById('invoiceCurrentPage');
        const totalPagesEl = document.getElementById('invoiceTotalPages');
        const totalItemsEl = document.getElementById('invoiceTotalItems');
        const currentPageBtn = document.getElementById('invoiceCurrentPageBtn');
        const prevBtn = document.getElementById('invoicePrevBtn');
        const nextBtn = document.getElementById('invoiceNextBtn');
        
        if (currentPageEl) currentPageEl.textContent = paginationState.currentPage;
        if (totalPagesEl) totalPagesEl.textContent = paginationState.totalPages;
        if (totalItemsEl) totalItemsEl.textContent = paginationState.totalItems;
        if (currentPageBtn) currentPageBtn.textContent = paginationState.currentPage;
        if (prevBtn) prevBtn.disabled = paginationState.currentPage === 1;
        if (nextBtn) nextBtn.disabled = paginationState.currentPage === paginationState.totalPages;
    }
    
    // Pagination functions
    window.goToInvoicePage = function(page) {
        if (page === 'prev') {
            if (paginationState.currentPage > 1) {
                paginationState.currentPage--;
                renderTable(filteredInvoices);
            }
        } else if (page === 'next') {
            if (paginationState.currentPage < paginationState.totalPages) {
                paginationState.currentPage++;
                renderTable(filteredInvoices);
            }
        } else if (typeof page === 'number') {
            paginationState.currentPage = page;
            renderTable(filteredInvoices);
        }
    };
    
    window.changeInvoiceItemsPerPage = function() {
        const select = document.getElementById('invoiceItemsPerPage');
        if (select) {
            paginationState.itemsPerPage = parseInt(select.value);
            paginationState.currentPage = 1;
            renderTable(filteredInvoices);
        }
    };
    
    // View and download functions
    window.viewInvoice = function(id) {
        console.log('Opening invoice view for ID:', id);
        
        // Загрузить страницу просмотра через fetch и вставить в SPA контейнер
        const viewUrl = `/admin/content/invoice-view.html?id=${id}`;
        const contentContainer = document.getElementById('spa-content');
        
        if (!contentContainer) {
            console.error('SPA content container not found');
            window.location.href = viewUrl;
            return;
        }
        
        // Показать состояние загрузки
        contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.8);"><i class="bi bi-hourglass-split" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Загрузка...</p></div>';
        
        // Загрузить контент
        fetch(viewUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // Вставить контент
                contentContainer.innerHTML = html;
                
                // Выполнить скрипты из загруженного контента
                const scripts = contentContainer.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                
                // Обновить заголовок страницы и breadcrumb
                updatePageHeaderForInvoiceView(id);
                
                // Обновить URL в браузере
                if (window.history && window.history.pushState) {
                    window.history.pushState({ route: 'invoice-view', id: id }, '', `#/invoice-view?id=${id}`);
                }
                
                // Скроллить наверх
                contentContainer.scrollTop = 0;
                
                console.log('Invoice view loaded successfully');
            })
            .catch(error => {
                console.error('Error loading invoice view:', error);
                contentContainer.innerHTML = `<div style="padding: 40px; text-align: center; color: #ff6b6b;"><p>Ошибка загрузки страницы: ${error.message}</p><button onclick="window.location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">Перезагрузить</button></div>`;
            });
    };
    
    window.printInvoice = function(id) {
        // Открыть страницу печати счета в новой вкладке
        const printUrl = `/admin/content/invoice-print.html?id=${id}`;
        window.open(printUrl, '_blank');
    };
    
    window.downloadInvoice = function(id) {
        // Открыть страницу печати для скачивания PDF
        const printUrl = `/admin/content/invoice-print.html?id=${id}`;
        window.open(printUrl, '_blank');
    };
    
    // Функция для обновления заголовка и breadcrumb при открытии просмотра счета
    function updatePageHeaderForInvoiceView(invoiceId) {
        // Обновить заголовок страницы
        const titleContainer = document.getElementById('page-title-container');
        if (titleContainer) {
            const h1 = titleContainer.querySelector('h1');
            if (h1) {
                h1.textContent = 'Счета';
            }
            
            // Обновить breadcrumb
            const breadcrumbContainer = titleContainer.querySelector('.page-breadcrumb');
            if (breadcrumbContainer) {
                breadcrumbContainer.innerHTML = `
                    <span class="breadcrumb-item">
                        <svg width="14" height="14" fill="currentColor" style="margin-right: 0.25rem; vertical-align: middle;">
                            <use href="/images/icons.svg#icon-apartments"></use>
                        </svg>
                        Финансы
                    </span>
                    <span>›</span>
                    <span class="breadcrumb-item">Счета</span>
                `;
            }
        }
        
        // Обновить title страницы
        document.title = 'Счета - RoyalPark Admin';
    }
    
    // Initialize custom pagination dropdown
    let invoiceDropdownInitialized = false;
    function initCustomInvoicePaginationDropdown() {
        const customSelect = document.getElementById('customInvoiceItemsPerPage');
        if (!customSelect || customSelect.dataset.initialized === 'true') return;
        customSelect.dataset.initialized = 'true';
        
        const nativeSelect = document.getElementById('invoiceItemsPerPage');
        const selectBtn = customSelect.querySelector('.select-btn');
        const selectText = customSelect.querySelector('.select-text');
        const options = customSelect.querySelectorAll('.select-option');
        
        if (nativeSelect) {
            const selectedValue = nativeSelect.value;
            selectText.textContent = selectedValue;
            options.forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.value === selectedValue) {
                    opt.classList.add('selected');
                }
            });
        }
        
        selectBtn.onclick = function(e) {
            e.stopPropagation();
            customSelect.classList.toggle('open');
        };
        
        options.forEach(option => {
            option.onclick = function(e) {
                e.stopPropagation();
                const value = option.dataset.value;
                if (nativeSelect) {
                    nativeSelect.value = value;
                    nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
                selectText.textContent = value;
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                customSelect.classList.remove('open');
            };
        });
        
        if (!invoiceDropdownInitialized) {
            document.addEventListener('click', function(e) {
                if (!customSelect.contains(e.target)) {
                    customSelect.classList.remove('open');
                }
            });
            invoiceDropdownInitialized = true;
        }
    }
    
    // Initial render
    renderTable(filteredInvoices);
    setTimeout(() => {
        initCustomInvoicePaginationDropdown();
    }, 500);

    // Invoice Actions Functions
    window.issueInvoiceByBlock = function() {
        const block = document.getElementById('invoiceBlock').value;
        const dueDate = document.getElementById('invoiceDueDate').value;
        
        if (!block) {
            if (typeof showWarning === 'function') {
                showWarning('Пожалуйста, выберите блок!');
            }
            return;
        }
        
        console.log('Issue invoice by block:', { block, dueDate });
        // TODO: Implement API call
        if (typeof showSuccess === 'function') {
            showSuccess(`Счета по блоку ${block} успешно выставлены!`);
        }
    };

    window.issueAllInvoices = function() {
        const dueDate = document.getElementById('invoiceDueDate').value;
        console.log('Issue all invoices:', { dueDate });
        // TODO: Implement API call
        if (typeof showSuccess === 'function') {
            showSuccess('Все счета успешно выставлены!');
        }
    };

    window.applyInvoiceFilters = function() {
        const year = document.getElementById('filterYear').value;
        const month = document.getElementById('filterMonth').value;
        const resident = document.getElementById('filterResident').value;
        const status = document.getElementById('filterStatus').value;
        const search = document.getElementById('filterSearch').value.toLowerCase();
        
        // Filter invoices
        filteredInvoices = allInvoices.filter(invoice => {
            // Filter by year
            if (year) {
                const invoiceYear = extractYear(invoice.period || invoice.issueDate || '');
                if (invoiceYear && invoiceYear.toString() !== year.toString()) {
                    return false;
                }
            }
            
            // Filter by month
            if (month) {
                const invoiceMonth = extractMonth(invoice.period || invoice.issueDate || '');
                if (invoiceMonth && invoiceMonth.toString() !== month.toString()) {
                    return false;
                }
            }
            
            // Filter by resident (if you have resident field in invoice data)
            if (resident && resident !== 'all') {
                // Adjust this based on your invoice data structure
                // For now, skip if no resident field
                if (invoice.residentId && invoice.residentId.toString() !== resident) {
                    return false;
                }
            }
            
            // Filter by status
            if (status && status !== 'all') {
                if (invoice.status !== status) {
                    return false;
                }
            }
            
            // Filter by search (ID or note)
            if (search) {
                const searchText = `${invoice.id} ${invoice.userName || ''} ${invoice.apartment || ''} ${invoice.note || ''}`.toLowerCase();
                if (!searchText.includes(search)) {
                    return false;
                }
            }
            
            return true;
        });
        
        // Reset to first page on filter
        paginationState.currentPage = 1;
        
        // Re-render table with filtered data
        renderTable(filteredInvoices);
        
        if (typeof showSuccess === 'function') {
            showSuccess(`Найдено записей: ${filteredInvoices.length}`);
        }
    };
    
    // Helper functions to extract year and month
    function extractYear(dateString) {
        if (!dateString) return null;
        const yearMatch = dateString.match(/(\d{4})/);
        return yearMatch ? parseInt(yearMatch[1]) : null;
    }
    
    function extractMonth(dateString) {
        if (!dateString) return null;
        
        // Try to extract month from date string (format: YYYY-MM-DD)
        const dateMatch = dateString.match(/\d{4}-(\d{2})-\d{2}/);
        if (dateMatch) {
            return parseInt(dateMatch[1]);
        }
        
        // Try to extract from period (e.g., "Октябрь 2024")
        const monthNames = {
            'январь': 1, 'февраль': 2, 'март': 3, 'апрель': 4,
            'май': 5, 'июнь': 6, 'июль': 7, 'август': 8,
            'сентябрь': 9, 'октябрь': 10, 'ноябрь': 11, 'декабрь': 12
        };
        
        const lowerDate = dateString.toLowerCase();
        for (const [monthName, monthNum] of Object.entries(monthNames)) {
            if (lowerDate.includes(monthName)) {
                return monthNum;
            }
        }
        
        return null;
    }
    
    // Clear filters function
    window.clearInvoiceFilters = function() {
        document.getElementById('filterYear').value = '';
        document.getElementById('filterMonth').value = '';
        document.getElementById('filterResident').value = 'all';
        document.getElementById('filterStatus').value = 'all';
        document.getElementById('filterSearch').value = '';
        
        // Reset to all invoices
        filteredInvoices = [...allInvoices];
        paginationState.currentPage = 1;
        renderTable(filteredInvoices);
        
        if (typeof showSuccess === 'function') {
            showSuccess('Фильтры очищены!');
        }
    };
    
    window.openDatePicker = function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            // Use native showPicker if available (modern browsers)
            if (input.showPicker && typeof input.showPicker === 'function') {
                input.showPicker().catch(err => {
                    input.focus();
                    input.click();
                });
            } else {
                input.focus();
                input.click();
            }
        }
    };

    // Auto-apply filters on input change and initialize date picker
    document.addEventListener('DOMContentLoaded', function() {
        // Setup filter inputs
        const filterInputs = ['filterYear', 'filterMonth', 'filterResident', 'filterStatus', 'filterSearch'];
        filterInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                if (inputId === 'filterSearch') {
                    let searchTimeout;
                    input.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(applyInvoiceFilters, 300);
                    });
                } else {
                    input.addEventListener('change', applyInvoiceFilters);
                }
            }
        });

        // Setup date picker click handler
        const dateInput = document.getElementById('invoiceDueDate');
        if (dateInput) {
            dateInput.addEventListener('click', function() {
                if (this.showPicker && typeof this.showPicker === 'function') {
                    this.showPicker().catch(() => {});
                }
            });
        }
    });
})();
</script>
