<link rel="stylesheet" href="/admin/content_css/invoice.css">
<div class="content-wrapper invoices-page" style="padding-top: 0 !important;">
    <!-- Actions Section -->
    <div class="invoices-actions">
        <div class="invoices-actions-row">
            <div class="invoices-actions-group">
                <label>–ë–ª–æ–∫ (–¥–ª—è ¬´–ø–æ –±–ª–æ–∫—É¬ª)</label>
                <select id="invoiceBlock">
                    <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ ‚Äî</option>
                    <option value="A">–ë–ª–æ–∫ A</option>
                    <option value="B">–ë–ª–æ–∫ B</option>
                    <option value="K">–ë–ª–æ–∫ K</option>
                    <option value="X">–ë–ª–æ–∫ X</option>
                    <option value="Z">–ë–ª–æ–∫ Z</option>
                </select>
            </div>
            
            <div class="invoices-actions-group">
                <label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã (due date)</label>
                <div class="date-input-wrapper">
                    <input type="date" id="invoiceDueDate" class="date-picker-input">
                    <button type="button" class="btn-calendar" onclick="openDatePicker('invoiceDueDate')" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">
                        <i class="bi bi-calendar"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="invoices-actions-row">
            <div class="invoices-actions-buttons">
                <button class="btn btn-outline-primary" onclick="issueInvoiceByBlock()">
                    –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç –ø–æ –±–ª–æ–∫—É
                </button>
                <button class="btn btn-primary" onclick="issueAllInvoices()">
                    –í—ã—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ —Å—á–µ—Ç–∞
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="invoices-filters">
        <div class="invoices-filters-row">
            <div class="invoices-filters-group">
                <label>–ì–æ–¥</label>
                <input type="number" id="filterYear" min="2000" max="2100" step="1" placeholder="–í—Å–µ –≥–æ–¥—ã">
            </div>
            
            <div class="invoices-filters-group">
                <label>–ú–µ—Å—è—Ü</label>
                <input type="number" id="filterMonth" min="1" max="12" step="1" placeholder="1-12">
            </div>
            
            <div class="invoices-filters-group">
                <label>–†–µ–∑–∏–¥–µ–Ω—Ç</label>
                <select id="filterResident">
                    <option value="all">–í—Å–µ</option>
                    <option value="1">–†–µ–∑–∏–¥–µ–Ω—Ç 1</option>
                    <option value="2">–†–µ–∑–∏–¥–µ–Ω—Ç 2</option>
                </select>
            </div>
            
            <div class="invoices-filters-group">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <select id="filterStatus">
                    <option value="all">–í—Å–µ</option>
                    <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
                    <option value="unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω</option>
                    <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</option>
                </select>
            </div>
            
            <div class="invoices-filters-group">
                <label>–ü–æ–∏—Å–∫</label>
                <input type="text" id="filterSearch" placeholder="‚Ññ –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ">
            </div>
        </div>
        
        <div class="invoices-filters-actions">
            <button class="btn btn-outline-secondary" onclick="applyInvoiceFilters()">
                <i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä
            </button>
            <button class="btn btn-outline-warning" onclick="clearInvoiceFilters()">
                <i class="bi bi-x-circle"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>

    <div style="position: relative; overflow: visible; padding-bottom: 100px;">
<!-- Invoices Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th>–†–µ–∑–∏–¥–µ–Ω—Ç</th>
                        <th>‚Ññ —Å—á–µ—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
                        <th>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="invoicesTable"></tbody>
            </table>
        </div>
        
        
    </div>
    <!-- Pagination -->
<div class="table-pagination">
    <div class="pagination-controls" id="invoicePaginationControls">
    <button class="btn-pagination" onclick="goToInvoicePage('prev')" disabled id="invoicePrevBtn">
        <i class="bi bi-chevron-double-left"></i>
    </button>
        <div id="invoicePageButtons" class="pagination-pages"></div>
    <button class="btn-pagination" onclick="goToInvoicePage('next')" disabled id="invoiceNextBtn">
        <i class="bi bi-chevron-double-right"></i>
    </button>
</div>
<div class="pagination-info">
    <span>–°—Ç—Ä. <span id="invoiceCurrentPage">1</span> –∏–∑ <span id="invoiceTotalPages">1</span> ¬∑ –≤—Å–µ–≥–æ <span id="invoiceTotalItems">0</span></span>
</div>
<div class="pagination-per-page">
    <span>–ù–∞</span>
    <span>—Å—Ç—Ä–∞–Ω–∏—Ü–µ:</span>
    <div class="custom-pag-select" id="customInvoiceItemsPerPage">
        <select id="invoiceItemsPerPage" onchange="changeInvoiceItemsPerPage()" style="display: none;">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
        <div class="select-btn">
            <span class="select-text">25</span>
            <span class="arrow">‚ñæ</span>
        </div>
        <div class="select-options" style="background: rgba(36, 40, 49, 0.95) !important">
            <div class="select-option" data-value="10">10</div>
            <div class="select-option selected" data-value="25">25</div>
            <div class="select-option" data-value="50">50</div>
            <div class="select-option" data-value="100">100</div>
        </div>
</div>
</div>
</div>
</div>
</div>

<script>
(function(){
    // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ü–†–ò–ú–ï–ù–ò–¢–¨ –°–ï–†–´–ô –§–û–ù –í DARK THEME
    function applyDarkThemeStyles() {
        if (document.documentElement.getAttribute('data-theme') === 'dark' || 
            document.body.getAttribute('data-theme') === 'dark') {
            const actionsSection = document.querySelector('.invoices-actions');
            const filtersSection = document.querySelector('.invoices-filters');
            
            if (actionsSection) {
                actionsSection.style.setProperty('background', '#242831', 'important');
                actionsSection.style.setProperty('background-color', '#242831', 'important');
                actionsSection.style.setProperty('border', '1px solid rgba(255, 255, 255, 0.08)', 'important');
                actionsSection.style.setProperty('color', '#e4e6eb', 'important');
            }
            
            if (filtersSection) {
                filtersSection.style.setProperty('background', '#242831', 'important');
                filtersSection.style.setProperty('background-color', '#242831', 'important');
                filtersSection.style.setProperty('border', '1px solid rgba(255, 255, 255, 0.08)', 'important');
                filtersSection.style.setProperty('color', '#e4e6eb', 'important');
            }

            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–µ—Ä—ã–π —Ñ–æ–Ω –∫ select –∏ option —ç–ª–µ–º–µ–Ω—Ç–∞–º
            const selectElements = document.querySelectorAll('.invoices-actions-group select, .invoices-filters-group select');
            selectElements.forEach(select => {
                select.style.setProperty('background', 'rgba(255, 255, 255, 0.05)', 'important');
                select.style.setProperty('background-color', 'rgba(255, 255, 255, 0.05)', 'important');
                select.style.setProperty('color', '#fefefe', 'important');
                
                // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ –∫ option —ç–ª–µ–º–µ–Ω—Ç–∞–º
                const options = select.querySelectorAll('option');
                options.forEach(option => {
                    option.style.setProperty('background', '#242831', 'important');
                    option.style.setProperty('background-color', '#242831', 'important');
                    option.style.setProperty('color', '#f6f7ff', 'important');
                });
            });

            // –ò–Ω—ä–µ–∫—Ü–∏—è CSS –¥–ª—è –±–µ–ª–æ–≥–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ date input
            const dateInputStyleId = 'date-input-placeholder-white';
            if (!document.getElementById(dateInputStyleId)) {
                const style = document.createElement('style');
                style.id = dateInputStyleId;
                style.textContent = `
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-text,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-month-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-day-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-year-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-text,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-month-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-day-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-year-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-text,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-month-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-day-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]::-webkit-datetime-edit-year-field {
                        color: #ffffff !important;
                    }
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-text,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-month-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-day-field,
                    [data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-year-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-text,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-month-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-day-field,
                    body[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-year-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-text,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-month-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-day-field,
                    html[data-theme="dark"] .date-input-wrapper input[type="date"]:invalid::-webkit-datetime-edit-year-field {
                        color: #ffffff !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ä–∞–∑—É
    applyDarkThemeStyles();
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyDarkThemeStyles);
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å—Ç–∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    setTimeout(applyDarkThemeStyles, 100);
    setTimeout(applyDarkThemeStyles, 500);
    setTimeout(applyDarkThemeStyles, 1000);

    // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å—Ç–∏–ª–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ select (–¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤)
    document.addEventListener('DOMContentLoaded', function() {
        const selectElements = document.querySelectorAll('.invoices-actions-group select, .invoices-filters-group select');
        selectElements.forEach(select => {
            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ (–æ—Ç–∫—Ä—ã—Ç–∏–µ dropdown)
            select.addEventListener('mousedown', function() {
                setTimeout(applyDarkThemeStyles, 10);
            });
            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
            select.addEventListener('focus', function() {
                setTimeout(applyDarkThemeStyles, 10);
            });
            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            select.addEventListener('change', function() {
                setTimeout(applyDarkThemeStyles, 10);
            });
        });
    });
    
    const statuses = {
        draft: {text: '–ß–µ—Ä–Ω–æ–≤–∏–∫', cls: 'secondary'},
        issued: {text: '–í—ã—Å—Ç–∞–≤–ª–µ–Ω', cls: 'info'},
        partial: {text: '–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω', cls: 'warning'},
        paid: {text: '–û–ø–ª–∞—á–µ–Ω', cls: 'success'},
        overpaid: {text: '–ü–µ—Ä–µ–ø–ª–∞—Ç–∞', cls: 'info'},
        canceled: {text: '–û—Ç–º–µ–Ω—ë–Ω', cls: 'danger'},
        // Legacy mappings
        unpaid: {text: '–ù–µ –æ–ø–ª–∞—á–µ–Ω', cls: 'warning'},
        overdue: {text: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω', cls: 'danger'},
    };
    
    // Store original data
    const API_BASE = 'http://localhost:8000';
    let allInvoices = [];
    let filteredInvoices = [];
    let blocks = [];
    let residents = [];
    
    // Pagination state - MUST be declared before loadInvoices
    let paginationState = {
        currentPage: 1,
        itemsPerPage: 25,
        totalItems: 0,
        totalPages: 1
    };
    
    // Load invoices from API
    window.loadInvoices = async function loadInvoices() {
        console.log('=== loadInvoices() called ===');

        // Safety: –≤—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—á–µ—Ç–æ–≤
        const invoicesPageRoot = document.querySelector('.content-wrapper.invoices-page');
        if (!invoicesPageRoot) {
            console.warn('loadInvoices(): not on invoices page, skipping DOM updates');
            return;
        }
        try {
            const year = document.getElementById('filterYear')?.value;
            const month = document.getElementById('filterMonth')?.value;
            const residentId = document.getElementById('filterResident')?.value;
            const status = document.getElementById('filterStatus')?.value;
            const search = document.getElementById('filterSearch')?.value;
            const page = paginationState.currentPage;
            const perPage = paginationState.itemsPerPage;
            
            console.log('Filters:', { year, month, residentId, status, search, page, perPage });
            
            let url = `${API_BASE}/api/invoices?page=${page}&per_page=${perPage}`;
            const params = new URLSearchParams();
            if (year && year.trim() !== '') params.append('year', year);
            if (month && month.trim() !== '') params.append('month', month);
            if (residentId && residentId !== 'all') params.append('resident_id', residentId);
            if (status && status !== 'all') params.append('status', status.toUpperCase());
            if (search && search.trim() !== '') params.append('q', search);
            if (params.toString()) url += '&' + params.toString();
            
            console.log('Loading invoices from:', url);
            
            let response = await fetch(url);
            console.log('Response status:', response.status, response.statusText);
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    url = url.replace('/api/invoices?', '/api/invoices/public?');
                    console.log('Trying public endpoint:', url);
                    response = await fetch(url);
                    console.log('Public response status:', response.status, response.statusText);
                }
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        const errorText = await response.text().catch(() => '');
                        if (errorText) {
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = errorJson.detail || errorText;
                            } catch {
                                errorMessage = errorText || errorMessage;
                            }
                        }
                    }
                    throw new Error(errorMessage);
                }
            }
            
            const data = await response.json();
            console.log('Invoices data received:', { invoices: data.invoices?.length || 0, blocks: data.blocks?.length || 0, residents: data.residents?.length || 0, pagination: data.pagination });
            
            allInvoices = (data.invoices || []).map(inv => ({
                id: inv.id,
                residentId: inv.resident_id,
                residentCode: inv.resident_code,
                residentInfo: inv.resident_info,
                blockName: inv.block_name,
                unitNumber: inv.unit_number,
                invoiceNumber: inv.number || `INV-${String(inv.id).padStart(4, '0')}`,
                number: inv.number,
                status: inv.status.toLowerCase(),
                dueDate: inv.due_date ? new Date(inv.due_date).toLocaleDateString('ru-RU') : '‚Äî',
                notes: inv.notes || '',
                period: `${inv.period_year}-${String(inv.period_month).padStart(2, '0')}`,
                periodYear: inv.period_year,
                periodMonth: inv.period_month,
                amount: inv.amount_total,
                amountNet: inv.amount_net,
                amountVat: inv.amount_vat,
                paid: inv.paid_amount || 0,
                remaining: inv.amount_total - (inv.paid_amount || 0),
                created_at: inv.created_at,
                lines: inv.lines || [],
            }));
            
            blocks = data.blocks || [];
            residents = data.residents || [];
            
            // Update pagination from API
            if (data.pagination) {
                paginationState.currentPage = data.pagination.page;
                paginationState.totalItems = data.pagination.total;
                paginationState.totalPages = data.pagination.last_page;
            }
            
            filteredInvoices = [...allInvoices];
            console.log('Calling renderTable with', filteredInvoices.length, 'invoices');
            if (filteredInvoices.length > 0) {
                console.log('First invoice sample:', filteredInvoices[0]);
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ DOM –≥–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
            if (document.getElementById('invoicesTable')) {
                renderTable(filteredInvoices);
            } else {
                console.log('Waiting for DOM to be ready...');
                setTimeout(() => {
                    renderTable(filteredInvoices);
                }, 150);
            }
            
            updateFilterDropdowns();
            console.log('‚úÖ loadInvoices completed successfully');
            
        } catch (error) {
            console.error('Error loading invoices:', error);
            if (typeof showError === 'function') {
                showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç–æ–≤: ${error.message}`);
            }
            allInvoices = [];
            filteredInvoices = [];
            renderTable([]);
        }
    };
    
    function updateFilterDropdowns() {
        // Update blocks dropdown
        const blockSelect = document.getElementById('invoiceBlock');
        if (blockSelect && blocks.length > 0) {
            const currentValue = blockSelect.value;
            blockSelect.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ ‚Äî</option>';
            blocks.forEach(block => {
                const option = document.createElement('option');
                option.value = block.id;
                option.textContent = block.name;
                if (block.id.toString() === currentValue) option.selected = true;
                blockSelect.appendChild(option);
            });
        }
        
        // Update residents dropdown
        const residentSelect = document.getElementById('filterResident');
        if (residentSelect && residents.length > 0) {
            const currentValue = residentSelect.value;
            residentSelect.innerHTML = '<option value="all">–í—Å–µ</option>';
            residents.forEach(resident => {
                const option = document.createElement('option');
                option.value = resident.id;
                option.textContent = `${resident.block_name} / ${resident.unit_number}`;
                if (resident.id.toString() === currentValue) option.selected = true;
                residentSelect.appendChild(option);
            });
        }
    }
    
    // Render table function
    function renderTable(invoices) {
        console.log('=== renderTable() called ===');
        console.log('Rendering invoices table:', { invoicesCount: invoices.length, tbody: !!document.getElementById('invoicesTable') });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ tbody —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        function findTbodyWithRetry(attempts = 0, maxAttempts = 10) {
            return new Promise((resolve) => {
                const tbody = document.getElementById('invoicesTable');
                if (tbody) {
                    resolve(tbody);
                    return;
                }
                
                if (attempts < maxAttempts) {
                    console.log(`‚è≥ invoicesTable tbody not found, retry ${attempts + 1}/${maxAttempts}...`);
                    setTimeout(() => {
                        findTbodyWithRetry(attempts + 1, maxAttempts).then(resolve);
                    }, 100);
                    return;
                }
                
                console.error('‚ùå invoicesTable tbody not found after all retries!');
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å tbody, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                const table = document.querySelector('.table.table-hover');
                if (table) {
                    console.log('‚ö†Ô∏è Creating tbody element manually...');
                    const newTbody = document.createElement('tbody');
                    newTbody.id = 'invoicesTable';
                    table.appendChild(newTbody);
                    resolve(newTbody);
                } else {
                    resolve(null);
                }
            });
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º async/await –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è
        (async () => {
            const tbody = await findTbodyWithRetry();
            if (!tbody) {
                console.error('‚ùå Could not find or create invoicesTable tbody!');
                return;
            }
            
            console.log('‚úÖ tbody found, rendering', invoices.length, 'invoices');
            
            // Data is already paginated from API, so just render it directly
            const pageInvoices = invoices;
            
            if (pageInvoices.length === 0) {
                console.log('‚ö†Ô∏è No invoices to render, showing empty message');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º</td></tr>';
            } else {
                console.log('üìù Rendering', pageInvoices.length, 'invoice rows');
                tbody.innerHTML = pageInvoices.map(i => {
                const invoiceNumber = i.invoiceNumber || i.number || `INV-${String(i.id).padStart(4, '0')}`;
                const resident = i.residentCode || i.residentInfo || '‚Äî';
                const period = i.period || '‚Äî';
                const amount = typeof i.amount === 'number' ? i.amount.toFixed(2) : (i.amount || '0.00');
                const dueDate = i.dueDate || '‚Äî';
                const statusKey = i.status ? i.status.toLowerCase() : 'draft';
                const statusConfig = statuses[statusKey] || { text: i.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', cls: 'secondary' };
                
                // –î–∞–Ω–Ω—ã–µ –æ–± –æ–ø–ª–∞—Ç–µ
                const paid = typeof i.paid === 'number' ? i.paid.toFixed(2) : '0.00';
                const remaining = typeof i.remaining === 'number' ? i.remaining.toFixed(2) : amount;
                const totalAmount = typeof i.amount === 'number' ? i.amount.toFixed(2) : amount;
                
                return `<tr>
                    <td>${period}</td>
                    <td><strong>${resident}</strong></td>
                    <td>${invoiceNumber}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span class="badge bg-${statusConfig.cls}">${statusConfig.text}</span>
                            <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); background: rgba(255, 255, 255, 0.05); padding: 4px 8px; border-radius: 4px; margin-top: 4px;">
                                –û–ø–ª–∞—á–µ–Ω–æ ${paid} / –û—Å—Ç–∞—Ç–æ–∫ ${remaining}
                            </div>
                        </div>
                    </td>
                    <td><strong style="color: #ff6b6b;">${totalAmount} ‚Çº</strong></td>
                    <td>${dueDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice(${i.id})">–û—Ç–∫—Ä—ã—Ç—å</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="printInvoice(${i.id})" title="–ü–µ—á–∞—Ç—å">
                            <i class="bi bi-printer"></i>
                        </button>
                    </td>
                </tr>`;
                }).join('');
            }
            
            updatePaginationUI();
        })();
    }
    
    function buildInvoicePageList(current, total) {
        if (total <= 5) {
            return Array.from({ length: total }, (_, i) => i + 1);
        }
        const pages = new Set([1, total]);
        if (current <= 3) {
            [2, 3, 4, 5].forEach(p => pages.add(p));
        } else if (current >= total - 2) {
            [total - 1, total - 2, total - 3, total - 4].forEach(p => pages.add(p));
        } else {
            [current - 2, current - 1, current, current + 1, current + 2].forEach(p => pages.add(p));
        }
        const sorted = Array.from(pages).filter(p => p >= 1 && p <= total).sort((a, b) => a - b);
        const result = [];
        for (let i = 0; i < sorted.length; i++) {
            const page = sorted[i];
            result.push(page);
            const next = sorted[i + 1];
            if (next && next - page > 1) {
                result.push('dots');
            }
        }
        return result;
    }

    // Update pagination UI
    function updatePaginationUI() {
        const currentPageEl = document.getElementById('invoiceCurrentPage');
        const totalPagesEl = document.getElementById('invoiceTotalPages');
        const totalItemsEl = document.getElementById('invoiceTotalItems');
        const prevBtn = document.getElementById('invoicePrevBtn');
        const nextBtn = document.getElementById('invoiceNextBtn');
        const pagesContainer = document.getElementById('invoicePageButtons');
        
        if (currentPageEl) currentPageEl.textContent = paginationState.currentPage;
        if (totalPagesEl) totalPagesEl.textContent = paginationState.totalPages;
        if (totalItemsEl) totalItemsEl.textContent = paginationState.totalItems;
        if (prevBtn) prevBtn.disabled = paginationState.currentPage <= 1;
        if (nextBtn) nextBtn.disabled = paginationState.currentPage >= paginationState.totalPages;

        if (!pagesContainer) return;
        pagesContainer.innerHTML = '';

        const pages = buildInvoicePageList(paginationState.currentPage, paginationState.totalPages);
        pages.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'btn-pagination';

            if (p === 'dots') {
                btn.textContent = '...';
                btn.disabled = true;
                btn.classList.add('dots');
            } else {
                btn.textContent = p;
                if (p > paginationState.totalPages) {
                    btn.disabled = true;
                } else {
                    btn.onclick = () => {
                        if (p !== paginationState.currentPage) {
                            goToInvoicePage(p);
                        }
                    };
                }
                if (p === paginationState.currentPage) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-current', 'page');
                }
            }

            pagesContainer.appendChild(btn);
        });
    }
    
    // Pagination functions
    window.goToInvoicePage = function(page) {
        if (page === 'prev') {
            if (paginationState.currentPage > 1) {
                paginationState.currentPage--;
                loadInvoices();
            }
        } else if (page === 'next') {
            if (paginationState.currentPage < paginationState.totalPages) {
                paginationState.currentPage++;
                loadInvoices();
            }
        } else if (typeof page === 'number') {
            paginationState.currentPage = page;
            loadInvoices();
        }
    };
    
    window.changeInvoiceItemsPerPage = function() {
        const select = document.getElementById('invoiceItemsPerPage');
        if (select) {
            paginationState.itemsPerPage = parseInt(select.value);
            paginationState.currentPage = 1;
            loadInvoices();
            updateCustomInvoicePaginationDropdown();
        }
    };
    
    // View and download functions
    window.viewInvoice = function(id) {
        console.log('Opening invoice view for ID:', id);
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á–µ—Ä–µ–∑ fetch –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ SPA –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        const viewUrl = `/admin/content/invoice-view.html?id=${id}`;
        const contentContainer = document.getElementById('spa-content');
        
        if (!contentContainer) {
            console.error('SPA content container not found');
            window.location.href = viewUrl;
            return;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
        contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.8);"><i class="bi bi-hourglass-split" style="font-size: 2rem; margin-bottom: 10px;"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
        fetch(viewUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // –í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
                contentContainer.innerHTML = html;
                
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å invoice ID –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ü–ï–†–ï–î –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Å–∫—Ä–∏–ø—Ç–æ–≤
                window.__currentInvoiceId = id;
                
                // –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                const scripts = contentContainer.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                
                // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ breadcrumb
                updatePageHeaderForInvoiceView(id);
                
                // –û–±–Ω–æ–≤–∏—Ç—å URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ —á–µ—Ä–µ–∑ hash (–¥–ª—è SPA —Ä–æ—É—Ç–µ—Ä–∞)
                window.location.hash = `#/invoice-view?id=${id}`;
                
                // –í—ã–∑–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    const event = new CustomEvent('spa:contentLoaded', { detail: { invoiceId: id } });
                    document.dispatchEvent(event);
                }, 100);
                
                // –°–∫—Ä–æ–ª–ª–∏—Ç—å –Ω–∞–≤–µ—Ä—Ö
                contentContainer.scrollTop = 0;
                
                console.log('Invoice view loaded successfully');
            })
            .catch(error => {
                console.error('Error loading invoice view:', error);
                contentContainer.innerHTML = `<div style="padding: 40px; text-align: center; color: #ff6b6b;"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${error.message}</p><button onclick="window.location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button></div>`;
            });
    };
    
    window.printInvoice = function(id) {
        // –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–µ—á–∞—Ç–∏ —Å—á–µ—Ç–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
        const printUrl = `/admin/content/invoice-print.html?id=${id}`;
        window.open(printUrl, '_blank');
    };
    
    window.downloadInvoice = function(id) {
        // –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–µ—á–∞—Ç–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF
        const printUrl = `/admin/content/invoice-print.html?id=${id}`;
        window.open(printUrl, '_blank');
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ breadcrumb –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—á–µ—Ç–∞
    function updatePageHeaderForInvoiceView(invoiceId) {
        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const titleContainer = document.getElementById('page-title-container');
        if (titleContainer) {
            const h1 = titleContainer.querySelector('h1');
            if (h1) {
                h1.textContent = '–°—á–µ—Ç–∞';
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å breadcrumb
            const breadcrumbContainer = titleContainer.querySelector('.page-breadcrumb');
            if (breadcrumbContainer) {
                breadcrumbContainer.innerHTML = `
                    <span class="breadcrumb-item">
                        <svg width="14" height="14" fill="currentColor" style="margin-right: 0.25rem; vertical-align: middle;">
                            <use href="/images/icons.svg#icon-apartments"></use>
                        </svg>
                        –§–∏–Ω–∞–Ω—Å—ã
                    </span>
                    <span>‚Ä∫</span>
                    <span class="breadcrumb-item">–°—á–µ—Ç–∞</span>
                `;
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å title —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.title = '–°—á–µ—Ç–∞ - RoyalPark Admin';
    }
    
    // Update custom pagination dropdown display
    function updateCustomInvoicePaginationDropdown() {
        const select = document.getElementById('invoiceItemsPerPage');
        const customSelect = document.getElementById('customInvoiceItemsPerPage');
        if (!select || !customSelect) return;
        
        const value = select.value;
        const selectText = customSelect.querySelector('.select-text');
        const options = customSelect.querySelectorAll('.select-option');
        
        if (selectText) selectText.textContent = value;
        options.forEach(opt => {
            opt.classList.remove('selected');
            if (opt.getAttribute('data-value') === value) {
                opt.classList.add('selected');
            }
        });
    }
    
    // Initialize custom pagination dropdown
    let invoiceDropdownInitialized = false;
    function initCustomInvoicePaginationDropdown() {
        const customSelect = document.getElementById('customInvoiceItemsPerPage');
        if (!customSelect) return;
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        if (customSelect.dataset.initialized === 'true') {
            updateCustomInvoicePaginationDropdown();
            return;
        }
        customSelect.dataset.initialized = 'true';
        
        const selectBtn = customSelect.querySelector('.select-btn');
        const selectOptions = customSelect.querySelector('.select-options');
        const options = selectOptions ? selectOptions.querySelectorAll('.select-option') : [];
        
        if (selectBtn) {
            selectBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                customSelect.classList.toggle('open');
            });
        }
        
        options.forEach(opt => {
            opt.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const select = document.getElementById('invoiceItemsPerPage');
                if (select) {
                    select.value = value;
                    changeInvoiceItemsPerPage();
                }
                customSelect.classList.remove('open');
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ dropdown —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        if (!invoiceDropdownInitialized) {
            document.addEventListener('click', function(e) {
                if (!customSelect.contains(e.target)) {
                    customSelect.classList.remove('open');
                }
            });
            invoiceDropdownInitialized = true;
        }
        
        updateCustomInvoicePaginationDropdown();
    }
    
    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded - calling loadInvoices()');
        setTimeout(() => {
            loadInvoices();
            setTimeout(() => {
                initCustomInvoicePaginationDropdown();
            }, 500);
        }, 100);
    });
    
    // Also load on SPA content loaded
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (window._invoicesContentLoadedHandler) {
        document.removeEventListener('spa:contentLoaded', window._invoicesContentLoadedHandler);
    }
    
    window._invoicesContentLoadedHandler = function() {
        console.log('spa:contentLoaded - calling loadInvoices()');
        setTimeout(() => {
            loadInvoices();
            setTimeout(() => {
                initCustomInvoicePaginationDropdown();
            }, 200);
        }, 100);
    };
    
    document.addEventListener('spa:contentLoaded', window._invoicesContentLoadedHandler);
    
    // Also try to load immediately if page is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log('Page already loaded, calling loadInvoices()');
        setTimeout(() => {
            loadInvoices();
            setTimeout(() => {
                initCustomInvoicePaginationDropdown();
            }, 200);
        }, 200);
    }

    // Invoice Actions Functions
    window.issueInvoiceByBlock = async function() {
        const blockSelect = document.getElementById('invoiceBlock');
        const blockValue = blockSelect?.value;
        const dueDateInput = document.getElementById('invoiceDueDate');
        const dueDate = dueDateInput?.value;
        
        if (!blockValue || blockValue === '') {
            if (typeof showWarning === 'function') {
                showWarning('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫!');
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫!');
            }
            return;
        }
        
        // Check if blockValue is a number (ID) or a string (name)
        let blockId = null;
        if (!isNaN(blockValue) && blockValue !== '') {
            // It's a number (ID)
            blockId = parseInt(blockValue);
        } else {
            // It's a name (A, B, K, etc.) - need to find ID from blocks array
            const block = blocks.find(b => b.name === blockValue);
            if (!block) {
                if (typeof showError === 'function') {
                    showError(`–ë–ª–æ–∫ "${blockValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.`);
                } else {
                    alert(`–ë–ª–æ–∫ "${blockValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.`);
                }
                return;
            }
            blockId = block.id;
        }
        
        console.log('Issue invoice by block:', { blockValue, blockId, dueDate, blocks: blocks.length });
        
        try {
            // Convert date from DD.MM.YYYY to YYYY-MM-DD if needed
            let formattedDueDate = null;
            if (dueDate) {
                console.log('üìÖ Original dueDate:', dueDate, 'type:', typeof dueDate);
                // Check if date is in DD.MM.YYYY format
                if (dueDate.includes('.')) {
                    const parts = dueDate.split('.');
                    if (parts.length === 3) {
                        formattedDueDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        console.log('üìÖ Converted from DD.MM.YYYY to YYYY-MM-DD:', formattedDueDate);
                    } else {
                        formattedDueDate = dueDate;
                    }
                } else {
                    // If it's already in YYYY-MM-DD format (from date input), use as is
                    formattedDueDate = dueDate;
                    console.log('üìÖ Using date as is (YYYY-MM-DD):', formattedDueDate);
                }
            } else {
                console.log('‚ö†Ô∏è No due date provided');
            }
            
            const payload = {
                action: 'by_block',
                block_id: parseInt(blockId),
                due_date: formattedDueDate
            };
            
            console.log('üì§ Sending bulk issue request:', JSON.stringify(payload, null, 2));
            
            let url = `${API_BASE}/api/invoices/bulk-issue`;
            let response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    url = `${API_BASE}/api/invoices/bulk-issue/public`;
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                }
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        const errorText = await response.text().catch(() => '');
                        if (errorText) {
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = errorJson.detail || errorText;
                            } catch {
                                errorMessage = errorText || errorMessage;
                            }
                        }
                    }
                    throw new Error(errorMessage);
                }
            }
            
            const data = await response.json();
            console.log('üì• Bulk issue response:', JSON.stringify(data, null, 2));
            
            if (typeof showSuccess === 'function') {
                showSuccess(data.message || `–°—á–µ—Ç–∞ –ø–æ –±–ª–æ–∫—É —É—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã! –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ: ${data.count}`);
            } else {
                alert(data.message || `–°—á–µ—Ç–∞ –ø–æ –±–ª–æ–∫—É —É—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã! –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ: ${data.count}`);
            }
            
            // Reload invoices to show updated status
            loadInvoices();
            
        } catch (error) {
            console.error('Error issuing invoices by block:', error);
            if (typeof showError === 'function') {
                showError(`–û—à–∏–±–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤: ${error.message}`);
            } else {
                alert(`–û—à–∏–±–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤: ${error.message}`);
            }
        }
    };

    window.issueAllInvoices = async function() {
        const dueDateInput = document.getElementById('invoiceDueDate');
        const dueDate = dueDateInput?.value;
        
        console.log('Issue all invoices:', { dueDate });
        
        if (typeof showConfirm === 'function') {
            showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ —Å—á–µ—Ç–∞?', async (confirmed) => {
                if (!confirmed) return;
                await performIssueAll(dueDate);
            });
        } else {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ —Å—á–µ—Ç–∞?')) {
                await performIssueAll(dueDate);
            }
        }
    };
    
    async function performIssueAll(dueDate) {
        try {
            // Convert date from DD.MM.YYYY to YYYY-MM-DD if needed
            let formattedDueDate = null;
            if (dueDate) {
                console.log('üìÖ Original dueDate:', dueDate, 'type:', typeof dueDate);
                // Check if date is in DD.MM.YYYY format
                if (dueDate.includes('.')) {
                    const parts = dueDate.split('.');
                    if (parts.length === 3) {
                        formattedDueDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        console.log('üìÖ Converted from DD.MM.YYYY to YYYY-MM-DD:', formattedDueDate);
                    } else {
                        formattedDueDate = dueDate;
                    }
                } else {
                    // If it's already in YYYY-MM-DD format (from date input), use as is
                    formattedDueDate = dueDate;
                    console.log('üìÖ Using date as is (YYYY-MM-DD):', formattedDueDate);
                }
            } else {
                console.log('‚ö†Ô∏è No due date provided');
            }
            
            const payload = {
                action: 'all',
                block_id: null,
                due_date: formattedDueDate
            };
            
            let url = `${API_BASE}/api/invoices/bulk-issue`;
            let response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    url = `${API_BASE}/api/invoices/bulk-issue/public`;
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                }
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        const errorText = await response.text().catch(() => '');
                        if (errorText) {
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = errorJson.detail || errorText;
                            } catch {
                                errorMessage = errorText || errorMessage;
                            }
                        }
                    }
                    throw new Error(errorMessage);
                }
            }
            
            const data = await response.json();
            console.log('Bulk issue response:', data);
            
            if (typeof showSuccess === 'function') {
                showSuccess(data.message || `–í—Å–µ —Å—á–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã! –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ: ${data.count}`);
            } else {
                alert(data.message || `–í—Å–µ —Å—á–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã! –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ: ${data.count}`);
            }
            
            // Reload invoices to show updated status
            loadInvoices();
            
        } catch (error) {
            console.error('Error issuing all invoices:', error);
            if (typeof showError === 'function') {
                showError(`–û—à–∏–±–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤: ${error.message}`);
            } else {
                alert(`–û—à–∏–±–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤: ${error.message}`);
            }
        }
    }

    window.applyInvoiceFilters = function() {
        // Reset to first page on filter
        paginationState.currentPage = 1;
        // Reload invoices with filters from API
        loadInvoices();
    };
    
    // Helper functions to extract year and month
    function extractYear(dateString) {
        if (!dateString) return null;
        const yearMatch = dateString.match(/(\d{4})/);
        return yearMatch ? parseInt(yearMatch[1]) : null;
    }
    
    function extractMonth(dateString) {
        if (!dateString) return null;
        
        // Try to extract month from date string (format: YYYY-MM-DD)
        const dateMatch = dateString.match(/\d{4}-(\d{2})-\d{2}/);
        if (dateMatch) {
            return parseInt(dateMatch[1]);
        }
        
        // Try to extract from period (e.g., "–û–∫—Ç—è–±—Ä—å 2024")
        const monthNames = {
            '—è–Ω–≤–∞—Ä—å': 1, '—Ñ–µ–≤—Ä–∞–ª—å': 2, '–º–∞—Ä—Ç': 3, '–∞–ø—Ä–µ–ª—å': 4,
            '–º–∞–π': 5, '–∏—é–Ω—å': 6, '–∏—é–ª—å': 7, '–∞–≤–≥—É—Å—Ç': 8,
            '—Å–µ–Ω—Ç—è–±—Ä—å': 9, '–æ–∫—Ç—è–±—Ä—å': 10, '–Ω–æ—è–±—Ä—å': 11, '–¥–µ–∫–∞–±—Ä—å': 12
        };
        
        const lowerDate = dateString.toLowerCase();
        for (const [monthName, monthNum] of Object.entries(monthNames)) {
            if (lowerDate.includes(monthName)) {
                return monthNum;
            }
        }
        
        return null;
    }
    
    // Clear filters function
    window.clearInvoiceFilters = function() {
        document.getElementById('filterYear').value = '';
        document.getElementById('filterMonth').value = '';
        document.getElementById('filterResident').value = 'all';
        document.getElementById('filterStatus').value = 'all';
        document.getElementById('filterSearch').value = '';
        
        paginationState.currentPage = 1;
        loadInvoices();
        
        if (typeof showSuccess === 'function') {
            showSuccess('–§–∏–ª—å—Ç—Ä—ã –æ—á–∏—â–µ–Ω—ã!');
        }
    };
    
    window.openDatePicker = function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            // Use native showPicker if available (modern browsers)
            if (input.showPicker && typeof input.showPicker === 'function') {
                input.showPicker().catch(err => {
                    input.focus();
                    input.click();
                });
            } else {
                input.focus();
                input.click();
            }
        }
    };

    // Auto-apply filters on input change and initialize date picker
    document.addEventListener('DOMContentLoaded', function() {
        // Setup filter inputs
        const filterInputs = ['filterYear', 'filterMonth', 'filterResident', 'filterStatus', 'filterSearch'];
        filterInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                if (inputId === 'filterSearch') {
                    let searchTimeout;
                    input.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(applyInvoiceFilters, 300);
                    });
                } else {
                    input.addEventListener('change', applyInvoiceFilters);
                }
            }
        });

        // Setup date picker click handler
        const dateInput = document.getElementById('invoiceDueDate');
        if (dateInput) {
            dateInput.addEventListener('click', function() {
                if (this.showPicker && typeof this.showPicker === 'function') {
                    this.showPicker().catch(() => {});
                }
            });
        }
    });
})();
</script>
