<style>
    .appeals-status-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        font-weight: 600;
    }
    .appeals-empty {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-secondary);
    }
    .appeal-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1100;
    }
    .appeal-modal-overlay.show {
        display: flex;
    }
    .appeal-modal {
        background: #1f2330;
        color: var(--text-primary);
        border-radius: 1rem;
        width: min(520px, 90vw);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.08);
    }
    .appeal-modal-header, .appeal-modal-footer {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .appeal-modal-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .appeal-info-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
    }
    .appeal-info-row span:first-child {
        color: var(--text-secondary);
    }
    .appeals-action-btn {
        border-radius: 12px;
        font-weight: 600;
    }

    .appeals-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 1rem;
    }

    .appeals-filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .appeals-filter-select {
        min-width: 160px;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .appeals-filter-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        background: rgba(255, 255, 255, 0.08);
    }
</style>

<div class="dashboard-content">
    <div class="card">
        <div class="card-body">
            <div class="appeals-header">
                <h4 class="card-title mb-0">Обращения жителей</h4>
                <div class="appeals-filter-group">
                    <span>Статус:</span>
                    <select id="appealsStatusFilter" class="appeals-filter-select">
                        <option value="all">Все</option>
                        <option value="unread">Не прочитано</option>
                        <option value="read">Прочитано</option>
                        <option value="in_progress">В процессе</option>
                        <option value="escalated">На доп. проверке</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Создано</th>
                            <th>Блок</th>
                            <th>Дом</th>
                            <th>Житель</th>
                            <th>Телефон</th>
                            <th>E-mail</th>
                            <th>Статус</th>
                            <th class="text-end">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="appealsTableBody"></tbody>
                </table>
            </div>

            <div class="appeals-empty" id="appealsEmptyState" style="display: none;">
                <i class="bi bi-inbox" style="font-size:2rem;"></i>
                <p class="mt-3 mb-0">Обращений нет</p>
            </div>
        </div>
    </div>
</div>

<div class="appeal-modal-overlay" id="appealModal">
    <div class="appeal-modal">
        <div class="appeal-modal-header">
            <h5 class="mb-0">Обращение</h5>
            <button type="button" class="btn-close btn-close-white" id="appealModalClose"></button>
        </div>
        <div class="appeal-modal-body">
            <div class="appeal-info-row">
                <span>Дом</span>
                <strong id="modalApartment">—</strong>
            </div>
            <div class="appeal-info-row">
                <span>Житель</span>
                <strong id="modalResident">—</strong>
            </div>
            <div class="appeal-info-row">
                <span>Контакты</span>
                <strong id="modalContacts">— / —</strong>
            </div>
            <div>
                <small class="text-muted text-uppercase">Описание</small>
                <p class="mb-0 mt-1" id="modalDescription">—</p>
            </div>
        </div>
        <div class="appeal-modal-footer">
            <button class="btn btn-outline-light" id="appealModalDismiss">Закрыть</button>
        </div>
    </div>
</div>

<script>
// Appeals table variant: compact list of resident complaints
(function() {
    'use strict';

    const statusStyles = {
        read: { text: 'прочитано', className: 'bg-success' },
        unread: { text: 'не прочитано', className: 'bg-warning text-dark' },
        in_progress: { text: 'в процессе', className: 'bg-primary' },
        escalated: { text: 'на доп. проверке', className: 'bg-danger' }
    };

    const state = {
        appeals: []
    };

    function init() {
        const users = ((window.TestData && window.TestData.users) || []).reduce((acc, user) => {
            acc[user.id] = user;
            return acc;
        }, {});

        state.appeals = ((window.TestData && window.TestData.debts) || []).map((entry) => {
            const resident = users[entry.userId] || {};
            const submitted = entry.submittedAt || `${entry.dueDate || '2024-01-01'}T09:00:00`;
            const [block, apt] = splitApartment(entry.apartment);
            return {
                id: entry.id,
                createdAt: submitted,
                block: block || resident.building || '—',
                home: apt || resident.apartment || '—',
                resident: resident.name || entry.userName || '—',
                phone: resident.phone || '—',
                email: resident.email || '—',
                status: deriveStatus(entry),
                raw: entry,
                residentData: resident
            };
        });

        // Если из TestData ничего не пришло, покажем несколько статических обращений
        if (!state.appeals.length) {
            state.appeals = [
                {
                    id: 1,
                    createdAt: '2025-11-25T09:58:00',
                    block: 'A',
                    home: '50',
                    resident: 'resident',
                    phone: '—',
                    email: '—',
                    status: 'unread',
                    raw: { residentComment: '—' }
                },
                {
                    id: 2,
                    createdAt: '2025-11-25T09:57:00',
                    block: 'A',
                    home: '50',
                    resident: 'resident',
                    phone: '—',
                    email: '—',
                    status: 'unread',
                    raw: { residentComment: '—' }
                }
            ];
        }

        cacheDom();
        applyFilters();
        bindEvents();
    }

    let tableBody, emptyState, statusSelect, searchInput, modalOverlay;
    let modalResident, modalApartment, modalContacts, modalDescription;

    function cacheDom() {
        tableBody = document.getElementById('appealsTableBody');
        emptyState = document.getElementById('appealsEmptyState');
        statusSelect = document.getElementById('appealsStatusFilter') || null;
        searchInput = null;
        modalOverlay = document.getElementById('appealModal');
        modalResident = document.getElementById('modalResident');
        modalApartment = document.getElementById('modalApartment');
        modalContacts = document.getElementById('modalContacts');
        modalDescription = document.getElementById('modalDescription');
    }

    function bindEvents() {
        if (statusSelect) {
            statusSelect.addEventListener('change', applyFilters);
        }
        if (searchInput) {
            searchInput.addEventListener('input', debounce(applyFilters, 200));
        }

        if (tableBody) {
            tableBody.addEventListener('click', (event) => {
                const viewBtn = event.target.closest('[data-action="view"]');
                const deleteBtn = event.target.closest('[data-action="delete"]');
                if (viewBtn) {
                    const appeal = findAppeal(viewBtn.dataset.id);
                    if (appeal) openModal(appeal);
                } else if (deleteBtn) {
                    const appeal = findAppeal(deleteBtn.dataset.id);
                    if (appeal) deleteAppeal(appeal.id);
                }
            });
        }

        const closeBtn = document.getElementById('appealModalClose');
        const dismissBtn = document.getElementById('appealModalDismiss');
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (dismissBtn) dismissBtn.addEventListener('click', closeModal);
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) closeModal();
            });
        }
    }

    function applyFilters() {
        const items = getFilteredAppeals();
        renderTable(items);
    }

    function getFilteredAppeals() {
        let items = [...state.appeals];

        const statusValue = statusSelect?.value || 'all';
        if (statusValue !== 'all') {
            items = items.filter(a => a.status === statusValue);
        }

        return items;
    }

    function renderTable(items = state.appeals) {
        if (!tableBody) {
            console.error('Table body not found!');
            return;
        }
        if (!items.length) {
            tableBody.innerHTML = '';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';
        tableBody.innerHTML = items.map(appeal => {
            const status = statusStyles[appeal.status] || statusStyles.unread;
            return `
                <tr>
                    <td>${formatDateTime(appeal.createdAt)}</td>
                    <td>${appeal.block}</td>
                    <td>${appeal.home}</td>
                    <td>${appeal.resident}</td>
                    <td>${appeal.phone}</td>
                    <td>${appeal.email}</td>
                    <td>
                        <span class="appeals-status-badge ${status.className}">${status.text}</span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm" data-action="view" data-id="${appeal.id}">
                            Просмотр
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-2" data-action="delete" data-id="${appeal.id}">
                            Удалить
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function openModal(appeal) {
        if (modalApartment) modalApartment.textContent = `${appeal.block} / ${appeal.home}`;
        if (modalResident) modalResident.textContent = appeal.resident;
        if (modalContacts) modalContacts.textContent = `${appeal.phone} / ${appeal.email}`;
        if (modalDescription) modalDescription.textContent = appeal.raw?.residentComment || appeal.raw?.complaintReason || '—';

        appeal.status = 'read';
        if (appeal.raw) appeal.raw.viewed = true;
        if (modalOverlay) modalOverlay.classList.add('show');
        applyFilters();
    }

    function closeModal() {
        if (modalOverlay) modalOverlay.classList.remove('show');
    }

    function deleteAppeal(id) {
        const index = state.appeals.findIndex(a => String(a.id) === String(id));
        if (index >= 0) {
            state.appeals.splice(index, 1);
            applyFilters();
        }
    }

    function findAppeal(id) {
        return state.appeals.find(a => String(a.id) === String(id));
    }

    function deriveStatus(entry) {
        if (!entry.viewed) return 'unread';
        if (entry.stage === 'in_progress') return 'in_progress';
        if (entry.stage === 'escalated') return 'escalated';
        return 'read';
    }

    function splitApartment(apartment = '') {
        if (!apartment) return ['—', '—'];
        const parts = apartment.split('-');
        return [parts[0] || '—', parts[1] || '—'];
    }

    function formatDateTime(value) {
        if (!value) return '—';
        const date = new Date(value);
        return date.toLocaleString('ru-RU', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function debounce(fn, delay = 200) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(null, args), delay);
        };
    }

    // Запускаем инициализацию после загрузки DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
        // Если DOM уже загружен, запускаем сразу
        setTimeout(init, 100);
    }

})();
</script>

