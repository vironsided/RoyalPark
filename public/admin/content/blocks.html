<style>
    .content-wrapper {
        padding: 2rem 32px 32px 32px;
    }
    
    .stats-grid {
        margin-top: 1.5rem;
    }
    
    .block-map-container {
        background: white;
        border-radius: 15px;
        padding: 32px;
        margin: 24px 0px 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .block-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .block-actions h2 {
        flex: 1 1 200px;
        margin-bottom: 0;
    }
    
    .block-actions input {
        flex: 1 1 260px;
        min-width: 0;
    }
    
    .block-actions button {
        flex: 0 0 auto;
        white-space: nowrap;
    }
    
    .block-details {
        margin-top: 32px;
    }
    
    .block-details .card {
        background: white;
        border-radius: 15px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .complex-map {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 15px;
        padding: 40px;
        min-height: 500px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        align-items: flex-start;
        justify-items: center;
        width: 100%;
        box-sizing: border-box;
    }
    
    .block-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 30px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        width: min(100%, 260px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        box-sizing: border-box;
        margin: 0 auto;
        height: 100%;
    }
    
    .block-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
    }
    
    .block-card.active {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .block-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 10px;
        word-break: normal;
        overflow-wrap: normal;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .block-info {
        font-size: 0.9rem;
        opacity: 0.9;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .complex-plan-wrapper {
        margin-top: 32px;
        background: #0f172a;
        border-radius: 18px;
        padding: 24px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    .complex-plan-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .plan-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.85);
    }

    .plan-legend span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.04);
        white-space: nowrap;
    }

    .plan-legend i {
        width: 14px;
        height: 14px;
        border-radius: 4px;
        flex-shrink: 0;
    }

    .plan-image-frame {
        position: relative;
        width: 100%;
        padding-bottom: calc(3505 / 4959 * 100%);
        border-radius: 16px;
        overflow: hidden;
        background: radial-gradient(circle, rgba(255,255,255,0.08), transparent 60%);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .plan-image-frame img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
        filter: drop-shadow(0 20px 40px rgba(0,0,0,0.4));
        z-index: 1;
    }
    
    .plan-overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
    }
    
    .plan-area {
        fill: rgba(255, 255, 255, 0.01);
        stroke: transparent;
        transition: fill 0.2s ease, stroke 0.2s ease;
        cursor: pointer;
        pointer-events: auto;
    }
    
    .plan-area:hover {
        fill: rgba(255, 255, 255, 0.2);
        stroke: rgba(255, 255, 255, 0.9);
        stroke-width: 8px;
    }
    
    .plan-tooltip {
        position: fixed;
        z-index: 9999;
        min-width: 180px;
        padding: 12px 16px;
        border-radius: 14px;
        background: rgba(8, 11, 19, 0.95);
        color: #fff;
        font-size: 0.82rem;
        pointer-events: none;
        transform: translate(-50%, calc(-100% - 14px)) scale(0.95);
        opacity: 0;
        transition: opacity 0.12s ease, transform 0.12s ease;
        box-shadow: 0 18px 40px rgba(0,0,0,0.45);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(16px);
    }
    
    .plan-tooltip::after {
        content: '';
        position: absolute;
        bottom: -7px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 7px 7px 0 7px;
        border-style: solid;
        border-color: rgba(8, 11, 19, 0.95) transparent transparent transparent;
    }
    
    .plan-tooltip .tooltip-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }
    
    .plan-tooltip .tooltip-dot {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        background: linear-gradient(135deg, #69a1ff, #8b5cf6);
        box-shadow: 0 0 10px rgba(105, 161, 255, 0.6);
        flex-shrink: 0;
    }
    
    .plan-tooltip .tooltip-title {
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 0.02em;
    }
    
    .plan-tooltip .tooltip-desc {
        font-size: 0.78rem;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.35;
    }
    
    .plan-tooltip.hidden {
        opacity: 0;
        transform: translate(-50%, calc(-80% - 10px)) scale(0.9);
    }

    .plan-note {
        margin-top: 12px;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
        text-align: right;
    }
    
    @media (max-width: 640px) {
        .block-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .block-actions h2,
        .block-actions input,
        .block-actions button {
            width: 100%;
        }
        
        .complex-map {
            grid-template-columns: 1fr;
            padding: 16px;
            justify-items: stretch;
            gap: 16px;
        }

        .block-card {
            width: 100%;
            max-width: none;
            padding: 20px;
            border-radius: 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            text-align: left;
            margin: 0;
        }

        .block-name {
            font-size: clamp(1.25rem, 6vw, 1.5rem);
            margin-bottom: 0;
        }

        .block-info {
            align-items: flex-start;
            font-size: 1rem;
            flex: 1;
        }

        .complex-plan-wrapper {
            padding: 16px;
        }

        .plan-image-frame {
            padding-bottom: 90%;
        }
    }
</style>

<div class="content-wrapper">
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card solid-blue">
            <div class="stat-icon blue">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-buildings"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">5</div>
                <div class="stat-label">Всего блоков</div>
                <div class="stat-change positive">↑ 100%</div>
            </div>
        </div>

        <div class="stat-card solid-green">
            <div class="stat-icon green">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-apartments"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">420</div>
                <div class="stat-label">Всего квартир</div>
                <div class="stat-change positive">↑ 25 новых</div>
            </div>
        </div>

        <div class="stat-card solid-orange">
            <div class="stat-icon orange">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-users"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">98%</div>
                <div class="stat-label">Заселенность</div>
                <div class="stat-change positive">↑ 5% за месяц</div>
            </div>
        </div>

        <div class="stat-card solid-red">
            <div class="stat-icon purple">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-users"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">1,850</div>
                <div class="stat-label">Жителей</div>
                <div class="stat-change positive">↑ 12% за месяц</div>
            </div>
        </div>
    </div>

    <!-- Complex Map -->
    <div class="block-map-container">
        <div class="block-actions">
            <h2 class="mb-0 flex-grow-1">План комплекса Royal Park</h2>
            <input type="text" id="newBlockName" class="form-control" placeholder="Название нового блока">
            <button class="btn btn-success w-auto" onclick="createBlock()">
                <i class="bi bi-plus-lg"></i> Создать блок
            </button>
        </div>
        
        <div class="complex-map" id="complexMap">
            <div class="block-card" data-block="A" onclick="selectBlock('A')">
                <div class="block-name">Блок A</div>
                <div class="block-info">
                    <div>10 этажей</div>
                    <div>80 квартир</div>
                    <div>320 жителей</div>
                </div>
            </div>
            
            <div class="block-card" data-block="B" onclick="selectBlock('B')">
                <div class="block-name">Блок B</div>
                <div class="block-info">
                    <div>10 этажей</div>
                    <div>80 квартир</div>
                    <div>315 жителей</div>
                </div>
            </div>
            
            <div class="block-card" data-block="K" onclick="selectBlock('K')">
                <div class="block-name">Блок K</div>
                <div class="block-info">
                    <div>12 этажей</div>
                    <div>96 квартир</div>
                    <div>385 жителей</div>
                </div>
            </div>
            
            <div class="block-card" data-block="X" onclick="selectBlock('X')">
                <div class="block-name">Блок X</div>
                <div class="block-info">
                    <div>15 этажей</div>
                    <div>120 квартир</div>
                    <div>480 жителей</div>
                </div>
            </div>
            
            <div class="block-card" data-block="Z" onclick="selectBlock('Z')">
                <div class="block-name">Блок Z</div>
                <div class="block-info">
                    <div>8 этажей</div>
                    <div>64 квартиры</div>
                    <div>256 жителей</div>
                </div>
            </div>
        </div>
        
        <div class="complex-plan-wrapper">
            <div class="complex-plan-header">
                <div>
                    <h5 class="mb-1 text-white">План комплекса Royal Park</h5>
                    <small class="text-muted">Обновлено вручную на основе утвержденной схемы</small>
                </div>
                <div class="plan-legend">
                    <span><i style="background:#5ba344"></i> Блок A</span>
                    <span><i style="background:#f4c64d"></i> Блок B</span>
                    <span><i style="background:#b24473"></i> Блок C</span>
                    <span><i style="background:#9b6a33"></i> Блок D</span>
                    <span><i style="background:#2c9d7d"></i> Блок E</span>
                    <span><i style="background:#c43a82"></i> Блок F</span>
                    <span><i style="background:#3357a1"></i> Блок H</span>
                    <span><i style="background:#4a6fbf"></i> Блок K</span>
                    <span><i style="background:#b62837"></i> Блок X</span>
                    <span><i style="background:#c75b3f"></i> Корпус G3</span>
                </div>
            </div>
            <div class="plan-image-frame">
                <img src="/images/edited-photo.png" alt="План комплекса Royal Park">
                <svg class="plan-overlay" viewBox="0 0 4959 3505" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
                    <polygon class="plan-area" data-block-label="Зона 1" data-block-info="Жилой сектор 1. Подтверждение границ ожидается." points="1356.31 1615.32 1266.83 1634.16 1342.18 2185.16 1667.13 2161.62 1676.55 1982.66 1445.79 1940.27"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 2" data-block-info="Жилые дома повышенной комфортности." points="1373.83 1603.62 1838.3 1544.95 1887.19 1730.74 1388.5 1794.29"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 3" data-block-info="Внутренние таунхаусы. Данные уточняются." points="1417.83 1784.52 1896.97 1735.63 1911.63 1818.74 1838.3 1828.52 1857.85 1911.63 1452.06 1960.52"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 4" data-block-info="Блоки вдоль центрального бульвара." points="2274.64 2175.74 2576.04 2152.2 3178.85 2500.69 3079.95 2637.26"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 5" data-block-info="Планируется смешанная застройка." points="2656.1 2166.32 2948.09 2133.36 3597.98 2514.82 3353.09 2585.46"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 6" data-block-info="Высотная часть проекта." points="3588.59 2068.08 3818.38 2239.2 3896.6 2468.99 3666.81 2512.99 2972.56 2116.97"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 7" data-block-info="Северные виллы с видом на парк." points="2679.22 1593.84 2889.45 1593.84 3050.79 2019.19 2742.78 2048.53"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 8" data-block-info="Коттеджная линия вдоль коридора." points="2933.45 1584.06 3080.12 1569.4 3241.46 1984.97 3089.9 2014.3"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 9" data-block-info="Территория вокруг площади TISA." points="2718.33 1476.5 3275.69 1461.84 3471.25 1965.41 3378.36 1975.19 3339.25 1916.52 3265.91 1931.19 3124.13 1579.17 2811.22 1584.06 2733 1584.06"></polygon>
                    <polygon class="plan-area" data-block-label="Зона 10" data-block-info="Площадь у въезда. Коммерция/сервис." points="1755.18 2043.64 1794.29 1984.97 1882.3 2038.75 1833.41 2097.42"></polygon>
                </svg>
            </div>
            <div class="plan-note">Для подробностей используйте оригинал в разделе документации.</div>
        </div>
    </div>

    <!-- Block Details -->
    <div class="block-details mt-4" id="blockDetails" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 id="selectedBlockName">Детали блока</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Основная информация</h5>
                        <ul class="list-unstyled">
                            <li><strong>Этажей:</strong> <span id="blockFloors">-</span></li>
                            <li><strong>Квартир:</strong> <span id="blockApartments">-</span></li>
                            <li><strong>Жителей:</strong> <span id="blockResidents">-</span></li>
                            <li><strong>Заселенность:</strong> <span id="blockOccupancy">-</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Быстрые действия</h5>
                        <div class="d-flex flex-column gap-2">
                            <button class="btn btn-success btn-sm" onclick="viewApartments()">
                                <i class="bi bi-list"></i> Список квартир
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewResidents()">
                                <i class="bi bi-people"></i> Список жителей
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="viewMeters()">
                                <i class="bi bi-speedometer"></i> Показатели счетчиков
                            </button>
                            <hr>
                            <button class="btn btn-warning btn-sm" onclick="renameBlock()">
                                <i class="bi bi-pencil"></i> Переименовать
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBlock()">
                                <i class="bi bi-trash"></i> Удалить блок
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedBlock = null;
    
    function selectBlock(blockName) {
        selectedBlock = blockName;
        
        // Remove active class from all blocks
        document.querySelectorAll('.block-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Add active class to selected block
        document.querySelector(`[data-block="${blockName}"]`).classList.add('active');
        
        // Show block details
        document.getElementById('blockDetails').style.display = 'block';
        document.getElementById('selectedBlockName').textContent = `Блок ${blockName}`;
        
        // Sample data - replace with actual data
        const blockData = {
            'A': {floors: 10, apartments: 80, residents: 320, occupancy: '100%'},
            'B': {floors: 10, apartments: 80, residents: 315, occupancy: '98%'},
            'K': {floors: 12, apartments: 96, residents: 385, occupancy: '100%'},
            'X': {floors: 15, apartments: 120, residents: 480, occupancy: '100%'},
            'Z': {floors: 8, apartments: 64, residents: 256, occupancy: '100%'}
        };
        
        const data = blockData[blockName];
        if (data) {
            document.getElementById('blockFloors').textContent = data.floors;
            document.getElementById('blockApartments').textContent = data.apartments;
            document.getElementById('blockResidents').textContent = data.residents;
            document.getElementById('blockOccupancy').textContent = data.occupancy;
        }
        
        // Smooth scroll to details
        setTimeout(() => {
            document.getElementById('blockDetails').scrollIntoView({behavior: 'smooth'});
        }, 100);
    }
    
    function createBlock() {
        const blockName = document.getElementById('newBlockName').value.trim();
        
        if (!blockName) {
            showWarning('Пожалуйста, введите название блока');
            return;
        }
        
        // Create new block card
        const complexMap = document.getElementById('complexMap');
        const newBlockCard = document.createElement('div');
        newBlockCard.className = 'block-card';
        newBlockCard.setAttribute('data-block', blockName);
        newBlockCard.setAttribute('onclick', `selectBlock('${blockName}')`);
        newBlockCard.innerHTML = `
            <div class="block-name">Блок ${blockName}</div>
            <div class="block-info">
                <div>0 этажей</div>
                <div>0 квартир</div>
                <div>0 жителей</div>
            </div>
        `;
        
        complexMap.appendChild(newBlockCard);
        
        // Clear input
        document.getElementById('newBlockName').value = '';
        
        // Show success message
        showSuccess(`Блок ${blockName} успешно создан!`);
        
        // TODO: Send to backend API
        // fetch('/api/blocks', {
        //     method: 'POST',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify({name: blockName})
        // });
    }
    
    function renameBlock() {
        if (!selectedBlock) {
            showWarning('Пожалуйста, выберите блок');
            return;
        }
        
        showPrompt(`Введите новое название для блока ${selectedBlock}:`, selectedBlock, (newName) => {
            if (newName && newName.trim() !== '' && newName !== selectedBlock) {
                const blockCard = document.querySelector(`[data-block="${selectedBlock}"]`);
                if (blockCard) {
                    // Update block card
                    blockCard.setAttribute('data-block', newName);
                    blockCard.setAttribute('onclick', `selectBlock('${newName}')`);
                    blockCard.querySelector('.block-name').textContent = `Блок ${newName}`;
                    
                    // Update selected block name
                    document.getElementById('selectedBlockName').textContent = `Блок ${newName}`;
                    selectedBlock = newName;
                    
                    showSuccess(`Блок успешно переименован в ${newName}!`);
                    
                    // TODO: Send to backend API
                    // fetch(`/api/blocks/${selectedBlock}`, {
                    //     method: 'PUT',
                    //     headers: {'Content-Type': 'application/json'},
                    //     body: JSON.stringify({name: newName})
                    // });
                }
            }
        });
    }
    
    function deleteBlock() {
        if (!selectedBlock) {
            showWarning('Пожалуйста, выберите блок');
            return;
        }
        
        showConfirm(`Вы уверены, что хотите удалить блок ${selectedBlock}?`, () => {
            const blockCard = document.querySelector(`[data-block="${selectedBlock}"]`);
            if (blockCard) {
                // Remove block card with animation
                blockCard.style.transition = 'all 0.3s ease';
                blockCard.style.opacity = '0';
                blockCard.style.transform = 'scale(0.8)';
                
                setTimeout(() => {
                    blockCard.remove();
                    
                    // Hide block details
                    document.getElementById('blockDetails').style.display = 'none';
                    selectedBlock = null;
                    
                    showSuccess('Блок успешно удален!');
                }, 300);
                
                // TODO: Send to backend API
                // fetch(`/api/blocks/${selectedBlock}`, {
                //     method: 'DELETE'
                // });
            }
        });
    }
    
    function viewApartments() {
        if (!selectedBlock) {
            showWarning('Пожалуйста, выберите блок');
            return;
        }
        showInfo(`Переход к списку квартир блока ${selectedBlock}...`);
        // TODO: Navigate to apartments page with block filter
        // window.location.href = `/admin/apartments.html?block=${selectedBlock}`;
    }
    
    function viewResidents() {
        if (!selectedBlock) {
            showWarning('Пожалуйста, выберите блок');
            return;
        }
        showInfo(`Переход к списку жителей блока ${selectedBlock}...`);
        // TODO: Navigate to residents page with block filter
        // window.location.href = `/admin/residents.html?block=${selectedBlock}`;
    }
    
    function viewMeters() {
        if (!selectedBlock) {
            showWarning('Пожалуйста, выберите блок');
            return;
        }
        showInfo(`Переход к показателям счетчиков блока ${selectedBlock}...`);
        // TODO: Navigate to meters page with block filter
        // window.location.href = `/admin/meters.html?block=${selectedBlock}`;
    }
    
</script>

<script>
(function setupPlanHoverTooltip() {
    const TOOLTIP_ID = 'planTooltip';
    
    const createTooltip = () => {
        let tooltip = document.getElementById(TOOLTIP_ID);
        if (tooltip) return tooltip;
        
        tooltip = document.createElement('div');
        tooltip.id = TOOLTIP_ID;
        tooltip.className = 'plan-tooltip hidden';
        tooltip.innerHTML = `
            <div class="tooltip-title-row">
                <span class="tooltip-dot"></span>
                <span class="tooltip-title">Зона</span>
            </div>
            <div class="tooltip-desc">Информация уточняется.</div>
        `;
        document.body.appendChild(tooltip);
        return tooltip;
    };
    
    const bindTooltip = () => {
        const areas = document.querySelectorAll('.plan-area');
        if (!areas.length) return false;
        
        const tooltip = createTooltip();
        const titleEl = tooltip.querySelector('.tooltip-title');
        const descEl = tooltip.querySelector('.tooltip-desc');
        
        const move = (event) => {
            tooltip.style.left = `${event.clientX}px`;
            tooltip.style.top = `${event.clientY - 18}px`;
        };
        
        areas.forEach(area => {
            if (area.dataset.tooltipBound === 'true') return;
            area.dataset.tooltipBound = 'true';
            
            area.addEventListener('pointerenter', () => {
                const label = area.dataset.blockLabel || 'Зона';
                const info = area.dataset.blockInfo || 'Информация уточняется.';
                titleEl.textContent = label;
                descEl.textContent = info;
                tooltip.classList.remove('hidden');
            }, { passive: true });
            
            area.addEventListener('pointermove', move, { passive: true });
            
            area.addEventListener('pointerleave', () => {
                tooltip.classList.add('hidden');
            }, { passive: true });
        });
        
        return true;
    };
    
    const init = () => {
        if (!bindTooltip()) {
            setTimeout(init, 100);
        }
    };
    
    init();
    
    window.addEventListener('spa:contentLoaded', (event) => {
        if (!event.detail || event.detail.route === '/blocks') {
            init();
        }
    });
})();
</script>
