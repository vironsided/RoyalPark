<link rel="stylesheet" href="/admin/content_css/logs.css">
<div class="content-wrapper">
    <div style="position: relative;">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>История действий (логи показаний)</h3>
            </div>
            
            <!-- Filters Section -->
            <div class="card-body">
                <div class="logs-filters mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Действие</label>
                            <select id="filterAction" class="form-select">
                                <option value="">Все</option>
                                <option value="CREATE">Создание</option>
                                <option value="UPDATE">Обновление</option>
                                <option value="DELETE">Удаление</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Резидент</label>
                            <select id="filterResident" class="form-select">
                                <option value="">Все</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Пользователь</label>
                            <select id="filterUser" class="form-select">
                                <option value="">Все</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-12">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-funnel"></i> Применить фильтры
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Очистить
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="table-responsive">
                    <table class="table logs-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ДАТА/ВРЕМЯ</th>
                                <th>ДЕЙСТВИЕ</th>
                                <th>РЕЗИДЕНТ</th>
                                <th>СЧЁТЧИК</th>
                                <th>ПОЛЬЗОВАТЕЛЬ</th>
                                <th>ДЕТАЛИ</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">Загрузка...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                
            </div>
                    <!-- Pagination -->
        <div class="table-pagination">
            <div class="pagination-controls" id="logPaginationControls">
                    <button class="btn-pagination" onclick="goToLogPage('prev')" disabled id="logPrevBtn">
                        <i class="bi bi-chevron-double-left"></i>
                    </button>
                <div id="logPageButtons" class="pagination-pages"></div>
                    <button class="btn-pagination" onclick="goToLogPage('next')" disabled id="logNextBtn">
                        <i class="bi bi-chevron-double-right"></i>
                    </button>
                </div>
                <div class="pagination-info">
                    <span>Стр. <span id="logCurrentPage">1</span> из <span id="logTotalPages">1</span> · всего <span id="logTotalItems">0</span></span>
                </div>
                <div class="pagination-per-page">
                    <span>На</span>
                    <span>странице:</span>
                    <div class="custom-pag-select" id="customLogItemsPerPage">
                        <select id="logItemsPerPage" onchange="changeLogItemsPerPage()" style="display: none;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <div class="select-btn">
                            <span class="select-text">25</span>
                            <span class="arrow">▾</span>
                        </div>
                        <div class="select-options" style="background: rgba(36, 40, 49, 0.95) !important">
                            <div class="select-option" data-value="10">10</div>
                            <div class="select-option selected" data-value="25">25</div>
                            <div class="select-option" data-value="50">50</div>
                            <div class="select-option" data-value="100">100</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    const API_BASE = 'http://localhost:8000';
    
    // Pagination state
    let paginationState = {
        currentPage: 1,
        itemsPerPage: 25,
        totalItems: 0,
        totalPages: 1
    };
    
    let residents = [];
    let users = [];
    
    // Загрузка списков для фильтров
    async function loadFilterData() {
        try {
            // Загружаем резидентов
            const residentsResp = await fetch(`${API_BASE}/api/residents`, { credentials: 'include' });
            if (residentsResp.ok) {
                const residentsData = await residentsResp.json();
                residents = Array.isArray(residentsData) ? residentsData : (residentsData.residents || residentsData.items || []);
                
                const residentSelect = document.getElementById('filterResident');
                if (residentSelect) {
                    residentSelect.innerHTML = '<option value="">Все</option>';
                    residents.forEach(r => {
                        const option = document.createElement('option');
                        option.value = r.id;
                        option.textContent = `${r.block_name || ''}/${r.unit_number || ''}`;
                        residentSelect.appendChild(option);
                    });
                }
            }
            
            // Загружаем пользователей
            const usersResp = await fetch(`${API_BASE}/api/users`, { credentials: 'include' });
            if (usersResp.ok) {
                const usersData = await usersResp.json();
                let allUsers = Array.isArray(usersData) ? usersData : (usersData.users || usersData.items || []);
                
                // Фильтруем пользователей: только ROOT, ADMIN, OPERATOR
                const allowedRoles = ['ROOT', 'ADMIN', 'OPERATOR'];
                users = allUsers.filter(u => allowedRoles.includes(u.role?.toUpperCase()));
                
                const userSelect = document.getElementById('filterUser');
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">Все</option>';
                    users.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.id;
                        option.textContent = u.username || u.full_name || `User ${u.id}`;
                        userSelect.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading filter data:', error);
        }
    }
    
    // Загрузка логов
    async function loadLogs() {
        const tbody = document.getElementById('logsTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Загрузка...</td></tr>';
        }
        
        try {
            const action = document.getElementById('filterAction')?.value || '';
            const residentId = document.getElementById('filterResident')?.value || '';
            const userId = document.getElementById('filterUser')?.value || '';
            
            const params = new URLSearchParams();
            params.append('page', paginationState.currentPage);
            params.append('per_page', paginationState.itemsPerPage);
            if (action) params.append('action', action);
            if (residentId) params.append('resident_id', residentId);
            if (userId) params.append('user_id', userId);
            
            const url = `${API_BASE}/api/logs/reading-logs?${params.toString()}`;
            console.log('Loading logs from:', url);
            console.log('Pagination state:', paginationState);
            
            const response = await fetch(url, { credentials: 'include' }).catch(() => 
                fetch(url)
            );
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Logs loaded:', data);
            console.log('Data structure:', {
                hasLogs: !!data.logs,
                hasTotal: !!data.total,
                hasPage: !!data.page,
                hasLastPage: !!data.last_page,
                logsCount: data.logs?.length || 0
            });
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Handle paginated response
            if (data.logs && Array.isArray(data.logs)) {
                // Update pagination state
                paginationState.totalItems = data.total || 0;
                paginationState.totalPages = data.last_page || 1;
                paginationState.currentPage = data.page || 1;
                
                renderLogs(data.logs);
                updatePaginationUI();
            } else {
                // Fallback for non-paginated response
                console.warn('Unexpected data format:', data);
                paginationState.totalItems = 0;
                paginationState.totalPages = 1;
                paginationState.currentPage = 1;
                renderLogs([]);
                updatePaginationUI();
            }
        } catch (error) {
            console.error('Error loading logs:', error);
            const tbody = document.getElementById('logsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Ошибка загрузки логов: ' + error.message + '</td></tr>';
            }
            // Reset pagination state on error
            paginationState.totalItems = 0;
            paginationState.totalPages = 1;
            paginationState.currentPage = 1;
            updatePaginationUI();
        }
    }
    
    function renderLogs(logs) {
        const tbody = document.getElementById('logsTableBody');
        if (!tbody) return;
        
        if (!logs.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Нет логов</td></tr>';
            return;
        }
        
        tbody.innerHTML = logs.map(log => {
            // Определяем класс бейджа для действия
            let actionClass = 'badge-info';
            if (log.action === 'СОЗДАНИЕ') {
                actionClass = 'badge-success';
            } else if (log.action === 'УДАЛЕНИЕ') {
                actionClass = 'badge-danger';
            } else if (log.action === 'ОБНОВЛЕНИЕ') {
                actionClass = 'badge-warning';
            }
            
            return `
                <tr>
                    <td>${log.id}</td>
                    <td>${log.date_time}</td>
                    <td><span class="badge ${actionClass}">${log.action}</span></td>
                    <td>${log.resident}</td>
                    <td>${log.meter}</td>
                    <td>${log.user}</td>
                    <td>${log.details}</td>
                </tr>
            `;
        }).join('');
    }
    
    // Pagination Functions
    function buildLogPageList(current, total) {
        if (total <= 5) {
            return Array.from({ length: total }, (_, i) => i + 1);
        }
        const pages = new Set([1, total]);
        if (current <= 3) {
            [2, 3, 4, 5].forEach(p => pages.add(p));
        } else if (current >= total - 2) {
            [total - 1, total - 2, total - 3, total - 4].forEach(p => pages.add(p));
        } else {
            [current - 2, current - 1, current, current + 1, current + 2].forEach(p => pages.add(p));
        }
        const sorted = Array.from(pages).filter(p => p >= 1 && p <= total).sort((a, b) => a - b);
        const result = [];
        for (let i = 0; i < sorted.length; i++) {
            const page = sorted[i];
            result.push(page);
            const next = sorted[i + 1];
            if (next && next - page > 1) {
                result.push('dots');
            }
        }
        return result;
    }

    function updatePaginationUI() {
        const currentPageEl = document.getElementById('logCurrentPage');
        const totalPagesEl = document.getElementById('logTotalPages');
        const totalItemsEl = document.getElementById('logTotalItems');
        const prevBtn = document.getElementById('logPrevBtn');
        const nextBtn = document.getElementById('logNextBtn');
        const pagesContainer = document.getElementById('logPageButtons');
        
        if (currentPageEl) currentPageEl.textContent = paginationState.currentPage;
        if (totalPagesEl) totalPagesEl.textContent = paginationState.totalPages;
        if (totalItemsEl) totalItemsEl.textContent = paginationState.totalItems;
        if (prevBtn) prevBtn.disabled = paginationState.currentPage <= 1;
        if (nextBtn) nextBtn.disabled = paginationState.currentPage >= paginationState.totalPages;

        if (!pagesContainer) return;
        pagesContainer.innerHTML = '';

        const pages = buildLogPageList(paginationState.currentPage, paginationState.totalPages);
        pages.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'btn-pagination';

            if (p === 'dots') {
                btn.textContent = '...';
                btn.disabled = true;
                btn.classList.add('dots');
            } else {
                btn.textContent = p;
                if (p > paginationState.totalPages) {
                    btn.disabled = true;
                } else {
                    btn.onclick = () => {
                        if (p !== paginationState.currentPage) {
                            goToLogPage(p);
                        }
                    };
                }
                if (p === paginationState.currentPage) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-current', 'page');
                }
            }

            pagesContainer.appendChild(btn);
        });
    }
    
    window.goToLogPage = function(page) {
        console.log('goToLogPage called with:', page, 'Current state:', paginationState);
        if (page === 'prev') {
            if (paginationState.currentPage > 1) {
                paginationState.currentPage--;
                console.log('Going to previous page:', paginationState.currentPage);
                loadLogs();
            }
        } else if (page === 'next') {
            if (paginationState.currentPage < paginationState.totalPages) {
                paginationState.currentPage++;
                console.log('Going to next page:', paginationState.currentPage);
                loadLogs();
            }
        } else if (typeof page === 'number' && page >= 1 && page <= paginationState.totalPages) {
            paginationState.currentPage = page;
            console.log('Going to page:', paginationState.currentPage);
            loadLogs();
        } else {
            console.warn('Invalid page number:', page);
        }
    };
    
    window.changeLogItemsPerPage = function() {
        const select = document.getElementById('logItemsPerPage');
        if (select) {
            const newValue = parseInt(select.value);
            console.log('changeLogItemsPerPage called, new value:', newValue);
            paginationState.itemsPerPage = newValue;
            paginationState.currentPage = 1;
            loadLogs();
            updateCustomLogPaginationDropdown();
        } else {
            console.error('logItemsPerPage select not found');
        }
    };
    
    function updateCustomLogPaginationDropdown() {
        const select = document.getElementById('logItemsPerPage');
        const customSelect = document.getElementById('customLogItemsPerPage');
        if (!select || !customSelect) {
            console.warn('updateCustomLogPaginationDropdown: select or customSelect not found');
            return;
        }
        
        // Sync select value with paginationState
        const currentValue = paginationState.itemsPerPage.toString();
        if (select.value !== currentValue) {
            select.value = currentValue;
        }
        
        const selectText = customSelect.querySelector('.select-text');
        const options = customSelect.querySelectorAll('.select-option');
        
        if (selectText) {
            selectText.textContent = currentValue;
            console.log('Updated select text to:', currentValue);
        }
        
        options.forEach(opt => {
            opt.classList.remove('selected');
            if (opt.getAttribute('data-value') === currentValue) {
                opt.classList.add('selected');
            }
        });
    }
    
    function initCustomLogPaginationDropdown() {
        const customSelect = document.getElementById('customLogItemsPerPage');
        if (!customSelect || customSelect.dataset.initialized === 'true') return;
        customSelect.dataset.initialized = 'true';
        
        const nativeSelect = document.getElementById('logItemsPerPage');
        const selectBtn = customSelect.querySelector('.select-btn');
        const selectText = customSelect.querySelector('.select-text');
        const options = customSelect.querySelectorAll('.select-option');
        
        if (nativeSelect) {
            const selectedValue = nativeSelect.value;
            if (selectText) selectText.textContent = selectedValue;
            options.forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.value === selectedValue) {
                    opt.classList.add('selected');
                }
            });
        }
        
        if (selectBtn) {
            selectBtn.onclick = function(e) {
                e.stopPropagation();
                customSelect.classList.toggle('open');
            };
        }
        
        options.forEach(option => {
            option.onclick = function(e) {
                e.stopPropagation();
                const value = option.dataset.value;
                if (nativeSelect) {
                    nativeSelect.value = value;
                    nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
                if (selectText) selectText.textContent = value;
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                customSelect.classList.remove('open');
            };
        });
        
        document.addEventListener('click', function(e) {
            if (!customSelect.contains(e.target)) {
                customSelect.classList.remove('open');
            }
        });
    }
    
    window.applyFilters = function() {
        paginationState.currentPage = 1;
        loadLogs();
    };
    
    window.clearFilters = function() {
        document.getElementById('filterAction').value = '';
        document.getElementById('filterResident').value = '';
        document.getElementById('filterUser').value = '';
        paginationState.currentPage = 1;
        paginationState.itemsPerPage = 25;
        const select = document.getElementById('logItemsPerPage');
        if (select) {
            select.value = '25';
            updateCustomLogPaginationDropdown();
        }
        loadLogs();
    };
    
    // Инициализация
    async function initLogsPage() {
        initCustomLogPaginationDropdown();
        await loadFilterData();
        await loadLogs();
    }
    
    // Инициализация при загрузке страницы
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLogsPage);
    } else {
        initLogsPage();
    }
    
    // Также инициализируем при SPA загрузке
    if (window._logsContentLoadedHandler) {
        window.removeEventListener('spa:contentLoaded', window._logsContentLoadedHandler);
    }
    
    window._logsContentLoadedHandler = function(e) {
        const route = e.detail?.route || window.location.hash.split('?')[0].slice(1);
        if (route === '/logs' || route.startsWith('/logs')) {
            console.log('Loading logs from spa:contentLoaded');
            setTimeout(() => {
                initLogsPage();
            }, 100);
        }
    };
    
    window.addEventListener('spa:contentLoaded', window._logsContentLoadedHandler);
    
})();
</script>
