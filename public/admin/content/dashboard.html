<!-- Dashboard Content -->
<style>
    /* Убираем все тени */
    .dashboard-content .stat-card,
    .dashboard-content .chart-card,
    .dashboard-content .activity-card,
    .dashboard-content .card {
        box-shadow: none !important;
    }
    
    .dashboard-content .stat-icon,
    .dashboard-content .activity-icon {
        box-shadow: none !important;
    }
    
    .dashboard-content * {
        text-shadow: none !important;
    }
</style>
<div class="dashboard-content">
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card solid-blue">
            <div class="stat-icon blue">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-users"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">1,245</div>
                <div class="stat-label">Всего пользователей</div>
                <div class="stat-change positive">↑ 12% за месяц</div>
            </div>
        </div>

        <div class="stat-card solid-green">
            <div class="stat-icon green">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-buildings"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">48</div>
                <div class="stat-label">Блоков</div>
                <div class="stat-change positive">↑ 2 новых</div>
            </div>
        </div>

        <div class="stat-card solid-orange">
            <div class="stat-icon orange">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-payments"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">₼2.4M</div>
                <div class="stat-label">Платежи за месяц</div>
                <div class="stat-change positive">↑ 8% за месяц</div>
            </div>
        </div>

        <div class="stat-card solid-red">
            <div class="stat-icon purple">
                <svg width="40" height="40" fill="white">
                    <use href="/images/icons.svg#icon-maintenance"></use>
                </svg>
            </div>
            <div class="stat-details">
                <div class="stat-value">23</div>
                <div class="stat-label">Активные заявки</div>
                <div class="stat-change negative">↓ 15% за неделю</div>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Статистика платежей</h3>
                <div class="chart-controls">
                    <button class="chart-btn active">Неделя</button>
                    <button class="chart-btn">Месяц</button>
                    <button class="chart-btn">Год</button>
                </div>
            </div>
            <div class="chart-container" style="position: relative; height: 350px; padding: 20px;">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="activity-card">
            <h3 class="chart-title">Последняя активность</h3>
            
            <div class="activity-item">
                <div class="activity-icon success">
                    <svg width="20" height="20" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Новый платеж получен</div>
                    <div class="activity-time">Квартира #205 - 5 минут назад</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon warning">
                    <svg width="20" height="20" fill="currentColor">
                        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                    </svg>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Новая заявка на ремонт</div>
                    <div class="activity-time">Здание A - 15 минут назад</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon info">
                    <svg width="20" height="20" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Показания счетчика</div>
                    <div class="activity-time">Квартира #301 - 1 час назад</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon success">
                    <svg width="20" height="20" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Проверка завершена</div>
                    <div class="activity-time">Здание B - 2 часа назад</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon info">
                    <svg width="20" height="20" fill="currentColor">
                        <use href="/images/icons.svg#icon-users"></use>
                    </svg>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Новый пользователь</div>
                    <div class="activity-time">Квартира #410 - 3 часа назад</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon warning">
                    <svg width="20" height="20" fill="currentColor">
                        <use href="/images/icons.svg#icon-debts"></use>
                    </svg>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Напоминание о задолженности</div>
                    <div class="activity-time">5 квартир - 4 часа назад</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables Section -->
    <div class="card mt-4">
        <div class="card-header">
            <h3>Последние платежи</h3>
        </div>
        <div class="table-responsive mobile-table-wrapper">
            <table class="table mobile-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Пользователь</th>
                        <th>Квартира</th>
                        <th>Сумма</th>
                        <th>Дата</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>#1234</td>
                        <td>Иванов И.И.</td>
                        <td>A-205</td>
                        <td>₼5,200</td>
                        <td>15.10.2024</td>
                        <td><span class="badge badge-success">Оплачено</span></td>
                    </tr>
                    <tr>
                        <td>#1233</td>
                        <td>Петров П.П.</td>
                        <td>B-301</td>
                        <td>₼4,800</td>
                        <td>15.10.2024</td>
                        <td><span class="badge badge-success">Оплачено</span></td>
                    </tr>
                    <tr>
                        <td>#1232</td>
                        <td>Сидоров С.С.</td>
                        <td>A-102</td>
                        <td>₼6,100</td>
                        <td>14.10.2024</td>
                        <td><span class="badge badge-warning">В обработке</span></td>
                    </tr>
                    <tr>
                        <td>#1231</td>
                        <td>Козлов К.К.</td>
                        <td>C-405</td>
                        <td>₼5,500</td>
                        <td>14.10.2024</td>
                        <td><span class="badge badge-success">Оплачено</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    const API_BASE = 'http://localhost:8000';
    
    // Загрузка статистики
    async function loadDashboardStats() {
        try {
            const response = await fetch(`${API_BASE}/api/dashboard/stats`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const stats = await response.json();
            console.log('Dashboard stats loaded:', stats);
            
            // Обновляем карточки статистики
            updateStatsCards(stats);
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
            // Используем значения по умолчанию
            updateStatsCards({
                totalUsers: 1245,
                totalBuildings: 48,
                monthlyPayments: 2400000,
                activeRequests: 23
            });
        }
    }
    
    function updateStatsCards(stats) {
        // Обновляем карточки
        const userCard = document.querySelector('.stat-card.solid-blue .stat-value');
        if (userCard) {
            animateValue(userCard, parseInt(userCard.textContent.replace(/,/g, '')) || 0, stats.totalUsers || 0, 1000);
        }
        
        const buildingCard = document.querySelector('.stat-card.solid-green .stat-value');
        if (buildingCard) {
            animateValue(buildingCard, parseInt(buildingCard.textContent) || 0, stats.totalBuildings || 0, 1000);
        }
        
        const paymentCard = document.querySelector('.stat-card.solid-orange .stat-value');
        if (paymentCard) {
            const currentValue = parseFloat(paymentCard.textContent.replace(/[₼,M]/g, '')) * 1000000 || 0;
            const newValue = stats.monthlyPayments || 0;
            animateValue(paymentCard, currentValue, newValue, 1000, true);
        }
        
        const requestCard = document.querySelector('.stat-card.solid-red .stat-value');
        if (requestCard) {
            animateValue(requestCard, parseInt(requestCard.textContent) || 0, stats.activeRequests || 0, 1000);
        }
    }
    
    function animateValue(element, start, end, duration, isCurrency = false) {
        if (!element) return;
        
        const startTime = performance.now();
        const range = end - start;
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const current = Math.floor(start + range * easeOutQuart);
            
            if (isCurrency) {
                if (current >= 1000000) {
                    element.textContent = `₼${(current / 1000000).toFixed(1)}M`;
                } else if (current >= 1000) {
                    element.textContent = `₼${(current / 1000).toFixed(0)}K`;
                } else {
                    element.textContent = `₼${current.toLocaleString()}`;
                }
            } else {
                element.textContent = current.toLocaleString();
            }
            
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                if (isCurrency) {
                    if (end >= 1000000) {
                        element.textContent = `₼${(end / 1000000).toFixed(1)}M`;
                    } else if (end >= 1000) {
                        element.textContent = `₼${(end / 1000).toFixed(0)}K`;
                    } else {
                        element.textContent = `₼${end.toLocaleString()}`;
                    }
                } else {
                    element.textContent = end.toLocaleString();
                }
            }
        }
        
        requestAnimationFrame(update);
    }
    
    // Загрузка последних платежей
    async function loadRecentPayments() {
        try {
            const response = await fetch(`${API_BASE}/api/dashboard/recent-payments?limit=4`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Recent payments loaded:', data);
            
            renderRecentPayments(data.payments || []);
        } catch (error) {
            console.error('Error loading recent payments:', error);
            // Оставляем моковые данные или показываем пустую таблицу
        }
    }
    
    function renderRecentPayments(payments) {
        const tbody = document.querySelector('.table.mobile-table tbody');
        if (!tbody) return;
        
        if (!payments.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Нет платежей</td></tr>';
            return;
        }
        
        tbody.innerHTML = payments.map(payment => {
            const statusClass = payment.status === 'Оплачено' ? 'badge-success' : 'badge-warning';
            const statusText = payment.status === 'Оплачено' ? 'Оплачено' : 'В обработке';
            const date = new Date(payment.received_at).toLocaleDateString('ru-RU');
            
            return `
                <tr>
                    <td>#${payment.id}</td>
                    <td>${payment.resident_info.split(',')[0] || '—'}</td>
                    <td>${payment.resident_code || '—'}</td>
                    <td>₼${payment.amount_total.toFixed(2)}</td>
                    <td>${date}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                </tr>
            `;
        }).join('');
    }
    
    // Загрузка последней активности
    async function loadRecentActivity() {
        try {
            const response = await fetch(`${API_BASE}/api/dashboard/recent-activity?limit=6`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Recent activity loaded:', data);
            
            renderRecentActivity(data.activities || []);
        } catch (error) {
            console.error('Error loading recent activity:', error);
            // Оставляем моковые данные
        }
    }
    
    function renderRecentActivity(activities) {
        const activityCard = document.querySelector('.activity-card');
        if (!activityCard) return;
        
        // Удаляем существующие элементы активности (кроме заголовка)
        const existingItems = activityCard.querySelectorAll('.activity-item');
        existingItems.forEach(item => item.remove());
        
        if (!activities.length) {
            activityCard.innerHTML += '<div class="activity-item"><div class="activity-details"><div class="activity-title">Нет активности</div></div></div>';
            return;
        }
        
        const iconMap = {
            success: `<svg width="20" height="20" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`,
            warning: `<svg width="20" height="20" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`,
            info: `<svg width="20" height="20" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>`
        };
        
        activities.forEach(activity => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon ${activity.icon}">
                    ${iconMap[activity.icon] || iconMap.info}
                </div>
                <div class="activity-details">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-time">${activity.description} - ${activity.time}</div>
                </div>
            `;
            activityCard.appendChild(item);
        });
    }
    
    // Загрузка данных для графика
    async function loadChartData(period = 'week') {
        try {
            const response = await fetch(`${API_BASE}/api/dashboard/payment-chart?period=${period}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const chartData = await response.json();
            console.log('Chart data loaded:', chartData);
            
            return {
                labels: chartData.labels || [],
                data: chartData.data || []
            };
        } catch (error) {
            console.error('Error loading chart data:', error);
            // Возвращаем пустые данные
            return { labels: [], data: [] };
        }
    }
    
    // Initialize Payment Statistics Chart
    document.addEventListener('DOMContentLoaded', function() {
        initDashboard();
    });
    
    // Also initialize when SPA loads content
    // Удаляем старый обработчик, если он существует
    if (window._dashboardContentLoadedHandler) {
        window.removeEventListener('spa:contentLoaded', window._dashboardContentLoadedHandler);
    }
    
    window._dashboardContentLoadedHandler = function(e) {
        if (e.detail && e.detail.route === '/dashboard') {
            initDashboard();
        }
    };
    
    window.addEventListener('spa:contentLoaded', window._dashboardContentLoadedHandler);
    
    async function initDashboard() {
        console.log('Initializing dashboard...');
        
        // Загружаем все данные параллельно
        await Promise.all([
            loadDashboardStats(),
            loadRecentPayments(),
            loadRecentActivity()
        ]);
        
        // Инициализируем график
        initializeChart();
    }
    
    async function initializeChart() {
        const canvas = document.getElementById('paymentChart');
        if (!canvas) return;
        
        // Destroy existing chart if any
        if (window.paymentChartInstance) {
            window.paymentChartInstance.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        
        // Загружаем данные для всех периодов
        const [weekChartData, monthChartData, yearChartData] = await Promise.all([
            loadChartData('week'),
            loadChartData('month'),
            loadChartData('year')
        ]);
        
        // Формируем данные для графика
        const weekData = {
            labels: weekChartData.labels.length > 0 ? weekChartData.labels : ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
            datasets: [{
                label: 'Платежи (₼)',
                data: weekChartData.data.length > 0 ? weekChartData.data : [0, 0, 0, 0, 0, 0, 0],
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        };
        
        const monthData = {
            labels: monthChartData.labels.length > 0 ? monthChartData.labels : ['Нед 1', 'Нед 2', 'Нед 3', 'Нед 4'],
            datasets: [{
                label: 'Платежи (₼)',
                data: monthChartData.data.length > 0 ? monthChartData.data : [0, 0, 0, 0],
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        };
        
        const yearData = {
            labels: yearChartData.labels.length > 0 ? yearChartData.labels : ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
            datasets: [{
                label: 'Платежи (₼)',
                data: yearChartData.data.length > 0 ? yearChartData.data : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        };
        
        let currentData = weekData;
        
        // Create chart
        window.paymentChartInstance = new Chart(ctx, {
            type: 'line',
            data: currentData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return 'Сумма: ₼' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '₼' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '₼' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '₼' + value;
                            },
                            font: {
                                size: 12
                            },
                            color: '#6c757d'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12
                            },
                            color: '#6c757d'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        // Chart period buttons
        const chartButtons = document.querySelectorAll('.chart-btn');
        chartButtons.forEach((btn, index) => {
            btn.addEventListener('click', async function() {
                // Remove active class from all buttons
                chartButtons.forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Load and update chart data based on period
                let period = 'week';
                if (index === 0) {
                    period = 'week';
                    currentData = weekData;
                } else if (index === 1) {
                    period = 'month';
                    currentData = monthData;
                } else if (index === 2) {
                    period = 'year';
                    currentData = yearData;
                }
                
                // Загружаем свежие данные для выбранного периода
                const freshData = await loadChartData(period);
                if (freshData.labels.length > 0 && freshData.data.length > 0) {
                    currentData.labels = freshData.labels;
                    currentData.datasets[0].data = freshData.data;
                }
                
                // Update chart
                window.paymentChartInstance.data = currentData;
                window.paymentChartInstance.update('active');
            });
        });
    }
    
})();
</script>
