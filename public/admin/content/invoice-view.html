<link rel="stylesheet" href="/admin/content_css/invoice-view.css">
<div class="content-wrapper invoice-view-page">
    <div class="invoice-header">
        <h1 id="invoiceTitle">–°—á—ë—Ç: <span id="invoiceNumber">2025-11/000001</span></h1>
        <a href="#"
            onclick="if (window.goBack) { window.goBack('/invoices'); } else if (window.spaRouter && typeof window.spaRouter.goBack === 'function') { window.spaRouter.goBack('/invoices'); } else if (window.spaRouter && typeof window.spaRouter.navigate === 'function') { window.spaRouter.navigate('/invoices'); } else { window.location.hash = '#/invoices'; } return false;"
            class="btn-back">
            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
        </a>
    </div>

    <!-- Invoice Summary -->
    <div class="invoice-summary">
        <div class="invoice-summary-item">
            <label>–†–µ–∑–∏–¥–µ–Ω—Ç</label>
            <div class="value" id="invoiceResident">X/2</div>
        </div>
        <div class="invoice-summary-item">
            <label>–ñ–∏—Ç–µ–ª—å</label>
            <div class="value" id="invoiceResidentUser">‚Äî</div>
        </div>
        <div class="invoice-summary-item">
            <label>–ü–µ—Ä–∏–æ–¥</label>
            <div class="value" id="invoicePeriod">2025-11</div>
        </div>
        <div class="invoice-summary-item">
            <label>–°—Ç–∞—Ç—É—Å</label>
            <div class="value" id="invoiceStatus">DRAFT</div>
        </div>
        <div class="invoice-summary-item">
            <label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label>
            <div class="value" id="invoiceDueDate">‚Äî</div>
        </div>
        <div class="invoice-summary-item">
            <label>–ò—Ç–æ–≥–æ</label>
            <div class="value total" id="invoiceTotal">10.00 ‚Çº</div>
        </div>
        <div class="invoice-summary-item">
            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
            <div class="value" id="invoiceNote">‚Äî</div>
        </div>
    </div>

    <!-- Invoice Actions -->
    <div class="invoice-actions-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç–æ–º</h3>
            <button class="btn-outline-secondary" onclick="printInvoice()">
                <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
            </button>
        </div>

        <div class="invoice-form-group" id="invoiceNumberGroup">
            <label>‚Ññ —Å—á–µ—Ç–∞</label>
            <input type="text" id="editInvoiceNumber" value="2025-11/000001" readonly>
        </div>

        <div class="invoice-form-group" id="dueDateGroup">
            <label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label>
            <div class="date-input-wrapper">
                <input type="date" id="editDueDate">
                <button type="button" class="btn-calendar" onclick="openDatePicker('editDueDate')"
                    title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">
                    <i class="bi bi-calendar"></i>
                </button>
            </div>
        </div>

        <div class="invoice-form-group" id="noteGroup">
            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
            <textarea id="editNote" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ..."></textarea>
        </div>

        <div class="invoice-form-buttons">
            <button class="btn-primary" id="saveInvoiceBtn" onclick="saveInvoice()">–í—ã—Å—Ç–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn-primary" id="reissueInvoiceBtn" onclick="reissueInvoice()"
                style="display: none;">–í—ã—Å—Ç–∞–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            <button class="btn-danger" id="cancelInvoiceBtn" onclick="cancelInvoice()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- Payments Section -->
    <div class="payments-section">
        <h3>–û–ø–ª–∞—Ç—ã –ø–æ —Å—á—ë—Ç—É</h3>
        <div id="paymentsList">
            <table class="payments-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ú–µ—Ç–æ–¥</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–ü–ª–∞—Ç—ë–∂</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    </tr>
                </thead>
                <tbody id="paymentsTableBody">
                    <tr class="payments-empty-row">
                        <td colspan="5">–û–ø–ª–∞—Ç—ã –ø–æ —ç—Ç–æ–º—É —Å—á—ë—Ç—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="payments-summary" id="paymentsSummary">
            –û–ø–ª–∞—á–µ–Ω–æ: <strong>0.00</strong> ¬∑ –û—Å—Ç–∞—Ç–æ–∫: <strong>10.00</strong> –∏–∑ <strong>10.00</strong>
        </div>
    </div>

    <!-- Line Items Table -->
    <div
        style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px; padding: 20px; overflow-x: auto;">
        <table class="line-items-table">
            <thead>
                <tr>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th data-i18n="user_invoice_items_th_consumed">–ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ</th>
                    <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
                    <th>–ù–î–°</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody id="lineItemsTable">
                <tr>
                    <td>–ì–∞–∑ 20.0 –º¬≥</td>
                    <td>10.00</td>
                    <td>0.00</td>
                    <td class="total-value">10.00</td>
                </tr>
                <tr class="total-row">
                    <td colspan="3">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</td>
                    <td class="total-value">10.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Cancel Invoice Modal -->
<div class="modal-overlay" id="cancelInvoiceModal">
    <div class="cancel-modal">
        <div class="cancel-modal-header">
            <h3>–û—Ç–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç</h3>
            <button class="cancel-modal-close" onclick="closeCancelModal()" type="button">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="cancel-modal-body">
            <div class="cancel-modal-description">
                –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã. –°—á—ë—Ç –ø–µ—Ä–µ–π–¥—ë—Ç –≤ —Å—Ç–∞—Ç—É—Å <span class="status-badge">CANCELED</span>
            </div>
            <div class="cancel-modal-form-group">
                <label for="cancelReason">–ü—Ä–∏—á–∏–Ω–∞</label>
                <textarea id="cancelReason" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–∫–∞–∑–∞–Ω–∏–µ –ø–æ –≤–æ–¥–µ –∑–∞ –æ–∫—Ç—è–±—Ä—å"
                    rows="4"></textarea>
            </div>
        </div>
        <div class="cancel-modal-footer">
            <button class="btn-modal-cancel" onclick="closeCancelModal()" type="button">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-modal-confirm" onclick="confirmCancelInvoice()" type="button"
                id="confirmCancelBtn">–û—Ç–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç</button>
        </div>
    </div>
</div>

<script>
    (function () {
        const API_BASE = 'http://localhost:8000';

        // URL params - need to be accessible globally
        const urlParams = new URLSearchParams(window.location.search);

        // Get invoice ID from multiple sources (priority order)
        let invoiceId = null;

        // 1. Try global variable (set by SPA loader)
        if (window.__currentInvoiceId) {
            invoiceId = window.__currentInvoiceId;
            console.log('üìã Got invoice ID from window.__currentInvoiceId:', invoiceId);
        }

        // 2. Try URL query params
        if (!invoiceId) {
            const urlParams = new URLSearchParams(window.location.search);
            invoiceId = urlParams.get('id');
            if (invoiceId) {
                console.log('üìã Got invoice ID from window.location.search:', invoiceId);
            }
        }

        // 3. Try hash query params
        if (!invoiceId) {
            const hashParts = window.location.hash.split('?');
            if (hashParts.length > 1) {
                const hashParams = new URLSearchParams(hashParts[1]);
                invoiceId = hashParams.get('id');
                if (invoiceId) {
                    console.log('üìã Got invoice ID from window.location.hash query:', invoiceId);
                }
            }
        }

        // 4. Try hash path
        if (!invoiceId) {
            const hashParts = window.location.hash.split('?');
            const hashPath = hashParts[0];
            const lastPart = hashPath.split('/').pop();
            // Only use if it's a number
            if (lastPart && !isNaN(lastPart) && lastPart !== 'invoice-view') {
                invoiceId = lastPart;
                console.log('üìã Got invoice ID from hash path:', invoiceId);
            }
        }

        // Clean up invoiceId - remove any non-numeric characters
        if (invoiceId) {
            invoiceId = invoiceId.toString().trim();
            // If it contains "invoices", extract the number part
            if (invoiceId.includes('invoices')) {
                const match = invoiceId.match(/\d+/);
                invoiceId = match ? match[0] : null;
            }
            // Ensure it's a valid number
            if (invoiceId && (isNaN(invoiceId) || invoiceId === '')) {
                invoiceId = null;
            }
        }

        console.log('üìã Final extracted invoice ID:', invoiceId);

        // Load invoice data
        async function loadInvoice(id) {
            console.log('üîç loadInvoice called with id:', id, 'type:', typeof id);

            if (!id) {
                console.error('No invoice ID provided');
                if (typeof showError === 'function') {
                    showError('–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞');
                }
                return;
            }

            // Ensure id is a number string
            const cleanId = String(id).trim();
            if (isNaN(cleanId)) {
                console.error('Invalid invoice ID (not a number):', cleanId);
                if (typeof showError === 'function') {
                    showError(`–ù–µ–≤–µ—Ä–Ω—ã–π ID —Å—á–µ—Ç–∞: ${cleanId}`);
                }
                return;
            }

            try {
                let url = `${API_BASE}/api/invoices/${cleanId}`;
                console.log('üì§ Fetching invoice from:', url);
                let response = await fetch(url, { credentials: 'include' });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìã Invoice data received:', data);
                console.log('üí∞ Payments in data:', data.payments);

                // Transform API data to frontend format
                const invoice = {
                    id: data.id,
                    invoiceNumber: data.number || `${data.period_year}-${String(data.period_month).padStart(2, '0')}/000000`,
                    resident: data.resident_code,
                    residentUser: data.resident_user_full_name || null,
                    period: `${data.period_year}-${String(data.period_month).padStart(2, '0')}`,
                    status: data.status,
                    dueDate: data.due_date || null,
                    total: data.amount_total,
                    paid: data.paid_amount,
                    remaining: data.remaining_amount,
                    note: data.notes || null,
                    payments: data.payments || [],
                    lineItems: data.lines || []
                };

                console.log('üìã Transformed invoice:', invoice);
                console.log('üí∞ Payments in invoice:', invoice.payments);

                renderInvoice(invoice);
            } catch (error) {
                console.error('Error loading invoice:', error);
                if (typeof showError === 'function') {
                    showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç–∞: ${error.message}`);
                } else {
                    alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç–∞: ${error.message}`);
                }
            }
        }

        function renderInvoice(invoice) {
            document.getElementById('invoiceNumber').textContent = invoice.invoiceNumber;
            document.getElementById('invoiceResident').textContent = invoice.resident;
            const userEl = document.getElementById('invoiceResidentUser');
            if (userEl) userEl.textContent = invoice.residentUser || '‚Äî';
            document.getElementById('invoicePeriod').textContent = invoice.period;

            // Status badge
            const statusEl = document.getElementById('invoiceStatus');
            statusEl.textContent = invoice.status;
            statusEl.className = 'value';

            // Show/hide buttons based on status
            const saveBtn = document.getElementById('saveInvoiceBtn');
            const reissueBtn = document.getElementById('reissueInvoiceBtn');
            const cancelBtn = document.getElementById('cancelInvoiceBtn');

            if (invoice.status === 'CANCELED') {
                // For CANCELED: show only "–í—ã—Å—Ç–∞–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ" button, hide others and form fields
                if (saveBtn) saveBtn.style.display = 'none';
                if (reissueBtn) reissueBtn.style.display = 'inline-block';
                if (cancelBtn) cancelBtn.style.display = 'none';

                // Hide form fields for CANCELED status
                const invoiceNumberGroup = document.getElementById('invoiceNumberGroup');
                const dueDateGroup = document.getElementById('dueDateGroup');
                const noteGroup = document.getElementById('noteGroup');

                if (invoiceNumberGroup) invoiceNumberGroup.style.display = 'none';
                if (dueDateGroup) dueDateGroup.style.display = 'none';
                if (noteGroup) noteGroup.style.display = 'none';
            } else if (invoice.status === 'PAID') {
                // For PAID: hide all action buttons (read-only)
                if (saveBtn) saveBtn.style.display = 'none';
                if (reissueBtn) reissueBtn.style.display = 'none';
                if (cancelBtn) cancelBtn.style.display = 'none';
            } else {
                // For DRAFT, ISSUED, PARTIAL: show "–í—ã—Å—Ç–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å" and "–û—Ç–º–µ–Ω–∏—Ç—å"
                if (saveBtn) saveBtn.style.display = 'inline-block';
                if (reissueBtn) reissueBtn.style.display = 'none';
                if (cancelBtn) cancelBtn.style.display = 'inline-block';

                // Show form fields for other statuses
                const invoiceNumberGroup = document.getElementById('invoiceNumberGroup');
                const dueDateGroup = document.getElementById('dueDateGroup');
                const noteGroup = document.getElementById('noteGroup');

                if (invoiceNumberGroup) invoiceNumberGroup.style.display = '';
                if (dueDateGroup) dueDateGroup.style.display = '';
                if (noteGroup) noteGroup.style.display = '';
            }

            // Format due date for display
            let dueDateDisplay = '‚Äî';
            if (invoice.dueDate) {
                const date = new Date(invoice.dueDate);
                dueDateDisplay = date.toLocaleDateString('ru-RU');
            }
            document.getElementById('invoiceDueDate').textContent = dueDateDisplay;
            document.getElementById('invoiceTotal').textContent = invoice.total.toFixed(2) + ' ‚Çº';
            document.getElementById('invoiceNote').textContent = invoice.note || '‚Äî';

            document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber;
            if (invoice.dueDate) {
                // Convert YYYY-MM-DD to date input format
                document.getElementById('editDueDate').value = invoice.dueDate;
            } else {
                document.getElementById('editDueDate').value = '';
            }
            if (invoice.note) {
                document.getElementById('editNote').value = invoice.note;
            } else {
                document.getElementById('editNote').value = '';
            }

            function _extractConsumption(desc) {
                if (!desc) return { label: '‚Äî', consumed: '‚Äî', serviceKey: '', qty: '', unitKey: '' };
                const isSewerageLine = /^(?:meter_sewerage\b|–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è(?:\s*\(–∞–≤—Ç–æ\))?\b)/i.test(String(desc).trim());

                const keyMatch = String(desc).match(/^(meter_[a-z_]+)\s+([\d.]+)\s*(.*)$/i);
                if (keyMatch) {
                    const key = keyMatch[1];
                    const qty = keyMatch[2];
                    const unitRaw = (keyMatch[3] || '').trim();
                    let unitKey = '';
                    if (/–∫–≤—Ç/i.test(unitRaw)) unitKey = 'user_unit_kwh';
                    else if (/–º¬≥|m3|m¬≥/i.test(unitRaw)) unitKey = 'user_unit_m3';
                    const label = (window.i18n?.translate?.(key, localStorage.getItem('language') || 'ru') || key);
                    if (key === 'meter_sewerage') {
                        return { label, consumed: '‚Äî', serviceKey: key, qty: '', unitKey: '' };
                    }
                    return { label, consumed: `${qty} ${unitRaw}`.trim(), serviceKey: key, qty, unitKey };
                }

                const patterns = [
                    { regex: /^–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ\s+([\d.]+)\s*–∫–í—Ç¬∑—á$/i, serviceKey: 'meter_electricity', unitKey: 'user_unit_kwh' },
                    { regex: /^–í–æ–¥–∞\s+([\d.]+)\s*–º¬≥$/i, serviceKey: 'meter_cold_water', unitKey: 'user_unit_m3' },
                    { regex: /^–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è(?:\s*\(–∞–≤—Ç–æ\))?\s+([\d.]+)\s*–º¬≥$/i, serviceKey: 'meter_sewerage', unitKey: 'user_unit_m3' },
                    { regex: /^–ì–∞–∑\s+([\d.]+)\s*–º¬≥$/i, serviceKey: 'meter_gas', unitKey: 'user_unit_m3' },
                    { regex: /^–ì–æ—Ä—è—á–∞—è\s+–≤–æ–¥–∞\s+([\d.]+)\s*–º¬≥$/i, serviceKey: 'meter_hot_water', unitKey: 'user_unit_m3' },
                ];
                for (const p of patterns) {
                    const m = String(desc).match(p.regex);
                    if (m) {
                        const qty = m[1];
                        const lang = localStorage.getItem('language') || 'ru';
                        const label = window.i18n?.translate?.(p.serviceKey, lang) || String(desc).split(' ')[0];
                        if (p.serviceKey === 'meter_sewerage' || isSewerageLine) {
                            return { label, consumed: '‚Äî', serviceKey: p.serviceKey, qty: '', unitKey: '' };
                        }
                        const unit = window.i18n?.translate?.(p.unitKey, lang) || String(desc).split(qty)[1].trim();
                        return { label, consumed: `${qty} ${unit}`.trim(), serviceKey: p.serviceKey, qty, unitKey: p.unitKey };
                    }
                }

                if (isSewerageLine) {
                    const lang = localStorage.getItem('language') || 'ru';
                    const label = window.i18n?.translate?.('meter_sewerage', lang) || '–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è';
                    return { label, consumed: '‚Äî', serviceKey: 'meter_sewerage', qty: '', unitKey: '' };
                }

                return { label: String(desc), consumed: '‚Äî', serviceKey: '', qty: '', unitKey: '' };
            }

            // Render line items
            const tbody = document.getElementById('lineItemsTable');
            if (invoice.lineItems && invoice.lineItems.length > 0) {
                let html = invoice.lineItems.map(item => {
                    const parsed = _extractConsumption(item.description || '');
                    const totalAmount = Number(item.amount_total || 0);
                    const paidAmount = Math.max(0, Number(item.paid_amount || 0));
                    const paymentStatus = item.payment_status || '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞';
                    const ratio = totalAmount > 0 ? Math.min(100, Math.max(0, (paidAmount / totalAmount) * 100)) : 0;
                    let statusClass = '';
                    let statusText = paymentStatus;
                    if (paymentStatus === '–û–ø–ª–∞—á–µ–Ω–∞') {
                        statusClass = 'payment-status-paid';
                    } else if (paymentStatus === '–ß–∞—Å—Ç–∏—á–Ω–æ') {
                        statusClass = 'payment-status-partial';
                    } else {
                        statusClass = 'payment-status-unpaid';
                    }
                    return `
                <tr>
                    <td data-original-description="${item.description || ''}" data-service-key="${parsed.serviceKey || ''}">${parsed.label}</td>
                    <td data-consumed-qty="${parsed.qty || ''}" data-consumed-unit-key="${parsed.unitKey || ''}">${parsed.consumed}</td>
                    <td>${(item.amount_net || 0).toFixed(2)}</td>
                    <td>${(item.amount_vat || 0).toFixed(2)}</td>
                    <td class="total-value">${totalAmount.toFixed(2)}</td>
                    <td>
                        <div class="payment-status-card ${statusClass}">
                            <div class="payment-status-head">${statusText}</div>
                            <div class="payment-status-meta">–û–ø–ª–∞—á–µ–Ω–æ ${paidAmount.toFixed(2)} –∏–∑ ${totalAmount.toFixed(2)}</div>
                            <div class="payment-status-track">
                                <span style="width:${ratio.toFixed(2)}%"></span>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
                }).join('');

                const total = invoice.lineItems.reduce((sum, item) => sum + (item.amount_total || 0), 0);
                html += `
                <tr class="total-row">
                    <td colspan="4">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</td>
                    <td class="total-value">${total.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;

                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = '<tr><td colspan="6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            }

            // Render payments table
            const paymentsTbody = document.getElementById('paymentsTableBody');
            if (paymentsTbody) {
                console.log('üí∞ Rendering payments:', invoice.payments);
                if (invoice.payments && invoice.payments.length > 0) {
                    paymentsTbody.innerHTML = invoice.payments.map(p => {
                        // Handle date - can be string or Date object
                        let dateStr = '‚Äî';
                        if (p.date) {
                            try {
                                if (typeof p.date === 'string') {
                                    dateStr = new Date(p.date).toLocaleDateString('ru-RU');
                                } else {
                                    dateStr = new Date(p.date).toLocaleDateString('ru-RU');
                                }
                            } catch (e) {
                                console.error('Error parsing date:', p.date, e);
                                dateStr = p.date;
                            }
                        }
                        return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${p.method || '‚Äî'}</td>
                        <td class="payments-amount-cell">${(p.amount || 0).toFixed(2)}</td>
                        <td>
                            <a 
                                href="#/payment-view?id=${p.payment_id}" 
                                class="payment-link"
                                onclick="if (window.viewPayment) { viewPayment(${p.payment_id}); } else { window.location.href = '/admin/#/payment-view?id=${p.payment_id}'; } return false;"
                            >
                                #${p.payment_id}${p.reference ? ' / ' + p.reference : ''}
                            </a>
                        </td>
                        <td>${p.comment || '‚Äî'}</td>
                    </tr>
                `;
                    }).join('');
                } else {
                    console.log('üí∞ No payments found');
                    paymentsTbody.innerHTML = '<tr class="payments-empty-row"><td colspan="5">–û–ø–ª–∞—Ç—ã –ø–æ —ç—Ç–æ–º—É —Å—á—ë—Ç—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</td></tr>';
                }
            }

            // Update payments summary
            document.getElementById('paymentsSummary').innerHTML = `
            –û–ø–ª–∞—á–µ–Ω–æ: <strong>${invoice.paid.toFixed(2)}</strong> ¬∑ –û—Å—Ç–∞—Ç–æ–∫: <strong>${invoice.remaining.toFixed(2)}</strong> –∏–∑ <strong>${invoice.total.toFixed(2)}</strong>
        `;
        }

        window.saveInvoice = async function () {
            // Use the global invoiceId variable, or try to get from URL
            let currentInvoiceId = invoiceId || window.__currentInvoiceId;

            if (!currentInvoiceId) {
                // Try to get from URL params
                const urlParams = new URLSearchParams(window.location.search);
                currentInvoiceId = urlParams.get('id');

                if (!currentInvoiceId) {
                    const hashParts = window.location.hash.split('?');
                    if (hashParts.length > 1) {
                        const hashParams = new URLSearchParams(hashParts[1]);
                        currentInvoiceId = hashParams.get('id');
                    }
                }
            }

            if (!currentInvoiceId) {
                if (typeof showError === 'function') {
                    showError('–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞');
                }
                return;
            }

            // Clean up invoiceId
            const cleanId = String(currentInvoiceId).trim();
            if (isNaN(cleanId)) {
                if (typeof showError === 'function') {
                    showError(`–ù–µ–≤–µ—Ä–Ω—ã–π ID —Å—á–µ—Ç–∞: ${cleanId}`);
                }
                return;
            }

            const dueDateInput = document.getElementById('editDueDate');
            const dueDate = dueDateInput ? dueDateInput.value.trim() : '';
            const noteInput = document.getElementById('editNote');
            const note = noteInput ? noteInput.value.trim() : '';

            try {
                const payload = {
                    due_date: dueDate || null,
                    notes: note || null
                };

                console.log('üíæ Saving invoice:', { cleanId, payload });

                let url = `${API_BASE}/api/invoices/${cleanId}`;
                console.log('üì§ PUT to:', url);
                let response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                console.log('üì• Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    console.error('‚ùå Error response:', errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (typeof showSuccess === 'function') {
                    showSuccess(result.message || '–°—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!');
                }

                // Reload invoice data
                await loadInvoice(cleanId);
            } catch (error) {
                console.error('Error saving invoice:', error);
                if (typeof showError === 'function') {
                    showError(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
                } else {
                    alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
                }
            }
        };

        window.cancelInvoice = function () {
            // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–º–µ–Ω—ã —Å—á–µ—Ç–∞
            const modal = document.getElementById('cancelInvoiceModal');
            if (modal) {
                modal.classList.add('show');
                // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                const reasonTextarea = document.getElementById('cancelReason');
                if (reasonTextarea) {
                    reasonTextarea.value = '';
                    reasonTextarea.focus();
                }
            }
        };

        window.closeCancelModal = function () {
            const modal = document.getElementById('cancelInvoiceModal');
            if (modal) {
                modal.classList.remove('show');
            }
        };

        window.confirmCancelInvoice = async function () {
            const reasonTextarea = document.getElementById('cancelReason');
            const reason = reasonTextarea ? reasonTextarea.value.trim() : '';

            if (!reason) {
                if (reasonTextarea) {
                    reasonTextarea.focus();
                    reasonTextarea.style.borderColor = '#ff6b6b';
                    setTimeout(() => {
                        reasonTextarea.style.borderColor = '';
                    }, 2000);
                }
                if (typeof showWarning === 'function') {
                    showWarning('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã');
                }
                return;
            }

            const confirmBtn = document.getElementById('confirmCancelBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '–û—Ç–º–µ–Ω–∞...';
            }

            // Use the global invoiceId variable, or try to get from URL
            let currentInvoiceId = invoiceId || window.__currentInvoiceId;

            if (!currentInvoiceId) {
                // Try to get from URL params
                const urlParams = new URLSearchParams(window.location.search);
                currentInvoiceId = urlParams.get('id');

                if (!currentInvoiceId) {
                    const hashParts = window.location.hash.split('?');
                    if (hashParts.length > 1) {
                        const hashParams = new URLSearchParams(hashParts[1]);
                        currentInvoiceId = hashParams.get('id');
                    }
                }
            }

            if (!currentInvoiceId) {
                if (typeof showError === 'function') {
                    showError('–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞');
                }
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç';
                }
                return;
            }

            // Clean up invoiceId
            const cleanId = String(currentInvoiceId).trim();
            if (isNaN(cleanId)) {
                if (typeof showError === 'function') {
                    showError(`–ù–µ–≤–µ—Ä–Ω—ã–π ID —Å—á–µ—Ç–∞: ${cleanId}`);
                }
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç';
                }
                return;
            }

            try {
                const payload = { reason: reason };

                let url = `${API_BASE}/api/invoices/${cleanId}/cancel`;
                let response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const result = await response.json();

                if (typeof showSuccess === 'function') {
                    showSuccess(result.message || '–°—á—ë—Ç –æ—Ç–º–µ–Ω—ë–Ω!');
                }

                closeCancelModal();

                setTimeout(() => {
                    if (window.goBack) {
                        window.goBack('/invoices');
                    } else if (window.spaRouter && typeof window.spaRouter.goBack === 'function') {
                        window.spaRouter.goBack('/invoices');
                    } else {
                        window.location.hash = '#/invoices';
                    }
                }, 1000);
            } catch (error) {
                console.error('Error canceling invoice:', error);
                if (typeof showError === 'function') {
                    showError(`–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ${error.message}`);
                } else {
                    alert(`–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ${error.message}`);
                }

                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç';
                }
            }
        };

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('cancelInvoiceModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        closeCancelModal();
                    }
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ ESC
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && modal.classList.contains('show')) {
                        closeCancelModal();
                    }
                });
            }
        });

        window.printInvoice = function () {
            // Use the global invoiceId that was extracted at page load
            let printId = invoiceId || window.__currentInvoiceId;

            if (!printId) {
                // Try to get from URL params
                const urlParams = new URLSearchParams(window.location.search);
                printId = urlParams.get('id');

                if (!printId) {
                    const hashParts = window.location.hash.split('?');
                    if (hashParts.length > 1) {
                        const hashParams = new URLSearchParams(hashParts[1]);
                        printId = hashParams.get('id');
                    }
                }
            }

            if (!printId) {
                if (typeof showError === 'function') {
                    showError('–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏');
                }
                return;
            }

            // Clean up invoiceId
            const cleanId = String(printId).trim();
            if (isNaN(cleanId)) {
                if (typeof showError === 'function') {
                    showError(`–ù–µ–≤–µ—Ä–Ω—ã–π ID —Å—á–µ—Ç–∞: ${cleanId}`);
                }
                return;
            }

            // Open frontend print page which loads data from backend API
            const printUrl = `/admin/content/invoice-print.html?id=${cleanId}`;
            window.open(printUrl, '_blank');
        };

        window.reissueInvoice = async function () {
            // Use the global invoiceId variable, or try to get from URL
            let currentInvoiceId = invoiceId || window.__currentInvoiceId;

            if (!currentInvoiceId) {
                // Try to get from URL params
                const urlParams = new URLSearchParams(window.location.search);
                currentInvoiceId = urlParams.get('id');

                if (!currentInvoiceId) {
                    const hashParts = window.location.hash.split('?');
                    if (hashParts.length > 1) {
                        const hashParams = new URLSearchParams(hashParts[1]);
                        currentInvoiceId = hashParams.get('id');
                    }
                }
            }

            if (!currentInvoiceId) {
                if (typeof showError === 'function') {
                    showError('–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞');
                }
                return;
            }

            // Clean up invoiceId
            const cleanId = String(currentInvoiceId).trim();
            if (isNaN(cleanId)) {
                if (typeof showError === 'function') {
                    showError(`–ù–µ–≤–µ—Ä–Ω—ã–π ID —Å—á–µ—Ç–∞: ${cleanId}`);
                }
                return;
            }

            const dueDateInput = document.getElementById('editDueDate');
            const dueDate = dueDateInput ? dueDateInput.value.trim() : '';
            const noteInput = document.getElementById('editNote');
            const comment = noteInput ? noteInput.value.trim() : '';

            try {
                const payload = {
                    due_date: dueDate || null,
                    comment: comment || null
                };

                console.log('üîÑ Reissuing invoice:', { cleanId, payload });

                let url = `${API_BASE}/api/invoices/${cleanId}/reissue`;
                console.log('üì§ POST to:', url);
                let response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                console.log('üì• Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    console.error('‚ùå Error response:', errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (typeof showSuccess === 'function') {
                    showSuccess(result.message || '–°—á—ë—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –∑–∞–Ω–æ–≤–æ!');
                }

                // Reload invoice data
                await loadInvoice(cleanId);
            } catch (error) {
                console.error('Error reissuing invoice:', error);
                if (typeof showError === 'function') {
                    showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                }
            }
        };

        window.openDatePicker = function (inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                if (input.showPicker && typeof input.showPicker === 'function') {
                    try {
                        const pickerPromise = input.showPicker();
                        if (pickerPromise && typeof pickerPromise.catch === 'function') {
                            pickerPromise.catch(err => {
                                console.warn('showPicker failed, using fallback:', err);
                                input.focus();
                                input.click();
                            });
                        } else {
                            input.focus();
                            input.click();
                        }
                    } catch (err) {
                        console.warn('showPicker not available, using fallback:', err);
                        input.focus();
                        input.click();
                    }
                } else {
                    input.focus();
                    input.click();
                }
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function updatePageHeaderForInvoiceView() {
            const titleContainer = document.getElementById('page-title-container');
            if (titleContainer) {
                const h1 = titleContainer.querySelector('h1');
                if (h1) {
                    h1.textContent = '–°—á–µ—Ç–∞';
                    // –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ inline —Å—Ç–∏–ª–∏, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å CSS —Å—Ç–∏–ª–∏
                    h1.removeAttribute('style');
                }

                const breadcrumb = titleContainer.querySelector('.page-breadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = `
                        <span class="breadcrumb-item">
                            <svg width="14" height="14" fill="currentColor" style="margin-right: 0.25rem; vertical-align: middle;">
                                <use href="/images/icons.svg#icon-apartments"></use>
                            </svg>
                            –ì–ª–∞–≤–Ω–∞—è
                        </span>
                        <span>‚Ä∫</span>
                        <span class="breadcrumb-item">–§–∏–Ω–∞–Ω—Å—ã</span>
                        <span>‚Ä∫</span>
                        <span class="breadcrumb-item">–°—á–µ—Ç–∞</span>
                    `;
                }
            }
        }

        // Load invoice on page load
        function initInvoiceView() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            updatePageHeaderForInvoiceView();
            
            if (invoiceId) {
                loadInvoice(invoiceId);
            } else {
                console.warn('‚ö†Ô∏è No invoice ID found, waiting for spa:contentLoaded event...');
            }
        }

        // Listen for SPA content loaded event
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (window._invoiceViewContentLoadedHandler) {
            window.removeEventListener('spa:contentLoaded', window._invoiceViewContentLoadedHandler);
        }

        window._invoiceViewContentLoadedHandler = function (event) {
            // Check if we're actually on the invoice-view page
            const route = window.spaRouter?.currentRoute || window.location.hash.replace('#', '');
            if (!route.includes('invoice-view')) {
                return; // Not on invoice-view page, skip
            }
            
            if (event.detail && event.detail.invoiceId) {
                const eventId = event.detail.invoiceId;
                console.log('üìã Got invoice ID from spa:contentLoaded event:', eventId);
                if (!invoiceId) {
                    invoiceId = eventId;
                    loadInvoice(invoiceId);
                }
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–µ—Ä–µ–∑ SPA
            updatePageHeaderForInvoiceView();
        };

        window.addEventListener('spa:contentLoaded', window._invoiceViewContentLoadedHandler);

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initInvoiceView);
        } else {
            initInvoiceView();
        }
    })();
</script>