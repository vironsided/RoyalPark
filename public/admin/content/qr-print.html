<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Печать QR-кода</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin/content_css/qr-print.css">
</head>

<body>
    <div class="print-actions">
        <button class="btn-print" onclick="window.print()">
            <i class="bi bi-printer"></i>
            Печать
        </button>
    </div>

    <div class="print-container">
        <div class="print-header">
            <div class="header-info">
                <div class="badge" id="entityBadge">Пользователь</div>
                <h1 id="pageTitle">QR-код для пользователя</h1>
                <p class="subtitle">Отсканируйте QR-код, чтобы установить пароль и завершить регистрацию.</p>
            </div>
            <div class="qr-preview">
                <canvas id="qrCanvas"></canvas>
                <div id="qrFallback" class="qr-fallback">QR загружается...</div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <label>Логин</label>
                <div class="value" id="loginValue">—</div>
            </div>
            <div class="info-card">
                <label>Временный пароль</label>
                <div class="value" id="passwordValue">—</div>
            </div>
            <div class="info-card">
                <label>Дата генерации</label>
                <div class="value" id="generatedDate">—</div>
            </div>
            <div class="info-card" id="homesCard" style="display: none;">
                <label>Объекты</label>
                <div class="homes-list" id="homesList"></div>
            </div>
        </div>

        <div class="qr-url">
            <div class="qr-url-label">Ссылка для установки пароля</div>
            <div class="qr-url-value" id="qrUrlText">—</div>
        </div>

        <div class="instructions">
            <h3>Как пользоваться</h3>
            <ul>
                <li>Откройте камеру или сканер QR на телефоне и наведите на код.</li>
                <li>Перейдите по ссылке, которая откроется после сканирования.</li>
                <li>Введите временный пароль и задайте новый для завершения доступа.</li>
            </ul>
        </div>

        <div class="footer">
            <p>QR для быстрого доступа к порталу. При необходимости перегенерируйте код, чтобы обновить ссылку.</p>
        </div>
    </div>

    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            const typeParam = params.get('type') === 'tenant' ? 'tenant' : 'user';
            const isTenant = typeParam === 'tenant';
            const username = params.get('username') || params.get('login') || '—';
            const tempPassword = params.get('password') || params.get('tempPassword') || '—';
            const qrUrl = params.get('qrUrl');
            const homesRaw = params.get('homes');

            document.getElementById('entityBadge').textContent = isTenant ? 'Житель' : 'Пользователь';
            document.getElementById('pageTitle').textContent = isTenant ? 'QR-код для жителя' : 'QR-код для пользователя';
            document.getElementById('loginValue').textContent = username || '—';
            document.getElementById('passwordValue').textContent = tempPassword || '—';
            document.getElementById('generatedDate').textContent = new Date().toLocaleString('ru-RU');
            document.getElementById('qrUrlText').textContent = qrUrl || '—';

            // Парсим список домов (для жителей)
            if (homesRaw) {
                try {
                    const homes = JSON.parse(homesRaw);
                    if (Array.isArray(homes) && homes.length > 0) {
                        const homesCard = document.getElementById('homesCard');
                        const homesList = document.getElementById('homesList');
                        homesList.innerHTML = '';

                        homes.forEach((home, idx) => {
                            const chip = document.createElement('div');
                            chip.className = 'home-chip';
                            chip.textContent = `${home.block || '—'} / ${home.number || '—'}`;
                            homesList.appendChild(chip);
                        });

                        homesCard.style.display = 'block';
                    }
                } catch (e) {
                    console.warn('Не удалось распарсить список домов', e);
                }
            }

            // Отрисовываем QR-код
            function renderQRCode(url) {
                const canvas = document.getElementById('qrCanvas');
                const fallback = document.getElementById('qrFallback');

                if (!url || !canvas) {
                    if (fallback) {
                        fallback.textContent = 'QR-ссылка отсутствует';
                        fallback.style.display = 'block';
                    }
                    return;
                }

                const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=360x360&data=${encodeURIComponent(url)}`;
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = function () {
                    const ctx = canvas.getContext('2d');
                    canvas.width = 360;
                    canvas.height = 360;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, 360, 360);
                    if (fallback) {
                        fallback.style.display = 'none';
                    }
                };

                img.onerror = function () {
                    const ctx = canvas.getContext('2d');
                    canvas.width = 360;
                    canvas.height = 360;
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, 360, 360);
                    ctx.fillStyle = '#111827';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('QR URL:', 180, 170);
                    ctx.fillText(url, 180, 190, 320);

                    if (fallback) {
                        fallback.textContent = 'QR не загрузился — использована текстовая ссылка';
                        fallback.style.display = 'block';
                    }
                };

                img.src = apiUrl;
            }

            renderQRCode(qrUrl);
        })();
    </script>
</body>

</html>


