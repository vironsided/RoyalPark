<style>
    .appeals-status-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        font-weight: 600;
    }
    .appeals-empty {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-secondary);
    }
    .appeal-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1100;
    }
    .appeal-modal-overlay.show {
        display: flex;
    }
    .appeal-modal {
        background: #1f2330;
        color: var(--text-primary);
        border-radius: 1rem;
        width: min(520px, 90vw);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.08);
    }
    .appeal-modal-header, .appeal-modal-footer {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .appeal-modal-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .appeal-info-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
    }
    .appeal-info-row span:first-child {
        color: var(--text-secondary);
    }
    .appeals-action-btn {
        border-radius: 12px;
        font-weight: 600;
    }

    .appeals-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 1rem;
    }

    .appeals-filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .appeals-filter-select {
        min-width: 160px;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .appeals-filter-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        background: rgba(255, 255, 255, 0.08);
    }
</style>

<div class="dashboard-content">
    <div class="card">
        <div class="card-body">
            <div class="appeals-header">
                <h4 class="card-title mb-0">Обращения жителей</h4>
                <div class="appeals-filter-group">
                    <span>Статус:</span>
                    <select id="appealsStatusFilter" class="appeals-filter-select">
                        <option value="all">Все</option>
                        <option value="UNREAD">Не прочитано</option>
                        <option value="READ">Прочитано</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Создано</th>
                            <th>Блок</th>
                            <th>Дом</th>
                            <th>Житель</th>
                            <th>Телефон</th>
                            <th>E-mail</th>
                            <th>Статус</th>
                            <th class="text-end">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="appealsTableBody">
                        <tr>
                            <td colspan="8" class="text-center">Загрузка данных...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="appeals-empty" id="appealsEmptyState" style="display: none;">
                <i class="bi bi-inbox" style="font-size:2rem;"></i>
                <p class="mt-3 mb-0">Обращений нет</p>
            </div>
        </div>
    </div>
</div>

<div class="appeal-modal-overlay" id="appealModal">
    <div class="appeal-modal">
        <div class="appeal-modal-header">
            <h5 class="mb-0">Обращение</h5>
            <button type="button" class="btn-close btn-close-white" id="appealModalClose"></button>
        </div>
        <div class="appeal-modal-body">
            <div class="appeal-info-row">
                <span>Дом</span>
                <strong id="modalApartment">—</strong>
            </div>
            <div class="appeal-info-row">
                <span>Житель</span>
                <strong id="modalResident">—</strong>
            </div>
            <div class="appeal-info-row">
                <span>Контакты</span>
                <strong id="modalContacts">— / —</strong>
            </div>
            <div>
                <small class="text-muted text-uppercase">Описание</small>
                <p class="mb-0 mt-1" id="modalDescription">—</p>
            </div>
        </div>
        <div class="appeal-modal-footer">
            <button class="btn btn-outline-light" id="appealModalDismiss">Закрыть</button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    const API_BASE = 'http://localhost:8000';
    const state = {
        notifications: [],
        currentNotification: null
    };

    const statusStyles = {
        READ: { text: 'прочитано', className: 'bg-success' },
        UNREAD: { text: 'не прочитано', className: 'bg-warning text-dark' }
    };

    let tableBody, emptyState, statusSelect, modalOverlay;
    let modalResident, modalApartment, modalContacts, modalDescription;

    function cacheDom() {
        tableBody = document.getElementById('appealsTableBody');
        emptyState = document.getElementById('appealsEmptyState');
        statusSelect = document.getElementById('appealsStatusFilter');
        modalOverlay = document.getElementById('appealModal');
        modalResident = document.getElementById('modalResident');
        modalApartment = document.getElementById('modalApartment');
        modalContacts = document.getElementById('modalContacts');
        modalDescription = document.getElementById('modalDescription');
    }

    async function loadNotifications() {
        try {
            const statusValue = statusSelect?.value || 'all';
            const statusParam = statusValue !== 'all' ? `&status=${statusValue}` : '';
            const url = `${API_BASE}/api/notifications/public?page=1&per_page=200${statusParam}`;
            
            console.log('Loading notifications from:', url);
            const response = await fetch(url);
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    console.log('Not authorized, using public endpoint');
                    // Уже используем публичный endpoint
                    throw new Error('Unauthorized');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Notifications data received:', data);
            
            state.notifications = data.notifications || [];
            renderTable();
        } catch (error) {
            console.error('Error loading notifications:', error);
            if (typeof showError === 'function') {
                showError('Ошибка загрузки обращений: ' + error.message);
            }
            state.notifications = [];
            renderTable();
        }
    }

    function renderTable() {
        if (!tableBody) {
            console.error('Table body not found!');
            return;
        }

        const items = state.notifications;

        if (!items.length) {
            tableBody.innerHTML = '';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';
        
        tableBody.innerHTML = items.map(notif => {
            const status = statusStyles[notif.status] || statusStyles.UNREAD;
            const block = notif.block_name || '—';
            const home = notif.unit_number || '—';
            const resident = notif.user_full_name || '—';
            const phone = notif.user_phone || '—';
            const email = notif.user_email || '—';
            
            return `
                <tr>
                    <td>${formatDateTime(notif.created_at)}</td>
                    <td>${block}</td>
                    <td>${home}</td>
                    <td>${resident}</td>
                    <td>${phone}</td>
                    <td>${email}</td>
                    <td>
                        <span class="appeals-status-badge ${status.className}">${status.text}</span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm" data-action="view" data-id="${notif.id}">
                            Просмотр
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-2" data-action="delete" data-id="${notif.id}">
                            Удалить
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function viewNotification(id) {
        try {
            const url = `${API_BASE}/api/notifications/${id}/public`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const notif = await response.json();
            state.currentNotification = notif;
            
            if (modalApartment) {
                const block = notif.block_name || '—';
                const home = notif.unit_number || '—';
                modalApartment.textContent = `${block} / ${home}`;
            }
            if (modalResident) {
                modalResident.textContent = notif.user_full_name || '—';
            }
            if (modalContacts) {
                const phone = notif.user_phone || '—';
                const email = notif.user_email || '—';
                modalContacts.textContent = `${phone} / ${email}`;
            }
            if (modalDescription) {
                modalDescription.textContent = notif.message || '—';
            }
            
            if (modalOverlay) modalOverlay.classList.add('show');
            
            // Перезагружаем список, чтобы обновить статус
            await loadNotifications();
        } catch (error) {
            console.error('Error loading notification:', error);
            if (typeof showError === 'function') {
                showError('Ошибка загрузки обращения: ' + error.message);
            }
        }
    }

    async function deleteNotification(id) {
        if (!confirm('Вы уверены, что хотите удалить это обращение?')) {
            return;
        }

        try {
            const url = `${API_BASE}/api/notifications/${id}/public`;
            const response = await fetch(url, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            if (typeof showSuccess === 'function') {
                showSuccess('Обращение успешно удалено!');
            }
            
            await loadNotifications();
        } catch (error) {
            console.error('Error deleting notification:', error);
            if (typeof showError === 'function') {
                showError('Ошибка удаления обращения: ' + error.message);
            }
        }
    }

    function closeModal() {
        if (modalOverlay) modalOverlay.classList.remove('show');
    }

    function formatDateTime(value) {
        if (!value) return '—';
        const date = new Date(value);
        return date.toLocaleString('ru-RU', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function bindEvents() {
        if (statusSelect) {
            statusSelect.addEventListener('change', loadNotifications);
        }

        if (tableBody) {
            tableBody.addEventListener('click', (event) => {
                const viewBtn = event.target.closest('[data-action="view"]');
                const deleteBtn = event.target.closest('[data-action="delete"]');
                if (viewBtn) {
                    const id = parseInt(viewBtn.dataset.id);
                    viewNotification(id);
                } else if (deleteBtn) {
                    const id = parseInt(deleteBtn.dataset.id);
                    deleteNotification(id);
                }
            });
        }

        const closeBtn = document.getElementById('appealModalClose');
        const dismissBtn = document.getElementById('appealModalDismiss');
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (dismissBtn) dismissBtn.addEventListener('click', closeModal);
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) closeModal();
            });
        }
    }

    function initAppealsPage() {
        console.log('Initializing appeals page...');
        cacheDom();
        bindEvents();
        loadNotifications();
    }

    // Удаляем старый обработчик, если он существует
    if (window._appealsContentLoadedHandler) {
        window.removeEventListener('spa:contentLoaded', window._appealsContentLoadedHandler);
    }
    
    window._appealsContentLoadedHandler = function(e) {
        console.log('SPA content loaded event:', e.detail);
        const route = e.detail?.route || window.location.hash.split('?')[0].slice(1);
        console.log('Current route:', route);
        if (!route || route === '/appeals' || route.startsWith('/appeals')) {
            console.log('Loading appeals from spa:contentLoaded');
            setTimeout(() => {
                initAppealsPage();
            }, 100);
        }
    };
    
    window.addEventListener('spa:contentLoaded', window._appealsContentLoadedHandler);

    // Загрузка при первой загрузке (если не через SPA)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAppealsPage);
    } else {
        initAppealsPage();
    }

})();
</script>
