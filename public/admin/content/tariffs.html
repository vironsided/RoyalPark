<link rel="stylesheet" href="/admin/content_css/tariffs.css">
<div class="content-wrapper">
                <h2 class="mb-4">Тарифы по блокам</h2>
                
                <!-- Filters -->
                <div class="filters-container">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Назначение</label>
                            <select id="filterPurpose">
                                <option value="all">Все</option>
                                <option value="electricity">Электричество</option>
                                <option value="gas">Газ</option>
                                <option value="water">Вода</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Тип клиента</label>
                            <select id="filterClientType">
                                <option value="all">Все</option>
                                <option value="individual">Индивидуальное</option>
                                <option value="legal">Юр лицо</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Поиск</label>
                            <input type="text" id="filterSearch" placeholder="Название тарифа">
                        </div>
                    </div>
                    
                    <div class="filters-actions">
                        <button class="btn btn-outline-secondary" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i> Фильтр
                        </button>
                        <button class="btn btn-outline-warning" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Очистить
                        </button>
                        <button class="btn btn-primary" onclick="openCreateModal()">
                            <i class="bi bi-plus-lg"></i> Создать
                        </button>
                    </div>
                </div>
                
                <!-- Tariffs List -->
                <div id="tariffsContainer">
                    <div class="tariffs-table-wrapper">
                        <div class="tariffs-table-header">
                            <div>
                                <h3>Список тарифов</h3>
                            </div>
                        </div>
                        <div class="tariffs-table-shell">
                            <div class="table-responsive">
                                <table class="tariffs-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Название</th>
                                            <th>Назначение</th>
                                            <th>Тип клиента</th>
                                            <th>НДС, %</th>
                                            <th>Ступени</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tariffsTableBody">
                                        <!-- rows rendered via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- <div class="blocks-tariffs-wrapper">
                        <h3 class="mt-4">Тарифы по блокам</h3>
                        <div id="tariffsBlocksWrapper"></div>
                    </div> -->
                </div>
            </div>
        </main>
    </div>

    <!-- Create Tariff Modal -->
    <div class="modal-overlay" id="createTariffModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Создать тариф</h2>
                <button class="modal-close" onclick="closeCreateModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <form id="createTariffForm" onsubmit="createTariff(event)">
                <div class="form-group">
                    <label>Название тарифа</label>
                    <input type="text" id="tariffName" required>
                </div>
                
                <div class="form-group">
                    <label>Для чего</label>
                    <select id="tariffPurpose" required>
                        <option value="electricity">Электричество</option>
                        <option value="gas">Газ</option>
                        <option value="water">Вода</option>
                        <option value="internet">Интернет</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Тип тарифа</label>
                    <select id="tariffType" required>
                        <option value="individual">Индивидуальный</option>
                        <option value="legal">Юридическое лицо</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>НДС, %</label>
                    <input type="number" id="tariffVAT" value="0" min="0" max="100">
                </div>
                
                <div class="tariff-steps">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Ступени</h4>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addTariffStep()">
                            <i class="bi bi-plus-lg"></i> Добавить ступень
                        </button>
                    </div>
                    
                    <div id="tariffStepsContainer">
                        <div class="step-row">
                            <div class="step-input-group">
                                <label>ОТ (вкл.)</label>
                                <input type="number" value="0" min="0" step="0.01">
                            </div>
                            <div class="step-input-group">
                                <label>ДО (искл.)</label>
                                <input type="text" value="∞">
                            </div>
                            <div class="step-input-group">
                                <label>Ед. изм.</label>
                                <input type="text" value="кВт-ч" class="unit-chip" readonly>
                            </div>
                            <div class="step-input-group">
                                <label>Цена</label>
                                <input type="number" step="0.01" min="0" required>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeStep(this)" style="height: 38px; white-space: nowrap;">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Создать
                    </button>
                </div>
            </form>
        </div>
    </div>

<script>
        const tariffsData = [
            {
                id: 1,
                name: 'Qaz',
                block: 'Блок A',
                purpose: 'Газ',
                purposeKey: 'gas',
                clientType: 'individual',
                clientTypeLabel: 'Индивидуальный',
                vat: 0,
                steps: [
                    { from: 0, to: 20, price: 0.5, unit: 'м³' },
                    { from: 20, to: 50, price: 0.7, unit: 'м³' }
                ]
            },
            {
                id: 2,
                name: 'X2 servis',
                block: 'Блок B',
                purpose: 'Сервис',
                purposeKey: 'service',
                clientType: 'individual',
                clientTypeLabel: 'Индивидуальный',
                vat: 0,
                steps: [
                    { from: 0, to: null, price: 100, unit: 'м³' }
                ]
            },
            {
                id: 3,
                name: 'X2 tok',
                block: 'Блок A',
                purpose: 'Электричество',
                purposeKey: 'electricity',
                clientType: 'individual',
                clientTypeLabel: 'Индивидуальный',
                vat: 0,
                steps: [
                    { from: 0, to: 50, price: 100, unit: 'кВт-ч' },
                    { from: 50, to: 100, price: 200, unit: 'кВт-ч' }
                ]
            },
            {
                id: 4,
                name: 'X2 qaz',
                block: 'Блок B',
                purpose: 'Электричество',
                purposeKey: 'electricity',
                clientType: 'legal',
                clientTypeLabel: 'Юридический',
                vat: 0,
                steps: [
                    { from: 0, to: 50, price: 100, unit: 'кВт-ч' },
                    { from: 50, to: 100, price: 200, unit: 'кВт-ч' }
                ]
            },
            {
                id: 5,
                name: 'X2 su',
                block: 'Блок A',
                purpose: 'Вода',
                purposeKey: 'water',
                clientType: 'individual',
                clientTypeLabel: 'Индивидуальный',
                vat: 0,
                steps: [
                    { from: 0, to: 50, price: 100, unit: 'м³' },
                    { from: 50, to: 100, price: 200, unit: 'м³' }
                ]
            }
        ];

        // const blockTariffsData = [
        //     ...
        // ];

        renderTariffsTable(tariffsData);
        // renderBlockTariffs(blockTariffsData);

        function renderTariffsTable(data) {
            const tbody = document.getElementById('tariffsTableBody');
            if (!tbody) return;

            if (!data.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-table">
                            Нет тарифов по указанным параметрам
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(tariff => `
                <tr>
                    <td>${tariff.id}</td>
                    <td>${tariff.name}</td>
                    <td>${tariff.purpose}</td>
                    <td>${tariff.clientTypeLabel}</td>
                    <td>${tariff.vat}</td>
                    <td>${formatSteps(tariff.steps)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-info" onclick="openCreateModal()">Редактировать</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="showWarning('Удаление тарифа временно недоступно')">Удалить</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function formatSteps(steps = []) {
            return steps.map(step => {
                const from = step.from?.toFixed(4) ?? '0.0000';
                if (step.to === null || step.to === undefined) {
                    return `${from}+: ${step.price.toFixed(4)} / ${step.unit}`;
                }
                const to = step.to.toFixed(4);
                return `${from}–${to}: ${step.price.toFixed(4)} / ${step.unit}`;
            }).join(' | ');
        }

        // function renderBlockTariffs(blocks) {
        //     ...
        // }

// Filter Functions
        function applyFilters() {
            const purpose = document.getElementById('filterPurpose').value;
            const clientType = document.getElementById('filterClientType').value;
            const searchTerm = document.getElementById('filterSearch').value.toLowerCase();
            
            const filtered = tariffsData.filter(item => {
                const matchesPurpose = purpose === 'all' || item.purposeKey === purpose;
                const matchesClient = clientType === 'all' || item.clientType === clientType;
                const matchesSearch = !searchTerm || item.name.toLowerCase().includes(searchTerm) || item.purpose.toLowerCase().includes(searchTerm);
                return matchesPurpose && matchesClient && matchesSearch;
            });
            
            renderTariffsTable(filtered);
            showSuccess('Фильтры применены!');
        }
        
        function clearFilters() {
            document.getElementById('filterPurpose').value = 'all';
            document.getElementById('filterClientType').value = 'all';
            document.getElementById('filterSearch').value = '';
            renderTariffsTable(tariffsData);
            showSuccess('Фильтры очищены!');
        }
        
        // Modal Functions
        function openCreateModal() {
            document.getElementById('createTariffModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeCreateModal() {
            document.getElementById('createTariffModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('createTariffForm').reset();
        }
        
        // Close modal on overlay click
        document.getElementById('createTariffModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateModal();
            }
        });
        
        // Tariff Step Functions
        function addTariffStep() {
            const container = document.getElementById('tariffStepsContainer');
            const steps = container.querySelectorAll('.step-row');
            let defaultFrom = 0;
            
            if (steps.length > 0) {
                const lastStepInputs = steps[steps.length - 1].querySelectorAll('input');
                const lastToValue = lastStepInputs[1].value.trim();
                
                if (!lastToValue || lastToValue === '∞') {
                    showWarning('Укажите граничное значение "ДО (искл.)" для предыдущей ступени.');
                    return;
                }
                
                defaultFrom = lastToValue;
            }
            
            const newStep = document.createElement('div');
            newStep.className = 'step-row';
            newStep.innerHTML = `
                <div class="step-input-group">
                    <label>ОТ (вкл.)</label>
                    <input type="number" value="${defaultFrom}" min="0" step="0.01">
                </div>
                <div class="step-input-group">
                    <label>ДО (искл.)</label>
                    <input type="text" value="">
                </div>
                <div class="step-input-group">
                    <label>Ед. изм.</label>
                    <input type="text" value="кВт-ч" class="unit-chip" readonly>
                </div>
                <div class="step-input-group">
                    <label>Цена</label>
                    <input type="number" step="0.01" min="0" required>
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeStep(this)" style="height: 38px; white-space: nowrap;">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            `;
            container.appendChild(newStep);
        }
        
        function removeStep(button) {
            const stepsContainer = document.getElementById('tariffStepsContainer');
            const steps = stepsContainer.querySelectorAll('.step-row');
            
            if (steps.length > 1) {
                button.closest('.step-row').remove();
            } else {
                showWarning('Должна быть хотя бы одна ступень!');
            }
        }
        
        // Create Tariff Function
        function createTariff(event) {
            event.preventDefault();
            
            const name = document.getElementById('tariffName').value;
            const purpose = document.getElementById('tariffPurpose').value;
            const type = document.getElementById('tariffType').value;
            const vat = document.getElementById('tariffVAT').value;
            
            // Collect steps data
            const steps = [];
            const stepRows = document.querySelectorAll('#tariffStepsContainer .step-row');
            stepRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                steps.push({
                    from: inputs[0].value,
                    to: inputs[1].value,
                    unit: inputs[2].value,
                    price: inputs[3].value
                });
            });
            
            const tariffData = {
                name,
                purpose,
                type,
                vat,
                steps
            };
            
            console.log('Creating tariff:', tariffData);
            
            // TODO: Send to backend API
            // fetch('/api/tariffs', {
            //     method: 'POST',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify(tariffData)
            // }).then(response => {
            //     if (response.ok) {
            //         closeCreateModal();
            //         // Reload tariffs list
            //     }
            // });
            
            showSuccess(`Тариф "${name}" успешно создан!`);
            closeCreateModal();
        }
</script>






