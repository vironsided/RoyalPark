<link rel="stylesheet" href="/admin/content_css/readings.css">
<div class="content-wrapper">
                <h2 class="mb-4">Показатели по квартирам</h2>
                
                <!-- Filters -->
                <div class="filters-container">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Блок</label>
                            <select id="filterBlock">
                                <option value="all">Все</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="K">K</option>
                                <option value="X">X</option>
                                <option value="Z">Z</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Резидент</label>
                            <select id="filterResident">
                                <option value="all">Все</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Тип счётчика</label>
                            <select id="filterMeterType">
                                <option value="all">Все</option>
                                <option value="electricity">Электричество</option>
                                <option value="gas">Газ</option>
                                <option value="water">Вода</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Год</label>
                            <select id="filterYear">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Месяц</label>
                            <select id="filterMonth">
                                <option value="1">Январь</option>
                                <option value="2">Февраль</option>
                                <option value="3">Март</option>
                                <option value="4">Апрель</option>
                                <option value="5">Май</option>
                                <option value="6">Июнь</option>
                                <option value="7">Июль</option>
                                <option value="8">Август</option>
                                <option value="9">Сентябрь</option>
                                <option value="10" selected>Октябрь</option>
                                <option value="11">Ноябрь</option>
                                <option value="12">Декабрь</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Поиск</label>
                            <input type="text" id="filterSearch" placeholder="№ дома, ФИО, телефон, email">
                        </div>
                    </div>
                    
                    <div class="filters-actions">
                        <button class="btn btn-outline-secondary" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i> Фильтр
                        </button>
                        <button class="btn btn-primary" onclick="openRecordModal()">
                            <i class="bi bi-plus-lg"></i> Запись показателя
                        </button>
                    </div>
                </div>
                
                <!-- Readings Table -->
                <div class="card readings-card">
                    <div class="readings-head">
                        <div>Резидент</div>
                        <div>Расход по счётчикам</div>
                        <div>Сумма по счётчикам</div>
                        <div>Действия</div>
                    </div>

                    <div class="readings-list" id="readingsTableBody">
                        <div class="reading-row" data-reading-key="a41">
                            <div class="reading-col reading-col-resident">
                                <div class="resident-badge">
                                    <span class="resident-code">A / 41</span>
                                    <span class="resident-info">Блок A, №41</span>
                                </div>
                            </div>
                            <div class="reading-col">
                                <div class="meter-stack">
                                    <div class="meter-item">
                                        <span class="meter-chip">Электричество</span>
                                        <span class="meter-value">8.000 кВт·ч</span>
                                    </div>
                                </div>
                            </div>
                            <div class="reading-col">
                                <div class="amount-stack">
                                    <div class="amount-item">
                                        <span class="status-pill status-paid">Оплачено</span>
                                        <span class="amount-value">0.00 ₼</span>
                                    </div>
                                </div>
                            </div>
                            <div class="reading-col reading-col-actions">
                                <div class="reading-actions">
                                    <button class="table-btn table-btn-primary" type="button" onclick="openReadingEditor('a41')">
                                        <i class="bi bi-pencil"></i>
                                        Редактировать
                                    </button>
                                    <button class="table-btn table-btn-secondary" type="button" onclick="openReadingDetails('a41')">
                                        <i class="bi bi-info-circle"></i>
                                        Подробнее
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="reading-row" data-reading-key="a50">
                            <div class="reading-col reading-col-resident">
                                <div class="resident-badge">
                                    <span class="resident-code">A / 50</span>
                                    <span class="resident-info">Блок A, №50</span>
                                </div>
                            </div>
                            <div class="reading-col">
                                <div class="meter-stack">
                                    <div class="meter-item">
                                        <span class="meter-chip">Электричество</span>
                                        <span class="meter-value">12.000 кВт·ч</span>
                                    </div>
                                    <div class="meter-item">
                                        <span class="meter-chip chip-warning">Строительство</span>
                                        <span class="meter-value">1.000 мес</span>
                                    </div>
                                </div>
                            </div>
                            <div class="reading-col">
                                <div class="amount-stack">
                                    <div class="amount-item">
                                        <span class="status-pill status-due">Электричество</span>
                                        <span class="amount-value amount-value-alert">12.00 ₼</span>
                                    </div>
                                    <div class="amount-item">
                                        <span class="status-pill status-due">Строительство</span>
                                        <span class="amount-value amount-value-alert">80.00 ₼</span>
                                    </div>
                                </div>
                            </div>
                            <div class="reading-col reading-col-actions">
                                <div class="reading-actions">
                                    <button class="table-btn table-btn-primary" type="button" onclick="openReadingEditor('a50')">
                                        <i class="bi bi-pencil"></i>
                                        Редактировать
                                    </button>
                                    <button class="table-btn table-btn-secondary" type="button" onclick="openReadingDetails('a50')">
                                        <i class="bi bi-info-circle"></i>
                                        Подробнее
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="reading-total">
                            <span>Итого:</span>
                            <span class="reading-total-value">92.00 ₼</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Record Reading Modal -->
    <div class="modal-overlay" id="recordReadingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Запись показателя</h2>
                <button class="modal-close" onclick="closeRecordModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <form id="recordReadingForm" onsubmit="recordReading(event)">
                <div class="record-form-grid">
                    <div class="form-group">
                        <label>Блок</label>
                        <select id="modalBlock" required onchange="loadResidents()">
                            <option value="">— выберите —</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="K">K</option>
                            <option value="X">X</option>
                            <option value="Z">Z</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Резидент</label>
                        <select id="modalResident" required disabled>
                            <option value="">— выберите блок —</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Дата показаний</label>
                        <input type="date" id="modalDate" required>
                    </div>
                </div>

                <div id="meterDetailsSection" class="meter-details hidden">
                    <div class="meter-table-wrapper">
                        <table class="meter-table">
                            <thead>
                                <tr>
                                    <th>Тип</th>
                                    <th>Тариф</th>
                                    <th>Предыдущее</th>
                                    <th>Новое / Отметить</th>
                                    <th>Расход</th>
                                    <th>Сумма</th>
                                    <th>Удалить последнее</th>
                                </tr>
                            </thead>
                            <tbody id="meterTableBody">
                                <tr>
                                    <td colspan="7" class="text-muted text-center">Выберите резидента, чтобы увидеть тарифы</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="form-group">
                        <label>Комментарий</label>
                        <textarea id="modalComment" rows="2" placeholder="Например, показания снял охранник..."></textarea>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRecordModal()">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Записать
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reading Details Modal -->
    <div class="modal-overlay" id="readingDetailsModal">
        <div class="modal-content readings-detail-modal">
            <div class="modal-header">
                <h2 id="readingDetailsTitle">Резидент</h2>
                <button class="modal-close" onclick="closeReadingDetails()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="reading-details-body" id="readingDetailsBody">
                <div class="text-muted">Выберите запись, чтобы увидеть детали</div>
            </div>
        </div>
    </div>

<script>
// Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modalDate').value = today;
        });
        
        // Filter Functions
        function applyFilters() {
            const block = document.getElementById('filterBlock').value;
            const resident = document.getElementById('filterResident').value;
            const meterType = document.getElementById('filterMeterType').value;
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            const searchTerm = document.getElementById('filterSearch').value.toLowerCase();
            
            console.log('Applying filters:', { block, resident, meterType, year, month, searchTerm });
            
            // TODO: Fetch filtered data from backend API
            // fetch('/api/readings?block=' + block + '&resident=' + resident + '&meterType=' + meterType + '&year=' + year + '&month=' + month + '&search=' + searchTerm)
            
            showSuccess('Фильтры применены!');
        }
        
        // Modal Functions
        function openRecordModal() {
            document.getElementById('recordReadingModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeRecordModal() {
            document.getElementById('recordReadingModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('recordReadingForm').reset();
            document.getElementById('modalResident').disabled = true;
            document.getElementById('modalResident').innerHTML = '<option value="">— выберите блок —</option>';
            hideMeterDetails();
        }
        
        // Close modal on overlay click
        document.getElementById('recordReadingModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRecordModal();
            }
        });

        const detailsModal = document.getElementById('readingDetailsModal');
        if (detailsModal) {
            detailsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeReadingDetails();
                }
            });
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeRecordModal();
                closeReadingDetails();
            }
        });
        
        const sampleMeterTariffs = {
            1: [
                { id: 'gas-a-1', type: 'Газ', tariff: 'A-gas', prev: 120, unit: 'м³', price: 45, placeholder: '≥ 120' },
                { id: 'water-a-1', type: 'Вода', tariff: 'A-su', prev: 80, unit: 'м³', price: 30, value: 95 },
            ],
            2: [
                { id: 'electric-a-2', type: 'Электричество', tariff: 'A tok', prev: 40, unit: 'кВт·ч', price: 70, value: 185 },
                { id: 'water-a-2', type: 'Вода', tariff: 'A aqua', prev: 60, unit: 'м³', price: 28, placeholder: '≥ 60' },
                { id: 'gas-a-2', type: 'Газ', tariff: 'A gas+', prev: 25, unit: 'м³', price: 55, value: 40 },
            ],
            3: [
                { id: 'water-b-0', type: 'Вода', tariff: 'B aqua', prev: 10, unit: 'м³', price: 28, value: 16 },
                { id: 'electric-b-0', type: 'Электричество', tariff: 'B tok', prev: 100, unit: 'кВт·ч', price: 82, placeholder: '≥ 100' },
            ],
            4: [
                { id: 'gas-b-1', type: 'Газ', tariff: 'Qaz', prev: 50, unit: 'м³', price: 55, placeholder: '≥ 50', value: 60 },
                { id: 'electric-b-1', type: 'Электричество', tariff: 'B tok', prev: 0, unit: 'кВт·ч', price: 80, value: 220 },
                { id: 'water-b-1', type: 'Вода', tariff: 'B su', prev: 30, unit: 'м³', price: 28, placeholder: '≥ 30' },
            ],
            5: [
                { id: 'electric-k-1', type: 'Электричество', tariff: 'K tok', prev: 300, unit: 'кВт·ч', price: 78, value: 430 },
                { id: 'water-k-1', type: 'Вода', tariff: 'K aqua', prev: 140, unit: 'м³', price: 32, value: 180 },
            ],
            6: [
                { id: 'gas-k-2', type: 'Газ', tariff: 'K gas', prev: 0, unit: 'м³', price: 60, placeholder: '≥ 0' },
                { id: 'water-k-2', type: 'Вода', tariff: 'K aqua+', prev: 70, unit: 'м³', price: 29, value: 110 },
            ],
            7: [
                { id: 'gas-main', type: 'Газ', tariff: 'Qaz', prev: 0, unit: 'м³', price: 50, placeholder: '≥ 0' },
                { id: 'electric', type: 'Электричество', tariff: 'X2 tok', prev: 0, unit: 'кВт·ч', price: 75, value: 200 },
                { id: 'gas-aux', type: 'Газ', tariff: 'Qaz', prev: 0, unit: 'м³', price: 50, placeholder: '≥ 0' },
                { id: 'water', type: 'Вода', tariff: 'X2 su', prev: 0, unit: 'м³', price: 50, value: 300 },
            ],
            8: [
                { id: 'electric-x-2', type: 'Электричество', tariff: 'X tok+', prev: 150, unit: 'кВт·ч', price: 77, value: 280 },
                { id: 'water-x-2', type: 'Вода', tariff: 'X su+', prev: 90, unit: 'м³', price: 35, placeholder: '≥ 90' },
            ],
            9: [
                { id: 'electric-z-1', type: 'Электричество', tariff: 'Z tok', prev: 400, unit: 'кВт·ч', price: 65, value: 540 },
                { id: 'water-z-1', type: 'Вода', tariff: 'Z aqua', prev: 220, unit: 'м³', price: 25, placeholder: '≥ 220' },
            ],
            10: [
                { id: 'gas-z-2', type: 'Газ', tariff: 'Z gas', prev: 95, unit: 'м³', price: 58, value: 120 },
                { id: 'electric-z-2', type: 'Электричество', tariff: 'Z tok+', prev: 210, unit: 'кВт·ч', price: 68, placeholder: '≥ 210' },
            ],
            11: [
                { id: 'gas-a-41', type: 'Газ', tariff: 'Qaz', prev: 180, unit: 'м³', price: 55, placeholder: '≥ 180' },
                { id: 'water-a-41', type: 'Вода', tariff: 'X2 su', prev: 250, unit: 'м³', price: 35, value: 300 },
            ],
            12: [
                { id: 'electric-a-50', type: 'Электричество', tariff: 'X2 tok', prev: 100, unit: 'кВт·ч', price: 75, value: 200 },
                { id: 'water-a-50', type: 'Вода', tariff: 'X2 su', prev: 0, unit: 'м³', price: 50, value: 300 },
                { id: 'gas-a-50', type: 'Газ', tariff: 'Qaz', prev: 0, unit: 'м³', price: 55, placeholder: '≥ 0' },
            ]
        };

        const readingDetailsData = {
            a41: {
                title: 'Резидент: A / 41',
                meters: [
                    {
                        type: 'Газ',
                        meter: '№ 123',
                        tariff: 'Qaz',
                        unit: 'м³',
                        rows: []
                    },
                    {
                        type: 'Электричество',
                        meter: '№ 1234',
                        tariff: 'X2 tok',
                        unit: 'кВт·ч',
                        rows: [
                            { date: '2025-11-26', value: '200.000', consumption: '200.000', amount: '15000.00', vat: '0', comment: '—' }
                        ]
                    },
                    {
                        type: 'Газ',
                        meter: '№ 13445',
                        tariff: 'Qaz',
                        unit: 'м³',
                        rows: []
                    },
                    {
                        type: 'Вода',
                        meter: '№ 58585',
                        tariff: 'X2 su',
                        unit: 'м³',
                        rows: [
                            { date: '2025-11-26', value: '300.000', consumption: '300.000', amount: '15000.00', vat: '0', comment: '—' }
                        ]
                    }
                ]
            },
            a50: {
                title: 'Резидент: A / 50',
                meters: [
                    {
                        type: 'Электричество',
                        meter: '№ 9801',
                        tariff: 'X2 tok',
                        unit: 'кВт·ч',
                        rows: [
                            { date: '2025-11-15', value: '120.000', consumption: '120.000', amount: '8200.00', vat: '0', comment: 'Оплачено' },
                            { date: '2025-10-15', value: '100.000', consumption: '100.000', amount: '6500.00', vat: '0', comment: '—' }
                        ]
                    },
                    {
                        type: 'Вода',
                        meter: '№ 7742',
                        tariff: 'A su',
                        unit: 'м³',
                        rows: [
                            { date: '2025-11-10', value: '180.000', consumption: '40.000', amount: '2400.00', vat: '0', comment: 'Контрольное снятие' }
                        ]
                    }
                ]
            }
        };

        const readingEditorPrefill = {
            a41: {
                block: 'A',
                residentId: '11',
                date: '2025-11-26',
                comment: 'Показания подтверждены охраной'
            },
            a50: {
                block: 'A',
                residentId: '12',
                date: '2025-11-15',
                comment: 'Заполнено вручную'
            }
        };

        // Load residents based on selected block
        function loadResidents() {
            const block = document.getElementById('modalBlock').value;
            const residentSelect = document.getElementById('modalResident');
            hideMeterDetails();
            
            if (block) {
                // Enable resident select
                residentSelect.disabled = false;
                
                // Sample data - replace with actual API call
                const residents = {
                    'A': [
                        {id: 1, name: 'Блок A, № 205'},
                        {id: 2, name: 'Блок A, № 305'},
                        {id: 11, name: 'Блок A, № 41'},
                        {id: 12, name: 'Блок A, № 50'},
                    ],
                    'B': [
                        {id: 3, name: 'Блок B, № 101'},
                        {id: 4, name: 'Блок B, № 201'},
                    ],
                    'K': [
                        {id: 5, name: 'Блок K, № 305'},
                        {id: 6, name: 'Блок K, № 405'},
                    ],
                    'X': [
                        {id: 7, name: 'Блок X, № 102'},
                        {id: 8, name: 'Блок X, № 202'},
                    ],
                    'Z': [
                        {id: 9, name: 'Блок Z, № 50'},
                        {id: 10, name: 'Блок Z, № 60'},
                    ]
                };
                
                // Populate residents
                residentSelect.innerHTML = '<option value="">— выберите —</option>';
                if (residents[block]) {
                    residents[block].forEach(resident => {
                        const option = document.createElement('option');
                        option.value = resident.id;
                        option.textContent = resident.name;
                        residentSelect.appendChild(option);
                    });
                }
                
                // TODO: Fetch residents from backend API
                // fetch('/api/residents?block=' + block)
            } else {
                residentSelect.disabled = true;
                residentSelect.innerHTML = '<option value="">— выберите блок —</option>';
            }
        }

        function openReadingEditor(key) {
            const prefill = readingEditorPrefill[key];
            openRecordModal();
            if (!prefill) return;

            const blockSelect = document.getElementById('modalBlock');
            const residentSelect = document.getElementById('modalResident');
            const dateInput = document.getElementById('modalDate');
            const commentField = document.getElementById('modalComment');

            if (blockSelect && prefill.block) {
                blockSelect.value = prefill.block;
                loadResidents();
            }

            if (residentSelect && prefill.residentId) {
                residentSelect.disabled = false;
                residentSelect.value = prefill.residentId;
                renderMeterDetails(prefill.residentId);
            }

            if (dateInput && prefill.date) {
                dateInput.value = prefill.date;
            }

            if (commentField) {
                commentField.value = prefill.comment || '';
            }
        }

        function openReadingDetails(key) {
            const modal = document.getElementById('readingDetailsModal');
            const title = document.getElementById('readingDetailsTitle');
            const body = document.getElementById('readingDetailsBody');
            if (!modal || !title || !body) return;

            const data = readingDetailsData[key];
            title.textContent = data?.title || 'Детали показаний';

            if (!data) {
                body.innerHTML = '<div class="detail-empty">Для этой записи пока нет подробностей.</div>';
            } else {
                body.innerHTML = data.meters.map(renderDetailMeterCard).join('');
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function renderDetailMeterCard(meter) {
            const rows = (meter.rows && meter.rows.length)
                ? meter.rows.map(row => `
                    <div class="detail-grid-row">
                        <div>${row.date || '—'}</div>
                        <div>${row.value || '—'}</div>
                        <div>${row.consumption || '—'}</div>
                        <div class="detail-amount ${row.amount && Number(row.amount) > 0 ? 'detail-amount-alert' : ''}">${row.amount || '0.00'}</div>
                        <div>${row.vat ?? '—'}</div>
                        <div>${row.comment || '—'}</div>
                    </div>
                `).join('')
                : '<div class="detail-empty-row">Нет записей</div>';

            return `
                <div class="detail-meter-card">
                    <div class="detail-meter-head">
                        <span class="detail-meter-badge">${meter.type}</span>
                        <div class="detail-meter-info">
                            <span>${meter.meter}</span>
                            <span>тариф: ${meter.tariff}</span>
                        </div>
                        <span class="detail-unit-chip">${meter.unit || ''}</span>
                    </div>
                    <div class="detail-grid detail-grid-head">
                        <div>Дата</div>
                        <div>Показание</div>
                        <div>Расход</div>
                        <div>Начислено</div>
                        <div>НДС, %</div>
                        <div>Комментарий</div>
                    </div>
                    <div class="detail-grid-body">
                        ${rows}
                    </div>
                </div>
            `;
        }

        function closeReadingDetails() {
            const modal = document.getElementById('readingDetailsModal');
            if (!modal) return;
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // Record Reading Function
        function recordReading(event) {
            event.preventDefault();
            
            const formData = {
                block: document.getElementById('modalBlock').value,
                resident: document.getElementById('modalResident').value,
                date: document.getElementById('modalDate').value,
                comment: document.getElementById('modalComment').value,
                meters: collectMeterData()
            };
            
            console.log('Recording reading:', formData);
            
            // TODO: Send to backend API
            // fetch('/api/readings', {
            //     method: 'POST',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify(formData)
            // }).then(response => {
            //     if (response.ok) {
            //         closeRecordModal();
            //         // Reload readings list
            //     }
            // });
            
            showSuccess('Показатель успешно записан! Дата: ' + formData.date);
            closeRecordModal();
        }

        function collectMeterData() {
            const rows = document.querySelectorAll('#meterTableBody tr[data-meter-id]');
            return Array.from(rows).map(row => ({
                id: row.dataset.meterId,
                newValue: row.querySelector('input')?.value || '',
                prev: row.dataset.prevValue,
                consumption: row.dataset.consumption || '0',
                amount: row.dataset.amount || '0'
            }));
        }

        function hideMeterDetails() {
            const section = document.getElementById('meterDetailsSection');
            if (section) {
                section.classList.add('hidden');
                document.getElementById('meterTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-muted text-center">Выберите резидента, чтобы увидеть тарифы</td>
                    </tr>`;
            }
        }

        document.getElementById('modalResident').addEventListener('change', function() {
            const residentId = this.value;
            if (!residentId) {
                hideMeterDetails();
                return;
            }
            renderMeterDetails(residentId);
        });

        function renderMeterDetails(residentId) {
            const section = document.getElementById('meterDetailsSection');
            const tbody = document.getElementById('meterTableBody');
            const data = sampleMeterTariffs[residentId];
            
            if (!section || !tbody) return;
            
            if (!data) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-muted text-center">Для выбранного резидента нет тарифов</td></tr>`;
                section.classList.remove('hidden');
                return;
            }
            
            tbody.innerHTML = data.map(meter => {
                const prev = meter.prev ?? 0;
                const newVal = meter.value ?? '';
                const consumption = meter.value ? (meter.value - prev) : 0;
                const amount = consumption * meter.price;
                return `
                    <tr data-meter-id="${meter.id}" data-prev-value="${prev}" data-consumption="${consumption}" data-amount="${amount}">
                        <td><span class="meter-type-pill">${meter.type}</span></td>
                        <td>${meter.tariff}</td>
                        <td>${prev} ${meter.unit || ''}</td>
                        <td>
                            <input type="number"
                                   class="meter-input"
                                   placeholder="${meter.placeholder || 'Введите'}"
                                   value="${newVal}"
                                   min="${prev}"
                                   oninput="handleMeterInput(this)">
                        </td>
                        <td><span class="meter-consumption">${consumption.toFixed(3)}</span></td>
                        <td><span class="meter-amount">${amount.toFixed(2)}</span></td>
                        <td>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMeterRow('${meter.id}')">
                                Удалить
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            section.classList.remove('hidden');
        }

        window.handleMeterInput = function(input) {
            const row = input.closest('tr');
            if (!row) return;
            const prev = parseFloat(row.dataset.prevValue || '0');
            const price = parseFloat(sampleMeterTariffsPrice(row.dataset.meterId));
            const value = parseFloat(input.value || '0');
            const consumption = Math.max(0, value - prev);
            const amount = consumption * (price || 0);
            
            row.dataset.consumption = consumption.toFixed(3);
            row.dataset.amount = amount.toFixed(2);
            row.querySelector('.meter-consumption').textContent = consumption.toFixed(3);
            row.querySelector('.meter-amount').textContent = amount.toFixed(2);
        };

        function sampleMeterTariffsPrice(meterId) {
            const residentId = document.getElementById('modalResident').value;
            const data = sampleMeterTariffs[residentId] || [];
            const found = data.find(m => m.id === meterId);
            return found ? found.price : 0;
        }

        window.removeMeterRow = function(id) {
            const row = document.querySelector(`#meterTableBody tr[data-meter-id="${id}"]`);
            if (row) {
                row.remove();
            }
            if (!document.querySelectorAll('#meterTableBody tr').length) {
                hideMeterDetails();
            }
        };
</script>

