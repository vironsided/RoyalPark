<link rel="stylesheet" href="/admin/content_css/payment-view.css">
<div class="content-wrapper payment-view-page">
    <div class="payment-header">
        <div class="payment-header-left">
            <button class="btn-back" onclick="goBackToPayments()">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
            <h1 id="paymentTitle">–ü–ª–∞—Ç–µ–∂ #1</h1>
        </div>
    </div>

    <!-- Payment Summary -->
    <div class="payment-summary" id="paymentSummary">
        <div class="payment-summary-item">
            <label>–†–µ–∑–∏–¥–µ–Ω—Ç</label>
            <div class="value" id="paymentResident">X / 2</div>
        </div>
        <div class="payment-summary-item">
            <label>–°—Å—ã–ª–∫–∞ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <div class="value" id="paymentLink">123456</div>
        </div>
        <div class="payment-summary-item">
            <label>–î–∞—Ç–∞</label>
            <div class="value" id="paymentDate">2025-11-21</div>
        </div>
        <div class="payment-summary-item">
            <label>–ú–µ—Ç–æ–¥</label>
            <div class="value" id="paymentMethod">CARD</div>
        </div>
        <div class="payment-summary-item">
            <label>–°—É–º–º–∞</label>
            <div class="value amount" id="paymentAmount">30.00</div>
        </div>
        <div class="payment-summary-item">
            <label>–û—Å—Ç–∞—Ç–æ–∫</label>
            <div class="value balance">
                <span class="badge-advance" id="paymentBalance">–ê–≤–∞–Ω—Å 20.00</span>
            </div>
        </div>
    </div>

    <!-- Distribution Section -->
    <div class="distribution-section">
        <div class="distribution-header">
            <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—á–µ—Ç–∞–º</h3>
            <button class="btn-secondary" type="button" onclick="autoDistribute()">–ê–≤—Ç–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
        </div>

        <div class="distribution-table-wrapper">
            <table class="distribution-table">
                <thead>
                    <tr>
                        <th>–°—á—ë—Ç (–ø–µ—Ä–∏–æ–¥)</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å</th>
                        <th>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</th>
                    </tr>
                </thead>
                <tbody id="distributionTableBody">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS -->
                </tbody>
            </table>
        </div>

        <div class="distribution-footer">
            <button class="btn-primary" type="button" onclick="saveDistribution()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</button>
        </div>
    </div>

    <!-- Applications Section -->
    <div class="applications-section">
        <h3>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è</h3>
        <table class="applications-table">
            <thead>
                <tr>
                    <th>–°—á—ë—Ç</th>
                    <th>–°—É–º–º–∞</th>
                </tr>
            </thead>
            <tbody id="applicationsTable">
                <tr>
                    <td>
                        <a href="#" class="account-link"
                            onclick="viewInvoice(event, '2025-11/000001')">2025-11/000001</a>
                    </td>
                    <td class="amount-value">10.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    (function () {
        const API_BASE = 'http://localhost:8000';
        const methodLabels = {
            'CASH': '–ù–∞–ª–∏—á–Ω—ã–µ',
            'CARD': 'CARD',
            'TRANSFER': '–ë–∞–Ω–∫',
            'ONLINE': '–û–Ω–ª–∞–π–Ω'
        };

        // Get payment ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        let paymentId = urlParams.get('id') || window.__currentPaymentId || window.location.hash.split('/').pop() || window.location.hash.split('=').pop();
        if (paymentId) paymentId = parseInt(paymentId);

        let currentPayment = null;
        let currentDistributionRows = [];
        let openInvoices = [];

        // Load payment data
        async function loadPayment(id) {
            if (!id) {
                console.error('Payment ID is required');
                return;
            }

            try {
                let url = `${API_BASE}/api/payments/${id}`;
                let response = await fetch(url, { credentials: 'include' });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.log('Not authorized, using public endpoint');
                        url = `${API_BASE}/api/payments/${id}/public`;
                        response = await fetch(url);
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const payment = await response.json();
                currentPayment = payment;

                // Load open invoices for distribution
                await loadOpenInvoices(id);

                renderPayment(payment);
            } catch (error) {
                console.error('Error loading payment:', error);
                if (typeof showError === 'function') {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–∞: ' + error.message);
                }
            }
        }

        // Load open invoices for distribution
        async function loadOpenInvoices(paymentId) {
            try {
                let url = `${API_BASE}/api/payments/${paymentId}/open-invoices`;
                let response = await fetch(url, { credentials: 'include' });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.log('Not authorized, using public endpoint for open invoices');
                        url = `${API_BASE}/api/payments/${paymentId}/open-invoices/public`;
                        response = await fetch(url);
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìã Open invoices data:', data);
                openInvoices = data.invoices || [];
                console.log('üìã Open invoices count:', openInvoices.length);
                console.log('üìã Open invoices:', openInvoices);

                // Build distribution rows
                currentDistributionRows = openInvoices.map(inv => {
                    // Check if this invoice already has an application
                    const existingApp = currentPayment?.applications?.find(app => app.invoice_id === inv.id);
                    const row = {
                        id: inv.id,
                        invoice_number: inv.number || `${inv.period}/---`,
                        period: inv.period,
                        total: inv.amount_total,
                        remaining: inv.left_to_pay,
                        apply: existingApp ? parseFloat(existingApp.amount_applied) : 0
                    };
                    console.log('üìã Distribution row:', row);
                    return row;
                });

                console.log('üìã Total distribution rows:', currentDistributionRows.length);
                renderDistributionTable();
            } catch (error) {
                console.error('Error loading open invoices:', error);
                openInvoices = [];
                currentDistributionRows = [];
                renderDistributionTable();
            }
        }

        function renderPayment(payment) {
            // Update title
            const titleEl = document.getElementById('paymentTitle');
            if (titleEl) titleEl.textContent = `–ü–ª–∞—Ç–µ–∂ #${payment.id}`;

            // Update summary
            const residentEl = document.getElementById('paymentResident');
            if (residentEl) residentEl.textContent = payment.resident_code || '-';

            const linkEl = document.getElementById('paymentLink');
            if (linkEl) linkEl.textContent = payment.reference || '-';

            const dateEl = document.getElementById('paymentDate');
            if (dateEl) dateEl.textContent = payment.received_at || '-';

            const methodEl = document.getElementById('paymentMethod');
            if (methodEl) methodEl.textContent = methodLabels[payment.method] || payment.method || '-';

            const amountEl = document.getElementById('paymentAmount');
            if (amountEl) amountEl.textContent = parseFloat(payment.amount_total || 0).toFixed(2);

            // Update balance badge
            const balanceEl = document.getElementById('paymentBalance');
            if (balanceEl) {
                const leftover = parseFloat(payment.leftover || 0);
                if (leftover > 0) {
                    balanceEl.textContent = `–ê–≤–∞–Ω—Å ${leftover.toFixed(2)}`;
                    balanceEl.className = 'badge-advance';
                } else {
                    balanceEl.textContent = '0.00';
                    balanceEl.className = '';
                }
            }

            // Update applications table
            const tbody = document.getElementById('applicationsTable');
            if (payment.applications && payment.applications.length > 0) {
                tbody.innerHTML = payment.applications.map(app => {
                    const invoiceDisplay = app.invoice_number || app.invoice_period || `${app.invoice_id}`;
                    return `
                <tr>
                    <td>
                        <a href="#" class="account-link" onclick="viewInvoiceById(event, ${app.invoice_id})">${invoiceDisplay}</a>
                    </td>
                    <td class="amount-value">${parseFloat(app.amount_applied || 0).toFixed(2)}</td>
                </tr>
            `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">–ù–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–π</td></tr>';
            }

            updateDistributionTotals();
        }

        window.goBackToPayments = function () {
            // Navigate back to payments list using router
            if (window.goBack) {
                window.goBack('/payments');
            } else if (window.spaRouter && typeof window.spaRouter.goBack === 'function') {
                window.spaRouter.goBack('/payments');
            } else if (window.spaRouter && typeof window.spaRouter.navigate === 'function') {
                window.spaRouter.navigate('/payments');
            } else {
                // Fallback: update hash directly
                window.location.hash = '#/payments';
            }
        };

        // Update page header when payment view loads
        function updatePageHeaderForPaymentsView() {
            const pageTitle = document.querySelector('.page-title');
            const breadcrumb = document.querySelector('.breadcrumb');

            if (pageTitle) {
                pageTitle.textContent = '–ü–ª–∞—Ç–µ–∂–∏';
            }

            if (breadcrumb) {
                breadcrumb.innerHTML = '<a href="#/dashboard">–ì–ª–∞–≤–Ω–∞—è</a> / <a href="#/payments">–§–∏–Ω–∞–Ω—Å—ã</a> / –ü–ª–∞—Ç–µ–∂–∏';
            }
        }

        // Update page header when loaded in SPA
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updatePageHeaderForPaymentsView);
        } else {
            updatePageHeaderForPaymentsView();
        }

        function renderDistributionTable() {
            const tbody = document.getElementById('distributionTableBody');
            if (!tbody) return;

            if (!currentDistributionRows.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 14px; text-align: center; color: rgba(255,255,255,0.6);">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å—á–µ—Ç–æ–≤</td></tr>';
                return;
            }

            tbody.innerHTML = currentDistributionRows.map(row => {
                const invoiceDisplay = row.invoice_number || row.period || `${row.id}`;
                return `
            <tr>
                <td>
                    <a href="#" class="distribution-invoice-link" onclick="viewInvoiceById(event, ${row.id})">${invoiceDisplay}</a>
                </td>
                <td class="distribution-amount">${parseFloat(row.total || 0).toFixed(2)}</td>
                <td class="distribution-remaining">${parseFloat(row.remaining || 0).toFixed(2)}</td>
                <td>
                    <input
                        type="number"
                        class="apply-input"
                        min="0"
                        step="0.01"
                        max="${row.remaining}"
                        value="${parseFloat(row.apply || 0).toFixed(2)}"
                        data-id="${row.id}"
                        oninput="updateDistributionFromInputs()"
                    />
                </td>
            </tr>
        `;
            }).join('');
        }

        function updateDistributionTotals() {
            if (!currentPayment) return;
            const totalApplied = currentDistributionRows.reduce((sum, r) => sum + (parseFloat(r.apply) || 0), 0);
            const leftover = parseFloat(currentPayment.leftover || 0);
            const remainingToPay = Math.max(0, leftover - totalApplied);

            const remainingEl = document.getElementById('remainingToPay');
            const applyEl = document.getElementById('applyAmount');
            if (remainingEl) remainingEl.textContent = remainingToPay.toFixed(2);
            if (applyEl) applyEl.textContent = totalApplied.toFixed(2);
        }

        window.updateDistributionFromInputs = function () {
            const inputs = document.querySelectorAll('.apply-input[data-id]');
            inputs.forEach(input => {
                const id = Number(input.getAttribute('data-id'));
                const row = currentDistributionRows.find(r => r.id === id);
                if (!row) return;
                const value = parseFloat(input.value.replace(',', '.')) || 0;
                row.apply = Math.max(0, value);
            });
            updateDistributionTotals();
        };

        window.saveDistribution = async function () {
            if (!currentPayment || !currentPayment.id) {
                if (typeof showError === 'function') {
                    showError('–ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
                return;
            }

            const totalApplied = currentDistributionRows.reduce((sum, r) => sum + (parseFloat(r.apply) || 0), 0);

            if (totalApplied <= 0) {
                if (typeof showWarning === 'function') {
                    showWarning('–°—É–º–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è!');
                }
                return;
            }

            // Build applications array
            const applications = currentDistributionRows
                .filter(row => parseFloat(row.apply) > 0)
                .map(row => ({
                    invoice_id: row.id,
                    amount: parseFloat(row.apply)
                }));

            try {
                const formData = new FormData();
                formData.append('data_json', JSON.stringify(applications));

                let response = await fetch(`${API_BASE}/api/payments/${currentPayment.id}/applications`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok && response.status === 401) {
                    response = await fetch(`${API_BASE}/api/payments/${currentPayment.id}/applications/public`, {
                        method: 'POST',
                        body: formData
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Reload payment to get updated data
                await loadPayment(currentPayment.id);

                if (typeof showSuccess === 'function') {
                    showSuccess('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                }
            } catch (error) {
                console.error('Error saving distribution:', error);
                if (typeof showError === 'function') {
                    showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: ' + error.message);
                }
            }
        };

        window.autoDistribute = async function () {
            if (!currentPayment || !currentPayment.id) {
                if (typeof showError === 'function') {
                    showError('–ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
                return;
            }

            if (!currentDistributionRows.length) {
                if (typeof showWarning === 'function') {
                    showWarning('–ù–µ—Ç —Å—á–µ—Ç–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è!');
                }
                return;
            }

            try {
                let response = await fetch(`${API_BASE}/api/payments/${currentPayment.id}/auto-apply`, {
                    method: 'POST'
                });

                if (!response.ok && response.status === 401) {
                    response = await fetch(`${API_BASE}/api/payments/${currentPayment.id}/auto-apply/public`, {
                        method: 'POST'
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Apply the plan to currentDistributionRows
                if (result.plan && Array.isArray(result.plan)) {
                    result.plan.forEach(planItem => {
                        const row = currentDistributionRows.find(r => r.id === planItem.invoice_id);
                        if (row) {
                            row.apply = parseFloat(planItem.amount || 0);
                        }
                    });
                } else {
                    // Fallback: manual distribution
                    let remaining = parseFloat(currentPayment.leftover || 0);
                    currentDistributionRows.forEach(row => {
                        const maxForRow = parseFloat(row.remaining || 0);
                        const apply = Math.min(remaining, maxForRow);
                        row.apply = apply;
                        remaining -= apply;
                    });
                }

                renderDistributionTable();
                updateDistributionTotals();

                if (typeof showSuccess === 'function') {
                    showSuccess('–ê–≤—Ç–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!');
                }
            } catch (error) {
                console.error('Error auto-distributing:', error);
                if (typeof showError === 'function') {
                    showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: ' + error.message);
                }
            }
        };

        window.viewInvoiceById = function (event, invoiceId) {
            if (event) {
                event.preventDefault();
            }

            console.log('Opening invoice view for invoice ID:', invoiceId);

            // Store invoice ID for invoice-view.html
            window.__currentInvoiceId = invoiceId;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á–µ—Ä–µ–∑ fetch –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ SPA –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const viewUrl = `/admin/content/invoice-view.html?id=${invoiceId}`;
            const contentContainer = document.getElementById('spa-content');

            if (!contentContainer) {
                console.error('SPA content container not found');
                window.location.href = viewUrl;
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.8);"><i class="bi bi-hourglass-split" style="font-size: 2rem; margin-bottom: 10px;"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
            fetch(viewUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    // –í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
                    contentContainer.innerHTML = html;

                    // –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                    const scripts = contentContainer.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ breadcrumb
                    updatePageHeaderForInvoiceView(invoiceId);

                    // –û–±–Ω–æ–≤–∏—Ç—å URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ —á–µ—Ä–µ–∑ hash (–¥–ª—è SPA —Ä–æ—É—Ç–µ—Ä–∞)
                    window.location.hash = `#/invoice-view?id=${invoiceId}`;

                    // –°–∫—Ä–æ–ª–ª–∏—Ç—å –Ω–∞–≤–µ—Ä—Ö
                    contentContainer.scrollTop = 0;

                    console.log('Invoice view loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading invoice view:', error);
                    contentContainer.innerHTML = `<div style="padding: 40px; text-align: center; color: #ff6b6b;"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${error.message}</p><button onclick="window.location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button></div>`;
                });
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ breadcrumb –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—á–µ—Ç–∞
        function updatePageHeaderForInvoiceView(invoiceId) {
            // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const pageTitle = document.querySelector('.page-title');
            const breadcrumb = document.querySelector('.breadcrumb');

            if (pageTitle) {
                pageTitle.textContent = '–°—á–µ—Ç–∞';
            }

            if (breadcrumb) {
                breadcrumb.innerHTML = '<a href="#/dashboard">–ì–ª–∞–≤–Ω–∞—è</a> / <a href="#/invoices">–§–∏–Ω–∞–Ω—Å—ã</a> / –°—á–µ—Ç–∞';
            }

            // –û–±–Ω–æ–≤–∏—Ç—å title —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.title = '–°—á–µ—Ç–∞ - RoyalPark Admin';
        }

        // Load payment on page load
        function initPaymentView() {
            if (paymentId) {
                loadPayment(paymentId);
            } else {
                console.error('Payment ID not found');
                if (typeof showError === 'function') {
                    showError('ID –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            }
        }

        // Listen for SPA content loaded event
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (window._paymentViewContentLoadedHandler) {
            document.removeEventListener('spa:contentLoaded', window._paymentViewContentLoadedHandler);
        }

        window._paymentViewContentLoadedHandler = function () {
            // Re-extract payment ID in case it changed
            const urlParams = new URLSearchParams(window.location.search);
            paymentId = urlParams.get('id') || window.__currentPaymentId || window.location.hash.split('/').pop() || window.location.hash.split('=').pop();
            if (paymentId) paymentId = parseInt(paymentId);
            initPaymentView();
        };

        document.addEventListener('spa:contentLoaded', window._paymentViewContentLoadedHandler);

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPaymentView);
        } else {
            initPaymentView();
        }
    })();
</script>