<link rel="stylesheet" href="/admin/content_css/payment-view.css">
<div class="content-wrapper payment-view-page">
    <div class="payment-header">
        <div class="payment-header-left">
            <button class="btn-back" onclick="goBackToPayments()">
                <i class="bi bi-arrow-left"></i> Назад
            </button>
            <h1 id="paymentTitle">Платеж #1</h1>
        </div>
    </div>

    <!-- Payment Summary -->
    <div class="payment-summary" id="paymentSummary">
        <div class="payment-summary-item">
            <label>Резидент</label>
            <div class="value" id="paymentResident">X / 2</div>
        </div>
        <div class="payment-summary-item">
            <label>Ссылка / Комментарий</label>
            <div class="value" id="paymentLink">123456</div>
        </div>
        <div class="payment-summary-item">
            <label>Дата</label>
            <div class="value" id="paymentDate">2025-11-21</div>
        </div>
        <div class="payment-summary-item">
            <label>Метод</label>
            <div class="value" id="paymentMethod">CARD</div>
        </div>
        <div class="payment-summary-item">
            <label>Сумма</label>
            <div class="value amount" id="paymentAmount">30.00</div>
        </div>
        <div class="payment-summary-item">
            <label>Остаток</label>
            <div class="value balance">
                <span class="badge-advance" id="paymentBalance">Аванс 20.00</span>
            </div>
        </div>
    </div>

    <!-- Distribution Section -->
    <div class="distribution-section">
        <div class="distribution-header">
            <h3>Распределение по счетам</h3>
            <button class="btn-secondary" type="button" onclick="autoDistribute()">Автораспределить</button>
        </div>

        <div class="distribution-table-wrapper">
            <table class="distribution-table">
                <thead>
                    <tr>
                        <th>Счёт (период)</th>
                        <th>Сумма</th>
                        <th>Осталось оплатить</th>
                        <th>Применить</th>
                    </tr>
                </thead>
                <tbody id="distributionTableBody">
                    <!-- Заполняется из JS -->
                </tbody>
            </table>
        </div>

        <div class="distribution-footer">
            <button class="btn-primary" type="button" onclick="saveDistribution()">Сохранить распределение</button>
        </div>
    </div>

    <!-- Applications Section -->
    <div class="applications-section">
        <h3>Применения</h3>
        <table class="applications-table">
            <thead>
                <tr>
                    <th>Счёт</th>
                    <th>Сумма</th>
                </tr>
            </thead>
            <tbody id="applicationsTable">
                <tr>
                    <td>
                        <a href="#" class="account-link" onclick="viewInvoice(event, '2025-11/000001')">2025-11/000001</a>
                    </td>
                    <td class="amount-value">10.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    // Get payment ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const paymentId = urlParams.get('id') || window.location.hash.split('/').pop() || window.location.hash.split('=').pop();
    
    let currentPayment = null;
    let currentDistributionRows = [];

    // Load payment data
    function loadPayment(id) {
        // TODO: Load from API
        // For now, use mock data
        const payment = {
            id: id || 1,
            resident: 'X / 2',
            link: '123456',
            date: '2025-11-21',
            method: 'CARD',
            amount: 30.00,
            balance: 20.00,
            balanceType: 'advance',
            applications: [
                { account: '2025-11/000001', amount: 10.00, invoiceId: 1 }
            ]
        };
        
        renderPayment(payment);
    }
    
    function renderPayment(payment) {
        currentPayment = payment;
        // Update title
        document.getElementById('paymentTitle').textContent = `Платеж #${payment.id}`;
        
        // Update summary
        document.getElementById('paymentResident').textContent = payment.resident;
        document.getElementById('paymentLink').textContent = payment.link || '-';
        document.getElementById('paymentDate').textContent = payment.date;
        document.getElementById('paymentMethod').textContent = payment.method;
        document.getElementById('paymentAmount').textContent = payment.amount.toFixed(2);
        
        // Update balance badge
        const balanceEl = document.getElementById('paymentBalance');
        if (payment.balanceType === 'advance') {
            balanceEl.textContent = `Аванс ${payment.balance.toFixed(2)}`;
            balanceEl.className = 'badge-advance';
        } else {
            balanceEl.textContent = payment.balance.toFixed(2);
            balanceEl.className = 'badge-debt';
        }
        
        // Mock distribution rows (пример как на скрине)
        currentDistributionRows = [
            {
                id: 1,
                account: '2025-11/000002',
                total: 92.00,
                remaining: 82.00,
                apply: 0
            }
        ];

        renderDistributionTable();
        
        // Update applications table
        const tbody = document.getElementById('applicationsTable');
        if (payment.applications && payment.applications.length > 0) {
            tbody.innerHTML = payment.applications.map(app => `
                <tr>
                    <td>
                        <a href="#" class="account-link" onclick="viewInvoice(event, '${app.account}')">${app.account}</a>
                    </td>
                    <td class="amount-value">${app.amount.toFixed(2)}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Нет применений</td></tr>';
        }
        
        updateDistributionTotals();
    }
    
    window.goBackToPayments = function() {
        // Navigate back to payments list
        if (window.router && typeof window.router.navigate === 'function') {
            window.router.navigate('/payments');
        } else {
            // Fallback: reload payments page
            const contentContainer = document.getElementById('spa-content');
            if (contentContainer) {
                fetch('/admin/content/payments.html')
                    .then(response => response.text())
                    .then(html => {
                        contentContainer.innerHTML = html;
                        const scripts = contentContainer.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                        
                        // Update page header
                        if (typeof updatePageHeaderForPayments === 'function') {
                            updatePageHeaderForPayments();
                        }
                        
                        if (window.history && window.history.pushState) {
                            window.history.pushState({ route: 'payments' }, '', '#/payments');
                        }
                    });
            } else {
                window.location.href = '/admin/#/payments';
            }
        }
    };
    
    // Update page header when payment view loads
    function updatePageHeaderForPaymentsView() {
        const pageTitle = document.querySelector('.page-title');
        const breadcrumb = document.querySelector('.breadcrumb');
        
        if (pageTitle) {
            pageTitle.textContent = 'Платежи';
        }
        
        if (breadcrumb) {
            breadcrumb.innerHTML = '<a href="#/dashboard">Главная</a> / <a href="#/payments">Финансы</a> / Платежи';
        }
    }
    
    // Update page header when loaded in SPA
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updatePageHeaderForPaymentsView);
    } else {
        updatePageHeaderForPaymentsView();
    }
    
    function renderDistributionTable() {
        const tbody = document.getElementById('distributionTableBody');
        if (!tbody) return;

        if (!currentDistributionRows.length) {
            tbody.innerHTML = '<tr><td colspan="4" style="padding: 14px; text-align: center; color: rgba(255,255,255,0.6);">Нет открытых счетов</td></tr>';
            return;
        }

        tbody.innerHTML = currentDistributionRows.map(row => `
            <tr>
                <td>
                    <a href="#" class="distribution-invoice-link" onclick="viewInvoice(event, '${row.account}')">${row.account}</a>
                </td>
                <td class="distribution-amount">${row.total.toFixed(2)}</td>
                <td class="distribution-remaining">${row.remaining.toFixed(2)}</td>
                <td>
                    <input
                        type="number"
                        class="apply-input"
                        min="0"
                        step="0.01"
                        value="${row.apply.toFixed(2)}"
                        data-id="${row.id}"
                        oninput="updateDistributionFromInputs()"
                    />
                </td>
            </tr>
        `).join('');
    }

    function updateDistributionTotals() {
        if (!currentPayment) return;
        const totalApplied = currentDistributionRows.reduce((sum, r) => sum + (r.apply || 0), 0);
        const remainingToPay = Math.max(0, currentPayment.balance - totalApplied);

        const remainingEl = document.getElementById('remainingToPay');
        const applyEl = document.getElementById('applyAmount');
        if (remainingEl) remainingEl.textContent = remainingToPay.toFixed(2);
        if (applyEl) applyEl.textContent = totalApplied.toFixed(2);
    }

    window.updateDistributionFromInputs = function() {
        const inputs = document.querySelectorAll('.apply-input[data-id]');
        inputs.forEach(input => {
            const id = Number(input.getAttribute('data-id'));
            const row = currentDistributionRows.find(r => r.id === id);
            if (!row) return;
            const value = parseFloat(input.value.replace(',', '.')) || 0;
            row.apply = Math.max(0, value);
        });
        updateDistributionTotals();
    };

    window.saveDistribution = function() {
        const totalApplied = currentDistributionRows.reduce((sum, r) => sum + (r.apply || 0), 0);

        if (totalApplied <= 0) {
            if (typeof showWarning === 'function') {
                showWarning('Сумма применения должна быть больше нуля!');
            }
            return;
        }

        console.log('Saving distribution:', {
            paymentId: currentPayment?.id,
            rows: currentDistributionRows
        });

        if (typeof showSuccess === 'function') {
            showSuccess('Распределение успешно сохранено!');
        }
    };

    window.autoDistribute = function() {
        if (!currentPayment || !currentDistributionRows.length) {
            if (typeof showWarning === 'function') {
                showWarning('Нет счетов для распределения!');
            }
            return;
        }

        let remaining = currentPayment.balance;
        currentDistributionRows.forEach(row => {
            const maxForRow = row.remaining;
            const apply = Math.min(remaining, maxForRow);
            row.apply = apply;
            remaining -= apply;
        });

        renderDistributionTable();
        updateDistributionTotals();

        if (typeof showSuccess === 'function') {
            showSuccess('Автораспределение выполнено!');
        }
    };
    
    window.viewInvoice = function(event, invoiceNumber) {
        if (event) {
            event.preventDefault();
        }
        
        console.log('Opening invoice view for invoice number:', invoiceNumber);
        
        // Extract invoice ID from invoice number
        // Format: "2025-11/000001" -> extract "000001" or use full number
        // For now, extract the last part after "/"
        let invoiceId = invoiceNumber;
        if (invoiceNumber && invoiceNumber.includes('/')) {
            const parts = invoiceNumber.split('/');
            invoiceId = parts[parts.length - 1]; // Get last part (e.g., "000001")
        }
        
        // Загрузить страницу просмотра через fetch и вставить в SPA контейнер
        const viewUrl = `/admin/content/invoice-view.html?id=${invoiceId}`;
        const contentContainer = document.getElementById('spa-content');
        
        if (!contentContainer) {
            console.error('SPA content container not found');
            window.location.href = viewUrl;
            return;
        }
        
        // Показать состояние загрузки
        contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.8);"><i class="bi bi-hourglass-split" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Загрузка...</p></div>';
        
        // Загрузить контент
        fetch(viewUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // Вставить контент
                contentContainer.innerHTML = html;
                
                // Выполнить скрипты из загруженного контента
                const scripts = contentContainer.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                
                // Обновить заголовок страницы и breadcrumb
                updatePageHeaderForInvoiceView(invoiceId);
                
                // Обновить URL в браузере
                if (window.history && window.history.pushState) {
                    window.history.pushState({ route: 'invoice-view', id: invoiceId }, '', `#/invoice-view?id=${invoiceId}`);
                }
                
                // Скроллить наверх
                contentContainer.scrollTop = 0;
                
                console.log('Invoice view loaded successfully');
            })
            .catch(error => {
                console.error('Error loading invoice view:', error);
                contentContainer.innerHTML = `<div style="padding: 40px; text-align: center; color: #ff6b6b;"><p>Ошибка загрузки страницы: ${error.message}</p><button onclick="window.location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">Перезагрузить</button></div>`;
            });
    };
    
    // Функция для обновления заголовка и breadcrumb при открытии просмотра счета
    function updatePageHeaderForInvoiceView(invoiceId) {
        // Обновить заголовок страницы
        const pageTitle = document.querySelector('.page-title');
        const breadcrumb = document.querySelector('.breadcrumb');
        
        if (pageTitle) {
            pageTitle.textContent = 'Счета';
        }
        
        if (breadcrumb) {
            breadcrumb.innerHTML = '<a href="#/dashboard">Главная</a> / <a href="#/invoices">Финансы</a> / Счета';
        }
        
        // Обновить title страницы
        document.title = 'Счета - RoyalPark Admin';
    }
    
    // Load payment on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => loadPayment(paymentId));
    } else {
        loadPayment(paymentId);
    }
})();
</script>

