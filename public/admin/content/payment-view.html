<style>
    .payment-view-page {
        padding: 20px;
    }

    .payment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .payment-header-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .payment-header h1 {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
    }

    .btn-back {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-back:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        color: #ffffff;
    }

    .payment-summary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .payment-summary-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .payment-summary-item label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 500;
    }

    .payment-summary-item .value {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
    }

    .payment-summary-item .value.amount {
        background: rgba(36, 40, 49, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        padding: 8px 12px;
        display: inline-block;
        width: fit-content;
    }

    .payment-summary-item .value.balance {
        display: inline-block;
        width: fit-content;
    }

    .badge-advance {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .distribution-section,
    .applications-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .distribution-section h3,
    .applications-section h3 {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .distribution-form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
    }

    .distribution-form-group label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }

    .distribution-form-group select {
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        color: #fefefe;
        font-size: 0.95rem;
    }

    .distribution-form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        background: rgba(255, 255, 255, 0.08);
    }

    .distribution-form-group select option {
        background: #1f2432;
        color: #f6f7ff;
    }

    .no-accounts {
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
        padding: 10px 0;
    }

    .distribution-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        align-items: center;
    }

    .distribution-info {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }

    .distribution-info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .distribution-info-item label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .distribution-info-item .value {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
    }

    .btn-primary {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        transform: translateY(-1px);
    }

    .applications-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .applications-table thead th {
        text-align: left;
        padding: 12px 16px;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .applications-table tbody td {
        padding: 12px 16px;
        color: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .applications-table tbody tr:last-child td {
        border-bottom: none;
    }

    .account-link {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
    }

    .account-link:hover {
        color: #764ba2;
        text-decoration: underline;
    }

    .amount-value {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
    }

    [data-theme="dark"] .payment-view-page,
    body[data-theme="dark"] .payment-view-page,
    html[data-theme="dark"] .payment-view-page {
        background: transparent;
        color: #e4e6eb;
    }

</style>

<div class="content-wrapper payment-view-page">
    <div class="payment-header">
        <div class="payment-header-left">
            <button class="btn-back" onclick="goBackToPayments()">
                <i class="bi bi-arrow-left"></i> Назад
            </button>
            <h1 id="paymentTitle">Платеж #1</h1>
        </div>
    </div>

    <!-- Payment Summary -->
    <div class="payment-summary" id="paymentSummary">
        <div class="payment-summary-item">
            <label>Резидент</label>
            <div class="value" id="paymentResident">X / 2</div>
        </div>
        <div class="payment-summary-item">
            <label>Ссылка / Комментарий</label>
            <div class="value" id="paymentLink">123456</div>
        </div>
        <div class="payment-summary-item">
            <label>Дата</label>
            <div class="value" id="paymentDate">2025-11-21</div>
        </div>
        <div class="payment-summary-item">
            <label>Метод</label>
            <div class="value" id="paymentMethod">CARD</div>
        </div>
        <div class="payment-summary-item">
            <label>Сумма</label>
            <div class="value amount" id="paymentAmount">30.00</div>
        </div>
        <div class="payment-summary-item">
            <label>Остаток</label>
            <div class="value balance">
                <span class="badge-advance" id="paymentBalance">Аванс 20.00</span>
            </div>
        </div>
    </div>

    <!-- Distribution Section -->
    <div class="distribution-section">
        <h3>Распределение по счетам</h3>
        <div class="distribution-form-group">
            <label>Счёт (период)</label>
            <select id="distributionAccount">
                <option value="">Нет открытых счетов</option>
            </select>
            <div class="no-accounts" id="noAccountsMessage" style="display: none;">Нет открытых счетов</div>
        </div>
        <div class="distribution-actions">
            <button class="btn-primary" onclick="saveDistribution()">Сохранить распределение</button>
            <button class="btn-primary" onclick="autoDistribute()">Автораспределить</button>
        </div>
        <div class="distribution-info">
            <div class="distribution-info-item">
                <label>Осталось оплатить</label>
                <div class="value" id="remainingToPay">20.00</div>
            </div>
            <div class="distribution-info-item">
                <label>Применить</label>
                <div class="value" id="applyAmount">0.00</div>
            </div>
        </div>
    </div>

    <!-- Applications Section -->
    <div class="applications-section">
        <h3>Применения</h3>
        <table class="applications-table">
            <thead>
                <tr>
                    <th>Счёт</th>
                    <th>Сумма</th>
                </tr>
            </thead>
            <tbody id="applicationsTable">
                <tr>
                    <td>
                        <a href="#" class="account-link" onclick="viewInvoice(event, '2025-11/000001')">2025-11/000001</a>
                    </td>
                    <td class="amount-value">10.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    // Get payment ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const paymentId = urlParams.get('id') || window.location.hash.split('/').pop() || window.location.hash.split('=').pop();
    
    // Load payment data
    function loadPayment(id) {
        // TODO: Load from API
        // For now, use mock data
        const payment = {
            id: id || 1,
            resident: 'X / 2',
            link: '123456',
            date: '2025-11-21',
            method: 'CARD',
            amount: 30.00,
            balance: 20.00,
            balanceType: 'advance',
            applications: [
                { account: '2025-11/000001', amount: 10.00, invoiceId: 1 }
            ]
        };
        
        renderPayment(payment);
    }
    
    function renderPayment(payment) {
        // Update title
        document.getElementById('paymentTitle').textContent = `Платеж #${payment.id}`;
        
        // Update summary
        document.getElementById('paymentResident').textContent = payment.resident;
        document.getElementById('paymentLink').textContent = payment.link || '-';
        document.getElementById('paymentDate').textContent = payment.date;
        document.getElementById('paymentMethod').textContent = payment.method;
        document.getElementById('paymentAmount').textContent = payment.amount.toFixed(2);
        
        // Update balance badge
        const balanceEl = document.getElementById('paymentBalance');
        if (payment.balanceType === 'advance') {
            balanceEl.textContent = `Аванс ${payment.balance.toFixed(2)}`;
            balanceEl.className = 'badge-advance';
        } else {
            balanceEl.textContent = payment.balance.toFixed(2);
            balanceEl.className = 'badge-debt';
        }
        
        // Update distribution info
        document.getElementById('remainingToPay').textContent = payment.balance.toFixed(2);
        const totalApplied = payment.applications.reduce((sum, app) => sum + app.amount, 0);
        document.getElementById('applyAmount').textContent = totalApplied.toFixed(2);
        
        // Update applications table
        const tbody = document.getElementById('applicationsTable');
        if (payment.applications && payment.applications.length > 0) {
            tbody.innerHTML = payment.applications.map(app => `
                <tr>
                    <td>
                        <a href="#" class="account-link" onclick="viewInvoice(event, '${app.account}')">${app.account}</a>
                    </td>
                    <td class="amount-value">${app.amount.toFixed(2)}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Нет применений</td></tr>';
        }
        
        // Update distribution account dropdown
        // TODO: Load available accounts from API
        const accountSelect = document.getElementById('distributionAccount');
        if (!payment.applications || payment.applications.length === 0) {
            accountSelect.innerHTML = '<option value="">Нет открытых счетов</option>';
            document.getElementById('noAccountsMessage').style.display = 'block';
        }
    }
    
    window.goBackToPayments = function() {
        // Navigate back to payments list
        if (window.router && typeof window.router.navigate === 'function') {
            window.router.navigate('/payments');
        } else {
            // Fallback: reload payments page
            const contentContainer = document.getElementById('spa-content');
            if (contentContainer) {
                fetch('/admin/content/payments.html')
                    .then(response => response.text())
                    .then(html => {
                        contentContainer.innerHTML = html;
                        const scripts = contentContainer.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                        
                        // Update page header
                        if (typeof updatePageHeaderForPayments === 'function') {
                            updatePageHeaderForPayments();
                        }
                        
                        if (window.history && window.history.pushState) {
                            window.history.pushState({ route: 'payments' }, '', '#/payments');
                        }
                    });
            } else {
                window.location.href = '/admin/#/payments';
            }
        }
    };
    
    // Update page header when payment view loads
    function updatePageHeaderForPaymentsView() {
        const pageTitle = document.querySelector('.page-title');
        const breadcrumb = document.querySelector('.breadcrumb');
        
        if (pageTitle) {
            pageTitle.textContent = 'Платежи';
        }
        
        if (breadcrumb) {
            breadcrumb.innerHTML = '<a href="#/dashboard">Главная</a> / <a href="#/payments">Финансы</a> / Платежи';
        }
    }
    
    // Update page header when loaded in SPA
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updatePageHeaderForPaymentsView);
    } else {
        updatePageHeaderForPaymentsView();
    }
    
    window.saveDistribution = function() {
        const accountId = document.getElementById('distributionAccount').value;
        const applyAmount = parseFloat(document.getElementById('applyAmount').textContent) || 0;
        
        if (!accountId) {
            if (typeof showWarning === 'function') {
                showWarning('Пожалуйста, выберите счёт!');
            }
            return;
        }
        
        if (applyAmount <= 0) {
            if (typeof showWarning === 'function') {
                showWarning('Сумма применения должна быть больше нуля!');
            }
            return;
        }
        
        console.log('Saving distribution:', { accountId, applyAmount });
        // TODO: Save via API
        
        if (typeof showSuccess === 'function') {
            showSuccess('Распределение успешно сохранено!');
        }
    };
    
    window.autoDistribute = function() {
        const remaining = parseFloat(document.getElementById('remainingToPay').textContent) || 0;
        
        if (remaining <= 0) {
            if (typeof showWarning === 'function') {
                showWarning('Нет остатка для распределения!');
            }
            return;
        }
        
        console.log('Auto-distributing:', remaining);
        // TODO: Implement auto-distribution logic via API
        
        if (typeof showSuccess === 'function') {
            showSuccess('Автораспределение выполнено!');
        }
    };
    
    window.viewInvoice = function(event, invoiceNumber) {
        if (event) {
            event.preventDefault();
        }
        
        console.log('Opening invoice view for invoice number:', invoiceNumber);
        
        // Extract invoice ID from invoice number
        // Format: "2025-11/000001" -> extract "000001" or use full number
        // For now, extract the last part after "/"
        let invoiceId = invoiceNumber;
        if (invoiceNumber && invoiceNumber.includes('/')) {
            const parts = invoiceNumber.split('/');
            invoiceId = parts[parts.length - 1]; // Get last part (e.g., "000001")
        }
        
        // Загрузить страницу просмотра через fetch и вставить в SPA контейнер
        const viewUrl = `/admin/content/invoice-view.html?id=${invoiceId}`;
        const contentContainer = document.getElementById('spa-content');
        
        if (!contentContainer) {
            console.error('SPA content container not found');
            window.location.href = viewUrl;
            return;
        }
        
        // Показать состояние загрузки
        contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.8);"><i class="bi bi-hourglass-split" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Загрузка...</p></div>';
        
        // Загрузить контент
        fetch(viewUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // Вставить контент
                contentContainer.innerHTML = html;
                
                // Выполнить скрипты из загруженного контента
                const scripts = contentContainer.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                
                // Обновить заголовок страницы и breadcrumb
                updatePageHeaderForInvoiceView(invoiceId);
                
                // Обновить URL в браузере
                if (window.history && window.history.pushState) {
                    window.history.pushState({ route: 'invoice-view', id: invoiceId }, '', `#/invoice-view?id=${invoiceId}`);
                }
                
                // Скроллить наверх
                contentContainer.scrollTop = 0;
                
                console.log('Invoice view loaded successfully');
            })
            .catch(error => {
                console.error('Error loading invoice view:', error);
                contentContainer.innerHTML = `<div style="padding: 40px; text-align: center; color: #ff6b6b;"><p>Ошибка загрузки страницы: ${error.message}</p><button onclick="window.location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">Перезагрузить</button></div>`;
            });
    };
    
    // Функция для обновления заголовка и breadcrumb при открытии просмотра счета
    function updatePageHeaderForInvoiceView(invoiceId) {
        // Обновить заголовок страницы
        const pageTitle = document.querySelector('.page-title');
        const breadcrumb = document.querySelector('.breadcrumb');
        
        if (pageTitle) {
            pageTitle.textContent = 'Счета';
        }
        
        if (breadcrumb) {
            breadcrumb.innerHTML = '<a href="#/dashboard">Главная</a> / <a href="#/invoices">Финансы</a> / Счета';
        }
        
        // Обновить title страницы
        document.title = 'Счета - RoyalPark Admin';
    }
    
    // Load payment on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => loadPayment(paymentId));
    } else {
        loadPayment(paymentId);
    }
})();
</script>

