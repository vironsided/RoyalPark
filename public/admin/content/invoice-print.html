<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin/content_css/invoice-print.css">

</head>

<body>
    <div class="print-actions">
        <button class="btn-print" onclick="window.print()">
            <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
        </button>
    </div>

    <div class="print-container invoice-template">
        <div class="invoice-title-row">
            <div class="invoice-title">INVOICE ‚Ññ <span id="invoiceNumber">‚Äî</span></div>
            <div class="invoice-date" id="invoiceDate">‚Äî</div>
        </div>

        <div class="invoice-parties">
            <div class="party-block">
                <div class="party-name" id="invoiceResident">‚Äî</div>
                <div class="party-line" id="invoiceResidentUser">‚Äî</div>
            </div>
            <div class="party-block">
                <div class="party-line">–ü–µ—Ä–∏–æ–¥: <span id="invoicePeriod">‚Äî</span></div>
                <div class="party-line">–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã: <span id="invoiceDueDate">‚Äî</span></div>
                <div class="party-line">–°—Ç–∞—Ç—É—Å: <span id="invoiceStatus">‚Äî</span></div>
            </div>
        </div>

        <table class="invoice-table invoice-lines">
            <thead>
                <tr>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ</th>
                    <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
                    <th>–ù–î–°</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                </tr>
            </thead>
            <tbody id="lineItemsTable">
                <tr><td colspan="5">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>

        <div class="invoice-totals">
            <div class="totals-row">
                <span>Total:</span>
                <span id="invoiceTotalNet">0.00</span>
            </div>
            <div class="totals-row">
                <span>VAT:</span>
                <span id="invoiceTotalVat">0.00</span>
            </div>
            <div class="totals-row totals-strong">
                <span>Total payment:</span>
                <span id="invoiceTotal">0.00</span>
            </div>
        </div>

        <div class="invoice-footer">
            <p>–ö–≤–∏—Ç–∞–Ω—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: <span id="generatedDate"></span></p>
            <p>–î–ª—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–≤–µ—Ä—Ö—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–ü–µ—á–∞—Ç—å –≤ PDF¬ª.</p>
        </div>
    </div>

    <script>
        (function () {
            const API_BASE = 'http://localhost:8000';

            // Get invoice ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let invoiceId = urlParams.get('id');

            // If not in query params, try to extract from path
            if (!invoiceId) {
                const pathParts = window.location.pathname.split('/');
                invoiceId = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
            }

            // Clean up invoiceId
            if (invoiceId) {
                invoiceId = invoiceId.toString().trim();
                if (isNaN(invoiceId) || invoiceId === '') {
                    invoiceId = null;
                }
            }

            console.log('üìÑ Print page - invoice ID:', invoiceId);

            function resetPrintPlaceholders() {
                const set = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                set('invoiceNumber', '‚Äî');
                set('invoiceDate', '‚Äî');
                set('invoiceResident', '‚Äî');
                set('invoiceResidentUser', '‚Äî');
                set('invoicePeriod', '‚Äî');
                set('invoiceDueDate', '‚Äî');
                set('invoiceStatus', '‚Äî');
                set('invoiceTotal', '0.00');
                set('invoiceTotalNet', '0.00');
                set('invoiceTotalVat', '0.00');
                const tbody = document.getElementById('lineItemsTable');
                if (tbody) tbody.innerHTML = '<tr><td colspan="5">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            }

            // Load invoice data
            async function loadInvoice(id) {
                resetPrintPlaceholders();
                if (!id) {
                    console.error('No invoice ID provided for print');
                    document.body.innerHTML = '<div style="padding: 40px; text-align: center;"><h2>–û—à–∏–±–∫–∞</h2><p>–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞</p></div>';
                    return;
                }

                try {
                    let url = `${API_BASE}/api/invoices/${id}`;
                    let response = await fetch(url, { credentials: 'include' });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    console.log('üìÑ API response for print:', {
                        amount_total: data.amount_total,
                        paid_amount: data.paid_amount,
                        remaining_amount: data.remaining_amount,
                        lines_count: data.lines?.length || 0,
                        lines_sum: data.lines?.reduce((sum, line) => sum + (line.amount_total || 0), 0) || 0
                    });

                    // Transform API data to frontend format
                    const invoice = {
                        id: data.id,
                        invoiceNumber: data.number || `${data.period_year}-${String(data.period_month).padStart(2, '0')}/000000`,
                        resident: data.resident_code,
                        residentUser: data.resident_user_full_name || null,
                        period: formatPeriod(data),
                        status: data.status,
                        dueDate: data.due_date || null,
                        total: Number(data.amount_total || 0),
                        netTotal: Number(data.amount_net || 0),
                        vatTotal: Number(data.amount_vat || 0),
                        lineItems: data.lines || []
                    };

                    renderInvoice(invoice);
                } catch (error) {
                    console.error('Error loading invoice for print:', error);
                    document.body.innerHTML = `<div style="padding: 40px; text-align: center;"><h2>–û—à–∏–±–∫–∞</h2><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞: ${error.message}</p></div>`;
                }
            }

            function formatPeriod(data) {
                if (data?.period_dates?.from && data?.period_dates?.to) {
                    return `${data.period_dates.from} - ${data.period_dates.to}`;
                }
                return `${data.period_year}-${String(data.period_month).padStart(2, '0')}`;
            }

            function extractConsumption(description) {
                if (!description) return { label: '‚Äî', consumed: '‚Äî' };
                const isSewerageLine = /^(?:meter_sewerage\b|–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è(?:\s*\(–∞–≤—Ç–æ\))?\b)/i.test(String(description).trim());
                const keyMatch = String(description).match(/^(meter_[a-z_]+)\s+([\d.]+)\s*(.*)$/i);
                if (keyMatch) {
                    const key = keyMatch[1];
                    const qty = keyMatch[2];
                    const unit = (keyMatch[3] || '').trim();
                    const map = {
                        meter_electricity: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ',
                        meter_cold_water: '–í–æ–¥–∞',
                        meter_hot_water: '–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞',
                        meter_gas: '–ì–∞–∑',
                        meter_sewerage: '–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è',
                    };
                    if (key === 'meter_sewerage') {
                        return { label: map[key] || key, consumed: '‚Äî' };
                    }
                    return { label: map[key] || key, consumed: `${qty}${unit ? ' ' + unit : ''}`.trim() };
                }
                const patterns = [
                    { regex: /^–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ\s+([\d.]+)\s*–∫–í—Ç¬∑—á$/i, label: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', unit: '–∫–í—Ç¬∑—á' },
                    { regex: /^–í–æ–¥–∞\s+([\d.]+)\s*–º¬≥$/i, label: '–í–æ–¥–∞', unit: '–º¬≥' },
                    { regex: /^–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è(?:\s*\(–∞–≤—Ç–æ\))?\s+([\d.]+)\s*–º¬≥$/i, label: '–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è', unit: '–º¬≥' },
                    { regex: /^–ì–∞–∑\s+([\d.]+)\s*–º¬≥$/i, label: '–ì–∞–∑', unit: '–º¬≥' },
                    { regex: /^–ì–æ—Ä—è—á–∞—è\s+–≤–æ–¥–∞\s+([\d.]+)\s*–º¬≥$/i, label: '–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞', unit: '–º¬≥' },
                ];
                for (const p of patterns) {
                    const m = String(description).match(p.regex);
                    if (m) {
                        if (/–∫–∞–Ω–∞–ª–∏–∑–∞—Ü/i.test(p.label) || isSewerageLine) {
                            return { label: '–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è', consumed: '‚Äî' };
                        }
                        return { label: p.label, consumed: `${m[1]} ${p.unit}` };
                    }
                }
                if (isSewerageLine) return { label: '–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è', consumed: '‚Äî' };
                if (/—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ/i.test(String(description))) return { label: String(description), consumed: '‚Äî' };
                return { label: String(description), consumed: '‚Äî' };
            }

            function renderInvoice(invoice) {
                document.getElementById('invoiceNumber').textContent = invoice.invoiceNumber;
                document.getElementById('invoiceResident').textContent = invoice.resident;
                const userEl = document.getElementById('invoiceResidentUser');
                if (userEl) userEl.textContent = invoice.residentUser || '‚Äî';
                document.getElementById('invoicePeriod').textContent = invoice.period;
                const statusMap = { DRAFT: '–ß–µ—Ä–Ω–æ–≤–∏–∫', ISSUED: '–í—ã—Å—Ç–∞–≤–ª–µ–Ω', PARTIAL: '–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω', PAID: '–û–ø–ª–∞—á–µ–Ω', CANCELED: '–û—Ç–º–µ–Ω–µ–Ω' };
                document.getElementById('invoiceStatus').textContent = statusMap[invoice.status] || invoice.status;

                // Format due date for display
                let dueDateDisplay = '‚Äî';
                if (invoice.dueDate) {
                    const date = new Date(invoice.dueDate);
                    dueDateDisplay = date.toLocaleDateString('ru-RU');
                }
                document.getElementById('invoiceDueDate').textContent = dueDateDisplay;
                document.getElementById('invoiceTotal').textContent = invoice.total.toFixed(2);
                document.getElementById('invoiceTotalNet').textContent = invoice.netTotal.toFixed(2);
                document.getElementById('invoiceTotalVat').textContent = invoice.vatTotal.toFixed(2);
                const dateEl = document.getElementById('invoiceDate');
                if (dateEl) dateEl.textContent = dueDateDisplay;

                console.log('üìÑ Print invoice data:', {
                    total: invoice.total,
                    paidAmount: invoice.paidAmount,
                    remainingAmount: invoice.remainingAmount,
                    lineItemsCount: invoice.lineItems.length
                });

                // Render line items
                const tbody = document.getElementById('lineItemsTable');
                if (invoice.lineItems && invoice.lineItems.length > 0) {
                    let html = invoice.lineItems.map(item => {
                        const parsed = extractConsumption(item.description || '');
                        return `
                        <tr>
                            <td>${parsed.label}</td>
                            <td>${parsed.consumed}</td>
                            <td>${(item.amount_net || 0).toFixed(2)}</td>
                            <td>${(item.amount_vat || 0).toFixed(2)}</td>
                            <td>${(item.amount_total || 0).toFixed(2)}</td>
                        </tr>
                    `;
                    }).join('');

                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                // Set generated date
                const now = new Date();
                document.getElementById('generatedDate').textContent = now.toLocaleString('ru-RU');
            }

            // Load invoice on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => loadInvoice(invoiceId));
            } else {
                loadInvoice(invoiceId);
            }
        })();
    </script>
</body>

</html>