<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin/content_css/invoice-print.css">

</head>

<body>
    <div class="print-actions">
        <button class="btn-print" onclick="window.print()">
            <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
        </button>
    </div>

    <div class="print-container">
        <div class="print-header">
            <h1>–°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É</h1>
        </div>

        <div class="invoice-info">
            <div class="invoice-info-left">
                <div class="info-item">
                    <label>‚Ññ</label>
                    <div class="value" id="invoiceNumber">2025-11/000001</div>
                </div>
                <div class="info-item">
                    <label>–†–µ–∑–∏–¥–µ–Ω—Ç</label>
                    <div class="value" id="invoiceResident">–• / 2</div>
                </div>
                <div class="info-item">
                    <label>–ü–µ—Ä–∏–æ–¥</label>
                    <div class="value" id="invoicePeriod">2025-11</div>
                </div>
                <div class="info-item">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <div class="value" id="invoiceStatus">DRAFT</div>
                </div>
            </div>
            <div class="invoice-info-right">
                <div class="info-item">
                    <label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label>
                    <div class="value" id="invoiceDueDate">‚Äî</div>
                </div>
                <div class="info-item">
                    <label>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</label>
                    <div class="value" id="invoiceTotal" style="font-size: 18px; color: #000;">10.00</div>
                </div>
            </div>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
                    <th>–ù–î–°</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                </tr>
            </thead>
            <tbody id="lineItemsTable">
                <tr>
                    <td>–ì–∞–∑ 20.0 –º¬≥</td>
                    <td>10.00</td>
                    <td>0.00</td>
                    <td>10.00</td>
                </tr>
                <tr class="total-row">
                    <td colspan="3">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</td>
                    <td class="total-value">10.00</td>
                </tr>
            </tbody>
        </table>

        <div class="invoice-footer">
            <p>–ö–≤–∏—Ç–∞–Ω—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: <span id="generatedDate"></span></p>
            <p>–î–ª—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–≤–µ—Ä—Ö—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–ü–µ—á–∞—Ç—å –≤ PDF¬ª.</p>
        </div>
    </div>

    <script>
        (function () {
            const API_BASE = 'http://localhost:8000';

            // Get invoice ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let invoiceId = urlParams.get('id');

            // If not in query params, try to extract from path
            if (!invoiceId) {
                const pathParts = window.location.pathname.split('/');
                invoiceId = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
            }

            // Clean up invoiceId
            if (invoiceId) {
                invoiceId = invoiceId.toString().trim();
                if (isNaN(invoiceId) || invoiceId === '') {
                    invoiceId = null;
                }
            }

            console.log('üìÑ Print page - invoice ID:', invoiceId);

            // Load invoice data
            async function loadInvoice(id) {
                if (!id) {
                    console.error('No invoice ID provided for print');
                    document.body.innerHTML = '<div style="padding: 40px; text-align: center;"><h2>–û—à–∏–±–∫–∞</h2><p>–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—á–µ—Ç–∞</p></div>';
                    return;
                }

                try {
                    let url = `${API_BASE}/api/invoices/${id}`;
                    let response = await fetch(url);

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            url = `${API_BASE}/api/invoices/${id}/public`;
                            response = await fetch(url);
                        }
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    console.log('üìÑ API response for print:', {
                        amount_total: data.amount_total,
                        paid_amount: data.paid_amount,
                        remaining_amount: data.remaining_amount,
                        lines_count: data.lines?.length || 0,
                        lines_sum: data.lines?.reduce((sum, line) => sum + (line.amount_total || 0), 0) || 0
                    });

                    // Transform API data to frontend format
                    const invoice = {
                        id: data.id,
                        invoiceNumber: data.number || `${data.period_year}-${String(data.period_month).padStart(2, '0')}/000000`,
                        resident: data.resident_code,
                        period: `${data.period_year}-${String(data.period_month).padStart(2, '0')}`,
                        status: data.status,
                        dueDate: data.due_date || null,
                        total: data.amount_total, // –ü–æ–ª–Ω–∞—è —Å—É–º–º–∞ —Å—á–µ—Ç–∞ (–∫–∞–∫ –≤ backend —à–∞–±–ª–æ–Ω–µ)
                        paidAmount: data.paid_amount || 0, // –û–ø–ª–∞—á–µ–Ω–Ω–∞—è —Å—É–º–º–∞
                        remainingAmount: data.remaining_amount || data.amount_total, // –û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ
                        lineItems: data.lines || []
                    };

                    renderInvoice(invoice);
                } catch (error) {
                    console.error('Error loading invoice for print:', error);
                    document.body.innerHTML = `<div style="padding: 40px; text-align: center;"><h2>–û—à–∏–±–∫–∞</h2><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞: ${error.message}</p></div>`;
                }
            }

            function renderInvoice(invoice) {
                document.getElementById('invoiceNumber').textContent = invoice.invoiceNumber;
                document.getElementById('invoiceResident').textContent = invoice.resident;
                document.getElementById('invoicePeriod').textContent = invoice.period;
                document.getElementById('invoiceStatus').textContent = invoice.status;

                // Format due date for display
                let dueDateDisplay = '‚Äî';
                if (invoice.dueDate) {
                    const date = new Date(invoice.dueDate);
                    dueDateDisplay = date.toLocaleDateString('ru-RU');
                }
                document.getElementById('invoiceDueDate').textContent = dueDateDisplay;
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É —Å—á–µ—Ç–∞ (amount_total), –∫–∞–∫ –≤ backend —à–∞–±–ª–æ–Ω–µ
                document.getElementById('invoiceTotal').textContent = invoice.total.toFixed(2);

                console.log('üìÑ Print invoice data:', {
                    total: invoice.total,
                    paidAmount: invoice.paidAmount,
                    remainingAmount: invoice.remainingAmount,
                    lineItemsCount: invoice.lineItems.length
                });

                // Render line items
                const tbody = document.getElementById('lineItemsTable');
                if (invoice.lineItems && invoice.lineItems.length > 0) {
                    let html = invoice.lineItems.map(item => `
                        <tr>
                            <td>${item.description || '‚Äî'}</td>
                            <td>${(item.amount_net || 0).toFixed(2)}</td>
                            <td>${(item.amount_vat || 0).toFixed(2)}</td>
                            <td>${(item.amount_total || 0).toFixed(2)}</td>
                        </tr>
                    `).join('');

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É —Å—á–µ—Ç–∞ (invoice.total), –∞ –Ω–µ —Å—É–º–º—É —Å—Ç—Ä–æ–∫
                    // –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ backend —à–∞–±–ª–æ–Ω–∞ invoice_pdf.html
                    const total = invoice.total; // amount_total –∏–∑ API
                    html += `
                        <tr class="total-row">
                            <td colspan="3">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</td>
                            <td class="total-value">${total.toFixed(2)}</td>
                        </tr>
                    `;

                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                // Set generated date
                const now = new Date();
                document.getElementById('generatedDate').textContent = now.toLocaleString('ru-RU');
            }

            // Load invoice on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => loadInvoice(invoiceId));
            } else {
                loadInvoice(invoiceId);
            }
        })();
    </script>
</body>

</html>