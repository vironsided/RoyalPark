<link rel="stylesheet" href="/admin/content_css/users.css">
<div class="content-wrapper">
    <div class="users-header">
        <h2>Пользователи</h2>
    </div>
    
    <!-- Create User Form -->
    <div class="user-create-form">
        <input 
            type="text" 
            id="newUserLogin" 
            placeholder="Логин нового пользователя"
            autocomplete="off"
        />
        <select id="newUserRole">
            <option value="ADMIN">ADMIN</option>
            <option value="OPERATOR">OPERATOR</option>
            <option value="RESIDENT">RESIDENT</option>
            <option value="ROOT">ROOT</option>
        </select>
        <button class="btn-create-user" onclick="createUser()">
            Создать
        </button>
    </div>
    
    <!-- Users Table -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Логин</th>
                    <th>Роль</th>
                    <th>Последний вход</th>
                    <th>Пароль</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal-overlay" id="qrModal">
    <div class="modal-content qr-modal-content">
        <div class="modal-header">
            <h2>QR-код для пользователя</h2>
            <button class="modal-close" onclick="closeQRModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body qr-modal-body">
            <div id="qrCodeContainer" style="text-align: center; padding: 20px;">
                <canvas id="qrCanvas" style="max-width: 100%; height: auto;"></canvas>
            </div>
            <p style="text-align: center; color: #666; margin-top: 15px;">
                Пользователь должен отсканировать этот QR-код для установки пароля
            </p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="printQRCode()">Print</button>
            <button class="btn btn-secondary" onclick="closeQRModal()">Закрыть</button>
        </div>
    </div>
</div>

<!-- jsPDF library for PDF generation -->
<script src="../../js/jsPDF.js"></script>
<script>
    // Функция для динамической загрузки jsPDF (резервный вариант)
    window.loadJSPDFLibrary = function() {
        return new Promise((resolve, reject) => {
            // Проверяем, не загружена ли уже библиотека
            const checkLibrary = () => {
                if (typeof window.jspdf !== 'undefined') {
                    if (window.jspdf.jsPDF || typeof window.jspdf === 'function') {
                        return true;
                    }
                }
                if (typeof window.jsPDF !== 'undefined') {
                    return true;
                }
                return false;
            };
            
            if (checkLibrary()) {
                resolve();
                return;
            }
            
            // Проверяем, не загружается ли уже скрипт
            const existingScript = document.querySelector('script[src*="jspdf"]');
            if (existingScript) {
                // Ждем загрузки существующего скрипта
                const checkInterval = setInterval(() => {
                    if (checkLibrary()) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!checkLibrary()) {
                        reject(new Error('jsPDF не загрузилась в течение 5 секунд'));
                    }
                }, 5000);
                return;
            }
            
            // Загружаем библиотеку
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = () => {
                // Ждем немного, чтобы библиотека инициализировалась
                let attempts = 0;
                const maxAttempts = 50; // 5 секунд
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (checkLibrary()) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('jsPDF не инициализировалась после загрузки'));
                    }
                }, 100);
            };
            script.onerror = () => reject(new Error('Не удалось загрузить jsPDF'));
            document.head.appendChild(script);
        });
    };
    
    // Предзагружаем библиотеку при загрузке страницы
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.loadJSPDFLibrary);
    } else {
        window.loadJSPDFLibrary();
    }
</script>

<script>
(function() {
    // Текущий список пользователей из backend
    let users = [];
    
    // Сохраняем данные текущего пользователя для печати
    let currentQRUserData = {
        username: null,
        tempPassword: null,
        qrUrl: null
    };
    
    const API_BASE = window.BACKEND_API_BASE || 'http://localhost:8000';
    
    async function fetchUsers() {
        try {
            // Сначала пробуем с авторизацией
            let resp = await fetch(`${API_BASE}/api/users`, { credentials: 'include' });
            // Если 401, пробуем временный публичный endpoint
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/public`);
            }
            if (!resp.ok) throw new Error(`Failed to load users: ${resp.status}`);
            users = await resp.json();
        } catch (e) {
            console.error('Users API error:', e);
            users = [];
        }
    }
    
    // Load users on page load
    async function loadUsers() {
        await fetchUsers();
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        users.forEach(user => {
            const row = document.createElement('tr');
            
            // Get role badge class
            const roleClass = `role-${String(user.role).toLowerCase()}`;
            
            // Password badge
            let passwordBadge = '';
            const passwordStatus = user.require_password_change ? 'temp' : 'set';
            const tempPassword = user.temp_password_plain;
            
            if (passwordStatus === 'set') {
                passwordBadge = '<span class="password-badge password-set">установлен</span>';
            } else if (passwordStatus === 'temp' && tempPassword) {
                passwordBadge = `<span class="password-badge password-temp">временный: ${tempPassword}</span>`;
            }
            
            // Actions (only for non-root users)
            let actions = '';
            if (user.username !== 'root') {
                actions = `
                    <div class="user-actions">
                        <button class="btn-user-action btn-reset-password" onclick="resetPassword(${user.id})">
                            Сброс пароля
                        </button>
                        <input 
                            type="text" 
                            class="input-new-name" 
                            id="newName${user.id}" 
                            placeholder="Новое имя"
                            autocomplete="off"
                        />
                        <button class="btn-user-action btn-rename-user" onclick="renameUser(${user.id})">
                            Переимен.
                        </button>
                        <button class="btn-user-action btn-delete-user" onclick="deleteUser(${user.id})">
                            Удалить
                        </button>
                        ${user.require_password_change && user.temp_password_plain ? `
                        <button class="btn-user-action btn-qr-user" onclick="showQRCode(${user.id}, '${user.username}', '${user.temp_password_plain}')">
                            QR
                        </button>
                        ` : ''}
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td><span class="role-badge ${roleClass}">RoleEnum.${user.role}</span></td>
                <td>${user.last_login_at || '—'}</td>
                <td>${passwordBadge}</td>
                <td>${actions}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Create user через backend API
    window.createUser = async function() {
        const loginInput = document.getElementById('newUserLogin');
        const roleSelect = document.getElementById('newUserRole');
        
        if (!loginInput || !roleSelect) return;
        
        const login = loginInput.value.trim();
        const role = roleSelect.value;
        
        if (!login) {
            if (window.showWarning) {
                showWarning('⚠️ Введите логин пользователя');
            } else {
                alert('Введите логин пользователя');
            }
            return;
        }
        
        try {
            // Сначала пробуем с авторизацией
            let resp = await fetch(`${API_BASE}/api/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    username: login,
                    role: role,
                    full_name: null,
                    phone: null,
                    email: null
                })
            });
            // Если 401, пробуем временный публичный endpoint
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/public`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: login,
                        role: role,
                        full_name: null,
                        phone: null,
                        email: null
                    })
                });
            }
            if (!resp.ok) {
                const errorText = await resp.text();
                throw new Error(`Failed to create user: ${resp.status} - ${errorText}`);
            }
            const created = await resp.json();
            
            await loadUsers();
            
            loginInput.value = '';
            roleSelect.value = 'ADMIN';
            
            const tempPassword = created.temp_password_plain || 'установлен';
            if (window.showSuccess) {
                showSuccess(`✅ Пользователь "${login}" создан! Временный пароль: ${tempPassword}`);
            } else {
                alert(`Пользователь создан!\nЛогин: ${login}\nВременный пароль: ${tempPassword}`);
            }
        } catch (e) {
            console.error('Create user error:', e);
            if (window.showError) {
                showError('❌ Не удалось создать пользователя');
            } else {
                alert('Не удалось создать пользователя');
            }
        }
    };
    
    // Reset password
    window.resetPassword = async function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (user.username === 'root') {
            if (window.showWarning) {
                showWarning('⚠️ Невозможно сбросить пароль для root');
            }
            return;
        }
        
        try {
            let resp = await fetch(`${API_BASE}/api/users/${userId}/reset`, {
                method: 'POST',
                credentials: 'include'
            });
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/${userId}/reset/public`, {
                    method: 'POST'
                });
            }
            if (!resp.ok) throw new Error('Failed to reset password');
            const updated = await resp.json();
            
            await loadUsers();
            
            const tempPassword = updated.temp_password_plain || 'временный пароль обновлён';
            if (window.showSuccess) {
                showSuccess(`✅ Пароль сброшен! Новый временный пароль: ${tempPassword}`);
            } else {
                alert(`Пароль сброшен!\nНовый временный пароль: ${tempPassword}`);
            }
        } catch (e) {
            console.error('Reset password error:', e);
            if (window.showError) {
                showError('❌ Не удалось сбросить пароль');
            } else {
                alert('Не удалось сбросить пароль');
            }
        }
    };
    
    // Rename user
    window.renameUser = async function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const newNameInput = document.getElementById(`newName${userId}`);
        if (!newNameInput) return;
        
        const newName = newNameInput.value.trim();
        
        if (!newName) {
            if (window.showWarning) {
                showWarning('⚠️ Введите новое имя');
            } else {
                alert('Введите новое имя');
            }
            return;
        }
        
        try {
            let resp = await fetch(`${API_BASE}/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ username: newName })
            });
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/${userId}/public`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: newName })
                });
            }
            if (!resp.ok) throw new Error('Failed to rename user');
            await loadUsers();
            
            if (window.showSuccess) {
                showSuccess(`✅ Пользователь "${user.username}" переименован в "${newName}"`);
            } else {
                alert(`Пользователь переименован: ${user.username} → ${newName}`);
            }
        } catch (e) {
            console.error('Rename user error:', e);
            if (window.showError) {
                showError('❌ Не удалось переименовать пользователя');
            } else {
                alert('Не удалось переименовать пользователя');
            }
        }
    };
    
    // Функция генерации QR-кода через Google Charts API (работает без внешних библиотек)
    function generateQRCodeImage(qrUrl, canvas) {
        // Используем Google Charts API для генерации QR-кода
        const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrUrl)}`;
        
        // Создаем изображение
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = function() {
            const ctx = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 300;
            ctx.drawImage(img, 0, 0);
            
            // Показываем модальное окно после успешной генерации
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.classList.add('active');
            }
        };
        
        img.onerror = function() {
            // Резервный вариант - показываем URL напрямую
            const ctx = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 300;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 300, 300);
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('QR Code URL:', 150, 140);
            ctx.fillText(qrUrl, 150, 160, 280);
            
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.classList.add('active');
            }
        };
        
        img.src = apiUrl;
    }
    
    // Show QR Code
    window.showQRCode = async function(userId, username, tempPassword) {
        try {
            // Создаем QR токен через API (используем публичный endpoint)
            let resp = await fetch(`${API_BASE}/api/qr/users/${userId}/qr-token/public`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!resp.ok) {
                const errorText = await resp.text();
                throw new Error(`Failed to generate QR token: ${resp.status} - ${errorText}`);
            }
            
            const data = await resp.json();
            const qrToken = data.token;
            
            // Формируем URL для QR-кода
            const frontendUrl = window.location.origin || 'http://localhost:3000';
            const qrUrl = `${frontendUrl}/qr-password-setup?token=${qrToken}`;
            
            // Сохраняем данные для печати
            currentQRUserData = {
                username: username,
                tempPassword: tempPassword,
                qrUrl: qrUrl
            };
            
            // Получаем canvas для QR-кода
            const canvas = document.getElementById('qrCanvas');
            if (!canvas) {
                console.error('QR canvas not found');
                if (window.showError) {
                    showError('❌ Элемент для QR-кода не найден');
                } else {
                    alert('Элемент для QR-кода не найден');
                }
                return;
            }
            
            // Генерируем QR-код через API
            generateQRCodeImage(qrUrl, canvas);
        } catch (e) {
            console.error('Show QR error:', e);
            if (window.showError) {
                showError('❌ Не удалось создать QR-код');
            } else {
                alert('Не удалось создать QR-код');
            }
        }
    };
    
    // Print QR Code to PDF
    window.printQRCode = function() {
        if (!currentQRUserData.username || !currentQRUserData.tempPassword) {
            if (window.showError) {
                showError('❌ Нет данных для печати');
            } else {
                alert('Нет данных для печати');
            }
            return;
        }
        
        try {
            // Проверяем наличие jsPDF разными способами
            let jsPDFClass;
            
            // Вариант 1: window.jspdf.jsPDF (UMD модуль)
            if (typeof window.jspdf !== 'undefined') {
                if (window.jspdf.jsPDF) {
                    jsPDFClass = window.jspdf.jsPDF;
                } else if (typeof window.jspdf === 'function') {
                    jsPDFClass = window.jspdf;
                } else if (window.jspdf.default && window.jspdf.default.jsPDF) {
                    jsPDFClass = window.jspdf.default.jsPDF;
                }
            }
            
            // Вариант 2: window.jsPDF (глобальный экспорт)
            if (!jsPDFClass && typeof window.jsPDF !== 'undefined') {
                jsPDFClass = window.jsPDF;
            }
            
            // Если не нашли, пробуем загрузить динамически
            if (!jsPDFClass) {
                console.warn('jsPDF not found, attempting to load...', {
                    window_jspdf: typeof window.jspdf,
                    window_jsPDF: typeof window.jsPDF,
                    jspdf_content: window.jspdf ? Object.keys(window.jspdf) : 'undefined'
                });
                
                // Попробуем загрузить библиотеку динамически
                window.loadJSPDFLibrary().then(() => {
                    // Повторно вызываем функцию после загрузки
                    setTimeout(() => window.printQRCode(), 200);
                }).catch((err) => {
                    console.error('Failed to load jsPDF:', err);
                    if (window.showError) {
                        showError('❌ Библиотека для генерации PDF не загружена. Попробуйте обновить страницу.');
                    } else {
                        alert('Библиотека для генерации PDF не загружена. Попробуйте обновить страницу.');
                    }
                });
                return;
            }
            
            const doc = new jsPDFClass();
            
            // Настройки страницы
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            
            // Функция для создания текста как изображения (для поддержки кириллицы)
            function createTextImage(text, fontSize, isBold, maxWidth) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Устанавливаем размер canvas
                canvas.width = maxWidth || 500;
                canvas.height = fontSize * 2;
                
                // Настройки текста
                ctx.fillStyle = '#000000';
                ctx.font = `${isBold ? 'bold' : 'normal'} ${fontSize}px Arial, sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                
                // Рисуем текст
                ctx.fillText(text, 0, 0);
                
                return canvas.toDataURL('image/png');
            }
            
            // Заголовок
            const titleText = 'QR-код для установки пароля';
            const titleImg = createTextImage(titleText, 20, true, 500);
            const titleWidth = 100;
            const titleHeight = 10;
            doc.addImage(titleImg, 'PNG', (pageWidth - titleWidth) / 2, margin, titleWidth, titleHeight);
            
            // Информация о пользователе
            let yPos = margin + 25;
            const labelSize = 12;
            const valueSize = 12;
            
            // Логин пользователя
            const loginLabelImg = createTextImage('Логин пользователя:', labelSize, false, 200);
            doc.addImage(loginLabelImg, 'PNG', margin, yPos, 50, 5);
            
            const loginValueImg = createTextImage(currentQRUserData.username, valueSize, true, 200);
            doc.addImage(loginValueImg, 'PNG', margin + 55, yPos, 50, 5);
            
            yPos += 12;
            
            // Временный пароль
            const passwordLabelImg = createTextImage('Временный пароль:', labelSize, false, 200);
            doc.addImage(passwordLabelImg, 'PNG', margin, yPos, 50, 5);
            
            const passwordValueImg = createTextImage(currentQRUserData.tempPassword, valueSize, true, 200);
            doc.addImage(passwordValueImg, 'PNG', margin + 55, yPos, 50, 5);
            
            // Получаем QR-код из canvas
            const canvas = document.getElementById('qrCanvas');
            if (canvas) {
                try {
                    // Конвертируем canvas в изображение
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Размер QR-кода в PDF (100x100 мм)
                    const qrSize = 80;
                    const qrX = (pageWidth - qrSize) / 2;
                    const qrY = yPos + 20;
                    
                    // Добавляем QR-код
                    doc.addImage(imgData, 'PNG', qrX, qrY, qrSize, qrSize);
                    
                    // Инструкция под QR-кодом
                    yPos = qrY + qrSize + 15;
                    const instructionText1 = 'Пользователь должен отсканировать этот QR-код';
                    const instructionText2 = 'для установки пароля';
                    const instructionImg1 = createTextImage(instructionText1, 10, false, 400);
                    const instructionImg2 = createTextImage(instructionText2, 10, false, 400);
                    const instructionWidth = 80;
                    const instructionHeight = 5;
                    doc.addImage(instructionImg1, 'PNG', (pageWidth - instructionWidth) / 2, yPos, instructionWidth, instructionHeight);
                    doc.addImage(instructionImg2, 'PNG', (pageWidth - instructionWidth) / 2, yPos + 6, instructionWidth, instructionHeight);
                } catch (e) {
                    console.error('Error adding QR image to PDF:', e);
                    // Если не удалось добавить изображение, добавляем URL как изображение текста
                    yPos += 20;
                    const urlLabelImg = createTextImage('QR URL:', 10, false, 200);
                    doc.addImage(urlLabelImg, 'PNG', margin, yPos, 30, 5);
                    const urlValueImg = createTextImage(currentQRUserData.qrUrl, 8, false, contentWidth);
                    doc.addImage(urlValueImg, 'PNG', margin, yPos + 8, contentWidth, 10);
                }
            } else {
                // Если canvas не найден, добавляем URL текстом
                yPos += 20;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('QR URL:', margin, yPos);
                doc.text(currentQRUserData.qrUrl, margin, yPos + 10, { maxWidth: contentWidth });
            }
            
            // Футер с датой
            const date = new Date().toLocaleString('ru-RU');
            const footerText = `Сгенерировано: ${date}`;
            const footerImg = createTextImage(footerText, 8, false, 400);
            doc.addImage(footerImg, 'PNG', (pageWidth - 80) / 2, pageHeight - 10, 80, 4);
            
            // Сохраняем PDF
            const filename = `QR_${currentQRUserData.username}_${Date.now()}.pdf`;
            doc.save(filename);
            
            if (window.showSuccess) {
                showSuccess('✅ PDF файл успешно создан');
            }
        } catch (e) {
            console.error('Print QR error:', e);
            if (window.showError) {
                showError('❌ Не удалось создать PDF файл');
            } else {
                alert('Не удалось создать PDF файл');
            }
        }
    };
    
    // Close QR Modal
    window.closeQRModal = function() {
        const modal = document.getElementById('qrModal');
        if (modal) {
            modal.classList.remove('active');
        }
    };
    
    // Close modal on overlay click
    document.addEventListener('DOMContentLoaded', function() {
        const qrModal = document.getElementById('qrModal');
        if (qrModal) {
            qrModal.addEventListener('click', function(e) {
                if (e.target === qrModal) {
                    closeQRModal();
                }
            });
        }
        
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQRModal();
            }
        });
    });
    
    // Delete user
    window.deleteUser = async function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (user.username === 'root') {
            if (window.showWarning) {
                showWarning('⚠️ Невозможно удалить root пользователя');
            }
            return;
        }
        
        const confirmDelete = confirm(`Вы уверены, что хотите удалить пользователя "${user.username}"?`);
        
        if (confirmDelete) {
            try {
                let resp = await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (resp.status === 401) {
                    console.warn('Not authorized, using public endpoint');
                    resp = await fetch(`${API_BASE}/api/users/${userId}/public`, {
                        method: 'DELETE'
                    });
                }
                if (!resp.ok) throw new Error('Failed to delete user');
                
                await loadUsers();
                
                if (window.showSuccess) {
                    showSuccess(`✅ Пользователь "${user.username}" удалён`);
                } else {
                    alert(`Пользователь "${user.username}" удалён`);
                }
            } catch (e) {
                console.error('Delete user error:', e);
                if (window.showError) {
                    showError('❌ Не удалось удалить пользователя');
                } else {
                    alert('Не удалось удалить пользователя');
                }
            }
        }
    };
    
    // Initialize on page load
    loadUsers();
    
    // Re-initialize when SPA content loads
    // Удаляем старый обработчик, если он существует
    if (window._usersContentLoadedHandler) {
        document.removeEventListener('spa:contentLoaded', window._usersContentLoadedHandler);
    }
    
    window._usersContentLoadedHandler = function(e) {
        if (e.detail && e.detail.route === '/users') {
            loadUsers();
        }
    };
    
    document.addEventListener('spa:contentLoaded', window._usersContentLoadedHandler);
})();
</script>
