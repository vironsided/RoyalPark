<link rel="stylesheet" href="/admin/content_css/users.css">
<div class="content-wrapper">
    <div class="users-header">
        <h2>Пользователи</h2>
    </div>
    
    <!-- Create User Form -->
    <div class="user-create-form">
        <input 
            type="text" 
            id="newUserLogin" 
            placeholder="Логин нового пользователя"
            autocomplete="off"
        />
        <select id="newUserRole">
            <option value="ADMIN">ADMIN</option>
            <option value="OPERATOR">OPERATOR</option>
            <option value="RESIDENT">RESIDENT</option>
            <option value="ROOT">ROOT</option>
        </select>
        <button class="btn-create-user" onclick="createUser()">
            Создать
        </button>
    </div>
    
    <!-- Users Table -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Логин</th>
                    <th>Роль</th>
                    <th>Последний вход</th>
                    <th>Пароль</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    // Sample users data
    let users = [
        {
            id: 1,
            login: 'root',
            role: 'ROOT',
            lastLogin: '2025-10-28 08:25:04.235780',
            passwordStatus: 'set',
            tempPassword: null
        },
        {
            id: 2,
            login: 'resident',
            role: 'RESIDENT',
            lastLogin: '2025-10-24 09:54:55.342651',
            passwordStatus: 'set',
            tempPassword: null
        },
        {
            id: 3,
            login: 'admin',
            role: 'ADMIN',
            lastLogin: '2025-10-27 14:32:10.123456',
            passwordStatus: 'temp',
            tempPassword: 'Abc123XyZ'
        }
    ];
    
    let nextUserId = 4;
    
    // Load users on page load
    function loadUsers() {
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        users.forEach(user => {
            const row = document.createElement('tr');
            
            // Get role badge class
            const roleClass = `role-${user.role.toLowerCase()}`;
            
            // Password badge
            let passwordBadge = '';
            if (user.passwordStatus === 'set') {
                passwordBadge = '<span class="password-badge password-set">установлен</span>';
            } else if (user.passwordStatus === 'temp' && user.tempPassword) {
                passwordBadge = `<span class="password-badge password-temp">временный: ${user.tempPassword}</span>`;
            }
            
            // Actions (only for non-root users)
            let actions = '';
            if (user.login !== 'root') {
                actions = `
                    <div class="user-actions">
                        <button class="btn-user-action btn-reset-password" onclick="resetPassword(${user.id})">
                            Сброс пароля
                        </button>
                        <input 
                            type="text" 
                            class="input-new-name" 
                            id="newName${user.id}" 
                            placeholder="Новое имя"
                            autocomplete="off"
                        />
                        <button class="btn-user-action btn-rename-user" onclick="renameUser(${user.id})">
                            Переимен.
                        </button>
                        <button class="btn-user-action btn-delete-user" onclick="deleteUser(${user.id})">
                            Удалить
                        </button>
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.login}</td>
                <td><span class="role-badge ${roleClass}">RoleEnum.${user.role}</span></td>
                <td>${user.lastLogin}</td>
                <td>${passwordBadge}</td>
                <td>${actions}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Create user
    window.createUser = function() {
        const loginInput = document.getElementById('newUserLogin');
        const roleSelect = document.getElementById('newUserRole');
        
        if (!loginInput || !roleSelect) return;
        
        const login = loginInput.value.trim();
        const role = roleSelect.value;
        
        if (!login) {
            if (window.showWarning) {
                showWarning('⚠️ Введите логин пользователя');
            } else {
                alert('Введите логин пользователя');
            }
            return;
        }
        
        // Check if user already exists
        if (users.find(u => u.login === login)) {
            if (window.showWarning) {
                showWarning('⚠️ Пользователь с таким логином уже существует');
            } else {
                alert('Пользователь с таким логином уже существует');
            }
            return;
        }
        
        // Generate temporary password
        const tempPassword = generateTempPassword();
        
        const newUser = {
            id: nextUserId++,
            login: login,
            role: role,
            lastLogin: new Date().toISOString().replace('T', ' ').substring(0, 26),
            passwordStatus: 'temp',
            tempPassword: tempPassword
        };
        
        users.push(newUser);
        loadUsers();
        
        // Clear form
        loginInput.value = '';
        roleSelect.value = 'ADMIN';
        
        if (window.showSuccess) {
            showSuccess(`✅ Пользователь "${login}" создан! Временный пароль: ${tempPassword}`);
        } else {
            alert(`Пользователь создан!\nЛогин: ${login}\nВременный пароль: ${tempPassword}`);
        }
    };
    
    // Reset password
    window.resetPassword = function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (user.login === 'root') {
            if (window.showWarning) {
                showWarning('⚠️ Невозможно сбросить пароль для root');
            }
            return;
        }
        
        const tempPassword = generateTempPassword();
        user.passwordStatus = 'temp';
        user.tempPassword = tempPassword;
        
        loadUsers();
        
        if (window.showSuccess) {
            showSuccess(`✅ Пароль сброшен! Новый временный пароль: ${tempPassword}`);
        } else {
            alert(`Пароль сброшен!\nНовый временный пароль: ${tempPassword}`);
        }
    };
    
    // Rename user
    window.renameUser = function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const newNameInput = document.getElementById(`newName${userId}`);
        if (!newNameInput) return;
        
        const newName = newNameInput.value.trim();
        
        if (!newName) {
            if (window.showWarning) {
                showWarning('⚠️ Введите новое имя');
            } else {
                alert('Введите новое имя');
            }
            return;
        }
        
        // Check if name already exists
        if (users.find(u => u.login === newName && u.id !== userId)) {
            if (window.showWarning) {
                showWarning('⚠️ Пользователь с таким именем уже существует');
            } else {
                alert('Пользователь с таким именем уже существует');
            }
            return;
        }
        
        const oldName = user.login;
        user.login = newName;
        
        loadUsers();
        
        if (window.showSuccess) {
            showSuccess(`✅ Пользователь "${oldName}" переименован в "${newName}"`);
        } else {
            alert(`Пользователь переименован: ${oldName} → ${newName}`);
        }
    };
    
    // Delete user
    window.deleteUser = function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (user.login === 'root') {
            if (window.showWarning) {
                showWarning('⚠️ Невозможно удалить root пользователя');
            }
            return;
        }
        
        const confirmDelete = confirm(`Вы уверены, что хотите удалить пользователя "${user.login}"?`);
        
        if (confirmDelete) {
            users = users.filter(u => u.id !== userId);
            loadUsers();
            
            if (window.showSuccess) {
                showSuccess(`✅ Пользователь "${user.login}" удалён`);
            } else {
                alert(`Пользователь "${user.login}" удалён`);
            }
        }
    };
    
    // Generate temporary password
    function generateTempPassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let password = '';
        for (let i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }
    
    // Initialize on page load
    loadUsers();
    
    // Re-initialize when SPA content loads
    document.addEventListener('spa:contentLoaded', function(e) {
        if (e.detail && e.detail.route === '/users') {
            loadUsers();
        }
    });
})();
</script>
