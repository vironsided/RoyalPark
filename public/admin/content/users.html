<link rel="stylesheet" href="/admin/content_css/users.css">
<div class="content-wrapper">
    <div class="users-header">
        <h2>Пользователи</h2>
    </div>
    
    <!-- Create User Form -->
    <div class="user-create-form">
        <input 
            type="text" 
            id="newUserLogin" 
            placeholder="Логин нового пользователя"
            autocomplete="off"
        />
        <select id="newUserRole">
            <option value="ADMIN">ADMIN</option>
            <option value="OPERATOR">OPERATOR</option>
            <option value="RESIDENT">RESIDENT</option>
            <option value="ROOT">ROOT</option>
        </select>
        <button class="btn-create-user" onclick="createUser()">
            Создать
        </button>
    </div>
    
    <!-- Users Table -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Логин</th>
                    <th>Роль</th>
                    <th>Последний вход</th>
                    <th>Пароль</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    // Текущий список пользователей из backend
    let users = [];
    
    const API_BASE = window.BACKEND_API_BASE || 'http://localhost:8000';
    
    async function fetchUsers() {
        try {
            // Сначала пробуем с авторизацией
            let resp = await fetch(`${API_BASE}/api/users`, { credentials: 'include' });
            // Если 401, пробуем временный публичный endpoint
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/public`);
            }
            if (!resp.ok) throw new Error(`Failed to load users: ${resp.status}`);
            users = await resp.json();
        } catch (e) {
            console.error('Users API error:', e);
            users = [];
        }
    }
    
    // Load users on page load
    async function loadUsers() {
        await fetchUsers();
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        users.forEach(user => {
            const row = document.createElement('tr');
            
            // Get role badge class
            const roleClass = `role-${String(user.role).toLowerCase()}`;
            
            // Password badge
            let passwordBadge = '';
            const passwordStatus = user.require_password_change ? 'temp' : 'set';
            const tempPassword = user.temp_password_plain;
            
            if (passwordStatus === 'set') {
                passwordBadge = '<span class="password-badge password-set">установлен</span>';
            } else if (passwordStatus === 'temp' && tempPassword) {
                passwordBadge = `<span class="password-badge password-temp">временный: ${tempPassword}</span>`;
            }
            
            // Actions (only for non-root users)
            let actions = '';
            if (user.username !== 'root') {
                actions = `
                    <div class="user-actions">
                        <button class="btn-user-action btn-reset-password" onclick="resetPassword(${user.id})">
                            Сброс пароля
                        </button>
                        <input 
                            type="text" 
                            class="input-new-name" 
                            id="newName${user.id}" 
                            placeholder="Новое имя"
                            autocomplete="off"
                        />
                        <button class="btn-user-action btn-rename-user" onclick="renameUser(${user.id})">
                            Переимен.
                        </button>
                        <button class="btn-user-action btn-delete-user" onclick="deleteUser(${user.id})">
                            Удалить
                        </button>
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td><span class="role-badge ${roleClass}">RoleEnum.${user.role}</span></td>
                <td>${user.last_login_at || '—'}</td>
                <td>${passwordBadge}</td>
                <td>${actions}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Create user через backend API
    window.createUser = async function() {
        const loginInput = document.getElementById('newUserLogin');
        const roleSelect = document.getElementById('newUserRole');
        
        if (!loginInput || !roleSelect) return;
        
        const login = loginInput.value.trim();
        const role = roleSelect.value;
        
        if (!login) {
            if (window.showWarning) {
                showWarning('⚠️ Введите логин пользователя');
            } else {
                alert('Введите логин пользователя');
            }
            return;
        }
        
        try {
            // Сначала пробуем с авторизацией
            let resp = await fetch(`${API_BASE}/api/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    username: login,
                    role: role,
                    full_name: null,
                    phone: null,
                    email: null
                })
            });
            // Если 401, пробуем временный публичный endpoint
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/public`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: login,
                        role: role,
                        full_name: null,
                        phone: null,
                        email: null
                    })
                });
            }
            if (!resp.ok) {
                const errorText = await resp.text();
                throw new Error(`Failed to create user: ${resp.status} - ${errorText}`);
            }
            const created = await resp.json();
            
            await loadUsers();
            
            loginInput.value = '';
            roleSelect.value = 'ADMIN';
            
            const tempPassword = created.temp_password_plain || 'установлен';
            if (window.showSuccess) {
                showSuccess(`✅ Пользователь "${login}" создан! Временный пароль: ${tempPassword}`);
            } else {
                alert(`Пользователь создан!\nЛогин: ${login}\nВременный пароль: ${tempPassword}`);
            }
        } catch (e) {
            console.error('Create user error:', e);
            if (window.showError) {
                showError('❌ Не удалось создать пользователя');
            } else {
                alert('Не удалось создать пользователя');
            }
        }
    };
    
    // Reset password
    window.resetPassword = async function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (user.username === 'root') {
            if (window.showWarning) {
                showWarning('⚠️ Невозможно сбросить пароль для root');
            }
            return;
        }
        
        try {
            let resp = await fetch(`${API_BASE}/api/users/${userId}/reset`, {
                method: 'POST',
                credentials: 'include'
            });
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/${userId}/reset/public`, {
                    method: 'POST'
                });
            }
            if (!resp.ok) throw new Error('Failed to reset password');
            const updated = await resp.json();
            
            await loadUsers();
            
            const tempPassword = updated.temp_password_plain || 'временный пароль обновлён';
            if (window.showSuccess) {
                showSuccess(`✅ Пароль сброшен! Новый временный пароль: ${tempPassword}`);
            } else {
                alert(`Пароль сброшен!\nНовый временный пароль: ${tempPassword}`);
            }
        } catch (e) {
            console.error('Reset password error:', e);
            if (window.showError) {
                showError('❌ Не удалось сбросить пароль');
            } else {
                alert('Не удалось сбросить пароль');
            }
        }
    };
    
    // Rename user
    window.renameUser = async function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const newNameInput = document.getElementById(`newName${userId}`);
        if (!newNameInput) return;
        
        const newName = newNameInput.value.trim();
        
        if (!newName) {
            if (window.showWarning) {
                showWarning('⚠️ Введите новое имя');
            } else {
                alert('Введите новое имя');
            }
            return;
        }
        
        try {
            let resp = await fetch(`${API_BASE}/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ username: newName })
            });
            if (resp.status === 401) {
                console.warn('Not authorized, using public endpoint');
                resp = await fetch(`${API_BASE}/api/users/${userId}/public`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: newName })
                });
            }
            if (!resp.ok) throw new Error('Failed to rename user');
            await loadUsers();
            
            if (window.showSuccess) {
                showSuccess(`✅ Пользователь "${user.username}" переименован в "${newName}"`);
            } else {
                alert(`Пользователь переименован: ${user.username} → ${newName}`);
            }
        } catch (e) {
            console.error('Rename user error:', e);
            if (window.showError) {
                showError('❌ Не удалось переименовать пользователя');
            } else {
                alert('Не удалось переименовать пользователя');
            }
        }
    };
    
    // Delete user
    window.deleteUser = async function(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (user.username === 'root') {
            if (window.showWarning) {
                showWarning('⚠️ Невозможно удалить root пользователя');
            }
            return;
        }
        
        const confirmDelete = confirm(`Вы уверены, что хотите удалить пользователя "${user.login}"?`);
        
        if (confirmDelete) {
            try {
                let resp = await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (resp.status === 401) {
                    console.warn('Not authorized, using public endpoint');
                    resp = await fetch(`${API_BASE}/api/users/${userId}/public`, {
                        method: 'DELETE'
                    });
                }
                if (!resp.ok) throw new Error('Failed to delete user');
                
                await loadUsers();
                
                if (window.showSuccess) {
                    showSuccess(`✅ Пользователь "${user.username}" удалён`);
                } else {
                    alert(`Пользователь "${user.username}" удалён`);
                }
            } catch (e) {
                console.error('Delete user error:', e);
                if (window.showError) {
                    showError('❌ Не удалось удалить пользователя');
                } else {
                    alert('Не удалось удалить пользователя');
                }
            }
        }
    };
    
    // Initialize on page load
    loadUsers();
    
    // Re-initialize when SPA content loads
    // Удаляем старый обработчик, если он существует
    if (window._usersContentLoadedHandler) {
        document.removeEventListener('spa:contentLoaded', window._usersContentLoadedHandler);
    }
    
    window._usersContentLoadedHandler = function(e) {
        if (e.detail && e.detail.route === '/users') {
            loadUsers();
        }
    };
    
    document.addEventListener('spa:contentLoaded', window._usersContentLoadedHandler);
})();
</script>
