<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="user_invoice_print_title">Счёт на оплату</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin/content_css/invoice-print.css">
    <style>
        .language-selector { display: none !important; }
    </style>
</head>
<body>
    <div class="print-actions">
        <button class="btn-print" onclick="window.print()">
            <i class="bi bi-printer"></i> <span data-i18n="user_invoice_print_print_button">Печать</span>
        </button>
    </div>

    <div class="print-container">
        <div class="print-header">
            <h1 data-i18n="user_invoice_print_title">Счёт на оплату</h1>
        </div>

        <div class="invoice-info">
            <div class="invoice-info-left">
                <div class="info-item">
                    <label data-i18n="user_invoice_print_number_label">№</label>
                    <div class="value" id="invoiceNumber">2025-11/000001</div>
                </div>
                <div class="info-item">
                    <label data-i18n="user_invoice_print_resident_label">Резидент</label>
                    <div class="value" id="invoiceResident">X / 2</div>
                </div>
                <div class="info-item">
                    <label data-i18n="user_invoice_print_period_label">Период</label>
                    <div class="value" id="invoicePeriod">2025-11</div>
                </div>
                <div class="info-item">
                    <label data-i18n="user_invoice_print_status_label">Статус</label>
                    <div class="value" id="invoiceStatus">PAID</div>
                </div>
            </div>
            <div class="invoice-info-right">
                <div class="info-item">
                    <label data-i18n="user_invoice_print_due_date_label">Срок оплаты</label>
                    <div class="value" id="invoiceDueDate">—</div>
                </div>
                <div class="info-item">
                    <label data-i18n="user_invoice_print_total_label">Сумма к оплате</label>
                    <div class="value" id="invoiceTotal" style="font-size: 18px; color: #000;">30000.00</div>
                </div>
            </div>
        </div>

        <!-- Таблица оплат по счёту -->
        <h2 style="margin-top: 24px; margin-bottom: 8px;" data-i18n="user_invoice_print_payments_title">Оплата по счёту</h2>
        <table class="invoice-table">
            <thead>
                <tr>
                    <th data-i18n="user_invoice_payments_th_date">Дата</th>
                    <th data-i18n="user_invoice_payments_th_method">Метод</th>
                    <th data-i18n="user_invoice_payments_th_amount">Сумма</th>
                    <th data-i18n="user_invoice_payments_th_comment">Комментарий</th>
                </tr>
            </thead>
            <tbody id="paymentsTable"><!-- наполняется из JS --></tbody>
        </table>
        <p style="margin-top: 6px; font-size: 13px;">
            <!-- Текст будет подставлен из JS с учётом текущего языка -->
            <span id="invoicePaymentsSummary"></span>
        </p>

        <!-- Основная таблица с позициями счёта (как в админском шаблоне, но с данными пользователя) -->
        <h2 style="margin-top: 24px; margin-bottom: 8px;" data-i18n="user_invoice_print_items_title">Описание</h2>
        <table class="invoice-table">
            <thead>
                <tr>
                    <th data-i18n="user_invoice_items_th_description">Описание</th>
                    <th data-i18n="user_invoice_items_th_charged">Начислено</th>
                    <th data-i18n="user_invoice_items_th_vat">НДС</th>
                    <th data-i18n="user_invoice_items_th_total">Итого</th>
                </tr>
            </thead>
            <tbody id="lineItemsTable"><!-- наполняется из JS --></tbody>
        </table>

        <div class="invoice-footer">
            <p><span data-i18n="user_invoice_print_generated_prefix">Квитанция сгенерирована:</span> <span id="generatedDate"></span></p>
            <p data-i18n="user_invoice_print_footer_note">Для печати нажмите кнопку сверху или используйте «Печать в PDF».</p>
        </div>
    </div>

    <script src="/js/i18n.js"></script>
    <script src="/js/i18n-auto.js"></script>
    <script>
        (function () {
            const API_BASE_URL = window.API_BASE_URL || window.BACKEND_API_BASE || 'http://localhost:8000';
            
            // Get invoice ID from sessionStorage or URL
            let invoiceId = null;
            
            // First try sessionStorage (set when clicking PDF button)
            const storedId = sessionStorage.getItem('printInvoiceId');
            if (storedId) {
                invoiceId = parseInt(storedId);
                console.log('Got invoice ID from sessionStorage:', invoiceId);
            }
            
            // If not in sessionStorage, try currentInvoiceId (from invoice-view page)
            if (!invoiceId && window.currentInvoiceId) {
                invoiceId = window.currentInvoiceId;
                console.log('Got invoice ID from window.currentInvoiceId:', invoiceId);
            }
            
            // Last resort: try URL params
            if (!invoiceId) {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id') || urlParams.get('invoice_id');
                if (id) {
                    invoiceId = parseInt(id);
                    console.log('Got invoice ID from URL params:', invoiceId);
                }
            }
            
            // If still no ID, try to get from parent window (if opened from invoice-view)
            if (!invoiceId && window.opener) {
                try {
                    const parentInvoiceId = window.opener.currentInvoiceId;
                    if (parentInvoiceId) {
                        invoiceId = parentInvoiceId;
                        console.log('Got invoice ID from parent window:', invoiceId);
                    }
                } catch (e) {
                    // Cross-origin or other error, ignore
                }
            }
            
            async function loadInvoice() {
                if (!invoiceId) {
                    console.error('Invoice ID not found');
                    document.querySelector('.print-container').innerHTML = 
                        '<div class="text-center text-danger p-4">Ошибка: не найден ID счета</div>';
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/resident/invoice/${invoiceId}`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/login.html';
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const invoiceData = await response.json();
                    
                    // Transform API data to print format
                    const totalAmount = Number(invoiceData.amount_total ?? 0);
                    const paidAmount = Number(invoiceData.paid_amount ?? 0);
                    const remainingAmount = Number(
                        invoiceData.remaining_amount !== undefined && invoiceData.remaining_amount !== null
                            ? invoiceData.remaining_amount
                            : totalAmount - paidAmount
                    );

                    const invoice = {
                        number: invoiceData.number || `#${invoiceData.id}`,
                        resident: invoiceData.resident_code || '—',
                        period: formatPeriod(invoiceData),
                        status: invoiceData.status,
                        dueDate: invoiceData.due_date,
                        total: totalAmount,
                        paid: paidAmount,
                        remaining: remainingAmount,
                        payments: (invoiceData.payments || []).map(p => ({
                            date: p.date,
                            method: p.method,
                            amount: p.amount,
                            comment: p.comment || '—'
                        })),
                        items: (invoiceData.lines || []).map(line => ({
                            description: line.description,
                            amount: line.amount_net,
                            vat: line.amount_vat,
                            total: line.amount_total
                        }))
                    };

                    renderInvoice(invoice);
                    
                    // Apply translations after rendering
                    if (window.applyTranslations) {
                        setTimeout(() => window.applyTranslations(), 100);
                    }
                } catch (error) {
                    console.error('Error loading invoice:', error);
                    const lang = localStorage.getItem('language') || 'ru';
                    const errorText = window.i18n?.translate?.('error_loading_data', lang) || 'Не удалось загрузить данные';
                    document.querySelector('.print-container').innerHTML = 
                        `<div class="text-center text-danger p-4">${errorText}: ${error.message}</div>`;
                }
            }
            
            // Translate payment comment (use global function if available, otherwise create local)
            function translatePaymentComment(comment, lang) {
                if (!comment || comment === '—') return comment;
                
                // Используем глобальную функцию, если она доступна
                if (window.translatePaymentComment && typeof window.translatePaymentComment === 'function') {
                    return window.translatePaymentComment(comment, lang);
                }
                
                // Fallback: простая логика перевода
                if (!lang) {
                    lang = localStorage.getItem('language') || 'ru';
                }
                
                const patterns = [
                    {
                        regex: /^(?:Оплата новой картой|Payment with new card|Yeni kartla ödəniş)\s+\*\*\*\*(\d+)$/i,
                        format: (match, last4) => {
                            const template = window.translations?.[lang]?.payment_comment_new_card || 
                                           window.translations?.ru?.payment_comment_new_card || 
                                           'Оплата новой картой ****{last4}';
                            return template.replace('{last4}', last4);
                        }
                    },
                    {
                        regex: /^(?:Списание из аванса|Deduction from|Royal Park Pass avansından çıxarış).*Royal Park Pass/i,
                        format: () => window.translations?.[lang]?.payment_comment_advance || 
                                    window.translations?.ru?.payment_comment_advance || 
                                    'Списание из аванса Royal Park Pass'
                    },
                    {
                        regex: /^(?:Оплата картой|Payment with|kartı ilə ödəniş)\s+([A-Za-z\s]+?)\s+\*\*\*\*(\d+)/i,
                        format: (match, brand, last4) => {
                            const suffix = `****${last4}`;
                            const template = window.translations?.[lang]?.payment_comment_saved_card || 
                                           window.translations?.ru?.payment_comment_saved_card || 
                                           'Оплата картой {brand} {suffix}';
                            return template.replace('{brand}', brand.trim()).replace('{suffix}', suffix);
                        }
                    },
                    {
                        regex: /^(?:Онлайн-оплата|Online payment|Onlayn ödəniş)$/i,
                        format: () => window.translations?.[lang]?.payment_comment_online || 
                                    window.translations?.ru?.payment_comment_online || 
                                    'Онлайн-оплата'
                    }
                ];
                
                for (const pattern of patterns) {
                    const match = comment.match(pattern.regex);
                    if (match) {
                        return pattern.format(match, ...match.slice(1));
                    }
                }
                
                return comment;
            }
            
            // Translate service description
            function translateServiceDescription(description, lang) {
                if (!description) return '—';
                
                // Паттерны для распознавания типов услуг
                const patterns = [
                    {
                        regex: /^Электричество\s+([\d.]+)\s*кВт·ч$/i,
                        serviceKey: 'meter_electricity',
                        unitKey: 'user_unit_kwh',
                        format: (amount, service, unit) => `${service} ${amount} ${unit}`
                    },
                    {
                        regex: /^Вода\s+([\d.]+)\s*м³$/i,
                        serviceKey: 'meter_cold_water',
                        unitKey: 'user_unit_m3',
                        format: (amount, service, unit) => {
                            let waterText = 'Вода';
                            if (lang === 'az') waterText = 'Su';
                            else if (lang === 'en') waterText = 'Water';
                            return `${waterText} ${amount} ${unit}`;
                        }
                    },
                    {
                        regex: /^Канализация(?:\s*\(авто\))?\s+([\d.]+)\s*м³$/i,
                        serviceKey: 'meter_sewerage',
                        unitKey: 'user_unit_m3',
                        format: (amount, service, unit) => {
                            let text = service || 'Канализация';
                            if (!service) {
                                if (lang === 'az') text = 'Kanalizasiya';
                                else if (lang === 'en') text = 'Sewerage';
                            }
                            return `${text} ${amount} ${unit}`;
                        }
                    },
                    {
                        regex: /^Газ\s+([\d.]+)\s*м³$/i,
                        serviceKey: 'meter_gas',
                        unitKey: 'user_unit_m3',
                        format: (amount, service, unit) => `${service} ${amount} ${unit}`
                    },
                    {
                        regex: /^Горячая\s+вода\s+([\d.]+)\s*м³$/i,
                        serviceKey: 'meter_hot_water',
                        unitKey: 'user_unit_m3',
                        format: (amount, service, unit) => `${service} ${amount} ${unit}`
                    }
                ];
                
                for (const pattern of patterns) {
                    const match = description.match(pattern.regex);
                    if (match) {
                        const amount = match[1];
                        const service = window.i18n?.translate?.(pattern.serviceKey, lang) || description.split(' ')[0];
                        const unit = window.i18n?.translate?.(pattern.unitKey, lang) || match[0].split(amount)[1].trim();
                        return pattern.format(amount, service, unit);
                }
                }
                
                // Если не найден паттерн, возвращаем оригинал
                return description;
            }
            
            function formatPeriod(invoiceData) {
                const lang = localStorage.getItem('language') || 'ru';
                const locale = lang === 'az' ? 'az-AZ' : lang === 'en' ? 'en-US' : 'ru-RU';
                const monthKeys = [
                    'month_january', 'month_february', 'month_march', 'month_april',
                    'month_may', 'month_june', 'month_july', 'month_august',
                    'month_september', 'month_october', 'month_november', 'month_december'
                ];
                const monthName = window.i18n?.translate?.(monthKeys[invoiceData.period_month - 1], lang) ||
                    ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                     'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'][invoiceData.period_month - 1];
                let periodText = `${monthName} ${invoiceData.period_year}`;
                if (invoiceData.period_dates && invoiceData.period_dates.from && invoiceData.period_dates.to) {
                    try {
                        const fromDate = new Date(invoiceData.period_dates.from);
                        const toDate = new Date(invoiceData.period_dates.to);
                        if (!isNaN(fromDate.getTime()) && !isNaN(toDate.getTime())) {
                            periodText = `${fromDate.toLocaleDateString(locale)} - ${toDate.toLocaleDateString(locale)}`;
                        } else {
                            periodText = `${invoiceData.period_dates.from} - ${invoiceData.period_dates.to}`;
                        }
                    } catch (e) {
                    periodText = `${invoiceData.period_dates.from} - ${invoiceData.period_dates.to}`;
                    }
                } else if (invoiceData.period_dates && invoiceData.period_dates.to) {
                    try {
                        const toDate = new Date(invoiceData.period_dates.to);
                        if (!isNaN(toDate.getTime())) {
                            periodText = toDate.toLocaleDateString(locale);
                        } else {
                            periodText = invoiceData.period_dates.to;
                        }
                    } catch (e) {
                    periodText = invoiceData.period_dates.to;
                    }
                }
                return periodText;
            }

            function renderInvoice(invoice) {
                // Хедер
                document.getElementById('invoiceNumber').textContent  = invoice.number;
                document.getElementById('invoiceResident').textContent = invoice.resident;
                document.getElementById('invoicePeriod').textContent   = invoice.period;
                // Статус с переводом
                const statusEl = document.getElementById('invoiceStatus');
                if (statusEl) {
                    const lang = localStorage.getItem('language') || 'ru';
                    const statusKey = `status_${invoice.status.toLowerCase()}`;
                    const statusText = window.i18n?.translate?.(statusKey, lang) || invoice.status;
                    statusEl.textContent = statusText;
                    statusEl.dataset.status = invoice.status;
                }
                // Срок оплаты с форматированием
                const dueDateEl = document.getElementById('invoiceDueDate');
                if (dueDateEl) {
                    const lang = localStorage.getItem('language') || 'ru';
                    const locale = lang === 'az' ? 'az-AZ' : lang === 'en' ? 'en-US' : 'ru-RU';
                    if (invoice.dueDate) {
                        try {
                            const date = new Date(invoice.dueDate);
                            if (!isNaN(date.getTime())) {
                                dueDateEl.textContent = date.toLocaleDateString(locale);
                            } else {
                                dueDateEl.textContent = invoice.dueDate;
                            }
                        } catch (e) {
                            dueDateEl.textContent = invoice.dueDate;
                        }
                    } else {
                        dueDateEl.textContent = '—';
                    }
                }
                document.getElementById('invoiceTotal').textContent    = invoice.total.toFixed(2);

                // Таблица оплат
                const paymentsTbody = document.getElementById('paymentsTable');
                if (paymentsTbody) {
                    const lang = localStorage.getItem('language') || 'ru';
                    const locale = lang === 'az' ? 'az-AZ' : lang === 'en' ? 'en-US' : 'ru-RU';
                    if (invoice.payments && invoice.payments.length > 0) {
                        paymentsTbody.innerHTML = invoice.payments.map(p => {
                            let dateStr = '—';
                            if (p.date) {
                                try {
                                    const date = new Date(p.date);
                                    if (!isNaN(date.getTime())) {
                                        dateStr = date.toLocaleDateString(locale);
                                    } else {
                                        dateStr = p.date;
                                    }
                                } catch (e) {
                                    dateStr = p.date;
                                }
                            }
                            // Переводим комментарий
                            let commentDisplay = translatePaymentComment(p.comment || '—', lang);
                            return `
                            <tr>
                                <td>${dateStr}</td>
                                <td>${p.method || '—'}</td>
                                <td>${p.amount.toFixed(2)}</td>
                                <td>${commentDisplay}</td>
                            </tr>
                        `;
                        }).join('');
                    } else {
                        const lang = localStorage.getItem('language') || 'ru';
                        let emptyText = 'Оплаты отсутствуют';
                        if (window.i18n && window.i18n.translate) {
                            emptyText = window.i18n.translate('invoice_payments_empty', lang);
                            if (emptyText === 'invoice_payments_empty') {
                                emptyText = 'Оплаты отсутствуют';
                            }
                        }
                        paymentsTbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted" data-i18n-empty="invoice_payments_empty">${emptyText}</td></tr>`;
                    }
                }
                
                // Update payments summary (use i18n template with {paid}, {remaining}, {total})
                const summarySpan = document.getElementById('invoicePaymentsSummary');
                if (summarySpan) {
                    const lang = (window.i18n && window.i18n.currentLanguage) || localStorage.getItem('language') || 'ru';
                    const dict = (window.translations && window.translations[lang]) || {};
                    let template = dict.user_invoice_print_payments_summary || summarySpan.textContent || '';

                    const paidStr = (Number.isFinite(invoice.paid) ? invoice.paid : 0).toFixed(2);
                    const remainingStr = (Number.isFinite(invoice.remaining) ? invoice.remaining : 0).toFixed(2);
                    const totalStr = (Number.isFinite(invoice.total) ? invoice.total : 0).toFixed(2);

                    template = template
                        .replace('{paid}', `<strong>${paidStr}</strong>`)
                        .replace('{remaining}', `<strong>${remainingStr}</strong>`)
                        .replace('{total}', `<strong>${totalStr}</strong>`);

                    summarySpan.innerHTML = template;
                }

                // Таблица позиций
                const itemsTbody = document.getElementById('lineItemsTable');
                if (itemsTbody && invoice.items && invoice.items.length) {
                    const lang = (window.i18n && window.i18n.currentLanguage) || localStorage.getItem('language') || 'ru';
                    const dict = (window.translations && window.translations[lang]) || {};

                    // Строки с позициями:
                    // Используем функцию translateServiceDescription для перевода описаний услуг
                    let html = invoice.items.map(it => {
                        let desc = translateServiceDescription(it.description, lang);
                        return `
                            <tr>
                                <td data-original-description="${it.description}">${desc}</td>
                                <td>${it.amount.toFixed(2)}</td>
                                <td>${it.vat.toFixed(2)}</td>
                                <td>${it.total.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('');

                    // Лейбл "Итого к оплате" берём из i18n по текущему языку
                    const total = invoice.items.reduce((sum, it) => sum + it.total, 0);
                    const totalLabel = dict.user_invoice_items_total_row || 'Итого к оплате';

                    html += `
                        <tr class="total-row">
                            <td colspan="3">${totalLabel}</td>
                            <td class="total-value">${total.toFixed(2)}</td>
                        </tr>
                    `;

                    itemsTbody.innerHTML = html;
                }

                // Дата генерации
                const now = new Date();
                const el = document.getElementById('generatedDate');
                if (el) {
                    const lang = localStorage.getItem('language') || 'ru';
                    const locale = lang === 'az' ? 'az-AZ' : lang === 'en' ? 'en-US' : 'ru-RU';
                    el.textContent = now.toLocaleString(locale);
                }
            }

            // Load invoice data when page is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    loadInvoice();
                    // Apply translations on initial load
                    if (window.applyTranslations) {
                        setTimeout(() => window.applyTranslations(), 500);
                    }
                });
            } else {
                loadInvoice();
                // Apply translations on initial load
                if (window.applyTranslations) {
                    setTimeout(() => window.applyTranslations(), 500);
                }
            }
            
            // Listen for language changes
            window.addEventListener('languageChanged', () => {
                if (window.applyTranslations) {
                    setTimeout(() => window.applyTranslations(), 100);
                }
            });
        })();
    </script>
</body>
</html>