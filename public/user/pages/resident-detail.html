<div class="resident-detail-wrapper">
    <div class="resident-detail-card">
        <div class="resident-detail-info">
            <div>
                <p class="label" data-i18n="user_resident_block_label">Блок</p>
                <p class="value">X</p>
            </div>
            <div>
                <p class="label" data-i18n="user_resident_apartment_label">Квартира</p>
                <p class="value">#2</p>
            </div>
            <div>
                <p class="label" data-i18n="user_resident_status_label">Статус</p>
                <span class="badge badge-success" data-i18n="user_resident_status_active">Активен</span>
            </div>
            <div>
                <p class="label" data-i18n="user_resident_balance_label">Баланс</p>
                <p class="value">₼0.00</p>
            </div>
        </div>
        <button class="back-button" data-user-route-target="dashboard">
            <span data-i18n="user_resident_back_btn">← Назад</span>
        </button>
    </div>

    <div class="resident-filter-card">
        <div class="date-range">
            <div class="input-group">
                <label data-i18n="user_resident_date_from">От</label>
                <input id="filterDateFrom" type="date" value="2025-11-01">
            </div>
            <div class="input-group">
                <label data-i18n="user_resident_date_to">До</label>
                <input id="filterDateTo" type="date" value="2025-11-30">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-outline-light" id="filterApplyBtn" data-i18n="user_resident_filter_btn">Фильтр</button>
            <button class="btn btn-outline-warning" id="filterResetBtn" data-i18n="user_resident_reset_btn">Очистить</button>
        </div>
        <div class="quick-filter">
            <span data-i18n="user_resident_quick_select">Быстрый выбор</span>
            <div class="quick-filter-buttons">
                <button class="quick-filter-btn active" data-range="month" data-i18n="user_resident_quick_month">За месяц</button>
                <button class="quick-filter-btn" data-range="quarter" data-i18n="user_resident_quick_quarter">За 3 мес.</button>
                <button class="quick-filter-btn" data-range="half" data-i18n="user_resident_quick_half">За 6 мес.</button>
                <button class="quick-filter-btn" data-range="year" data-i18n="user_resident_quick_year">За год</button>
            </div>
        </div>
    </div>

    <div class="meters-list">
        <div class="meter-card">
            <div class="meter-card-header">
                <span class="meter-tag meter-gas" data-i18n="user_resident_meter_gas">Газ</span>
                <div class="meter-meta">
                    <span>№ 123 &nbsp; Тариф: Qaz</span>
                    <span class="meter-unit">м³</span>
                </div>
            </div>
            <div class="meter-table" data-meter-key="gasMain">
                <div class="meter-row meter-head">
                    <span data-i18n="user_resident_table_date">Дата</span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_reading">Показание</span><span class="meter-head-unit">м³</span></span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_usage">Расход</span><span class="meter-head-unit">м³</span></span>
                    <span data-i18n="user_resident_table_charge">Начислено</span>
                    <span>НДС, %</span>
                    <span data-i18n="user_resident_table_comment">Комментарий</span>
                </div>
                <div class="meter-body"></div>
            </div>
        </div>

        <div class="meter-card">
            <div class="meter-card-header">
                <span class="meter-tag meter-electric" data-i18n="user_resident_meter_electricity">Электричество</span>
                <div class="meter-meta">
                    <span>№ 1234 &nbsp; Тариф: X2 tok</span>
                    <span class="meter-unit">кВт⋅ч</span>
                </div>
            </div>
            <div class="meter-table" data-meter-key="electricMain">
                <div class="meter-row meter-head">
                    <span data-i18n="user_resident_table_date">Дата</span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_reading">Показание</span><span class="meter-head-unit">кВт⋅ч</span></span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_usage">Расход</span><span class="meter-head-unit">кВт⋅ч</span></span>
                    <span data-i18n="user_resident_table_charge">Начислено</span>
                    <span>НДС, %</span>
                    <span data-i18n="user_resident_table_comment">Комментарий</span>
                </div>
                <div class="meter-body"></div>
            </div>
        </div>

        <div class="meter-card">
            <div class="meter-card-header">
                <span class="meter-tag meter-gas" data-i18n="user_resident_meter_gas">Газ</span>
                <div class="meter-meta">
                    <span>№ 13445 &nbsp; Тариф: Qaz</span>
                    <span class="meter-unit">м³</span>
                </div>
            </div>
            <div class="meter-table" data-meter-key="gasSecond">
                <div class="meter-row meter-head">
                    <span data-i18n="user_resident_table_date">Дата</span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_reading">Показание</span><span class="meter-head-unit">м³</span></span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_usage">Расход</span><span class="meter-head-unit">м³</span></span>
                    <span data-i18n="user_resident_table_charge">Начислено</span>
                    <span data-i18n="user_resident_table_vat">НДС, %</span>
                    <span data-i18n="user_resident_table_comment">Комментарий</span>
                </div>
                <div class="meter-body"></div>
            </div>
        </div>

        <div class="meter-card">
            <div class="meter-card-header">
                <span class="meter-tag meter-water" data-i18n="user_resident_meter_water">Вода</span>
                <div class="meter-meta">
                    <span>№ 58585 &nbsp; Тариф: X2 su</span>
                    <span class="meter-unit">м³</span>
                </div>
            </div>
            <div class="meter-table" data-meter-key="waterMain">
                <div class="meter-row meter-head">
                    <span data-i18n="user_resident_table_date">Дата</span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_reading">Показание</span><span class="meter-head-unit">м³</span></span>
                    <span class="meter-head-label"><span data-i18n="user_resident_table_usage">Расход</span><span class="meter-head-unit">м³</span></span>
                    <span data-i18n="user_resident_table_charge">Начислено</span>
                    <span data-i18n="user_resident_table_vat">НДС, %</span>
                    <span data-i18n="user_resident_table_comment">Комментарий</span>
                </div>
                <div class="meter-body"></div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        const mockMeterData = {
            gasMain: [
                { date: '28.11.2025', reading: '312.40', usage: '12.60', charge: '₼18.90', vat: '18%', comment: 'Передано автоматически' },
                { date: '15.11.2025', reading: '299.80', usage: '10.15', charge: '₼15.22', vat: '18%', comment: 'Ручной ввод' },
                { date: '01.11.2025', reading: '289.65', usage: '9.80', charge: '₼14.70', vat: '18%', comment: 'Снято оператором' }
            ],
            electricMain: [
                { date: '29.11.2025', reading: '4 820', usage: '145', charge: '₼42.05', vat: '18%', comment: 'Ночной тариф учтён' },
                { date: '14.11.2025', reading: '4 675', usage: '138', charge: '₼39.96', vat: '18%', comment: 'Пиковое потребление' },
                { date: '01.11.2025', reading: '4 537', usage: '129', charge: '₼37.35', vat: '18%', comment: 'Снято автоматически' }
            ],
            gasSecond: [
                { date: '26.11.2025', reading: '88.10', usage: '4.25', charge: '₼6.38', vat: '18%', comment: 'Котельная' },
                { date: '11.11.2025', reading: '83.85', usage: '3.90', charge: '₼5.85', vat: '18%', comment: '' }
            ],
            waterMain: [
                { date: '27.11.2025', reading: '152.30', usage: '5.40', charge: '₼7.56', vat: '18%', comment: 'Горячая вода' },
                { date: '12.11.2025', reading: '146.90', usage: '5.05', charge: '₼7.07', vat: '18%', comment: 'Норма' },
                { date: '01.11.2025', reading: '141.85', usage: '4.80', charge: '₼6.72', vat: '18%', comment: '' }
            ]
        };

        const dateFromInput = document.getElementById('filterDateFrom');
        const dateToInput = document.getElementById('filterDateTo');
        const filterApplyBtn = document.getElementById('filterApplyBtn');
        const filterResetBtn = document.getElementById('filterResetBtn');
        const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
        const meterTables = document.querySelectorAll('.meter-table');
        const defaultRange = { from: dateFromInput.value, to: dateToInput.value };

        const parseMeterDate = (value) => {
            const [day, month, year] = value.split('.');
            return new Date(`${year}-${month}-${day}`);
        };

        const formatForInput = (date) => {
            return date.toISOString().split('T')[0];
        };

        const getLatestDataDate = () => {
            const allDates = Object.values(mockMeterData)
                .flat()
                .map(row => parseMeterDate(row.date).getTime());
            return allDates.length ? new Date(Math.max(...allDates)) : new Date();
        };

        const renderMeterTables = (dataset) => {
            meterTables.forEach(table => {
                const key = table.dataset.meterKey;
                const body = table.querySelector('.meter-body');
                const rows = dataset[key] || [];

                if (!rows.length) {
                    body.innerHTML = `
                        <div class="meter-row meter-empty">
                            <span>Записей пока нет</span>
                        </div>
                    `;
                    return;
                }

                body.innerHTML = rows.map(row => `
                    <div class="meter-row">
                        <span>${row.date}</span>
                        <span>${row.reading}</span>
                        <span>${row.usage}</span>
                        <span>${row.charge}</span>
                        <span>${row.vat}</span>
                        <span>${row.comment || '—'}</span>
                    </div>
                `).join('');
            });
        };

        const filterDataset = (fromValue, toValue) => {
            const fromDate = fromValue ? new Date(fromValue) : null;
            const toDate = toValue ? new Date(toValue) : null;
            const filtered = {};

            Object.entries(mockMeterData).forEach(([key, rows]) => {
                filtered[key] = rows.filter(row => {
                    const date = parseMeterDate(row.date);
                    if (fromDate && date < fromDate) return false;
                    if (toDate && date > toDate) return false;
                    return true;
                });
            });

            return filtered;
        };

        const applyFilter = () => {
            const dataset = filterDataset(dateFromInput.value, dateToInput.value);
            renderMeterTables(dataset);
        };

        const resetFilter = () => {
            dateFromInput.value = defaultRange.from;
            dateToInput.value = defaultRange.to;
            renderMeterTables(mockMeterData);
            quickFilterBtns.forEach(btn => btn.classList.remove('active'));
            const defaultBtn = document.querySelector('.quick-filter-btn[data-range="month"]');
            if (defaultBtn) defaultBtn.classList.add('active');
        };

        const applyQuickRange = (range) => {
            const end = getLatestDataDate();
            const start = new Date(end);

            switch (range) {
                case 'quarter':
                    start.setMonth(start.getMonth() - 3);
                    break;
                case 'half':
                    start.setMonth(start.getMonth() - 6);
                    break;
                case 'year':
                    start.setFullYear(start.getFullYear() - 1);
                    break;
                default:
                    start.setMonth(start.getMonth() - 1);
            }

            dateFromInput.value = formatForInput(start);
            dateToInput.value = formatForInput(end);
            applyFilter();
        };

        if (filterApplyBtn) filterApplyBtn.addEventListener('click', applyFilter);
        if (filterResetBtn) filterResetBtn.addEventListener('click', resetFilter);

        quickFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                quickFilterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                applyQuickRange(btn.dataset.range);
            });
        });

        renderMeterTables(mockMeterData);
    })();
</script>

