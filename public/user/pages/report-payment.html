<section class="user-bills-section user-payment-page">
    <div class="payment-container">
        <!-- Left Column: Saved Cards -->
        <div class="payment-left-column">
            <h3 class="payment-section-title">Выберите способ оплаты</h3>
            
            <!-- Saved Cards -->
            <div class="saved-cards-container">
                <div class="saved-card-wrapper" onclick="flipSavedCard(this)">
                    <div class="saved-card-inner">
                        <div class="card-preview">
                            <header class="card-preview-header">
                                <div class="card-header-left">
                                    <div class="chip"></div>
                                    <span class="logo">
                                        <div class="mastercard-logo">
                                            <span class="mastercard-circle circle-red"></span>
                                            <span class="mastercard-circle circle-orange"></span>
                                        </div>
                                        <h5>Master Card</h5>
                                    </span>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="contactless-icon">
                                        <i class="bi bi-wifi" style="transform: rotate(-90deg); font-size: 24px;"></i>
                                    </div>
                                    <div class="card-network-logo">
                                        <div class="visa-logo-small">VISA</div>
                                    </div>
                                </div>
                            </header>
                            <div class="card-details">
                                <div class="name-number">
                                    <h6>Card Number</h6>
                                    <h5 class="number">4985 3212 3456 7899</h5>
                                    <div class="card-holder-section">
                                        <h6>Card Holder name</h6>
                                        <h5 class="name">ИВАН ИВАНОВ</h5>
                                    </div>
                                </div>
                                <div class="valid-date">
                                    <h6>Expiry Date</h6>
                                    <h5>12/28</h5>
                                </div>
                            </div>
                        </div>
                        <div class="card-preview-back">
                            <div class="magnetic-strip"></div>
                            <div class="text-end pe-3 mb-2">
                                <small style="color: rgba(255,255,255,0.7); font-size: 0.7rem;">Authorized Signature</small>
                            </div>
                            <div class="signature-area">
                                <span class="cvv-display">468</span>
                            </div>
                            <div class="d-flex justify-content-between px-3 align-items-center mt-auto">
                                <small style="color: rgba(255,255,255,0.6); font-size: 0.6rem; line-height: 1.2; max-width: 200px;">
                                    This card is property of the issuer.
                                </small>
                                <div class="mastercard-logo">
                                    <span class="mastercard-circle circle-red"></span>
                                    <span class="mastercard-circle circle-orange"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="saved-card-wrapper" onclick="flipSavedCard(this)">
                    <div class="saved-card-inner">
                        <div class="card-preview">
                            <header class="card-preview-header">
                                <div class="card-header-left">
                                    <div class="chip"></div>
                                    <span class="logo">
                                        <div class="mastercard-logo">
                                            <span class="mastercard-circle circle-red"></span>
                                            <span class="mastercard-circle circle-orange"></span>
                                        </div>
                                        <h5>Master Card</h5>
                                    </span>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="contactless-icon">
                                        <i class="bi bi-wifi" style="transform: rotate(-90deg); font-size: 24px;"></i>
                                    </div>
                                    <div class="card-network-logo">
                                        <div class="visa-logo-small">VISA</div>
                                    </div>
                                </div>
                            </header>
                            <div class="card-details">
                                <div class="name-number">
                                    <h6>Card Number</h6>
                                    <h5 class="number">5282 3456 7890 1289</h5>
                                    <div class="card-holder-section">
                                        <h6>Card Holder name</h6>
                                        <h5 class="name">ПЕТР ПЕТРОВ</h5>
                                    </div>
                                </div>
                                <div class="valid-date">
                                    <h6>Expiry Date</h6>
                                    <h5>09/25</h5>
                                </div>
                            </div>
                        </div>
                        <div class="card-preview-back">
                            <div class="magnetic-strip"></div>
                            <div class="text-end pe-3 mb-2">
                                <small style="color: rgba(255,255,255,0.7); font-size: 0.7rem;">Authorized Signature</small>
                            </div>
                            <div class="signature-area">
                                <span class="cvv-display">789</span>
                            </div>
                            <div class="d-flex justify-content-between px-3 align-items-center mt-auto">
                                <small style="color: rgba(255,255,255,0.6); font-size: 0.6rem; line-height: 1.2; max-width: 200px;">
                                    This card is property of the issuer.
                                </small>
                                <div class="mastercard-logo">
                                    <span class="mastercard-circle circle-red"></span>
                                    <span class="mastercard-circle circle-orange"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="add-card-btn">
                    <i class="bi bi-plus-lg"></i>
                    <span>Добавить новую</span>
                </button>
            </div>
        </div>

        <!-- Middle Column: Credit Card Form -->
        <div class="payment-middle-column">
            <h3 class="payment-section-title">Оплата банковской картой</h3>
            <p class="payment-amount-label">Сумма к оплате: <span id="paymentAmountLabel">0,00 ₼</span></p>
            
            <!-- Card Preview with 3D Flip -->
            <div class="card-preview-container" id="cardPreviewContainer" onclick="flipPreviewCard()">
                <div class="card-preview-wrapper">
                    <div class="card-preview" id="cardPreview">
                        <header class="card-preview-header">
                            <div class="card-header-left">
                                <div class="chip"></div>
                                <span class="logo">
                                    <div class="mastercard-logo" id="mastercardLogo">
                                        <span class="mastercard-circle circle-red"></span>
                                        <span class="mastercard-circle circle-orange"></span>
                                    </div>
                                    <h5 id="cardPreviewLogoText">Master Card</h5>
                                </span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <div class="contactless-icon">
                                    <i class="bi bi-wifi" style="transform: rotate(-90deg); font-size: 24px;"></i>
                                </div>
                                <div class="card-network-logo" id="cardPreviewNetwork">
                                    <div class="visa-logo-small">VISA</div>
                                </div>
                            </div>
                        </header>
                        <div class="card-details">
                            <div class="name-number">
                                <h6>Card Number</h6>
                                <h5 class="number" id="cardPreviewNumber">**** **** **** ****</h5>
                                <div class="card-holder-section">
                                    <h6>Card Holder name</h6>
                                    <h5 class="name" id="cardPreviewName">ИМЯ ФАМИЛИЯ</h5>
                                </div>
                            </div>
                            <div class="valid-date">
                                <h6>Expiry Date</h6>
                                <h5 id="cardPreviewExpiry">MM/YY</h5>
                            </div>
                        </div>
                    </div>
                    <div class="card-preview-back" id="cardPreviewBack">
                        <div class="magnetic-strip"></div>
                        <div class="text-end pe-3 mb-2">
                            <small style="color: rgba(255,255,255,0.7); font-size: 0.7rem;">Authorized Signature</small>
                        </div>
                        <div class="signature-area">
                            <span class="cvv-display" id="cardPreviewCVV">***</span>
                        </div>
                        <div class="d-flex justify-content-between px-3 align-items-center mt-auto">
                            <small style="color: rgba(255,255,255,0.6); font-size: 0.6rem; line-height: 1.2; max-width: 200px;">
                                This card is property of the issuer.
                            </small>
                            <div class="mastercard-logo" id="cardPreviewBackLogo">
                                <span class="mastercard-circle circle-red"></span>
                                <span class="mastercard-circle circle-orange"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Type Logos -->
            <div class="card-type-logos">
                <div class="card-type-logo-text">Visa</div>
                <div class="card-type-logo-text">Mastercard</div>
                <div class="card-type-logo-text">Мир</div>
            </div>

            <form class="payment-card-form">
                <div class="form-group">
                    <label>Номер карты</label>
                    <div class="card-input-wrapper">
                        <input type="text" placeholder="2324 5566 6677 7898" maxlength="19" class="card-number-input" id="cardNumberInput">
                        <div class="card-input-icon" id="cardInputIcon">MC</div>
                    </div>
                    <div class="card-bank-info" id="cardBankInfo"></div>
                </div>

                <div class="form-group">
                    <label>Имя на карте</label>
                    <input type="text" placeholder="Имя Фамилия" class="card-name-input" id="cardNameInput">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Срок действия</label>
                        <input type="text" placeholder="11/25" class="card-exp-input" id="cardExpInput">
                    </div>

                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" placeholder="123" maxlength="3" class="card-cvv-input" id="cardCvvInput">
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" class="save-card-checkbox">
                        <span>Сохранить карту</span>
                    </label>
                </div>

                <button type="submit" class="pay-button">Оплатить</button>
            </form>
        </div>

        <!-- Right Column: Payment Details -->
        <div class="payment-right-column">
            <h3 class="payment-section-title">Детали оплаты</h3>
            
            <div class="order-summary">
                <div class="order-header">
                    <div class="order-logo">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="order-info">
                        <div class="order-title">RoyalPark Residence</div>
                        <div class="order-subtitle">Оплата счёта</div>
                    </div>
                </div>

                <div class="order-details">
                    <div class="order-detail-item">
                        <span class="detail-label">Тип платежа</span>
                        <span class="detail-value" id="paymentType">—</span>
                    </div>

                    <div class="order-detail-item">
                        <span class="detail-label">Резидент</span>
                        <span class="detail-value" id="paymentResident">—</span>
                    </div>

                    <div class="order-detail-item">
                        <span class="detail-label">Период</span>
                        <span class="detail-value" id="paymentDate">—</span>
                    </div>

                    <!-- <div class="order-detail-item">
                        <span class="detail-label">Комиссия</span>
                        <span class="detail-value" id="paymentCommission">0,00 ₼</span>
                    </div> -->

                    <div class="order-detail-item">
                        <span class="detail-label">Счёт</span>
                        <span class="detail-value" id="invoiceNumber">—</span>
                    </div>
                </div>

                <div class="order-totals">
                    <div class="order-total-item final">
                        <span class="total-label">Итого</span>
                        <span class="total-value" id="total"></span>
                    </div>
                </div>

                <!-- Custom Amount Section -->
                <div class="custom-amount-section">
                    <div class="custom-amount-checkbox">
                        <label class="custom-amount-label">
                            <input type="checkbox" id="customAmountCheckbox" class="custom-amount-checkbox-input">
                            <span class="custom-amount-checkbox-text">Указать другую сумму для оплаты</span>
                        </label>
                    </div>
                    <div class="custom-amount-field-wrapper" id="customAmountFieldWrapper" style="display: none;">
                        <label class="custom-amount-field-label">Сумма к оплате</label>
                        <div class="custom-amount-input-wrapper">
                            <input 
                                type="number" 
                                id="customAmountInput" 
                                class="custom-amount-input" 
                                step="0.01" 
                                min="0.01" 
                                placeholder="0.00"
                            >
                            <span class="custom-amount-currency">₼</span>
                        </div>
                        <div class="custom-amount-hint" id="customAmountHint"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// API Configuration (используем var, чтобы избежать ошибок при повторной загрузке через SPA)
var API_BASE = window.BACKEND_API_BASE || 'http://localhost:8000';
var BIN_LOOKUP_URL = API_BASE + '/api/payment/bin-lookup';

// Current card data
var currentCardData = {
    bin: null,
    bank: null,
    scheme: null,
    country: null
};

// Card styles for different banks (один экземпляр на всё приложение)
if (!window.bankStyles) {
    window.bankStyles = {
        default: {
            gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            logo: 'MC'
        },
        'sberbank': {
            gradient: 'linear-gradient(135deg, #21a038 0%, #16802a 100%)',
            logo: 'СБЕР'
        },
        'vtb': {
            gradient: 'linear-gradient(135deg, #003d82 0%, #001f4d 100%)',
            logo: 'ВТБ'
        },
        'gazprombank': {
            gradient: 'linear-gradient(135deg, #003366 0%, #001a33 100%)',
            logo: 'ГПБ'
        },
        'alfabank': {
            gradient: 'linear-gradient(135deg, #ef3124 0%, #cc2619 100%)',
            logo: 'АЛЬФА'
        },
        'tinkoff': {
            gradient: 'linear-gradient(135deg, #ffdd2d 0%, #ffcd02 100%)',
            logo: 'ТИНЬ',
            textColor: '#000'
        },
        'raiffeisen': {
            gradient: 'linear-gradient(135deg, #ffcc00 0%, #ff9900 100%)',
            logo: 'РБ'
        }
    };
}
var bankStyles = window.bankStyles;

// Fetch BIN data from backend proxy (приоритет: API BINTable)
async function fetchBINData(bin) {
    if (!bin || bin.length < 6) return null;
    
    const firstSix = bin.substring(0, 6);
    
    try {
        const response = await fetch(`${BIN_LOOKUP_URL}?bin=${firstSix}`);
        
        if (!response.ok) {
            console.warn('BIN lookup failed:', response.status);
            // Fallback: определяем схему по номеру, если API недоступен
            return determineSchemeByNumber(firstSix);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Приоритет отдаём данным из BINTable API
            return {
                bank: data.bank || null,
                scheme: data.scheme || null,  // Схема из BINTable API
                country: data.country || null,
                type: data.type || null
            };
        }
        
        // Если API не вернул успешный результат, используем fallback
        return determineSchemeByNumber(firstSix);
    } catch (error) {
        console.error('BIN lookup error:', error);
        // Fallback: определяем схему по номеру при ошибке
        return determineSchemeByNumber(firstSix);
    }
}

// Определяем схему карты по номеру
function determineSchemeByNumber(number) {
    if (!number || number.length < 2) {
        return { scheme: 'Unknown', logo: 'MC' };
    }
    
    const firstDigit = number[0];
    const firstTwo = number.substring(0, 2);
    const firstFour = number.substring(0, 4);
    
    // Visa: начинается с 4
    if (firstDigit === '4') {
        return { scheme: 'Visa', logo: 'VISA' };
    }
    
    // MasterCard: 51-55 или 2221-2720
    if (firstTwo >= '51' && firstTwo <= '55') {
        return { scheme: 'Mastercard', logo: 'MC' };
    }
    
    // MasterCard новая серия: 2221-2720
    const firstFourNum = parseInt(firstFour);
    if (firstFourNum >= 2221 && firstFourNum <= 2720) {
        return { scheme: 'Mastercard', logo: 'MC' };
    }
    
    // Maestro: 50, 56-58, 67
    if (firstTwo === '50' || 
        (firstTwo >= '56' && firstTwo <= '58') || 
        firstTwo === '67') {
        return { scheme: 'Maestro', logo: 'MC' };
    }
    
    // UnionPay: начинается с 62
    if (firstTwo === '62') {
        return { scheme: 'UnionPay', logo: 'UP' };
    }
    
    // Mir: начинается с 2200-2204
    const mirRange = parseInt(firstFour);
    if (mirRange >= 2200 && mirRange <= 2204) {
        return { scheme: 'Мир', logo: 'МИР' };
    }
    
    // Дополнительная проверка для Mir: 2xxx (но не 2200-2204 уже обработано)
    if (firstDigit === '2' && firstTwo !== '22' && firstTwo !== '23') {
        // Другие варианты Mir
        if (firstTwo >= '24' && firstTwo <= '27') {
            // Проверяем, не попали ли в MasterCard диапазон
            if (!(firstFourNum >= 2221 && firstFourNum <= 2720)) {
                return { scheme: 'Мир', logo: 'МИР' };
            }
        }
    }
    
    return { scheme: 'Unknown', logo: 'MC' };
}

// Get bank style
function getBankStyle(bankName) {
    if (!bankName) return bankStyles.default;
    
    const bankLower = bankName.toLowerCase();
    
    // Поиск по ключевым словам в названии банка
    if (bankLower.includes('sber') || bankLower.includes('сбер')) {
        return bankStyles.sberbank;
    } else if (bankLower.includes('vtb') || bankLower.includes('втб')) {
        return bankStyles.vtb;
    } else if (bankLower.includes('gazprom') || bankLower.includes('газпром')) {
        return bankStyles.gazprombank;
    } else if (bankLower.includes('alfa') || bankLower.includes('альфа')) {
        return bankStyles.alfabank;
    } else if (bankLower.includes('tinkoff') || bankLower.includes('тинькофф')) {
        return bankStyles.tinkoff;
    } else if (bankLower.includes('raiffeisen') || bankLower.includes('райффайзен')) {
        return bankStyles.raiffeisen;
    } else if (bankLower.includes('abb') || bankLower.includes('azerbaijan') || bankLower.includes('beynəlxalq')) {
        return bankStyles.abb;
    }
    
    return bankStyles.default;
}

// Update card preview
function updateCardPreview(cardNumber, cardName, cardExp, cardData) {
    const preview = document.getElementById('cardPreview');
    const previewNumber = document.getElementById('cardPreviewNumber');
    const previewName = document.getElementById('cardPreviewName');
    const previewExpiry = document.getElementById('cardPreviewExpiry');
    const previewLogoText = document.getElementById('cardPreviewLogoText');
    const mastercardLogo = document.getElementById('mastercardLogo');
    const cardPreviewNetwork = document.getElementById('cardPreviewNetwork');
    const cardInputIcon = document.getElementById('cardInputIcon');
    const cardBankInfo = document.getElementById('cardBankInfo');
    
    // Update card number
    if (cardNumber) {
        // Убираем пробелы и форматируем строго по 4 цифры
        const digitsOnly = cardNumber.replace(/\s/g, '');
        const formatted = digitsOnly.replace(/(.{4})/g, '$1 ').trim();
        previewNumber.textContent = formatted || '**** **** **** ****';
    } else {
        previewNumber.textContent = '**** **** **** ****';
    }
    
    // Update name
    previewName.textContent = (cardName || 'ИМЯ ФАМИЛИЯ').toUpperCase();
    
    // Update expiry
    previewExpiry.textContent = cardExp || 'MM/YY';
    
    // Определяем тип карты и логотип
    let cardType = 'Master Card';
    let showMastercardLogo = true;
    
    if (cardData?.scheme) {
        const scheme = cardData.scheme.toLowerCase();
        if (scheme === 'visa') {
            cardType = 'Visa';
            showMastercardLogo = false;
        } else if (scheme === 'мир' || scheme === 'mir') {
            cardType = 'МИР';
            showMastercardLogo = false;
        } else if (scheme === 'mastercard') {
            cardType = 'Master Card';
            showMastercardLogo = true;
        } else if (scheme === 'maestro') {
            cardType = 'Maestro';
            showMastercardLogo = false;
        } else if (scheme === 'unionpay') {
            cardType = 'UnionPay';
            showMastercardLogo = false;
        }
    }
    
    // Показываем/скрываем логотип Mastercard и создаем другие логотипы
    const logoContainer = preview.querySelector('.logo');
    if (logoContainer) {
        // Удаляем все существующие логотипы (кроме текста)
        const existingLogos = logoContainer.querySelectorAll('.mastercard-logo, .visa-logo, .mir-logo');
        existingLogos.forEach(logo => logo.remove());
        
        // Создаем нужный логотип
        if (showMastercardLogo) {
            const mcLogo = document.createElement('div');
            mcLogo.className = 'mastercard-logo';
            mcLogo.innerHTML = '<span class="mastercard-circle circle-red"></span><span class="mastercard-circle circle-orange"></span>';
            logoContainer.insertBefore(mcLogo, previewLogoText);
        } else if (cardType === 'Visa') {
            const visaLogo = document.createElement('div');
            visaLogo.className = 'visa-logo';
            visaLogo.textContent = 'VISA';
            logoContainer.insertBefore(visaLogo, previewLogoText);
        } else if (cardType === 'МИР') {
            const mirLogo = document.createElement('div');
            mirLogo.className = 'mir-logo';
            mirLogo.textContent = 'МИР';
            logoContainer.insertBefore(mirLogo, previewLogoText);
        }
    }
    
    if (previewLogoText) {
        previewLogoText.textContent = cardType;
    }
    if (cardInputIcon) {
        cardInputIcon.textContent = cardType;
    }
    
    // Обновляем логотип сети в правом верхнем углу
    if (cardPreviewNetwork) {
        if (cardType === 'Visa') {
            cardPreviewNetwork.innerHTML = '<div class="visa-logo-small">VISA</div>';
        } else if (cardType === 'Master Card') {
            cardPreviewNetwork.innerHTML = '<div class="mastercard-logo-small"><span class="mastercard-circle circle-red"></span><span class="mastercard-circle circle-orange"></span></div>';
        } else if (cardType === 'МИР') {
            cardPreviewNetwork.innerHTML = '<div class="mir-logo-small">МИР</div>';
        } else {
            cardPreviewNetwork.innerHTML = '<div class="visa-logo-small">VISA</div>';
        }
    }
    
    // Update background based on bank or default beautiful gradient
    const bankStyle = getBankStyle(cardData?.bank);
    if (bankStyle && bankStyle.gradient) {
        preview.style.background = bankStyle.gradient;
    } else {
        // Красивый градиент по умолчанию
        preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
    preview.style.color = 'white';
    
    // Show bank info
    if (cardBankInfo && cardData?.bank) {
        cardBankInfo.innerHTML = `<small>Банк: ${cardData.bank}${cardData.country ? ` (${cardData.country})` : ''}</small>`;
    } else if (cardBankInfo) {
        cardBankInfo.innerHTML = '';
    }
}

// Card number formatting and BIN lookup
document.getElementById('cardNumberInput')?.addEventListener('input', async function(e) {
    let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    // Форматируем строго по 4 цифры в группе (максимум 16 цифр для стандартной карты)
    let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1 ');
    // Ограничиваем до 19 символов (16 цифр + 3 пробела)
    if (formattedValue.length > 19) {
        formattedValue = formattedValue.substring(0, 19);
    }
    e.target.value = formattedValue;
    
    // Update preview
    const cardName = document.getElementById('cardNameInput').value;
    const cardExp = document.getElementById('cardExpInput').value;
    updateCardPreview(formattedValue, cardName, cardExp, currentCardData);
    
    // Для первых 2-4 цифр используем быстрый fallback для предварительного определения
    let fallbackScheme = null;
    if (value.length >= 2 && value.length < 6) {
        const tempScheme = determineSchemeByNumber(value);
        if (tempScheme) {
            fallbackScheme = tempScheme.scheme;
            currentCardData.scheme = fallbackScheme;
            updateCardPreview(formattedValue, cardName, cardExp, currentCardData);
        }
        return; // Выходим, так как для BIN lookup нужно минимум 6 цифр
    }
    
    // Lookup BIN через API BINTable (приоритетный источник) если есть минимум 6 цифр
    if (value.length >= 6) {
        const bin = value.substring(0, 6);
        if (bin !== currentCardData.bin) {
            currentCardData.bin = bin;
            
            // Запрашиваем данные через BINTable API (приоритет)
            const binData = await fetchBINData(value);
            
            if (binData) {
                // Используем данные из API BINTable (схема, банк, страна)
                currentCardData = { 
                    ...currentCardData, 
                    bank: binData.bank || null,
                    scheme: binData.scheme || null,  // Схема из API имеет приоритет
                    country: binData.country || null,
                    type: binData.type || null
                };
            } else {
                // Если API не вернул данных, используем fallback определение
                const fallbackData = determineSchemeByNumber(value);
                currentCardData = {
                    ...currentCardData,
                    bank: null,
                    scheme: fallbackData?.scheme || null,
                    country: null,
                    type: null
                };
            }
            
            updateCardPreview(formattedValue, cardName, cardExp, currentCardData);
        }
    } else if (value.length === 0) {
        // Если поле очищено, сбрасываем данные
        currentCardData = { bin: null, bank: null, scheme: null, country: null };
        updateCardPreview(formattedValue, cardName, cardExp, null);
    }
});

// Card name input
document.getElementById('cardNameInput')?.addEventListener('input', function(e) {
    const cardNumber = document.getElementById('cardNumberInput').value;
    const cardExp = document.getElementById('cardExpInput').value;
    updateCardPreview(cardNumber, e.target.value, cardExp, currentCardData);
});

// Exp date formatting (MM/YY)
document.getElementById('cardExpInput')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
    
    const cardNumber = document.getElementById('cardNumberInput').value;
    const cardName = document.getElementById('cardNameInput').value;
    updateCardPreview(cardNumber, cardName, value, currentCardData);
});

// CVV formatting
document.getElementById('cardCvvInput')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

// Flip card functions
function flipSavedCard(element) {
    if (element) {
        element.classList.toggle('flipped');
    }
}

function flipPreviewCard() {
    const container = document.getElementById('cardPreviewContainer');
    if (container) {
        container.classList.toggle('flipped');
    }
}

// Update CVV on card back
document.getElementById('cardCvvInput')?.addEventListener('input', function(e) {
    const cvv = e.target.value.replace(/\D/g, '');
    const cvvDisplay = document.getElementById('cardPreviewCVV');
    if (cvvDisplay) {
        cvvDisplay.textContent = cvv || '***';
    }
});

// -------------------------------
// Инициализация данных оплаты
// -------------------------------

// Fallback: получить сводку дашборда с backend
async function loadDashboardSummaryForPayment(scope) {
    try {
        const resp = await fetch(`${API_BASE}/api/resident/dashboard`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        if (!resp.ok) {
            console.warn('Failed to load dashboard summary for payment:', resp.status);
            return null;
        }
        const data = await resp.json();
        const summary = data.summary || {};
        const amount = scope === 'all'
            ? (summary.total_debt || 0)
            : (summary.total_month || 0);
        return { amount, summary };
    } catch (err) {
        console.error('Error loading dashboard summary for payment:', err);
        return null;
    }
}

// Загрузка связанных счетов резидента для показа в деталях оплаты
async function loadPaymentInvoices(scope, residentCode) {
    try {
        const response = await fetch(`${API_BASE}/api/resident/invoices`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            console.warn('Failed to load resident invoices for payment details:', response.status);
            return;
        }

        const data = await response.json();
        const invoices = data.invoices || [];
        if (!invoices.length) {
            return;
        }

        const now = new Date();
        const curYear = now.getFullYear();
        const curMonth = now.getMonth() + 1;

        let targetInvoices = invoices;
        if (scope === 'month') {
            const monthInvoices = invoices.filter(inv => inv.period_year === curYear && inv.period_month === curMonth);
            if (monthInvoices.length) {
                targetInvoices = monthInvoices;
            }
        }

        // Подготовим список id выбранных счетов для страницы "Мои счета"
        const targetInvoiceIds = (targetInvoices || [])
            .map(inv => inv && inv.id)
            .filter(id => id !== null && id !== undefined);
        if (targetInvoiceIds.length) {
            try {
                sessionStorage.setItem('billsFilterInvoiceIds', JSON.stringify(targetInvoiceIds));
                // При переходе со страницы оплаты хотим сразу показывать только счета в статусе ISSUED и PARTIAL
                const statusesForBills = ['ISSUED', 'PARTIAL'];
                sessionStorage.setItem('billsFilterStatuses', JSON.stringify(statusesForBills));
            } catch (e) {
                console.warn('Failed to store billsFilterInvoiceIds or billsFilterStatuses', e);
            }
        }

        const invoiceNumberEl = document.getElementById('invoiceNumber');
        const paymentResidentEl = document.getElementById('paymentResident');
        const paymentDateEl = document.getElementById('paymentDate');
        const totalEl = document.getElementById('total');
        const amountLabelEl = document.getElementById('paymentAmountLabel');

        const first = targetInvoices[0];

        // Номер счёта
        if (invoiceNumberEl) {
            // Сбрасываем класс ссылки перед установкой
            invoiceNumberEl.classList.remove('invoice-link');

            if (targetInvoices.length === 1 && first) {
                // Один счёт — делаем номер кликабельным и ведём на страницу просмотра счёта
                invoiceNumberEl.textContent = first.number || `№${first.id}`;
                invoiceNumberEl.style.cursor = 'pointer';
                invoiceNumberEl.classList.add('invoice-link');
                invoiceNumberEl.onclick = function () {
                    const invId = first.id;
                    if (!invId) return;
                    try {
                        // Для user/pages/invoice-view.html
                        sessionStorage.setItem('currentInvoiceId', String(invId));
                    } catch (e) {
                        console.warn('Failed to store currentInvoiceId before navigation', e);
                    }

                    // Переход на маршрут invoice (user SPA)
                    if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                        window.userSpaRouter.navigate('invoice', true);
                    } else {
                        // Fallback: обычный URL с hash и параметром id
                        window.location.href = `/user/dashboard.html#invoice?id=${encodeURIComponent(invId)}`;
                    }
                };
            } else {
                // Несколько счетов — ведём на список счетов с фильтрацией
                invoiceNumberEl.textContent = `Несколько счетов (${targetInvoices.length})`;
                invoiceNumberEl.style.cursor = 'pointer';
                invoiceNumberEl.classList.add('invoice-link');
                invoiceNumberEl.onclick = function () {
                    if (targetInvoiceIds.length) {
                        try {
                            sessionStorage.setItem('billsFilterInvoiceIds', JSON.stringify(targetInvoiceIds));
                        } catch (e) {
                            console.warn('Failed to store billsFilterInvoiceIds before navigation', e);
                        }
                    }
                    if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                        window.userSpaRouter.navigate('bills', true);
                    } else {
                        window.location.href = '/user/dashboard.html#bills';
                    }
                };
            }
        }

        // Резидент
        if (paymentResidentEl) {
            const codeFromInvoice = first?.resident_code;
            if (codeFromInvoice) {
                paymentResidentEl.textContent = codeFromInvoice;
            } else if (residentCode) {
                paymentResidentEl.textContent = residentCode;
            }
        }

        // Период
        if (paymentDateEl && targetInvoices.length > 0) {
            if (scope === 'all' && targetInvoices.length > 1) {
                // Для полного погашения долга показываем диапазон от первой до последней даты
                const parseDate = (str) => {
                    if (!str || typeof str !== 'string') return null;
                    const parts = str.split('.');
                    if (parts.length !== 3) return null;
                    const [dd, mm, yyyy] = parts.map(p => parseInt(p, 10));
                    if (!dd || !mm || !yyyy) return null;
                    return new Date(yyyy, mm - 1, dd);
                };

                let minDate = null;
                let maxDate = null;
                let minText = null;
                let maxText = null;

                targetInvoices.forEach(inv => {
                    const fromStr = inv?.period_dates?.from || null;
                    const toStr = inv?.period_dates?.to || null;

                    const fromDate = parseDate(fromStr || toStr);
                    const toDate = parseDate(toStr || fromStr);

                    if (fromDate) {
                        if (!minDate || fromDate < minDate) {
                            minDate = fromDate;
                            minText = fromStr || toStr;
                        }
                    }
                    if (toDate) {
                        if (!maxDate || toDate > maxDate) {
                            maxDate = toDate;
                            maxText = toStr || fromStr;
                        }
                    }
                });

                if (minText && maxText) {
                    paymentDateEl.textContent = `${minText} — ${maxText}`;
                } else {
                    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                    let minYear = null, minMonth = null, maxYear = null, maxMonth = null;
                    targetInvoices.forEach(inv => {
                        if (inv.period_year && inv.period_month) {
                            const y = inv.period_year;
                            const m = inv.period_month;
                            if (minYear === null || y < minYear || (y === minYear && m < minMonth)) {
                                minYear = y;
                                minMonth = m;
                            }
                            if (maxYear === null || y > maxYear || (y === maxYear && m > maxMonth)) {
                                maxYear = y;
                                maxMonth = m;
                            }
                        }
                    });
                    if (minYear !== null && maxYear !== null) {
                        const minTextMonth = monthNames[minMonth - 1] || minMonth;
                        const maxTextMonth = monthNames[maxMonth - 1] || maxMonth;
                        if (minYear === maxYear && minMonth === maxMonth) {
                            paymentDateEl.textContent = `${minTextMonth} ${minYear}`;
                        } else {
                            paymentDateEl.textContent = `${minTextMonth} ${minYear} — ${maxTextMonth} ${maxYear}`;
                        }
                    }
                }
            } else if (first) {
                if (first.period_dates && first.period_dates.from && first.period_dates.to) {
                    paymentDateEl.textContent = `${first.period_dates.from} — ${first.period_dates.to}`;
                } else if (first.period_year && first.period_month) {
                    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                    const mName = monthNames[first.period_month - 1] || first.period_month;
                    paymentDateEl.textContent = `${mName} ${first.period_year}`;
                }
            }
        }

        // Сумма по инвойсам как дополнительная гарантия
        if (totalEl && amountLabelEl && targetInvoices.length > 0) {
            let sumAmount = 0;
            // Для пользователя важно видеть сумму К ОПЛАТЕ (остаток), а не общий номинал счетов
            // Поэтому и для 'all', и для 'month' используем remaining_amount, если он есть
            sumAmount = targetInvoices.reduce(
                (acc, inv) => acc + (inv.remaining_amount ?? inv.amount_total ?? 0),
                0
            );

            const formatted = new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(sumAmount) + ' ₼';

            totalEl.textContent = formatted;
            amountLabelEl.textContent = formatted;
        }
    } catch (error) {
        console.error('Error loading payment-related invoices:', error);
    }
}

// Форматирование текущей даты/времени для возможного использования
function formatPaymentDateNow() {
    const now = new Date();
    return now.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Главная инициализация страницы оплаты
async function initPaymentPage() {
    // Изначально очищаем превью карты
    updateCardPreview('', '', '', null);

    try {
        const scope = sessionStorage.getItem('paymentScope') || 'month';
        let amountRaw = sessionStorage.getItem('paymentAmount');
        let amount = amountRaw ? parseFloat(amountRaw) : 0;
        const scopeLabelStored = sessionStorage.getItem('paymentScopeLabel');
        const residentCodeStored = sessionStorage.getItem('paymentResidentCode');
        const paymentSummaryRaw = sessionStorage.getItem('paymentSummary');
        let paymentSummary = null;
        if (paymentSummaryRaw) {
            try {
                paymentSummary = JSON.parse(paymentSummaryRaw);
            } catch (e) {
                console.warn('Failed to parse paymentSummary from sessionStorage', e);
            }
        }

        const totalEl = document.getElementById('total');
        const subtitleEl = document.querySelector('.order-subtitle');
        const amountLabelEl = document.getElementById('paymentAmountLabel');
        const paymentTypeEl = document.getElementById('paymentType');
        const paymentResidentEl = document.getElementById('paymentResident');
        const paymentDateEl = document.getElementById('paymentDate');
        const paymentCommissionEl = document.getElementById('paymentCommission');

        // Если сумма из sessionStorage отсутствует или равна 0, пробуем взять её из summary/бэкенда
        if (!amount || Number.isNaN(amount)) {
            if (paymentSummary) {
                amount = scope === 'all'
                    ? (paymentSummary.total_debt || 0)
                    : (paymentSummary.total_month || 0);
            }
            if (!amount || Number.isNaN(amount)) {
                const fallback = await loadDashboardSummaryForPayment(scope);
                if (fallback && typeof fallback.amount === 'number') {
                    amount = fallback.amount;
                }
            }
        }

        const formattedAmount = new Intl.NumberFormat('ru-RU', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount || 0) + ' ₼';

        if (totalEl) {
            totalEl.textContent = formattedAmount;
        }
        if (amountLabelEl) {
            amountLabelEl.textContent = formattedAmount;
        }

        if (subtitleEl) {
            if (scope === 'all') {
                subtitleEl.textContent = 'Оплата всего долга';
            } else {
                subtitleEl.textContent = 'Оплата за текущий месяц';
            }
        }

        if (paymentTypeEl) {
            const defaultScopeText = scope === 'all'
                ? 'Полное погашение долга по счетам'
                : 'Оплата счетов за текущий месяц';
            paymentTypeEl.textContent = scopeLabelStored || defaultScopeText;
        }

        if (paymentResidentEl) {
            paymentResidentEl.textContent = residentCodeStored || '—';
        }

        // Загрузить данные по счетам с backend, чтобы дополнить детали оплаты
        loadPaymentInvoices(scope, residentCodeStored || null);

        if (paymentCommissionEl) {
            paymentCommissionEl.textContent = '0,00 ₼';
        }
        // paymentDateEl заполняется в loadPaymentInvoices, но при полном отсутствии данных
        if (paymentDateEl && !paymentDateEl.textContent) {
            paymentDateEl.textContent = formatPaymentDateNow();
        }

        // Initialize custom amount functionality
        initCustomAmountField(amount);
    } catch (err) {
        console.error('Error initializing payment summary:', err);
    }
}

// Initialize custom amount field functionality
function initCustomAmountField(defaultAmount) {
    const checkbox = document.getElementById('customAmountCheckbox');
    const fieldWrapper = document.getElementById('customAmountFieldWrapper');
    const amountInput = document.getElementById('customAmountInput');
    const hintEl = document.getElementById('customAmountHint');
    const totalEl = document.getElementById('total');

    if (!checkbox || !fieldWrapper || !amountInput) return;

    // Get total amount from invoice
    let invoiceTotal = defaultAmount || 0;
    if (totalEl) {
        const totalText = totalEl.textContent || '';
        const cleanAmount = totalText.replace(/[^\d,\.]/g, '').replace(',', '.');
        invoiceTotal = parseFloat(cleanAmount) || 0;
    }

    // Checkbox change handler
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            fieldWrapper.style.display = 'block';
            amountInput.focus();
            // Set default value to invoice total
            if (invoiceTotal > 0) {
                amountInput.value = invoiceTotal.toFixed(2);
            }
            updateAmountHint(invoiceTotal, invoiceTotal);
        } else {
            fieldWrapper.style.display = 'none';
            amountInput.value = '';
            if (hintEl) hintEl.textContent = '';
        }
    });

    // Input change handler
    amountInput.addEventListener('input', function() {
        const customAmount = parseFloat(this.value) || 0;
        updateAmountHint(invoiceTotal, customAmount);
    });

    // Update hint based on amounts
    function updateAmountHint(invoiceTotal, customAmount) {
        if (!hintEl) return;
        
        if (customAmount <= 0) {
            hintEl.textContent = '';
            hintEl.className = 'custom-amount-hint';
            return;
        }

        if (customAmount > invoiceTotal) {
            const advance = customAmount - invoiceTotal;
            hintEl.textContent = `Излишек ${advance.toFixed(2)} ₼ будет зачислен в аванс`;
            hintEl.className = 'custom-amount-hint hint-advance';
        } else if (customAmount < invoiceTotal) {
            const remaining = invoiceTotal - customAmount;
            hintEl.textContent = `Останется к оплате: ${remaining.toFixed(2)} ₼ (счёт будет частично оплачен)`;
            hintEl.className = 'custom-amount-hint hint-partial';
        } else {
            hintEl.textContent = 'Счёт будет полностью оплачен';
            hintEl.className = 'custom-amount-hint hint-full';
        }
    }
}

// -------------------------------
// Submit Payment Function
// -------------------------------

async function submitPayment(event) {
    if (event) {
        event.preventDefault();
    }
    
    const payButton = document.querySelector('.pay-button');
    const originalText = payButton ? payButton.textContent : 'Оплатить';
    
    // Validate card form
    const cardNumber = document.getElementById('cardNumberInput')?.value?.replace(/\s/g, '') || '';
    const cardName = document.getElementById('cardNameInput')?.value?.trim() || '';
    const cardExp = document.getElementById('cardExpInput')?.value || '';
    const cardCvv = document.getElementById('cardCvvInput')?.value || '';
    
    // Basic validation
    if (cardNumber.length < 13) {
        showPaymentError('Введите корректный номер карты');
        return false;
    }
    if (cardName.length < 2) {
        showPaymentError('Введите имя на карте');
        return false;
    }
    if (!cardExp.match(/^\d{2}\/\d{2}$/)) {
        showPaymentError('Введите срок действия карты (MM/YY)');
        return false;
    }
    if (cardCvv.length < 3) {
        showPaymentError('Введите CVV код');
        return false;
    }
    
    // Get payment data from session storage
    const scope = sessionStorage.getItem('paymentScope') || 'month';
    let amount = parseFloat(sessionStorage.getItem('paymentAmount') || '0');
    
    // Check if custom amount is enabled
    const customAmountCheckbox = document.getElementById('customAmountCheckbox');
    const customAmountInput = document.getElementById('customAmountInput');
    const useCustomAmount = customAmountCheckbox && customAmountCheckbox.checked;
    
    if (useCustomAmount && customAmountInput) {
        // Use custom amount from input
        const customAmount = parseFloat(customAmountInput.value) || 0;
        if (customAmount <= 0) {
            showPaymentError('Введите сумму для оплаты');
            return false;
        }
        amount = customAmount;
    } else {
        // Use default amount from session storage or total element
        if (!amount || amount <= 0) {
            const totalEl = document.getElementById('total');
            if (totalEl) {
                const totalText = totalEl.textContent || '';
                // Parse "1 234,56 ₼" format
                const cleanAmount = totalText.replace(/[^\d,\.]/g, '').replace(',', '.');
                amount = parseFloat(cleanAmount) || 0;
            }
        }
    }
    
    if (amount <= 0) {
        showPaymentError('Сумма оплаты должна быть больше 0');
        return false;
    }
    
    // Get resident IDs from dashboard data
    let residentId = null;
    try {
        const dashboardResp = await fetch(`${API_BASE}/api/resident/dashboard`, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });
        if (dashboardResp.ok) {
            const dashboardData = await dashboardResp.json();
            if (dashboardData.residents && dashboardData.residents.length > 0) {
                // Use first resident ID (in case user has multiple)
                residentId = dashboardData.residents[0].id;
            }
        }
    } catch (err) {
        console.error('Failed to get resident ID:', err);
    }
    
    if (!residentId) {
        showPaymentError('Не удалось определить резидента. Попробуйте перезагрузить страницу.');
        return false;
    }
    
    // Show loading state
    if (payButton) {
        payButton.disabled = true;
        payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обработка...';
    }
    
    try {
        // Submit payment to backend
        const response = await fetch(`${API_BASE}/api/resident/payment`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                resident_id: residentId,
                amount: amount,
                method: 'CARD',
                reference: `Card ***${cardNumber.slice(-4)}`,
                comment: `Онлайн-оплата картой ${cardName}`
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Ошибка сервера: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.ok) {
            // Success!
            showPaymentSuccess('Платёж успешно проведён!');
            
            // Clear payment session data
            sessionStorage.removeItem('paymentAmount');
            sessionStorage.removeItem('paymentScope');
            sessionStorage.removeItem('paymentScopeLabel');
            sessionStorage.removeItem('paymentResidentCode');
            sessionStorage.removeItem('paymentSummary');
            
            // Set filter to show DRAFT status invoices on bills page
            sessionStorage.setItem('billsFilterStatuses', JSON.stringify(['DRAFT']));
            
            // Redirect to bills page with DRAFT filter after short delay
            setTimeout(() => {
                if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                    window.userSpaRouter.navigate('bills', true);
                } else {
                    window.location.href = '/user/dashboard.html#bills?status=DRAFT';
                }
            }, 2000);
        } else {
            throw new Error(result.message || 'Не удалось обработать платёж');
        }
        
    } catch (error) {
        console.error('Payment error:', error);
        showPaymentError(error.message || 'Произошла ошибка при обработке платежа');
        
        // Restore button
        if (payButton) {
            payButton.disabled = false;
            payButton.textContent = originalText;
        }
    }
    
    return false;
}

// Show success message
function showPaymentSuccess(message) {
    // Try to use global notification system if available
    if (window.showSuccess) {
        window.showSuccess(message);
        return;
    }
    
    // Fallback: create custom toast
    const toast = document.createElement('div');
    toast.className = 'payment-toast payment-toast-success';
    toast.innerHTML = `
        <div class="payment-toast-icon">
            <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="payment-toast-message">${message}</div>
    `;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Show error message
function showPaymentError(message) {
    // Try to use global notification system if available
    if (window.showError) {
        window.showError(message);
        return;
    }
    
    // Fallback: create custom toast
    const toast = document.createElement('div');
    toast.className = 'payment-toast payment-toast-error';
    toast.innerHTML = `
        <div class="payment-toast-icon">
            <i class="bi bi-exclamation-circle-fill"></i>
        </div>
        <div class="payment-toast-message">${message}</div>
    `;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add toast animations
if (!document.getElementById('payment-toast-styles')) {
    const style = document.createElement('style');
    style.id = 'payment-toast-styles';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

// Bind pay button
function bindPayButton() {
    const payForm = document.querySelector('.payment-card-form');
    const payButton = document.querySelector('.pay-button');
    
    if (payForm) {
        payForm.addEventListener('submit', submitPayment);
    }
    
    if (payButton && !payButton.dataset.bound) {
        payButton.dataset.bound = 'true';
        payButton.addEventListener('click', function(e) {
            if (!payForm) {
                submitPayment(e);
            }
        });
    }
}

// Инициализируем страницу как при обычной загрузке, так и при загрузке через SPA
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        initPaymentPage();
        bindPayButton();
    });
} else {
    initPaymentPage();
    bindPayButton();
}
</script>
