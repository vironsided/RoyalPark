<section class="user-bills-section user-payment-page">
    <div class="payment-container">
        <!-- Left Column: Saved Cards -->
        <div class="payment-left-column">
            <h3 class="payment-section-title">Выберите способ оплаты</h3>
            
            <!-- Saved Cards -->
            <div class="saved-cards-container">
                <!-- Default Royal Park resident card (advance balance) -->
                <div class="saved-card-wrapper resident-pass-wrapper">
                    <div class="resident-pass-card"
                         data-card-id="advance-pass"
                         data-card-type="ADVANCE"
                         data-card-holder="Vusal Guleli Teymurov">
                        <div class="pass-header">
                            <div class="pass-brand">
                                <svg class="pass-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z" />
                                </svg>
                                <span class="pass-brand-name">ROYAL PARK</span>
                            </div>
                            <div class="pass-type">RESIDENT PASS</div>
                        </div>

                        <div class="pass-chip-row">
                            <div class="pass-chip">
                                <div class="chip-line"></div>
                                <div class="chip-line"></div>
                                <div class="chip-line"></div>
                                <div class="chip-line"></div>
                            </div>
                            <svg class="pass-contactless" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 8a10 10 0 0 1 0 8" />
                                <path d="M8 6a14 14 0 0 1 0 12" />
                                <path d="M11 4a18 18 0 0 1 0 16" />
                            </svg>
                        </div>

                        <div class="pass-balance">
                            <div class="pass-label">Advance Balance</div>
                            <div class="pass-amount" id="passAdvanceAmount"></div>
                        </div>

                        <div class="pass-footer">
                            <div>
                                <div class="pass-label">Resident Name</div>
                                <div class="pass-name" id="passResidentName"></div>
                            </div>
                            <div class="pass-expiry">
                                <div class="pass-label">Valid Thru</div>
                                <div class="pass-exp">12/28</div>
                            </div>
                        </div>

                        <div class="pass-pattern"></div>
                        <div class="pass-gloss"></div>
                    </div>
                </div>

                <!-- Stylized static saved cards -->
                <div class="bank-card animated-bg-1"
                     data-card-id="saved-mc-1"
                     data-card-last4="7899"
                     data-card-holder="ИВАН ИВАНОВ">
                    <div class="glass-overlay"></div>
                    <div class="card-inner">
                        <div class="card-top">
                            <div class="chip chip-with-svg">
                                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                                    <defs>
                                        <linearGradient id="saved-chip-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#b8860b;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <rect x="10" y="20" width="80" height="60" rx="10" fill="url(#saved-chip-grad)" />
                                    <path d="M10 40 H90 M10 60 H90 M40 20 V80 M60 20 V80" stroke="rgba(0,0,0,0.2)" stroke-width="1" fill="none"/>
                                </svg>
                            </div>
                            <div class="contactless">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                                    <path d="M5 8a10 10 0 0 1 0 8" />
                                    <path d="M8 6a14 14 0 0 1 0 12" />
                                    <path d="M11 4a18 18 0 0 1 0 16" />
                                </svg>
                            </div>
                        </div>
                        
                        <div class="brand-row">
                            <div class="brand-logo">
                                <div class="mc-circles">
                                    <div class="circle red"></div>
                                    <div class="circle orange"></div>
                                </div>
                                <span class="brand-name">MasterCard</span>
                            </div>
                        </div>

                        <div class="card-number">4985 3212 3456 7899</div>

                        <div class="card-bottom">
                            <div class="info-group">
                                <label>CARD HOLDER NAME</label>
                                <div class="value">ИВАН ИВАНОВ</div>
                            </div>
                            <div class="info-group align-right">
                                <label>EXPIRY DATE</label>
                                <div class="value">12/28</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bank-card animated-bg-2"
                     data-card-id="saved-visa-1"
                     data-card-last4="1289"
                     data-card-holder="ПЕТР ПЕТРОВ">
                    <div class="glass-overlay"></div>
                    <div class="card-inner">
                        <div class="card-top">
                            <div class="chip chip-with-svg">
                                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                                    <rect x="10" y="20" width="80" height="60" rx="10" fill="#ffd700" />
                                    <path d="M10 40 H90 M10 60 H90 M40 20 V80 M60 20 V80" stroke="rgba(0,0,0,0.2)" stroke-width="1" fill="none"/>
                                </svg>
                            </div>
                            <div class="contactless">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                                    <path d="M5 8a10 10 0 0 1 0 8" />
                                    <path d="M8 6a14 14 0 0 1 0 12" />
                                    <path d="M11 4a18 18 0 0 1 0 16" />
                                </svg>
                            </div>
                        </div>
                        
                        <div class="brand-row">
                            <div class="brand-logo">
                                <div class="visa-badge">VISA</div>
                            </div>
                        </div>

                        <div class="card-number">5282 3456 7890 1289</div>

                        <div class="card-bottom">
                            <div class="info-group">
                                <label>CARD HOLDER NAME</label>
                                <div class="value">ПЕТР ПЕТРОВ</div>
                            </div>
                            <div class="info-group align-right">
                                <label>EXPIRY DATE</label>
                                <div class="value">09/25</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="add-card-btn">
                    <i class="bi bi-plus-lg"></i>
                    <span>Добавить новую</span>
                </button>
            </div>
        </div>

        <!-- Middle Column: Credit Card Form (hidden by default until user chooses to add a card) -->
        <div class="payment-middle-column is-hidden" id="paymentMiddleColumn">
            <h3 class="payment-section-title">Оплата банковской картой</h3>
            <p class="payment-amount-label">Сумма к оплате: <span id="paymentAmountLabel">0,00 ₼</span></p>
            
            <!-- Card Preview with 3D Flip -->
            <div class="card-preview-container" id="cardPreviewContainer" onclick="flipPreviewCard()">
                <div class="card-preview-wrapper">
                    <div class="card-preview modern-card" id="cardPreview">
                        <div class="glass-overlay card-preview-overlay"></div>
                        <header class="card-preview-header">
                            <div class="card-header-left">
                                <div class="chip modern-chip"></div>
                                <span class="logo">
                                    <div class="mastercard-logo" id="mastercardLogo">
                                        <span class="mastercard-circle circle-red"></span>
                                        <span class="mastercard-circle circle-orange"></span>
                                    </div>
                                    <h5 id="cardPreviewLogoText">Master Card</h5>
                                </span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <div class="contactless-icon">
                                    <i class="bi bi-wifi" style="transform: rotate(-90deg); font-size: 24px;"></i>
                                </div>
                                <div class="card-network-logo" id="cardPreviewNetwork">
                                    <div class="visa-logo-small">VISA</div>
                                </div>
                            </div>
                        </header>
                        <div class="card-details">
                            <div class="name-number">
                                <h6>Card Number</h6>
                                <h5 class="number" id="cardPreviewNumber">**** **** **** ****</h5>
                                <div class="card-holder-section">
                                    <h6>Card Holder name</h6>
                                    <h5 class="name" id="cardPreviewName">ИМЯ ФАМИЛИЯ</h5>
                                </div>
                            </div>
                            <div class="valid-date">
                                <h6>Expiry Date</h6>
                                <h5 id="cardPreviewExpiry">MM/YY</h5>
                            </div>
                        </div>
                    </div>
                    <div class="card-preview-back" id="cardPreviewBack">
                        <div class="magnetic-strip"></div>
                        <div class="text-end pe-3 mb-2">
                            <small style="color: rgba(255,255,255,0.7); font-size: 0.7rem;">Authorized Signature</small>
                        </div>
                        <div class="signature-area">
                            <span class="cvv-display" id="cardPreviewCVV">***</span>
                        </div>
                        <div class="d-flex justify-content-between px-3 align-items-center mt-auto">
                            <small style="color: rgba(255,255,255,0.6); font-size: 0.6rem; line-height: 1.2; max-width: 200px;">
                                This card is property of the issuer.
                            </small>
                            <div class="mastercard-logo" id="cardPreviewBackLogo">
                                <span class="mastercard-circle circle-red"></span>
                                <span class="mastercard-circle circle-orange"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Type Logos -->
            <div class="card-type-logos">
                <div class="card-type-logo-text">Visa</div>
                <div class="card-type-logo-text">Mastercard</div>
                <div class="card-type-logo-text">Мир</div>
            </div>

            <form class="payment-card-form">
                <div class="form-group">
                    <label>Номер карты</label>
                    <div class="card-input-wrapper">
                        <input type="text" placeholder="2324 5566 6677 7898" maxlength="19" class="card-number-input" id="cardNumberInput">
                        <div class="card-input-icon" id="cardInputIcon">MC</div>
                    </div>
                    <div class="card-bank-info" id="cardBankInfo"></div>
                </div>

                <div class="form-group">
                    <label>Имя на карте</label>
                    <input type="text" placeholder="Имя Фамилия" class="card-name-input" id="cardNameInput">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Срок действия</label>
                        <input type="text" placeholder="11/25" class="card-exp-input" id="cardExpInput">
                    </div>

                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" placeholder="123" maxlength="3" class="card-cvv-input" id="cardCvvInput">
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" class="save-card-checkbox">
                        <span>Сохранить карту</span>
                    </label>
                </div>

                <button type="submit" class="pay-button">Оплатить</button>
            </form>
        </div>

        <!-- Right Column: Payment Details -->
        <div class="payment-right-column">
            <h3 class="payment-section-title">Детали оплаты</h3>
            
            <div class="order-summary">
                <div class="order-header">
                    <div class="order-logo">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="order-info">
                        <div class="order-title">RoyalPark Residence</div>
                        <div class="order-subtitle">Оплата счёта</div>
                    </div>
                </div>

                <div class="order-details">
                    <div class="order-detail-item">
                        <span class="detail-label">Тип платежа</span>
                        <span class="detail-value" id="paymentType">—</span>
                    </div>

                    <div class="order-detail-item">
                        <span class="detail-label">Резидент</span>
                        <span class="detail-value" id="paymentResident">—</span>
                    </div>

                    <div class="order-detail-item">
                        <span class="detail-label">Период</span>
                        <span class="detail-value" id="paymentDate">—</span>
                    </div>

                    <!-- <div class="order-detail-item">
                        <span class="detail-label">Комиссия</span>
                        <span class="detail-value" id="paymentCommission">0,00 ₼</span>
                    </div> -->

                    <div class="order-detail-item">
                        <span class="detail-label">Счёт</span>
                        <span class="detail-value" id="invoiceNumber">—</span>
                    </div>
                </div>

                <div class="order-totals">
                    <div class="order-total-item final">
                        <span class="total-label">Итого</span>
                        <span class="total-value" id="total"></span>
                    </div>
                </div>

                <!-- Custom Amount Section -->
                <div class="custom-amount-section">
                    <div class="custom-amount-checkbox">
                        <label class="custom-amount-label">
                            <input type="checkbox" id="customAmountCheckbox" class="custom-amount-checkbox-input">
                            <span class="custom-amount-checkbox-text">Указать другую сумму для оплаты</span>
                        </label>
                    </div>
                    <div class="custom-amount-field-wrapper" id="customAmountFieldWrapper" style="display: none;">
                        <label class="custom-amount-field-label">Сумма к оплате</label>
                        <div class="custom-amount-input-wrapper">
                            <input 
                                type="number" 
                                id="customAmountInput" 
                                class="custom-amount-input" 
                                step="0.01" 
                                min="0.01" 
                                placeholder="0.00"
                            >
                            <span class="custom-amount-currency">₼</span>
                        </div>
                        <div class="custom-amount-hint" id="customAmountHint"></div>
                    </div>
                </div>
            </div>

            <!-- Default pay action when user doesn't add a new card -->
            <div class="default-pay-actions">
                <button type="button" class="pay-button default-pay-button">Оплатить</button>
            </div>
        </div>
    </div>
</section>

<script>
// API Configuration (используем var, чтобы избежать ошибок при повторной загрузке через SPA)
var API_BASE = window.BACKEND_API_BASE || 'http://localhost:8000';
var BIN_LOOKUP_URL = API_BASE + '/api/payment/bin-lookup';
// Флаг демо-режима оплаты: true — имитация платежа без реального запроса на backend
var ENABLE_FAKE_PAYMENT = false;

// Current card data
var currentCardData = {
    bin: null,
    bank: null,
    scheme: null,
    country: null
};

// Currently selected saved card (from the list on the left)
var selectedSavedCard = null;

// Card styles for different banks (один экземпляр на всё приложение)
if (!window.bankStyles) {
    window.bankStyles = {
        default: {
            gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            logo: 'MC'
        },
        'sberbank': {
            gradient: 'linear-gradient(135deg, #21a038 0%, #16802a 100%)',
            logo: 'СБЕР'
        },
        'vtb': {
            gradient: 'linear-gradient(135deg, #003d82 0%, #001f4d 100%)',
            logo: 'ВТБ'
        },
        'gazprombank': {
            gradient: 'linear-gradient(135deg, #003366 0%, #001a33 100%)',
            logo: 'ГПБ'
        },
        'alfabank': {
            gradient: 'linear-gradient(135deg, #ef3124 0%, #cc2619 100%)',
            logo: 'АЛЬФА'
        },
        'tinkoff': {
            gradient: 'linear-gradient(135deg, #ffdd2d 0%, #ffcd02 100%)',
            logo: 'ТИНЬ',
            textColor: '#000'
        },
        'raiffeisen': {
            gradient: 'linear-gradient(135deg, #ffcc00 0%, #ff9900 100%)',
            logo: 'РБ'
        }
    };
}
var bankStyles = window.bankStyles;

// Fetch BIN data from backend proxy (приоритет: API BINTable)
async function fetchBINData(bin) {
    if (!bin || bin.length < 6) return null;
    
    const firstSix = bin.substring(0, 6);
    
    try {
        const response = await fetch(`${BIN_LOOKUP_URL}?bin=${firstSix}`);
        
        if (!response.ok) {
            console.warn('BIN lookup failed:', response.status);
            // Fallback: определяем схему по номеру, если API недоступен
            return determineSchemeByNumber(firstSix);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Приоритет отдаём данным из BINTable API
            return {
                bank: data.bank || null,
                scheme: data.scheme || null,  // Схема из BINTable API
                country: data.country || null,
                type: data.type || null
            };
        }
        
        // Если API не вернул успешный результат, используем fallback
        return determineSchemeByNumber(firstSix);
    } catch (error) {
        console.error('BIN lookup error:', error);
        // Fallback: определяем схему по номеру при ошибке
        return determineSchemeByNumber(firstSix);
    }
}

// Определяем схему карты по номеру
function determineSchemeByNumber(number) {
    if (!number || number.length < 2) {
        return { scheme: 'Unknown', logo: 'MC' };
    }
    
    const firstDigit = number[0];
    const firstTwo = number.substring(0, 2);
    const firstFour = number.substring(0, 4);
    
    // Visa: начинается с 4
    if (firstDigit === '4') {
        return { scheme: 'Visa', logo: 'VISA' };
    }
    
    // MasterCard: 51-55 или 2221-2720
    if (firstTwo >= '51' && firstTwo <= '55') {
        return { scheme: 'Mastercard', logo: 'MC' };
    }
    
    // MasterCard новая серия: 2221-2720
    const firstFourNum = parseInt(firstFour);
    if (firstFourNum >= 2221 && firstFourNum <= 2720) {
        return { scheme: 'Mastercard', logo: 'MC' };
    }
    
    // Maestro: 50, 56-58, 67
    if (firstTwo === '50' || 
        (firstTwo >= '56' && firstTwo <= '58') || 
        firstTwo === '67') {
        return { scheme: 'Maestro', logo: 'MC' };
    }
    
    // UnionPay: начинается с 62
    if (firstTwo === '62') {
        return { scheme: 'UnionPay', logo: 'UP' };
    }
    
    // Mir: начинается с 2200-2204
    const mirRange = parseInt(firstFour);
    if (mirRange >= 2200 && mirRange <= 2204) {
        return { scheme: 'Мир', logo: 'МИР' };
    }
    
    // Дополнительная проверка для Mir: 2xxx (но не 2200-2204 уже обработано)
    if (firstDigit === '2' && firstTwo !== '22' && firstTwo !== '23') {
        // Другие варианты Mir
        if (firstTwo >= '24' && firstTwo <= '27') {
            // Проверяем, не попали ли в MasterCard диапазон
            if (!(firstFourNum >= 2221 && firstFourNum <= 2720)) {
                return { scheme: 'Мир', logo: 'МИР' };
            }
        }
    }
    
    return { scheme: 'Unknown', logo: 'MC' };
}

// Get bank style
function getBankStyle(bankName) {
    if (!bankName) return bankStyles.default;
    
    const bankLower = bankName.toLowerCase();
    
    // Поиск по ключевым словам в названии банка
    if (bankLower.includes('sber') || bankLower.includes('сбер')) {
        return bankStyles.sberbank;
    } else if (bankLower.includes('vtb') || bankLower.includes('втб')) {
        return bankStyles.vtb;
    } else if (bankLower.includes('gazprom') || bankLower.includes('газпром')) {
        return bankStyles.gazprombank;
    } else if (bankLower.includes('alfa') || bankLower.includes('альфа')) {
        return bankStyles.alfabank;
    } else if (bankLower.includes('tinkoff') || bankLower.includes('тинькофф')) {
        return bankStyles.tinkoff;
    } else if (bankLower.includes('raiffeisen') || bankLower.includes('райффайзен')) {
        return bankStyles.raiffeisen;
    } else if (bankLower.includes('abb') || bankLower.includes('azerbaijan') || bankLower.includes('beynəlxalq')) {
        return bankStyles.abb;
    }
    
    return bankStyles.default;
}

// Update card preview
function updateCardPreview(cardNumber, cardName, cardExp, cardData) {
    const preview = document.getElementById('cardPreview');
    const previewNumber = document.getElementById('cardPreviewNumber');
    const previewName = document.getElementById('cardPreviewName');
    const previewExpiry = document.getElementById('cardPreviewExpiry');
    const previewLogoText = document.getElementById('cardPreviewLogoText');
    const mastercardLogo = document.getElementById('mastercardLogo');
    const cardPreviewNetwork = document.getElementById('cardPreviewNetwork');
    const cardInputIcon = document.getElementById('cardInputIcon');
    const cardBankInfo = document.getElementById('cardBankInfo');
    
    // Update card number
    if (cardNumber) {
        // Убираем пробелы и форматируем строго по 4 цифры
        const digitsOnly = cardNumber.replace(/\s/g, '');
        const formatted = digitsOnly.replace(/(.{4})/g, '$1 ').trim();
        previewNumber.textContent = formatted || '**** **** **** ****';
    } else {
        previewNumber.textContent = '**** **** **** ****';
    }
    
    // Update name
    previewName.textContent = (cardName || 'ИМЯ ФАМИЛИЯ').toUpperCase();
    
    // Update expiry
    previewExpiry.textContent = cardExp || 'MM/YY';
    
    // Определяем тип карты и логотип
    let cardType = 'Master Card';
    let showMastercardLogo = true;
    
    if (cardData?.scheme) {
        const scheme = cardData.scheme.toLowerCase();
        if (scheme === 'visa') {
            cardType = 'Visa';
            showMastercardLogo = false;
        } else if (scheme === 'мир' || scheme === 'mir') {
            cardType = 'МИР';
            showMastercardLogo = false;
        } else if (scheme === 'mastercard') {
            cardType = 'Master Card';
            showMastercardLogo = true;
        } else if (scheme === 'maestro') {
            cardType = 'Maestro';
            showMastercardLogo = false;
        } else if (scheme === 'unionpay') {
            cardType = 'UnionPay';
            showMastercardLogo = false;
        }
    }
    
    // Показываем/скрываем логотип Mastercard и создаем другие логотипы
    const logoContainer = preview.querySelector('.logo');
    if (logoContainer) {
        // Удаляем все существующие логотипы (кроме текста)
        const existingLogos = logoContainer.querySelectorAll('.mastercard-logo, .visa-logo, .mir-logo');
        existingLogos.forEach(logo => logo.remove());
        
        // Создаем нужный логотип
        if (showMastercardLogo) {
            const mcLogo = document.createElement('div');
            mcLogo.className = 'mastercard-logo';
            mcLogo.innerHTML = '<span class="mastercard-circle circle-red"></span><span class="mastercard-circle circle-orange"></span>';
            logoContainer.insertBefore(mcLogo, previewLogoText);
        } else if (cardType === 'Visa') {
            const visaLogo = document.createElement('div');
            visaLogo.className = 'visa-logo';
            visaLogo.textContent = 'VISA';
            logoContainer.insertBefore(visaLogo, previewLogoText);
        } else if (cardType === 'МИР') {
            const mirLogo = document.createElement('div');
            mirLogo.className = 'mir-logo';
            mirLogo.textContent = 'МИР';
            logoContainer.insertBefore(mirLogo, previewLogoText);
        }
    }
    
    if (previewLogoText) {
        previewLogoText.textContent = cardType;
    }
    if (cardInputIcon) {
        cardInputIcon.textContent = cardType;
    }
    
    // Обновляем логотип сети в правом верхнем углу
    if (cardPreviewNetwork) {
        if (cardType === 'Visa') {
            cardPreviewNetwork.innerHTML = '<div class="visa-logo-small">VISA</div>';
        } else if (cardType === 'Master Card') {
            cardPreviewNetwork.innerHTML = '<div class="mastercard-logo-small"><span class="mastercard-circle circle-red"></span><span class="mastercard-circle circle-orange"></span></div>';
        } else if (cardType === 'МИР') {
            cardPreviewNetwork.innerHTML = '<div class="mir-logo-small">МИР</div>';
        } else {
            cardPreviewNetwork.innerHTML = '<div class="visa-logo-small">VISA</div>';
        }
    }
    
    // Keep background defined in CSS (modern animated gradient) to match saved cards design.
    // We only control foreground (text/icons) via JS.
    preview.style.color = 'white';
    
    // Show bank info
    if (cardBankInfo && cardData?.bank) {
        cardBankInfo.innerHTML = `<small>Банк: ${cardData.bank}${cardData.country ? ` (${cardData.country})` : ''}</small>`;
    } else if (cardBankInfo) {
        cardBankInfo.innerHTML = '';
    }
}

// Card number formatting and BIN lookup
document.getElementById('cardNumberInput')?.addEventListener('input', async function(e) {
    let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    // Форматируем строго по 4 цифры в группе (максимум 16 цифр для стандартной карты)
    let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1 ');
    // Ограничиваем до 19 символов (16 цифр + 3 пробела)
    if (formattedValue.length > 19) {
        formattedValue = formattedValue.substring(0, 19);
    }
    e.target.value = formattedValue;
    
    // Update preview
    const cardName = document.getElementById('cardNameInput').value;
    const cardExp = document.getElementById('cardExpInput').value;
    updateCardPreview(formattedValue, cardName, cardExp, currentCardData);
    
    // Для первых 2-4 цифр используем быстрый fallback для предварительного определения
    let fallbackScheme = null;
    if (value.length >= 2 && value.length < 6) {
        const tempScheme = determineSchemeByNumber(value);
        if (tempScheme) {
            fallbackScheme = tempScheme.scheme;
            currentCardData.scheme = fallbackScheme;
            updateCardPreview(formattedValue, cardName, cardExp, currentCardData);
        }
        return; // Выходим, так как для BIN lookup нужно минимум 6 цифр
    }
    
    // Lookup BIN через API BINTable (приоритетный источник) если есть минимум 6 цифр
    if (value.length >= 6) {
        const bin = value.substring(0, 6);
        if (bin !== currentCardData.bin) {
            currentCardData.bin = bin;
            
            // Запрашиваем данные через BINTable API (приоритет)
            const binData = await fetchBINData(value);
            
            if (binData) {
                // Используем данные из API BINTable (схема, банк, страна)
                currentCardData = { 
                    ...currentCardData, 
                    bank: binData.bank || null,
                    scheme: binData.scheme || null,  // Схема из API имеет приоритет
                    country: binData.country || null,
                    type: binData.type || null
                };
            } else {
                // Если API не вернул данных, используем fallback определение
                const fallbackData = determineSchemeByNumber(value);
                currentCardData = {
                    ...currentCardData,
                    bank: null,
                    scheme: fallbackData?.scheme || null,
                    country: null,
                    type: null
                };
            }
            
            updateCardPreview(formattedValue, cardName, cardExp, currentCardData);
        }
    } else if (value.length === 0) {
        // Если поле очищено, сбрасываем данные
        currentCardData = { bin: null, bank: null, scheme: null, country: null };
        updateCardPreview(formattedValue, cardName, cardExp, null);
    }
});

// Card name input
document.getElementById('cardNameInput')?.addEventListener('input', function(e) {
    const cardNumber = document.getElementById('cardNumberInput').value;
    const cardExp = document.getElementById('cardExpInput').value;
    updateCardPreview(cardNumber, e.target.value, cardExp, currentCardData);
});

// Exp date formatting (MM/YY)
document.getElementById('cardExpInput')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
    
    const cardNumber = document.getElementById('cardNumberInput').value;
    const cardName = document.getElementById('cardNameInput').value;
    updateCardPreview(cardNumber, cardName, value, currentCardData);
});

// CVV formatting
document.getElementById('cardCvvInput')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

// Flip card functions
function flipSavedCard(element) {
    if (element) {
        element.classList.toggle('flipped');
    }
}

function flipPreviewCard() {
    const container = document.getElementById('cardPreviewContainer');
    if (container) {
        container.classList.toggle('flipped');
    }
}

// Update CVV on card back
document.getElementById('cardCvvInput')?.addEventListener('input', function(e) {
    const cvv = e.target.value.replace(/\D/g, '');
    const cvvDisplay = document.getElementById('cardPreviewCVV');
    if (cvvDisplay) {
        cvvDisplay.textContent = cvv || '***';
    }
});

// -------------------------------
// Инициализация данных оплаты
// -------------------------------

// Fallback: получить сводку дашборда с backend
async function loadDashboardSummaryForPayment(scope) {
    try {
        const resp = await fetch(`${API_BASE}/api/resident/dashboard`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        if (!resp.ok) {
            console.warn('Failed to load dashboard summary for payment:', resp.status);
            return null;
        }
        const data = await resp.json();
        const summary = data.summary || {};
        const amount = scope === 'all'
            ? (summary.total_debt || 0)
            : (summary.total_month || 0);
        return { amount, summary };
    } catch (err) {
        console.error('Error loading dashboard summary for payment:', err);
        return null;
    }
}

// Загрузка связанных счетов резидента для показа в деталях оплаты
// preferredAmount - сумма из sessionStorage, которая имеет приоритет над суммой из счетов
// residentId - ID резидента для фильтрации счетов
async function loadPaymentInvoices(scope, residentCode, preferredAmount = null, residentId = null) {
    try {
        const response = await fetch(`${API_BASE}/api/resident/invoices`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            console.warn('Failed to load resident invoices for payment details:', response.status);
            return;
        }

        const data = await response.json();
        const invoices = data.invoices || [];
        if (!invoices.length) {
            return;
        }

        const now = new Date();
        const curYear = now.getFullYear();
        const curMonth = now.getMonth() + 1;

        // Фильтруем счета по резидент-коду и/или residentId, если они указаны
        let filteredInvoices = invoices;
        if (residentId) {
            // Приоритет: фильтрация по residentId (более точная)
            filteredInvoices = invoices.filter(inv => inv.resident_id === residentId);
        } else if (residentCode) {
            // Fallback: фильтрация по резидент-коду
            filteredInvoices = invoices.filter(inv => {
                const invResidentCode = inv.resident_code || '';
                // Сравниваем резидент-коды (нормализуем пробелы)
                return invResidentCode.replace(/\s+/g, ' ').trim() === residentCode.replace(/\s+/g, ' ').trim();
            });
        }

        // Затем фильтруем по периоду, если scope === 'month'
        let targetInvoices = filteredInvoices;
        if (scope === 'month') {
            const monthInvoices = filteredInvoices.filter(inv => inv.period_year === curYear && inv.period_month === curMonth);
            if (monthInvoices.length) {
                targetInvoices = monthInvoices;
            } else if (filteredInvoices.length > 0) {
                // Если нет счетов за текущий месяц, но есть отфильтрованные счета, используем их
                targetInvoices = filteredInvoices;
            }
        }

        // Подготовим список id выбранных счетов для страницы "Мои счета"
        // НЕ сохраняем их в sessionStorage сразу - только при клике на invoice-link
        const targetInvoiceIds = (targetInvoices || [])
            .map(inv => inv && inv.id)
            .filter(id => id !== null && id !== undefined);

        const invoiceNumberEl = document.getElementById('invoiceNumber');
        const paymentResidentEl = document.getElementById('paymentResident');
        const paymentDateEl = document.getElementById('paymentDate');
        const totalEl = document.getElementById('total');
        const amountLabelEl = document.getElementById('paymentAmountLabel');

        const first = targetInvoices[0];

        // Номер счёта
        if (invoiceNumberEl) {
            // Сбрасываем класс ссылки перед установкой
            invoiceNumberEl.classList.remove('invoice-link');

            if (targetInvoices.length === 1 && first) {
                // Один счёт — делаем номер кликабельным и ведём на страницу просмотра счёта
                invoiceNumberEl.textContent = first.number || `№${first.id}`;
                invoiceNumberEl.style.cursor = 'pointer';
                invoiceNumberEl.classList.add('invoice-link');
                invoiceNumberEl.onclick = function () {
                    const invId = first.id;
                    if (!invId) return;
                    try {
                        // Для user/pages/invoice-view.html
                        sessionStorage.setItem('currentInvoiceId', String(invId));
                    } catch (e) {
                        console.warn('Failed to store currentInvoiceId before navigation', e);
                    }

                    // Переход на маршрут invoice (user SPA)
                    if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                        window.userSpaRouter.navigate('invoice', true);
                    } else {
                        // Fallback: обычный URL с hash и параметром id
                        window.location.href = `/user/dashboard.html#invoice?id=${encodeURIComponent(invId)}`;
                    }
                };
            } else {
                // Несколько счетов — ведём на список счетов с фильтрацией
                invoiceNumberEl.textContent = `Несколько счетов (${targetInvoices.length})`;
                invoiceNumberEl.style.cursor = 'pointer';
                invoiceNumberEl.classList.add('invoice-link');
                invoiceNumberEl.onclick = function () {
                    if (targetInvoiceIds.length) {
                        try {
                            // Сохраняем ID счетов и статусы только при клике на invoice-link
                            sessionStorage.setItem('billsFilterInvoiceIds', JSON.stringify(targetInvoiceIds));
                            // При переходе со страницы оплаты через invoice-link показываем только счета в статусе ISSUED и PARTIAL
                            const statusesForBills = ['ISSUED', 'PARTIAL'];
                            sessionStorage.setItem('billsFilterStatuses', JSON.stringify(statusesForBills));
                        } catch (e) {
                            console.warn('Failed to store billsFilterInvoiceIds or billsFilterStatuses before navigation', e);
                        }
                    }
                    if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                        window.userSpaRouter.navigate('bills', true);
                    } else {
                        window.location.href = '/user/dashboard.html#bills';
                    }
                };
            }
        }

        // Резидент
        // Приоритет отдаём резидент-коду из sessionStorage (который был передан при нажатии кнопки)
        // Не перезаписываем, если резидент-код уже установлен из sessionStorage
        if (paymentResidentEl) {
            const currentResidentCode = paymentResidentEl.textContent || '';
            // Если резидент-код уже установлен и совпадает с переданным, не меняем
            if (residentCode && currentResidentCode.trim() === residentCode.trim()) {
                // Уже правильно установлен, не меняем
            } else if (residentCode) {
                // Устанавливаем резидент-код из параметра (из sessionStorage)
                paymentResidentEl.textContent = residentCode;
            } else if (first?.resident_code) {
                // Fallback: берем из первого счёта, если резидент-код не был передан
                paymentResidentEl.textContent = first.resident_code;
            }
        }

        // Период
        // Если scope === 'month', период должен быть текущий месяц
        // Если scope === 'all', показываем диапазон из счетов
        if (paymentDateEl) {
            // Если scope === 'month' и нет счетов после фильтрации, показываем текущий месяц
            if (scope === 'month' && targetInvoices.length === 0) {
                const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                const mName = monthNames[curMonth - 1] || curMonth;
                paymentDateEl.textContent = `${mName} ${curYear}`;
            } else if (targetInvoices.length > 0) {
                if (scope === 'all' && targetInvoices.length > 1) {
                // Для полного погашения долга показываем диапазон от первой до последней даты
                const parseDate = (str) => {
                    if (!str || typeof str !== 'string') return null;
                    const parts = str.split('.');
                    if (parts.length !== 3) return null;
                    const [dd, mm, yyyy] = parts.map(p => parseInt(p, 10));
                    if (!dd || !mm || !yyyy) return null;
                    return new Date(yyyy, mm - 1, dd);
                };

                let minDate = null;
                let maxDate = null;
                let minText = null;
                let maxText = null;

                targetInvoices.forEach(inv => {
                    const fromStr = inv?.period_dates?.from || null;
                    const toStr = inv?.period_dates?.to || null;

                    const fromDate = parseDate(fromStr || toStr);
                    const toDate = parseDate(toStr || fromStr);

                    if (fromDate) {
                        if (!minDate || fromDate < minDate) {
                            minDate = fromDate;
                            minText = fromStr || toStr;
                        }
                    }
                    if (toDate) {
                        if (!maxDate || toDate > maxDate) {
                            maxDate = toDate;
                            maxText = toStr || fromStr;
                        }
                    }
                });

                if (minText && maxText) {
                    paymentDateEl.textContent = `${minText} — ${maxText}`;
                } else {
                    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                    let minYear = null, minMonth = null, maxYear = null, maxMonth = null;
                    targetInvoices.forEach(inv => {
                        if (inv.period_year && inv.period_month) {
                            const y = inv.period_year;
                            const m = inv.period_month;
                            if (minYear === null || y < minYear || (y === minYear && m < minMonth)) {
                                minYear = y;
                                minMonth = m;
                            }
                            if (maxYear === null || y > maxYear || (y === maxYear && m > maxMonth)) {
                                maxYear = y;
                                maxMonth = m;
                            }
                        }
                    });
                    if (minYear !== null && maxYear !== null) {
                        const minTextMonth = monthNames[minMonth - 1] || minMonth;
                        const maxTextMonth = monthNames[maxMonth - 1] || maxMonth;
                        if (minYear === maxYear && minMonth === maxMonth) {
                            paymentDateEl.textContent = `${minTextMonth} ${minYear}`;
                        } else {
                            paymentDateEl.textContent = `${minTextMonth} ${minYear} — ${maxTextMonth} ${maxYear}`;
                        }
                    }
                }
                } else if (first) {
                    if (first.period_dates && first.period_dates.from && first.period_dates.to) {
                        paymentDateEl.textContent = `${first.period_dates.from} — ${first.period_dates.to}`;
                    } else if (first.period_year && first.period_month) {
                        const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                        const mName = monthNames[first.period_month - 1] || first.period_month;
                        paymentDateEl.textContent = `${mName} ${first.period_year}`;
                    }
                } else if (scope === 'month') {
                    // Если нет счетов, но scope === 'month', показываем текущий месяц
                    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                    const mName = monthNames[curMonth - 1] || curMonth;
                    paymentDateEl.textContent = `${mName} ${curYear}`;
                }
            }
        }

        // Сумма по инвойсам как дополнительная гарантия
        // НЕ перезаписываем сумму, если она уже была установлена из sessionStorage
        if (totalEl && amountLabelEl && targetInvoices.length > 0) {
            // Если передана preferredAmount (сумма из sessionStorage), используем её как приоритет
            if (preferredAmount !== null && preferredAmount > 0) {
                // Сумма из sessionStorage имеет приоритет, не перезаписываем её
                // Только убеждаемся, что amountLabelEl синхронизирован с totalEl
                const currentTotal = totalEl.textContent || '';
                if (amountLabelEl.textContent !== currentTotal && currentTotal) {
                    amountLabelEl.textContent = currentTotal;
                }
                return; // Не перезаписываем сумму из счетов
            }
            
            // Если preferredAmount не передан или равен 0, проверяем sessionStorage напрямую
            const storedAmountRaw = sessionStorage.getItem('paymentAmount');
            const storedAmount = storedAmountRaw ? parseFloat(storedAmountRaw) : 0;
            
            // Проверяем текущую установленную сумму
            const existingAmountText = totalEl.textContent || '';
            const existingAmountValue = existingAmountText.replace(/[^\d,\.]/g, '').replace(',', '.');
            const existingAmount = parseFloat(existingAmountValue) || 0;
            
            // Если сумма из sessionStorage уже установлена и она больше 0, не перезаписываем её
            if (storedAmount > 0 && Math.abs(existingAmount - storedAmount) < 0.01) {
                // Сумма уже правильно установлена из sessionStorage, не перезаписываем
                if (amountLabelEl.textContent !== existingAmountText) {
                    amountLabelEl.textContent = existingAmountText;
                }
                return; // Не перезаписываем сумму из счетов
            }
            
            // Если сумма не была установлена или равна 0, вычисляем её из счетов как fallback
            let sumAmount = 0;
            // Для пользователя важно видеть сумму К ОПЛАТЕ (остаток), а не общий номинал счетов
            // Поэтому и для 'all', и для 'month' используем remaining_amount, если он есть
            sumAmount = targetInvoices.reduce(
                (acc, inv) => acc + (inv.remaining_amount ?? inv.amount_total ?? 0),
                0
            );

            const formatted = new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(sumAmount) + ' ₼';

            // Обновляем только если текущая сумма равна 0 или не установлена
            if (existingAmount <= 0 || !existingAmountText || existingAmountText === '—') {
                totalEl.textContent = formatted;
                amountLabelEl.textContent = formatted;
            }
        }
    } catch (error) {
        console.error('Error loading payment-related invoices:', error);
    }
}

// Форматирование текущей даты/времени для возможного использования
function formatPaymentDateNow() {
    const now = new Date();
    return now.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Главная инициализация страницы оплаты
async function initPaymentPage() {
    // Изначально очищаем превью карты
    updateCardPreview('', '', '', null);

    // helper to set resident name and advance on the Royal Park pass
    async function setResidentPassInfo(codeFromSession) {
        const nameEl = document.getElementById('passResidentName');
        const advanceEl = document.getElementById('passAdvanceAmount');
        if (!nameEl && !advanceEl) return;

        let displayName = codeFromSession || '';
        let advanceValue = null;
        let userFullName = '';

        // fallback helper to load user profile name
        async function fetchUserName() {
            try {
                const resp = await fetch(`${API_BASE}/api/users/me`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (resp.ok) {
                    const user = await resp.json();
                    return user?.full_name || user?.username || '';
                }
            } catch (e) {
                console.warn('Failed to load user profile for pass name', e);
            }
            return '';
        }

        try {
            // Добавляем timestamp для предотвращения кэширования при обновлении после оплаты
            const timestamp = new Date().getTime();
            const resp = await fetch(`${API_BASE}/api/resident/dashboard?t=${timestamp}`, {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                cache: 'no-cache'
            });
            if (resp.ok) {
                const data = await resp.json();
                const residents = data?.residents || [];
                const summary = data?.summary || {};

                if (residents.length) {
                    // prefer match by resident_code, else first resident
                    const matched = residents.find(r => r?.resident_code === codeFromSession) || residents[0];
                    displayName = matched?.full_name || matched?.resident_name || matched?.resident_code || displayName;

                    // try multiple possible advance keys (приоритет: advance_total из API)
                    advanceValue = matched?.advance_total ?? matched?.advance ?? matched?.advance_balance ?? matched?.balance?.advance ?? matched?.balance?.advance_balance ?? null;
                }

                // fallback to summary if resident value not found
                if (advanceValue === null || advanceValue === undefined) {
                    advanceValue = summary?.total_advance ?? summary?.advance ?? null;
                }
            }
        } catch (e) {
            console.warn('Failed to load resident info for pass', e);
        }

        if (!displayName) {
            userFullName = await fetchUserName();
            displayName = userFullName || displayName;
        }

        if (nameEl) {
            nameEl.textContent = displayName || 'Резидент';
        }

        if (advanceEl) {
            const adv = typeof advanceValue === 'number' ? advanceValue : 0;
            advanceEl.textContent = new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(adv) + ' ₼';
        }
        
        // Отключаем карту Royal Park, если аванс = 0
        const advanceCard = document.querySelector('.resident-pass-card[data-card-type="ADVANCE"]');
        if (advanceCard) {
            const adv = typeof advanceValue === 'number' ? advanceValue : 0;
            if (adv <= 0) {
                // Отключаем карту: добавляем класс disabled и делаем недоступной для выбора
                advanceCard.classList.add('disabled');
                advanceCard.style.opacity = '0.5';
                advanceCard.style.cursor = 'not-allowed';
                advanceCard.setAttribute('aria-disabled', 'true');
                advanceCard.title = 'Аванс недоступен (баланс: 0,00 ₼)';
                
                // Если эта карта была выбрана, снимаем выбор
                if (advanceCard.classList.contains('selected')) {
                    advanceCard.classList.remove('selected');
                    // Выбираем первую доступную карту (не Royal Park)
                    const availableCards = document.querySelectorAll('.saved-cards-container .bank-card:not(.disabled), .saved-cards-container .resident-pass-card:not(.disabled)');
                    if (availableCards.length > 0 && availableCards[0] !== advanceCard) {
                        availableCards[0].click();
                    }
                }
            } else {
                // Включаем карту обратно, если аванс > 0
                advanceCard.classList.remove('disabled');
                advanceCard.style.opacity = '';
                advanceCard.style.cursor = '';
                advanceCard.removeAttribute('aria-disabled');
                advanceCard.title = '';
            }
        }
    }

    try {
        // Проверяем временную метку данных оплаты (данные действительны 5 минут)
        const paymentTimestamp = sessionStorage.getItem('paymentTimestamp');
        const now = Date.now();
        const PAYMENT_DATA_TTL = 5 * 60 * 1000; // 5 минут в миллисекундах
        
        // Если данные устарели (старше 5 минут) или их нет, очищаем все данные оплаты
        if (!paymentTimestamp || (now - parseInt(paymentTimestamp, 10)) > PAYMENT_DATA_TTL) {
            // Очищаем старые данные оплаты
            sessionStorage.removeItem('paymentScope');
            sessionStorage.removeItem('paymentAmount');
            sessionStorage.removeItem('paymentScopeLabel');
            sessionStorage.removeItem('paymentResidentCode');
            sessionStorage.removeItem('paymentResidentId');
            sessionStorage.removeItem('paymentSummary');
            sessionStorage.removeItem('paymentTimestamp');
        }
        
        const scope = sessionStorage.getItem('paymentScope') || 'month';
        let amountRaw = sessionStorage.getItem('paymentAmount');
        let amount = amountRaw ? parseFloat(amountRaw) : 0;
        const scopeLabelStored = sessionStorage.getItem('paymentScopeLabel');
        const residentCodeStored = sessionStorage.getItem('paymentResidentCode');
        const paymentSummaryRaw = sessionStorage.getItem('paymentSummary');
        let paymentSummary = null;
        if (paymentSummaryRaw) {
            try {
                paymentSummary = JSON.parse(paymentSummaryRaw);
            } catch (e) {
                console.warn('Failed to parse paymentSummary from sessionStorage', e);
            }
        }

        const totalEl = document.getElementById('total');
        const subtitleEl = document.querySelector('.order-subtitle');
        const amountLabelEl = document.getElementById('paymentAmountLabel');
        const paymentTypeEl = document.getElementById('paymentType');
        const paymentResidentEl = document.getElementById('paymentResident');
        const paymentDateEl = document.getElementById('paymentDate');
        const paymentCommissionEl = document.getElementById('paymentCommission');

        // Проверяем, есть ли актуальные данные в sessionStorage (пользователь перешел через кнопку)
        // Данные считаются актуальными только если есть временная метка и она не устарела
        const hasPaymentData = paymentTimestamp && (now - parseInt(paymentTimestamp, 10)) <= PAYMENT_DATA_TTL && 
                               (amountRaw || residentCodeStored || paymentSummaryRaw || sessionStorage.getItem('paymentResidentId'));
        
        // Если сумма из sessionStorage отсутствует или равна 0, пробуем взять её из summary/бэкенда
        // Но только если есть данные в sessionStorage (пользователь перешел через кнопку)
        if (hasPaymentData) {
            if (!amount || Number.isNaN(amount)) {
                if (paymentSummary) {
                    amount = scope === 'all'
                        ? (paymentSummary.total_debt || 0)
                        : (paymentSummary.total_month || 0);
                }
                if (!amount || Number.isNaN(amount)) {
                    const fallback = await loadDashboardSummaryForPayment(scope);
                    if (fallback && typeof fallback.amount === 'number') {
                        amount = fallback.amount;
                    }
                }
            }
        } else {
            // Если нет данных в sessionStorage, сумма должна быть 0
            amount = 0;
        }

        const formattedAmount = new Intl.NumberFormat('ru-RU', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount || 0) + ' ₼';

        if (totalEl) {
            totalEl.textContent = formattedAmount;
        }
        if (amountLabelEl) {
            amountLabelEl.textContent = formattedAmount;
        }

        // Проверяем, есть ли данные в sessionStorage (пользователь перешел через кнопку)
        // Загрузить данные по счетам с backend только если есть данные в sessionStorage
        // (т.е. пользователь перешел на страницу оплаты через кнопку, а не напрямую)
        if (hasPaymentData) {
            // Устанавливаем поля только если есть данные
            if (subtitleEl) {
                if (scope === 'all') {
                    subtitleEl.textContent = 'Оплата всего долга';
                } else {
                    subtitleEl.textContent = 'Оплата за текущий месяц';
                }
            }

            if (paymentTypeEl) {
                const defaultScopeText = scope === 'all'
                    ? 'Полное погашение долга по счетам'
                    : 'Оплата счетов за текущий месяц';
                paymentTypeEl.textContent = scopeLabelStored || defaultScopeText;
            }

            if (paymentResidentEl) {
                paymentResidentEl.textContent = residentCodeStored || '—';
            }
            
            // update resident name and advance on the default pass
            setResidentPassInfo(residentCodeStored);
            // Передаём сумму из sessionStorage, чтобы loadPaymentInvoices не перезаписывала её
            const residentIdStored = sessionStorage.getItem('paymentResidentId');
            const residentIdParsed = residentIdStored ? parseInt(residentIdStored, 10) : null;
            loadPaymentInvoices(scope, residentCodeStored || null, amount, residentIdParsed);
        } else {
            // Если нет данных в sessionStorage, оставляем все поля пустыми
            if (subtitleEl) {
                subtitleEl.textContent = 'Оплата счёта';
            }
            
            if (paymentTypeEl) {
                paymentTypeEl.textContent = '—';
            }
            
            if (paymentResidentEl) {
                paymentResidentEl.textContent = '—';
            }
            
            if (paymentDateEl) {
                paymentDateEl.textContent = '—';
            }
            
            const invoiceNumberEl = document.getElementById('invoiceNumber');
            if (invoiceNumberEl) {
                invoiceNumberEl.textContent = '—';
                invoiceNumberEl.classList.remove('invoice-link');
                invoiceNumberEl.style.cursor = 'default';
                invoiceNumberEl.onclick = null;
            }
            
            // Сумма уже установлена в 0 выше, но убедимся
            if (totalEl) {
                totalEl.textContent = '0,00 ₼';
            }
            if (amountLabelEl) {
                amountLabelEl.textContent = '0,00 ₼';
            }
        }
        
        // Всегда загружаем данные резидента для pass (имя и аванс), независимо от наличия данных в sessionStorage
        // Если residentCodeStored пустой, функция сама загрузит данные первого резидента
        setResidentPassInfo(residentCodeStored || null);

        if (paymentCommissionEl) {
            paymentCommissionEl.textContent = '0,00 ₼';
        }
        // paymentDateEl заполняется в loadPaymentInvoices, но при полном отсутствии данных
        if (paymentDateEl && !paymentDateEl.textContent) {
            paymentDateEl.textContent = formatPaymentDateNow();
        }

        // Initialize custom amount functionality
        initCustomAmountField(amount);
    } catch (err) {
        console.error('Error initializing payment summary:', err);
    }
}

// Initialize custom amount field functionality
function initCustomAmountField(defaultAmount) {
    const checkbox = document.getElementById('customAmountCheckbox');
    const fieldWrapper = document.getElementById('customAmountFieldWrapper');
    const amountInput = document.getElementById('customAmountInput');
    const hintEl = document.getElementById('customAmountHint');
    const totalEl = document.getElementById('total');

    if (!checkbox || !fieldWrapper || !amountInput) return;

    // Get total amount from invoice
    let invoiceTotal = defaultAmount || 0;
    if (totalEl) {
        const totalText = totalEl.textContent || '';
        const cleanAmount = totalText.replace(/[^\d,\.]/g, '').replace(',', '.');
        invoiceTotal = parseFloat(cleanAmount) || 0;
    }

    // Checkbox change handler
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            fieldWrapper.style.display = 'block';
            amountInput.focus();
            // Set default value to invoice total
            if (invoiceTotal > 0) {
                amountInput.value = invoiceTotal.toFixed(2);
            }
            updateAmountHint(invoiceTotal, invoiceTotal);
        } else {
            fieldWrapper.style.display = 'none';
            amountInput.value = '';
            if (hintEl) hintEl.textContent = '';
        }
    });

    // Input change handler
    amountInput.addEventListener('input', function() {
        const customAmount = parseFloat(this.value) || 0;
        updateAmountHint(invoiceTotal, customAmount);
    });

    // Update hint based on amounts
    function updateAmountHint(invoiceTotal, customAmount) {
        if (!hintEl) return;
        
        if (customAmount <= 0) {
            hintEl.textContent = '';
            hintEl.className = 'custom-amount-hint';
            return;
        }

        if (customAmount > invoiceTotal) {
            const advance = customAmount - invoiceTotal;
            hintEl.textContent = `Излишек ${advance.toFixed(2)} ₼ будет зачислен в аванс`;
            hintEl.className = 'custom-amount-hint hint-advance';
        } else if (customAmount < invoiceTotal) {
            const remaining = invoiceTotal - customAmount;
            hintEl.textContent = `Останется к оплате: ${remaining.toFixed(2)} ₼ (счёт будет частично оплачен)`;
            hintEl.className = 'custom-amount-hint hint-partial';
        } else {
            hintEl.textContent = 'Счёт будет полностью оплачен';
            hintEl.className = 'custom-amount-hint hint-full';
        }
    }
}

// -------------------------------
// Submit Payment Function
// -------------------------------

async function submitPayment(event) {
    if (event) {
        event.preventDefault();
    }
    
    // Determine which pay button was actually clicked (default in sidebar or form button)
    let payButton = null;
    if (event && event.target && event.target.classList && event.target.classList.contains('pay-button')) {
        payButton = event.target;
    } else {
        payButton = document.querySelector('.pay-button');
    }
    const originalText = payButton ? payButton.textContent : 'Оплатить';

    // Понимаем, использует ли пользователь форму "новая карта" или сохранённые карты / аванс
    const isUsingNewCardForm = !!(event && event.target && event.target.closest && event.target.closest('.payment-middle-column'));

    // Данные карты (нужны только если пользователь вводит новую карту)
    const cardNumber = document.getElementById('cardNumberInput')?.value?.replace(/\s/g, '') || '';
    const cardName = document.getElementById('cardNameInput')?.value?.trim() || '';
    const cardExp = document.getElementById('cardExpInput')?.value || '';
    const cardCvv = document.getElementById('cardCvvInput')?.value || '';
    
    if (isUsingNewCardForm) {
        // Валидация только для сценария "Добавить новую карту"
        if (cardNumber.length < 13) {
            showPaymentError('Введите корректный номер карты');
            return false;
        }
        if (cardName.length < 2) {
            showPaymentError('Введите имя на карте');
            return false;
        }
        if (!cardExp.match(/^\d{2}\/\d{2}$/)) {
            showPaymentError('Введите срок действия карты (MM/YY)');
            return false;
        }
        if (cardCvv.length < 3) {
            showPaymentError('Введите CVV код');
            return false;
        }
    }
    
    // Get payment data from session storage
    let scope = sessionStorage.getItem('paymentScope') || 'month';
    let amount = parseFloat(sessionStorage.getItem('paymentAmount') || '0');
    
    // Check if custom amount is enabled
    const customAmountCheckbox = document.getElementById('customAmountCheckbox');
    const customAmountInput = document.getElementById('customAmountInput');
    const useCustomAmount = customAmountCheckbox && customAmountCheckbox.checked;
    
    // Проверяем, есть ли invoice для оплаты
    const invoiceNumberEl = document.getElementById('invoiceNumber');
    const hasInvoice = invoiceNumberEl && invoiceNumberEl.textContent && invoiceNumberEl.textContent.trim() !== '—';
    
    // Проверяем сумму из total элемента (сумма invoice)
    const totalEl = document.getElementById('total');
    let invoiceTotal = 0;
    if (totalEl) {
        const totalText = totalEl.textContent || '';
        // Parse "1 234,56 ₼" format
        const cleanAmount = totalText.replace(/[^\d,\.]/g, '').replace(',', '.');
        invoiceTotal = parseFloat(cleanAmount) || 0;
    }
    
    if (useCustomAmount && customAmountInput) {
        // Use custom amount from input
        const customAmount = parseFloat(customAmountInput.value) || 0;
        if (customAmount <= 0) {
            showPaymentError('Введите сумму для оплаты');
            return false;
        }
        amount = customAmount;
        
        // Если нет invoice (invoiceNumber = "—") или invoice total = 0, это пополнение аванса
        // В этом случае scope должен быть null, чтобы платеж не применялся к счетам
        if (!hasInvoice || invoiceTotal === 0) {
            scope = null;
        }
        // Если есть invoice, но пользователь указал кастомную сумму, применяем к invoice
        // (излишек автоматически уйдет в аванс)
    } else {
        // Use default amount from session storage or total element
        if (!amount || amount <= 0) {
            amount = invoiceTotal;
        }
        
        // Если нет invoice или invoice total = 0, это пополнение аванса
        if (!hasInvoice || invoiceTotal === 0) {
            scope = null;
        }
    }
    
    // Сохраняем scope для передачи в backend (null если пополнение аванса)
    const paymentScope = scope;
    
    if (amount <= 0) {
        showPaymentError('Сумма оплаты должна быть больше 0');
        return false;
    }
    
    // Get resident ID - приоритет: из sessionStorage (сохранен при нажатии кнопки), иначе из dashboard
    let residentId = null;
    
    // Сначала проверяем sessionStorage (сохранен при нажатии "Оплатить за месяц" для конкретного резидента)
    const residentIdStored = sessionStorage.getItem('paymentResidentId');
    if (residentIdStored) {
        residentId = parseInt(residentIdStored, 10);
    }
    
    // Если не нашли в sessionStorage, получаем из dashboard (fallback)
    if (!residentId) {
        try {
            const dashboardResp = await fetch(`${API_BASE}/api/resident/dashboard`, {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            });
            if (dashboardResp.ok) {
                const dashboardData = await dashboardResp.json();
                if (dashboardData.residents && dashboardData.residents.length > 0) {
                    // Use first resident ID (in case user has multiple)
                    residentId = dashboardData.residents[0].id;
                }
            }
        } catch (err) {
            console.error('Failed to get resident ID:', err);
        }
    }
    
    if (!residentId) {
        showPaymentError('Не удалось определить резидента. Попробуйте перезагрузить страницу.');
        return false;
    }

    // Тип метода оплаты: карта или аванс (если выбрана карта Royal Park)
    let paymentMethod = 'CARD';
    if (window.selectedSavedCard && window.selectedSavedCard.type === 'ADVANCE') {
        // Дополнительная проверка: если карта отключена, не позволяем оплату через аванс
        const advanceCard = document.querySelector('.resident-pass-card[data-card-type="ADVANCE"]');
        if (advanceCard && (advanceCard.classList.contains('disabled') || advanceCard.getAttribute('aria-disabled') === 'true')) {
            showPaymentError('Аванс недоступен. Баланс аванса равен 0,00 ₼. Выберите другой способ оплаты.');
            if (payButton) {
                payButton.disabled = false;
                payButton.textContent = originalText;
            }
            return false;
        }
        paymentMethod = 'ADVANCE';
    }

    // Show loading state
    if (payButton) {
        payButton.disabled = true;
        payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обработка...';
    }

    // DEMO: имитация успешной оплаты без обращения к backend
    if (ENABLE_FAKE_PAYMENT) {
        try {
            await new Promise(resolve => setTimeout(resolve, 800));

            showPaymentSuccess(
                paymentMethod === 'ADVANCE'
                    ? 'Платёж успешно проведён из аванса (демо-режим).'
                    : 'Платёж успешно проведён (демо-режим).'
            );

            // Очищаем сессионные данные как при реальной оплате
            sessionStorage.removeItem('paymentAmount');
            sessionStorage.removeItem('paymentScope');
            sessionStorage.removeItem('paymentScopeLabel');
            sessionStorage.removeItem('paymentResidentCode');
            sessionStorage.removeItem('paymentSummary');

            // Фильтр для черновиков на странице счетов
            sessionStorage.setItem('billsFilterStatuses', JSON.stringify(['DRAFT']));

            setTimeout(() => {
                if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                    window.userSpaRouter.navigate('bills', true);
                } else {
                    window.location.href = '/user/dashboard.html#bills?status=DRAFT';
                }
            }, 2000);
        } finally {
            if (payButton) {
                payButton.disabled = false;
                payButton.textContent = originalText;
            }
        }
        return false;
    }

    try {
        // Submit payment to backend (боевой режим)
        const response = await fetch(`${API_BASE}/api/resident/payment`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                resident_id: residentId,
                amount: amount,
                method: paymentMethod,
                reference: isUsingNewCardForm ? `Card ***${cardNumber.slice(-4)}` : (window.selectedSavedCard?.brand || 'Saved card'),
                comment: isUsingNewCardForm
                    ? `Онлайн-оплата картой ${cardName}`
                    : `Онлайн-оплата сохранённой картой / авансом`,
                scope: paymentScope  // 'month' или 'all' - для применения к счетам, null - только пополнение аванса
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Ошибка сервера: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.ok) {
            // Success!
            showPaymentSuccess('Платёж успешно проведён!');
            
            // Сохраняем residentCode перед очисткой sessionStorage
            const residentCode = sessionStorage.getItem('paymentResidentCode');
            
            // Clear payment session data
            sessionStorage.removeItem('paymentAmount');
            sessionStorage.removeItem('paymentScope');
            sessionStorage.removeItem('paymentScopeLabel');
            sessionStorage.removeItem('paymentResidentCode');
            sessionStorage.removeItem('paymentSummary');
            
            // Обновляем аванс на странице оплаты перед редиректом
            // Делаем это после небольшой задержки, чтобы бэкенд успел обработать платеж
            if (residentCode && typeof setResidentPassInfo === 'function') {
                setTimeout(() => {
                    setResidentPassInfo(residentCode);
                }, 300);
            }
            
            // Set filter to show DRAFT status invoices on bills page
            sessionStorage.setItem('billsFilterStatuses', JSON.stringify(['DRAFT']));
            
            // Redirect to dashboard first to show updated progress, then to bills page
            setTimeout(() => {
                if (window.userSpaRouter && typeof window.userSpaRouter.navigate === 'function') {
                    // Navigate to dashboard first to show updated data
                    window.userSpaRouter.navigate('dashboard', true);
                    // Обновляем дашборд после навигации (SPA router автоматически вызывает loadDashboardData через 100ms)
                    // Но добавляем дополнительный вызов с задержкой, чтобы убедиться, что контейнер загружен
                    setTimeout(() => {
                        if (typeof loadDashboardData === 'function') {
                            console.log('Refreshing dashboard after payment...');
                            // Принудительно обновляем данные (forceRefresh = true)
                            loadDashboardData(true).then(() => {
                                console.log('Dashboard refreshed successfully');
                                // Принудительно обновляем еще раз через небольшую задержку
                                // чтобы убедиться, что все данные обновились (включая аванс)
                                setTimeout(() => {
                                    if (typeof loadDashboardData === 'function') {
                                        loadDashboardData(true);
                                    }
                                }, 500);
                            }).catch(err => {
                                console.error('Failed to refresh dashboard:', err);
                            });
                        }
                    }, 500);
                    // Then navigate to bills after a short delay
                    setTimeout(() => {
                        window.userSpaRouter.navigate('bills', true);
                    }, 2000);
                } else {
                    // Fallback для обычной навигации
                    window.location.href = '/user/dashboard.html#dashboard';
                    // После загрузки страницы обновляем данные
                    setTimeout(() => {
                        if (typeof loadDashboardData === 'function') {
                            loadDashboardData();
                        }
                    }, 500);
                }
            }, 1500);
        } else {
            throw new Error(result.message || 'Не удалось обработать платёж');
        }
        
    } catch (error) {
        console.error('Payment error:', error);
        showPaymentError(error.message || 'Произошла ошибка при обработке платежа');
        
        // Restore button
        if (payButton) {
            payButton.disabled = false;
            payButton.textContent = originalText;
        }
    }
    
    return false;
}

// Show success message
function showPaymentSuccess(message) {
    // Try to use global notification system if available
    if (window.showSuccess) {
        window.showSuccess(message);
        return;
    }
    
    // Fallback: create custom toast
    const toast = document.createElement('div');
    toast.className = 'payment-toast payment-toast-success';
    toast.innerHTML = `
        <div class="payment-toast-icon">
            <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="payment-toast-message">${message}</div>
    `;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Show error message
function showPaymentError(message) {
    // Try to use global notification system if available
    if (window.showError) {
        window.showError(message);
        return;
    }
    
    // Fallback: create custom toast
    const toast = document.createElement('div');
    toast.className = 'payment-toast payment-toast-error';
    toast.innerHTML = `
        <div class="payment-toast-icon">
            <i class="bi bi-exclamation-circle-fill"></i>
        </div>
        <div class="payment-toast-message">${message}</div>
    `;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add toast animations
if (!document.getElementById('payment-toast-styles')) {
    const style = document.createElement('style');
    style.id = 'payment-toast-styles';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

// Bind pay button
function bindPayButton() {
    const payForm = document.querySelector('.payment-card-form');
    const payButton = document.querySelector('.pay-button');
    
    if (payForm) {
        payForm.addEventListener('submit', submitPayment);
    }
    
    if (payButton && !payButton.dataset.bound) {
        payButton.dataset.bound = 'true';
        payButton.addEventListener('click', function(e) {
            if (!payForm) {
                submitPayment(e);
            }
        });
    }
}

// Saved cards selection (user can choose which card, including Royal Park advance pass)
function setupSavedCardSelection() {
    const savedCards = document.querySelectorAll('.saved-cards-container .bank-card, .saved-cards-container .resident-pass-card');
    if (!savedCards.length) return;

    function applySelection(cardElement) {
        savedCards.forEach(c => c.classList.remove('selected'));
        cardElement.classList.add('selected');

        const last4 = cardElement.dataset.cardLast4 || '';
        const holder = cardElement.dataset.cardHolder || '';
        const type = cardElement.dataset.cardType || 'CARD';
        const brandEl = cardElement.querySelector('.brand-name, .visa-badge');
        const brand = brandEl ? brandEl.textContent.trim() : 'Card';

        selectedSavedCard = {
            id: cardElement.dataset.cardId || null,
            last4,
            holder,
            type,
            brand
        };
    }

    savedCards.forEach(card => {
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');

        card.addEventListener('click', () => {
            // Проверяем, не отключена ли карта (особенно для Royal Park с авансом = 0)
            if (card.classList.contains('disabled') || card.getAttribute('aria-disabled') === 'true') {
                return; // Не позволяем выбрать отключенную карту
            }
            applySelection(card);
        });
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                // Проверяем, не отключена ли карта
                if (card.classList.contains('disabled') || card.getAttribute('aria-disabled') === 'true') {
                    return; // Не позволяем выбрать отключенную карту
                }
                applySelection(card);
            }
        });
    });

    // Select the first available (not disabled) saved card by default
    const availableCards = Array.from(savedCards).filter(card => 
        !card.classList.contains('disabled') && card.getAttribute('aria-disabled') !== 'true'
    );
    if (availableCards.length > 0) {
        applySelection(availableCards[0]);
    }
}

// Layout logic: show/hide card form and default pay button
function setupPaymentLayout() {
    const addCardBtn = document.querySelector('.add-card-btn');
    const middleColumn = document.getElementById('paymentMiddleColumn');
    const defaultPayActions = document.querySelector('.default-pay-actions');
    const defaultPayButton = document.querySelector('.default-pay-button');

    function toggleCardForm(show) {
        if (middleColumn) {
            if (show) {
                middleColumn.classList.remove('is-hidden');
            } else {
                middleColumn.classList.add('is-hidden');
            }
        }
        if (defaultPayActions) {
            defaultPayActions.style.display = show ? 'none' : '';
        }
    }

    if (addCardBtn) {
        addCardBtn.addEventListener('click', function (e) {
            e.preventDefault();
            toggleCardForm(true);
            // небольшая прокрутка к форме карты
            if (middleColumn && typeof middleColumn.scrollIntoView === 'function') {
                middleColumn.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }

    if (defaultPayButton) {
        defaultPayButton.addEventListener('click', function (e) {
            // Используем тот же submitPayment, что и для формы
            submitPayment(e);
        });
    }

    // начальное состояние: форма скрыта, видна только правая кнопка "Оплатить"
    toggleCardForm(false);
}

// Функция для очистки данных оплаты из sessionStorage
function clearPaymentData() {
    try {
        sessionStorage.removeItem('paymentScope');
        sessionStorage.removeItem('paymentAmount');
        sessionStorage.removeItem('paymentScopeLabel');
        sessionStorage.removeItem('paymentResidentCode');
        sessionStorage.removeItem('paymentResidentId');
        sessionStorage.removeItem('paymentSummary');
        sessionStorage.removeItem('paymentTimestamp');
    } catch (e) {
        console.warn('Failed to clear payment data from sessionStorage', e);
    }
}

// Очищаем данные оплаты при уходе со страницы оплаты
function setupPaymentDataCleanup() {
    let previousHash = window.location.hash;
    let wasOnReportPage = previousHash.includes('#report') || previousHash.endsWith('#report');
    
    // Отслеживаем изменения hash - если пользователь ушел со страницы #report, очищаем данные
    const handleHashChange = () => {
        const currentHash = window.location.hash;
        const isOnReportPage = currentHash.includes('#report') || currentHash.endsWith('#report');
        
        // Если были на странице оплаты и ушли на другую страницу - очищаем данные
        if (wasOnReportPage && !isOnReportPage) {
            // Небольшая задержка, чтобы дать возможность вернуться назад
            // Если пользователь вернется в течение 100мс, данные сохранятся
            setTimeout(() => {
                const finalHash = window.location.hash;
                const finalIsOnReportPage = finalHash.includes('#report') || finalHash.endsWith('#report');
                // Очищаем только если все еще не на странице оплаты
                if (!finalIsOnReportPage) {
                    clearPaymentData();
                }
            }, 100);
        }
        
        wasOnReportPage = isOnReportPage;
        previousHash = currentHash;
    };
    
    // Слушаем изменения hash
    window.addEventListener('hashchange', handleHashChange);
    
    // Также очищаем при закрытии/перезагрузке страницы, если были на странице оплаты
    window.addEventListener('beforeunload', () => {
        const currentHash = window.location.hash;
        const isOnReportPage = currentHash.includes('#report') || currentHash.endsWith('#report');
        if (isOnReportPage) {
            // Очищаем данные при закрытии страницы, если были на странице оплаты
            clearPaymentData();
        }
    });
    
    // Очищаем данные при полном закрытии окна/вкладки
    window.addEventListener('pagehide', (event) => {
        // Если страница выгружается окончательно (не просто скрывается)
        if (event.persisted === false) {
            const currentHash = window.location.hash;
            const isOnReportPage = currentHash.includes('#report') || currentHash.endsWith('#report');
            if (isOnReportPage) {
                clearPaymentData();
            }
        }
    });
}

// Инициализируем страницу как при обычной загрузке, так и при загрузке через SPA
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        initPaymentPage();
        bindPayButton();
        setupSavedCardSelection();
        setupPaymentLayout();
        setupPaymentDataCleanup();
    });
} else {
    initPaymentPage();
    bindPayButton();
    setupSavedCardSelection();
    setupPaymentLayout();
    setupPaymentDataCleanup();
}
</script>
