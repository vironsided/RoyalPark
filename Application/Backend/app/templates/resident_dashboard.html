{% extends "resident_base.html" %}
{% block title %}Личный кабинет — Житель{% endblock %}
{% block content %}

<h4 class="mb-3">Здравствуйте, {{ user.full_name or user.username }}</h4>

{# --- Сводка по всем домам --- #}
<div class="row g-3 mb-2">
  <div class="col-12 col-md-4">
    <div class="card shadow-sm" data-bs-toggle="tooltip" title="Сумма остатков по счету текущего месяца по всем домам">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="text-muted">К оплате за месяц</div>
        {% set tm = total_month or 0 %}
        <div class="fs-5 {{ 'text-danger fw-bold' if tm>0 else 'text-success fw-semibold' }}">{{ '%.2f'|format(tm) }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card shadow-sm" data-bs-toggle="tooltip" title="Сумма всех живых счетов минус все применённые оплаты">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="text-muted">Долг по счетам</div>
        {% set td = total_debt or 0 %}
        <div class="fs-5 {{ 'text-danger fw-bold' if td>0 else 'text-secondary fw-semibold' }}">{{ '%.2f'|format(td) }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card shadow-sm" data-bs-toggle="tooltip" title="Свободный остаток платежей, ещё не разложенный по счетам">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="text-muted">Аванс</div>
        {% set ta = total_adv or 0 %}
        <div class="fs-5 {{ 'text-success fw-semibold' if ta>0 else 'text-secondary' }}">{{ '%.2f'|format(ta) }}</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  {% for r in residents %}
  {% set m = month_due[r.id] or 0 %}
  {% set mt = month_total[r.id] or 0 %}
  {% set mp = month_paid[r.id] or 0 %}
  {% set d = debt_total[r.id] or 0 %}
  {% set a = advance_total[r.id] or 0 %}
  {% set p = pay_now[r.id] or 0 %}
  {% set due = due_info[r.id]['due_date'] if due_info is defined else None %}
  {% set due_state = due_info[r.id]['state'] if due_info is defined else 'none' %}
  {% set pct = (mp / mt * 100) if mt > 0 else 0 %}
  {% set apply_cap = (a if a < d else d) %}

  <div class="col-12 col-md-6 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">

        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted">Резидент</div>
            <div class="fw-semibold">{{ r.block.name }} / {{ r.unit_number }}</div>
          </div>

          {% if due %}
            <span class="badge
              {% if due_state=='over' %} bg-danger
              {% elif due_state=='soon' %} bg-warning text-dark
              {% else %} bg-secondary-subtle text-secondary-emphasis {% endif %}
            " data-bs-toggle="tooltip" title="Срок оплаты счёта текущего месяца">
              до {{ due }}
            </span>
          {% endif %}
        </div>

        <div class="mt-3">
          <div class="d-flex justify-content-between" data-bs-toggle="tooltip" title="Остаток по счёту текущего месяца">
            <div class="text-muted">За месяц</div>
            <div class="{{ 'text-danger fw-semibold' if m>0 else 'text-success fw-semibold' }}">{{ '%.2f'|format(m) }}</div>
          </div>

          {% if mt > 0 %}
            <div class="small text-secondary d-flex justify-content-between">
              <span>Оплачено</span>
              <span>{{ '%.2f'|format(mp) }} / {{ '%.2f'|format(mt) }}</span>
            </div>
            <div class="progress" role="progressbar" aria-valuenow="{{ pct|round(0, 'floor') }}" aria-valuemin="0" aria-valuemax="100"
                 data-bs-toggle="tooltip" title="Оплачено {{ '%.2f'|format(mp) }} из {{ '%.2f'|format(mt) }} ({{ ('%.0f'|format(pct)) }}%)">
              <div class="progress-bar
                {% if pct >= 100 %} bg-success
                {% elif pct > 0 %} bg-warning
                {% else %} bg-secondary {% endif %}"
                style="width: {{ pct }}%">
              </div>
            </div>
          {% endif %}

          <div class="d-flex justify-content-between mt-2" data-bs-toggle="tooltip" title="Сумма живых счетов − применённые оплаты">
            <div class="text-muted">Долг по счетам</div>
            <div class="{{ 'text-danger fw-semibold' if d>0 else 'text-secondary fw-semibold' }}">{{ '%.2f'|format(d) }}</div>
          </div>
          <div class="d-flex justify-content-between" data-bs-toggle="tooltip" title="Свободный остаток ваших платежей">
            <div class="text-muted">Аванс</div>
            <div class="{{ 'text-success fw-semibold' if a>0 else 'text-secondary' }}">{{ '%.2f'|format(a) }}</div>
          </div>
          <hr class="my-2">
          <div class="d-flex justify-content-between align-items-center" data-bs-toggle="tooltip" title="К оплате сейчас = Долг − Аванс (не меньше 0)">
            <div class="text-muted">К оплате сейчас</div>
            <div class="fs-5 {{ 'text-danger fw-bold' if p>0 else 'text-success fw-semibold' }}">{{ '%.2f'|format(p) }}</div>
          </div>
        </div>

        <div class="mt-auto pt-3 d-flex flex-wrap gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="/resident/detail/{{ r.id }}">Подробнее</a>
          <a class="btn btn-outline-primary btn-sm" href="/resident/invoices?resident_id={{ r.id }}">Мои счета</a>
          <a class="btn btn-primary btn-sm" href="/resident/report-payment?resident_id={{ r.id }}">Сообщить об оплате</a>

          {# НОВОЕ: Погасить из аванса (если есть что применять) #}
          <form method="post" action="/resident/apply-advance" class="ms-auto">
            <input type="hidden" name="resident_id" value="{{ r.id }}">
            <button class="btn btn-success btn-sm"
                    {% if not (a > 0 and d > 0) %} disabled {% endif %}
                    data-bs-toggle="tooltip"
                    title="Применит из аванса до {{ '%.2f'|format(apply_cap) }} к открытым счетам этого дома">
              Погасить из аванса{% if a>0 and d>0 %} (до {{ '%.2f'|format(apply_cap) }}){% endif %}
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>
  {% else %}
    <div class="col-12"><div class="text-secondary">Домов пока не привязано.</div></div>
  {% endfor %}
</div>

<script>
  // Инициализация Bootstrap tooltips
  (function () {
    const triggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    triggerList.forEach(el => new bootstrap.Tooltip(el));
  })();
</script>

{% endblock %}
