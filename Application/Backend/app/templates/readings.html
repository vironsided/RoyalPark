{% extends "base.html" %}
{% block title %}Показатели{% endblock %}
{% block content %}

{# --------- флеш-сообщения --------- #}
{% set err = request.query_params.get('error') %}
{% set ok  = request.query_params.get('ok') %}
{% if err %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    Ошибка: {{ err }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'created' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Показания записаны.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'deleted' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Последнее показание удалено.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% endif %}

<h4 class="mb-3">Показатели</h4>

{# --------------------------- фильтры + кнопка --------------------------- #}
<div class="card mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get" action="{{ request.url_for('list_readings') }}">
      <div class="col-md-3">
        <label class="form-label">Блок</label>
        <select name="block_id" class="form-select">
          <option value="" {{ 'selected' if not block_id }}>Все</option>
          {% for b in blocks %}
            <option value="{{ b.id }}" {{ 'selected' if block_id|string == b.id|string }}>{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Резидент</label>
        <select name="resident_id" class="form-select">
          <option value="" {{ 'selected' if not resident_id }}>Все</option>
          {% for r in residents %}
            <option value="{{ r.id }}" {{ 'selected' if resident_id|string == r.id|string }}>
              {{ r.block.name }} / {{ r.unit_number }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Тип счётчика</label>
        <select name="meter_type" class="form-select">
          <option value="" {{ 'selected' if not meter_type }}>Все</option>
          <option value="ELECTRIC"  {{ 'selected' if meter_type=='ELECTRIC'  }}>Электричество</option>
          <option value="GAS"       {{ 'selected' if meter_type=='GAS'       }}>Газ</option>
          <option value="WATER"     {{ 'selected' if meter_type=='WATER'     }}>Вода</option>
          <option value="SEWERAGE"  {{ 'selected' if meter_type=='SEWERAGE'  }}>Канализация</option>
          <option value="SERVICE"   {{ 'selected' if meter_type=='SERVICE'   }}>Сервис (фикс)</option>
          <option value="RENT"      {{ 'selected' if meter_type=='RENT'      }}>Аренда (фикс)</option>
          <option value="CONSTRUCTION" {{ 'selected' if meter_type=='CONSTRUCTION' }}>Строительство (фикс)</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Год</label>
        <input class="form-control" type="number" name="year" value="{{ year }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Месяц</label>
        <input class="form-control" type="number" name="month" min="1" max="12" value="{{ month }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Поиск</label>
        <input class="form-control" type="text" name="q" value="{{ q or '' }}" placeholder="Дом/№, ФИО, телефон, email">
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-outline-secondary" type="submit">Фильтр</button>
        {% if block_id or resident_id or meter_type or q %}
          <a class="btn btn-outline-warning" href="{{ request.url_for('list_readings') }}">Очистить</a>
        {% endif %}
        <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#readingModal"
                onclick="ReadingModal.open()">Запись показателя</button>
      </div>
    </form>
  </div>
</div>

{# ------------------------------ таблица ------------------------------ #}
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>Резидент</th>
            <th>Расход по счётчикам</th>
            <th>Сумма по счётчикам</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% set paid_ids = paid_resident_ids if paid_resident_ids is defined else [] %}
          {% for rid, row in rows.items() %}
            {% set resident = row.resident %}
            {% set meters = row.meters %}
            {% set ns = namespace(total=0) %}
            <tr>
              <td class="fw-semibold">{{ resident.block.name }} / {{ resident.unit_number }}</td>
              <td class="small align-top">
                {% if meters %}
                  <div class="d-grid gap-1">
                    {% for mid, m in meters.items() %}
                      {% set mt = m.meter.meter_type %}
                      <div class="d-flex align-items-center">
                        <span class="badge bg-secondary-subtle text-secondary-emphasis me-2">
                          {% if mt == MeterType.ELECTRIC %}Электричество
                          {% elif mt == MeterType.GAS %}Газ
                          {% elif mt == MeterType.WATER %}Вода
                          {% elif mt == MeterType.SEWERAGE %}Канализация
                          {% elif mt == MeterType.SERVICE %}Сервис
                          {% elif mt == MeterType.RENT %}Аренда
                          {% elif mt == MeterType.CONSTRUCTION %}Строительство
                          {% else %}Неизвестно{% endif %}
                        </span>
                        <span class="ms-auto">{{ '%.3f'|format(m.consumption) }} {{ m.unit }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}—{% endif %}
              </td>
              <td class="small align-top">
                {% if resident.id in paid_ids %}
                  <div class="d-flex align-items-center justify-content-between">
                    <span class="badge bg-success-subtle text-success-emphasis">Оплачено</span>
                    <span class="ms-auto">0.00</span>
                  </div>
                {% else %}
                  {% if meters %}
                    <div class="d-grid gap-1">
                      {% for mid, m in meters.items() %}
                        {% set mt = m.meter.meter_type %}
                        {% set ns.total = ns.total + m.total %}
                        <div class="d-flex align-items-center">
                          <span class="badge bg-secondary-subtle text-secondary-emphasis me-2">
                            {% if mt == MeterType.ELECTRIC %}Электричество
                            {% elif mt == MeterType.GAS %}Газ
                            {% elif mt == MeterType.WATER %}Вода
                            {% elif mt == MeterType.SEWERAGE %}Канализация
                            {% elif mt == MeterType.SERVICE %}Сервис
                            {% elif mt == MeterType.RENT %}Аренда
                            {% elif mt == MeterType.CONSTRUCTION %}Строительство
                            {% else %}Неизвестно{% endif %}
                          </span>
                          <span class="ms-auto">{{ '%.2f'|format(m.total) }}</span>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="text-danger fw-semibold border-top pt-1 mt-2 d-flex">
                      <span>Итого:</span>
                      <span class="ms-auto">{{ '%.2f'|format(ns.total) }}</span>
                    </div>
                  {% else %}—{% endif %}
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-inline-flex gap-2">
                  <button class="btn btn-sm btn-outline-info"
                          data-bs-toggle="modal" data-bs-target="#readingModal"
                          onclick="ReadingModal.open({{ resident.block_id }}, {{ resident.id }})">
                    Редактировать
                  </button>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ request.url_for('readings_detail', resident_id=resident.id) }}">
                    Подробнее
                  </a>
                </div>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-secondary">Нет показаний за период</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# ------------------------------ модалка ------------------------------ #}
<div class="modal fade" id="readingModal" tabindex="-1" aria-labelledby="readingModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" id="readingForm" action="{{ request.url_for('create_readings') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="readingModalTitle">Запись показателя</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>

        <div class="modal-body">
          <div id="readingAlert" class="alert alert-danger d-none" role="alert"></div>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" for="selBlock">Блок</label>
              <select id="selBlock" class="form-select">
                <option value="">— выберите —</option>
                {% for b in blocks %}
                  <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="selResident">Резидент</label>
              <select id="selResident" name="resident_id" class="form-select" required>
                <option value="">— выберите блок —</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="reading_date">Дата показаний</label>
              <input type="date" name="date_str" id="reading_date" class="form-control" value="">
            </div>
          </div>

          <hr class="my-3">

          <div id="metersWrap" class="d-none">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Тип</th>
                    <th>Тариф</th>
                    <th>Предыдущее</th>
                    <th>Новое / Отметить</th>
                    <th>Расход</th>
                    <th>Сумма</th>
                    <th>Удалить последнее</th>
                  </tr>
                </thead>
                <tbody id="metersBody"></tbody>
              </table>
            </div>

            <div class="mt-2">
              <label class="form-label" for="note">Комментарий</label>
              <input name="note" id="note" class="form-control">
            </div>

            <input type="hidden" name="payload_json" id="payload_json">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Записать</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ------------------------------ скрипт ------------------------------ #}
<script>
  // Автозакрытие флеш-алертов
  window.addEventListener('DOMContentLoaded', function () {
    const alerts = document.querySelectorAll('.alert');
    setTimeout(() => alerts.forEach(a => {
      if (a.classList.contains('show')) bootstrap.Alert.getOrCreateInstance(a).close();
    }), 5000);
  });

  const URLS = {
    quote: "{{ request.url_for('quote') }}",
    deleteLast: "{{ request.url_for('delete_last_reading') }}",
    meters: "{{ request.url_for('get_resident_meters', resident_id='__ID__') }}",
  };

  const ReadingModal = (function(){
    const selBlock   = document.getElementById('selBlock');
    const selResident= document.getElementById('selResident');
    const metersWrap = document.getElementById('metersWrap');
    const metersBody = document.getElementById('metersBody');
    const payloadInp = document.getElementById('payload_json');
    const alertBox   = document.getElementById('readingAlert');
    const dateInput  = document.getElementById('reading_date');

    function setAlert(msg){
      alertBox.textContent = msg || '';
      alertBox.classList.toggle('d-none', !msg);
    }
    function setToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    async function loadResidentsByBlock(blockId){
      selResident.innerHTML = '<option value="">— выберите —</option>';
      {% for r in residents %}
        if (String({{ r.block_id }}) === String(blockId)) {
          const opt = document.createElement('option');
          opt.value = '{{ r.id }}';
          opt.textContent = '{{ r.block.name }} / {{ r.unit_number|e }}';
          selResident.appendChild(opt);
        }
      {% endfor %}
    }

    async function quoteSum(tariffId, qty){
      if (!tariffId || !isFinite(qty)) return { amount_total: 0, amount_net: 0, amount_vat: 0 };
      try{
        const url = new URL(URLS.quote, window.location.origin);
        url.searchParams.set('tariff_id', tariffId);
        url.searchParams.set('qty', qty);
        const resp = await fetch(url);
        if(!resp.ok) return { amount_total: 0, amount_net: 0, amount_vat: 0 };
        return await resp.json();
      }catch(_e){ return { amount_total: 0, amount_net: 0, amount_vat: 0 }; }
    }

    async function ajaxDeleteLast(meterId){
      try{
        const resp = await fetch(URLS.deleteLast, {
          method: 'POST',
          headers: { 'x-requested-with': 'fetch', 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `meter_id=${encodeURIComponent(meterId)}`
        });
        const data = await resp.json().catch(()=>({ok:false,error:'bad_response'}));
        if (!resp.ok || data.ok === false) {
          setAlert(data.error === 'nothing_to_delete'
            ? 'Нет записей для удаления по выбранному счётчику'
            : 'Не удалось удалить последнее показание');
          return false;
        }
        return true;
      }catch(_e){
        setAlert('Ошибка сети при удалении');
        return false;
      }
    }

    async function loadMeters(residentId){
      const metersUrl = URLS.meters.replace('__ID__', String(residentId)) + (dateInput.value ? `?date=${dateInput.value}` : '');
      const resp = await fetch(metersUrl);
      if (!resp.ok){ setAlert('Не удалось загрузить данные'); return; }
      const data = await resp.json();
      const metersArr = data.meters || [];
      metersBody.innerHTML = '';

      for (const row of metersArr){
        const tr = document.createElement('tr');

        // Тип (бейдж)
        const tdType = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge bg-secondary-subtle text-secondary-emphasis';
        badge.textContent = row.display_type;
        tdType.appendChild(badge);

        // Тариф
        const tdTariff = document.createElement('td');
        tdTariff.textContent = row.tariff_name;

        // Предыдущее
        const tdPrev = document.createElement('td');
        tdPrev.textContent = `${row.prev_value} ${row.unit}`;

        // Новое/Отметить, Расход, Сумма
        const tdNew  = document.createElement('td');
        const tdDiff = document.createElement('td');
        const tdSum  = document.createElement('td');
        tdSum.className = 'text-danger fw-semibold';

        // Удалить последнее
        const tdDel = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'btn btn-sm btn-outline-danger';
        delBtn.textContent = 'Удалить';
        delBtn.onclick = async () => {
          const ok = await ajaxDeleteLast(row.meter_id);
          if (ok) loadMeters(residentId);
        };
        tdDel.appendChild(delBtn);

        if (row.is_fixed) {
          const chkContainer = document.createElement('div');
          chkContainer.className = 'd-flex align-items-center gap-2';
          
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.className = 'form-check-input';
          chkContainer.appendChild(chk);
          
          // Для CONSTRUCTION показываем диапазон дат
          if (row.type === 'CONSTRUCTION' && row.date_range) {
            const dateSpan = document.createElement('span');
            dateSpan.className = 'small text-secondary';
            const fromDate = new Date(row.date_range.from_date);
            const toDate = new Date(row.date_range.to_date);
            const formatDate = (d) => {
              const day = String(d.getDate()).padStart(2, '0');
              const month = String(d.getMonth() + 1).padStart(2, '0');
              const year = d.getFullYear();
              return `${day}.${month}.${year}`;
            };
            dateSpan.textContent = `от ${formatDate(fromDate)} до ${formatDate(toDate)}`;
            chkContainer.appendChild(dateSpan);
          }
          
          tdNew.appendChild(chkContainer);
          tdDiff.textContent = '0.000';
          tdSum.textContent  = '0.00';

          // если за месяц уже есть запись — считаем, что редактируем, выставим сразу
          if (row.existing) {
            chk.checked = true;
            tdDiff.textContent = '1.000';
            const q = await quoteSum(row.tariff_id, 1);
            tdSum.textContent = Number(q.amount_total || 0).toFixed(2);
          }

          chk.addEventListener('change', async () => {
            if (chk.checked) {
              tdDiff.textContent = '1.000';
              const q = await quoteSum(row.tariff_id, 1);
              tdSum.textContent = Number(q.amount_total || 0).toFixed(2);
            } else {
              tdDiff.textContent = '0.000';
              tdSum.textContent  = '0.00';
            }
          });
        } else {
          const inputNew = document.createElement('input');
          inputNew.type = 'number';
          inputNew.step = '0.0001';
          inputNew.min  = row.prev_value;
          inputNew.className = 'form-control form-control-sm';
          inputNew.placeholder = `≥ ${row.prev_value}`;
          tdNew.appendChild(inputNew);
          tdDiff.textContent = '0.000';
          tdSum.textContent  = '0.00';

          // если запись за месяц есть — подставим значение и пересчитаем
          if (row.existing && row.existing_value != null) {
            inputNew.value = row.existing_value;
            const v = parseFloat(inputNew.value || '0');
            const prev = parseFloat(row.prev_value);
            const diff = Math.max(0, v - prev);
            tdDiff.textContent = diff.toFixed(3);
            const q = await quoteSum(row.tariff_id, diff);
            tdSum.textContent = Number(q.amount_total || 0).toFixed(2);
          }

          inputNew.addEventListener('input', async ()=>{
            const v = parseFloat(inputNew.value || '0');
            const prev = parseFloat(row.prev_value);
            const diff = Math.max(0, v - prev);
            tdDiff.textContent = diff.toFixed(3);
            const q = await quoteSum(row.tariff_id, diff);
            tdSum.textContent = Number(q.amount_total || 0).toFixed(2);
          });
        }

        tr.appendChild(tdType);
        tr.appendChild(tdTariff);
        tr.appendChild(tdPrev);
        tr.appendChild(tdNew);
        tr.appendChild(tdDiff);
        tr.appendChild(tdSum);
        tr.appendChild(tdDel);

        tr.dataset.meterId = row.meter_id;
        tr.dataset.prev    = row.prev_value;
        tr.dataset.tariff  = row.tariff_id;
        tr.dataset.isFixed = row.is_fixed ? '1' : '0';

        metersBody.appendChild(tr);
      }

      metersWrap.classList.toggle('d-none', metersArr.length === 0);
    }

    selBlock.addEventListener('change', ()=> {
      const id = selBlock.value;
      loadResidentsByBlock(id);
      metersWrap.classList.add('d-none');
      metersBody.innerHTML = '';
    });
    selResident.addEventListener('change', ()=> {
      const rid = selResident.value;
      if (rid) loadMeters(rid);
    });
    dateInput.addEventListener('change', ()=> {
      if (selResident.value) loadMeters(selResident.value);
    });

    document.getElementById('readingForm').addEventListener('submit', function(e){
      setAlert('');
      const rows = metersBody.querySelectorAll('tr');
      const payload = [];

      for (let tr of rows){
        const isFixed = tr.dataset.isFixed === '1';
        if (isFixed) {
          const chk = tr.querySelector('input[type=checkbox]');
          const prev = parseFloat(tr.dataset.prev);
          if (chk && chk.checked) {
            payload.push({ meter_id: Number(tr.dataset.meterId), new_value: prev + 1 });
          } else {
            // Unchecked fixed meter - send null to delete existing reading
            payload.push({ meter_id: Number(tr.dataset.meterId), new_value: null });
          }
        } else {
          const input = tr.querySelector('input[type=number]');
          if (!input || input.value === '') continue;
          const newVal = parseFloat(input.value);
          const prev = parseFloat(tr.dataset.prev);
          if (newVal < prev) { e.preventDefault(); setAlert('Новое значение не может быть меньше предыдущего.'); return; }
          payload.push({ meter_id: Number(tr.dataset.meterId), new_value: newVal });
        }
      }

      if (payload.length === 0){
        e.preventDefault(); setAlert('Укажите хотя бы одно новое показание или отметьте фикс-счётчик.'); return;
      }
      document.getElementById('payload_json').value = JSON.stringify(payload);
    });

    return {
      open(prefBlockId=null, prefResidentId=null){
        setAlert('');
        document.getElementById('readingForm').reset();
        setToday();

        if (prefBlockId){
          selBlock.value = String(prefBlockId);
          loadResidentsByBlock(prefBlockId).then(()=>{
            if (prefResidentId){
              selResident.value = String(prefResidentId);
              if (selResident.value) loadMeters(prefResidentId);
            }
          });
        } else {
          selResident.innerHTML = '<option value="">— выберите блок —</option>';
          metersBody.innerHTML = '';
          metersWrap.classList.add('d-none');
        }
      }
    }
  })();
</script>

{% endblock %}
