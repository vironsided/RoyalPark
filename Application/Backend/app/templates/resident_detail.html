{#-----------------------------------------------------------------------------
  Template: app/templates/resident_detail.html
  Author: Mamedli Ayaz
  Purpose: ЛК жителя — История показаний по дому с фильтрами периода
-----------------------------------------------------------------------------#}
{% extends "resident_base.html" %}
{% block title %}ЛК: {{ resident.block.name }} / {{ resident.unit_number }}{% endblock %}
{% block content %}

{# ---------- helpers ---------- #}
{% macro meter_label(mt) -%}
  {%- if mt == MeterType.ELECTRIC -%}Электричество
  {%- elif mt == MeterType.GAS -%}Газ
  {%- elif mt == MeterType.WATER -%}Вода
  {%- elif mt == MeterType.SEWERAGE -%}Канализация
  {%- elif mt == MeterType.SERVICE -%}Сервис
  {%- elif mt == MeterType.RENT -%}Аренда
  {%- elif mt == MeterType.CONSTRUCTION -%}Строительство
  {%- else -%}Неизвестно
  {%- endif -%}
{%- endmacro %}

{% macro unit_label(mt) -%}
  {%- if mt == MeterType.ELECTRIC -%}кВт·ч
  {%- elif mt in [MeterType.GAS, MeterType.WATER, MeterType.SEWERAGE] -%}м³
  {%- elif mt in [MeterType.SERVICE, MeterType.RENT, MeterType.CONSTRUCTION] -%}мес.
  {%- else -%}—
  {%- endif -%}
{%- endmacro %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Резидент: {{ resident.block.name }} / {{ resident.unit_number }}</h4>
  <a href="/resident" class="btn btn-outline-secondary btn-sm">← Назад</a>
</div>

{# --------------------- Фильтры периода --------------------- #}
<div class="card mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get" action="/resident/detail/{{ resident.id }}">
      <div class="col-md-3">
        <label class="form-label" for="from">От</label>
        <input id="from" name="from" type="date" value="{{ from_val or '' }}" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label" for="to">До</label>
        <input id="to" name="to" type="date" value="{{ to_val or '' }}" class="form-control">
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-outline-secondary w-100" type="submit">Фильтр</button>
        <a class="btn btn-outline-warning w-100" href="/resident/detail/{{ resident.id }}">Очистить</a>
      </div>
      <div class="col-md-3">
        <label class="form-label">Быстрый выбор</label>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-sm btn-outline-primary {{ 'active' if range_val=='month' }}"
             href="/resident/detail/{{ resident.id }}?range_=month">За месяц</a>
          <a class="btn btn-sm btn-outline-primary {{ 'active' if range_val=='3m' }}"
             href="/resident/detail/{{ resident.id }}?range_=3m">За 3&nbsp;мес.</a>
          <a class="btn btn-sm btn-outline-primary {{ 'active' if range_val=='6m' }}"
             href="/resident/detail/{{ resident.id }}?range_=6m">За 6&nbsp;мес.</a>
          <a class="btn btn-sm btn-outline-primary {{ 'active' if range_val=='year' }}"
             href="/resident/detail/{{ resident.id }}?range_=year">За год</a>
        </div>
      </div>
    </form>
  </div>
</div>

{# --------------------- История по счётчикам --------------------- #}
<div class="card">
  <div class="card-body">
    {% for m in meters %}
      {% set unit = unit_label(m.meter_type) %}
      {% set show_serial = (m.meter_type not in [MeterType.SERVICE, MeterType.RENT, MeterType.CONSTRUCTION]) and (m.serial_number and m.serial_number|length>0) %}

      <div class="d-flex align-items-center justify-content-between mt-3 mb-2 pb-1 border-bottom">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="badge bg-secondary-subtle text-secondary-emphasis">
            {{ meter_label(m.meter_type) }}
          </span>
          {% if show_serial %}
            <span class="text-secondary">№ {{ m.serial_number }}</span>
          {% endif %}
          <span class="text-secondary">тариф: {{ m.tariff.name }}</span>
        </div>
        <span class="badge bg-secondary">{{ unit }}</span>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle mb-3">
          <thead>
            <tr>
              <th style="width: 180px;">Дата</th>
              <th class="text-end">Показание, {{ unit }}</th>
              <th class="text-end">Расход, {{ unit }}</th>
              <th class="text-end">Начислено</th>
              <th class="text-center" style="width:110px;">НДС, %</th>
              <th>Комментарий</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in history[m.id] %}
              <tr>
                <td>{{ rd.reading_date | baku_datetime }}</td>
                <td class="text-end">{{ '%.3f'|format(rd.value) }}</td>
                <td class="text-end">{{ '%.3f'|format(rd.consumption) }}</td>
                <td class="text-end text-danger fw-semibold">{{ '%.2f'|format(rd.amount_total) }}</td>
                <td class="text-center">{{ rd.vat_percent }}</td>
                <td>{{ rd.note or '—' }}</td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="text-secondary">Записей пока нет</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>
</div>

{% endblock %}
