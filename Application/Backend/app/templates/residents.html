{#-----------------------------------------------------------------------------
  Template: app/templates/residents.html
  Author: Mamedli Ayaz
  Назначение: Управление резидентами (только счётчики)
-----------------------------------------------------------------------------#}

{% extends "base.html" %}
{% block title %}Резиденты{% endblock %}
{% block content %}

{# Русские подписи для enum-значений (только отображение) #}
{% set RESIDENT_TYPE_LABELS = {
  'OWNER': 'Собственник',
  'TENANT': 'Арендатор'
} %}
{% set CUSTOMER_TYPE_LABELS = {
  'INDIVIDUAL': 'Физ. лицо',
  'LEGAL': 'Юр. лицо'
} %}
{% set RESIDENT_STATUS_LABELS = {
  'ACTIVE': 'Активен',
  'INACTIVE': 'Неактивен',
  'SUSPENDED': 'Приостановлен',
  'MOVED_OUT': 'Выбыл'
} %}

{% set ok = request.query_params.get('ok') %}
{% set error = request.query_params.get('error') %}

<h4 class="mb-3">Резиденты</h4>

{# Флеш-сообщения #}
{% if error %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    Ошибка: {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'created' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Резидент создан.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'updated' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Изменения сохранены.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'deleted' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Резидент удалён.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% endif %}

{# --------------------------- Фильтры + Создать ---------------------------- #}
<form class="row g-2 align-items-end mb-3" method="get" action="{{ request.url_for('list_residents') }}">
  <div class="col-md-3">
    <label class="form-label" for="f_block">Блок</label>
    <select name="block_id" id="f_block" class="form-select">
      <option value="" {{ 'selected' if not block_id }}>Все</option>
      {% for b in blocks %}
        <option value="{{ b.id }}" {{ 'selected' if block_id==b.id }}>{{ b.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label" for="f_status">Статус</label>
    <select name="status" id="f_status" class="form-select">
      <option value="" {{ 'selected' if not status_val }}>Все</option>
      {% for s in ResidentStatus %}
        <option value="{{ s.value }}" {{ 'selected' if status_val==s.value }}>
          {{ RESIDENT_STATUS_LABELS.get(s.value, s.name) }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label" for="f_rtype">Тип резидента</label>
    <select name="rtype" id="f_rtype" class="form-select">
      <option value="" {{ 'selected' if not rtype_val }}>Все</option>
      {% for t in ResidentType %}
        <option value="{{ t.value }}" {{ 'selected' if rtype_val==t.value }}>
          {{ RESIDENT_TYPE_LABELS.get(t.value, t.name) }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label" for="f_q">Поиск</label>
    <input name="q" id="f_q" value="{{ q or '' }}" class="form-control" placeholder="Дом/№, ФИО, телефон, email">
  </div>

  <div class="col-12 d-flex gap-2">
    <button class="btn btn-outline-secondary" type="submit">Фильтр</button>
    <a class="btn btn-outline-warning" href="{{ request.url_for('list_residents') }}">Очистить</a>
    <button class="btn btn-primary ms-auto" type="button"
            data-bs-toggle="modal" data-bs-target="#residentModal"
            data-action="resident-create">Создать</button>
  </div>
</form>

{# -------------------------------- Таблица --------------------------------- #}
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Блок</th>
            <th>Дом/№</th>
            <th>Тип</th>
            <th>Клиент</th>
            <th>Статус</th>
            <th>Контакты</th>
            <th class="text-break">Счётчики</th>
            <th class="text-end" style="width: 220px;">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% if not residents %}
            <tr><td colspan="9" class="text-secondary">Пока нет резидентов</td></tr>
          {% else %}
            {% for r in residents %}
              <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.block.name if r.block else '-' }}</td>
                <td>{{ r.unit_number }}</td>
                <td>{{ RESIDENT_TYPE_LABELS.get(r.resident_type.value, r.resident_type.name) }}</td>
                <td>{{ CUSTOMER_TYPE_LABELS.get(r.customer_type.value, r.customer_type.name) }}</td>
                <td>{{ RESIDENT_STATUS_LABELS.get(r.status.value, r.status.name) }}</td>
                <td class="small">
                  {% if r.owner_full_name %}{{ r.owner_full_name }}<br>{% endif %}
                  {% if r.owner_phone %}<span class="text-secondary">{{ r.owner_phone }}</span><br>{% endif %}
                  {% if r.owner_email %}<span class="text-secondary">{{ r.owner_email }}</span>{% endif %}
                </td>
                <td class="small text-break">
                  {% for m in r.meters %}
                    {% if m.meter_type == MeterType.ELECTRIC %}
                      {% set unit = 'кВт·ч' %}
                    {% elif m.meter_type in [MeterType.GAS, MeterType.WATER, MeterType.SEWERAGE] %}
                      {% set unit = 'м³' %}
                    {% else %}
                      {% set unit = 'фикс' %}
                    {% endif %}
                    <div>
                      <span class="badge bg-secondary-subtle text-secondary-emphasis">
                        {% if m.meter_type == MeterType.ELECTRIC %}Электричество
                        {% elif m.meter_type == MeterType.GAS %}Газ
                        {% elif m.meter_type == MeterType.WATER %}Вода
                        {% elif m.meter_type == MeterType.SEWERAGE %}Канализация
                        {% elif m.meter_type == MeterType.SERVICE %}Сервис
                        {% elif m.meter_type == MeterType.RENT %}Аренда
                        {% elif m.meter_type == MeterType.CONSTRUCTION %}Строительство
                        {% else %}Неизвестно{% endif %}
                      </span>
                      {% if m.serial_number %} SN: {{ m.serial_number }}{% endif %}
                      {% if m.used_before %}, опорное: {{ m.initial_reading }}{% endif %}
                      , тариф: {{ m.tariff.name if m.tariff else '—' }}
                    </div>
                  {% endfor %}
                </td>
                <td>
                  <div class="d-flex gap-2 justify-content-end">
                    <button class="btn btn-sm btn-outline-info"
                            data-bs-toggle="modal" data-bs-target="#residentModal"
                            data-action="resident-edit"
                            data-resident-id="{{ r.id }}">
                      Редактировать
                    </button>
                    <form method="post"
                          action="{{ request.url_for('delete_resident', resident_id=r.id) }}"
                          onsubmit="return confirm('Удалить резидента {{ r.unit_number }}?')">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# ----------------------------- Модальное окно ----------------------------- #}
<div class="modal fade" id="residentModal" tabindex="-1" aria-labelledby="residentModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" id="residentForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="residentModalTitle">Создать резидента</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>

        <div class="modal-body">
          <div id="residentAlert" class="alert alert-danger d-none" role="alert"></div>

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label" for="r_block">Блок</label>
              <select name="block_id" id="r_block" class="form-select" required>
                {% for b in blocks %}
                  <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_unit">Дом/Номер</label>
              <input name="unit_number" id="r_unit" class="form-control" required maxlength="64">
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_rtype">Тип резидента</label>
              <select name="resident_type" id="r_rtype" class="form-select" required>
                {% for t in ResidentType %}
                  <option value="{{ t.value }}">{{ RESIDENT_TYPE_LABELS.get(t.value, t.name) }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_ctype">Тип клиента</label>
              <select name="customer_type" id="r_ctype" class="form-select" required>
                {% for c in CustomerType %}
                  <option value="{{ c.value }}">{{ CUSTOMER_TYPE_LABELS.get(c.value, c.name) }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_status">Статус</label>
              <select name="status" id="r_status" class="form-select" required>
                {% for s in ResidentStatus %}
                  <option value="{{ s.value }}">{{ RESIDENT_STATUS_LABELS.get(s.value, s.name) }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_name">ФИО владельца</label>
              <input name="owner_full_name" id="r_name" class="form-control">
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_phone">Телефон</label>
              <input name="owner_phone" id="r_phone" class="form-control">
            </div>

            <div class="col-md-3">
              <label class="form-label" for="r_email">Email</label>
              <input type="email" name="owner_email" id="r_email" class="form-control">
            </div>
          </div>

          <hr class="my-3">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Счётчики</h6>
            <button class="btn btn-sm btn-outline-primary" type="button" onclick="ResidentModal.addMeterRow()">
              Добавить услуги
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle" id="metersTable">
              <thead>
                <tr>
                  <th style="width:18%;">Тип</th>
                  <th style="width:22%;">Серийный №</th>
                  <th style="width:12%;">Б/у?</th>
                  <th style="width:20%;">Опорное</th>
                  <th style="width:18%;">Ед.</th>
                  <th style="width:22%;">Тариф</th>
                  <th style="width:12%;">Удалить</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <input type="hidden" name="meters_json" id="meters_json">
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary" id="residentSubmitBtn">Создать</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Автозакрытие флеш-алертов
  window.addEventListener('DOMContentLoaded', function () {
    const alerts = document.querySelectorAll('.alert');
    setTimeout(() => alerts.forEach(a => {
      if (a.classList.contains('show')) bootstrap.Alert.getOrCreateInstance(a).close();
    }), 5000);

    const createBtn = document.querySelector('[data-action="resident-create"]');
    if (createBtn) {
      createBtn.addEventListener('click', () => ResidentModal.openCreate());
    }
    document.querySelectorAll('[data-action="resident-edit"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.residentId;
        if (id) ResidentModal.openEdit(Number(id));
      });
    });
  });

  // Все тарифы (id, name, meter_type) прокинуты с бэка
  const ALL_TARIFFS = JSON.parse('{{ tariffs | tojson | safe }}');

  const ResidentModal = (function () {
    const form = document.getElementById('residentForm');
    const title = document.getElementById('residentModalTitle');
    const submitBtn = document.getElementById('residentSubmitBtn');
    const alertBox = document.getElementById('residentAlert');
    const metersTableBody = document.querySelector('#metersTable tbody');

    const FIXED_TYPES = new Set(['SERVICE', 'RENT', 'CONSTRUCTION']);

    function reset() {
      alertBox.classList.add('d-none');
      alertBox.textContent = '';
      form.reset();
      metersTableBody.innerHTML = '';
    }

    function unitLabel(typeVal) {
      if (typeVal === 'ELECTRIC') return 'кВт·ч';
      if (typeVal === 'GAS' || typeVal === 'WATER' || typeVal === 'SEWERAGE') return 'м³';
      if (FIXED_TYPES.has(typeVal)) return 'Фикс цена';
      return '—';
    }

    function tariffOptionsHtml(typeVal, selectedId) {
      const opts = ALL_TARIFFS.filter(t => t.meter_type === typeVal);
      if (!opts.length) return '<option value="">— нет тарифов —</option>';
      return opts.map(t =>
        `<option value="${t.id}" ${String(selectedId) === String(t.id) ? 'selected' : ''}>${t.name}</option>`
      ).join('');
    }

    // Перестраиваем ячейки строки под выбранный тип
    function layoutForType(tr, typeVal) {
      const tdSerial  = tr.querySelector('[data-col="serial"]');
      const tdUsed    = tr.querySelector('[data-col="used"]');
      const tdInitial = tr.querySelector('[data-col="initial"]');
      const tdUnit    = tr.querySelector('[data-col="unit"]');
      const tdTariff  = tr.querySelector('[data-col="tariff"]');

      // единицы измерения
      tdUnit.querySelector('span').textContent = unitLabel(typeVal);

      // перестроить "Серийный №", "Б/у?", "Опорное"
      tdSerial.innerHTML = '';
      tdUsed.innerHTML = '';
      tdInitial.innerHTML = '';

      if (FIXED_TYPES.has(typeVal)) {
        // -------- СЕРВИС/АРЕНДА: серийник заменяем на текст названия тарифа, убираем Б/у и Опорное --------
        const selTariff = tdTariff.querySelector('select');
        const label = document.createElement('div');
        label.className = 'form-control-plaintext small text-secondary';
        // при пустом списке тарифов показываем прочерк
        label.textContent = selTariff.options.length && selTariff.value
          ? selTariff.options[selTariff.selectedIndex].text
          : '—';
        tdSerial.appendChild(label);
        // used/initial — пустые (скрытые) колонки
      } else {
        // -------- Обычные счётчики --------
        const inpSerial = document.createElement('input');
        inpSerial.className = 'form-control form-control-sm';
        inpSerial.placeholder = 'например, AB123';
        tdSerial.appendChild(inpSerial);

        const chkUsed = document.createElement('input');
        chkUsed.type = 'checkbox';
        chkUsed.className = 'form-check-input';
        tdUsed.appendChild(chkUsed);

        const inpInitial = document.createElement('input');
        inpInitial.type = 'number';
        inpInitial.step = '0.0001';
        inpInitial.min = '0';
        inpInitial.placeholder = '0.0000';
        inpInitial.className = 'form-control form-control-sm';
        inpInitial.disabled = true; // включим по чекбоксу
        tdInitial.appendChild(inpInitial);

        // связь чекбокса и опорного
        chkUsed.addEventListener('change', () => {
          inpInitial.disabled = !chkUsed.checked;
          if (!chkUsed.checked) inpInitial.value = '';
        });
      }
    }

    function addMeterRow(meter_type, serial, used, initial, tariff_id) {
      const tr = document.createElement('tr');

      // Тип
      const tdType = document.createElement('td');
      const selType = document.createElement('select');
      selType.className = 'form-select form-select-sm';
      selType.innerHTML = `
        <option value="ELECTRIC">Электричество</option>
        <option value="GAS">Газ</option>
        <option value="WATER">Вода</option>
        <option value="SEWERAGE">Канализация</option>
        <option value="SERVICE">Сервис</option>
        <option value="RENT">Аренда</option>
        <option value="CONSTRUCTION">Строительство</option>
      `;
      if (meter_type) selType.value = meter_type;
      tdType.appendChild(selType);

      // Серийный № (контейнер, наполним ниже)
      const tdSerial = document.createElement('td');
      tdSerial.setAttribute('data-col', 'serial');

      // Б/у? (контейнер)
      const tdUsed = document.createElement('td');
      tdUsed.setAttribute('data-col', 'used');

      // Опорное (контейнер)
      const tdInitial = document.createElement('td');
      tdInitial.setAttribute('data-col', 'initial');

      // Ед.
      const tdUnit = document.createElement('td');
      tdUnit.setAttribute('data-col', 'unit');
      const badge = document.createElement('span');
      badge.className = 'badge bg-secondary-subtle text-secondary-emphasis';
      tdUnit.appendChild(badge);

      // Тариф
      const tdTariff = document.createElement('td');
      tdTariff.setAttribute('data-col', 'tariff');
      const selTariff = document.createElement('select');
      selTariff.className = 'form-select form-select-sm';
      tdTariff.appendChild(selTariff);

      // Удалить
      const tdDel = document.createElement('td');
      const btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = 'btn btn-sm btn-outline-danger';
      btnDel.textContent = 'Удалить';
      btnDel.onclick = () => tr.remove();
      tdDel.appendChild(btnDel);

      // Сборка строки
      tr.appendChild(tdType);
      tr.appendChild(tdSerial);
      tr.appendChild(tdUsed);
      tr.appendChild(tdInitial);
      tr.appendChild(tdUnit);
      tr.appendChild(tdTariff);
      tr.appendChild(tdDel);
      metersTableBody.appendChild(tr);

      // Инициализация тарифов + лэйаута
      const fillTariffs = (typeVal, selectedId) => {
        selTariff.innerHTML = tariffOptionsHtml(typeVal, selectedId ?? '');
      };

      // первичная отрисовка
      fillTariffs(selType.value, tariff_id);
      layoutForType(tr, selType.value);

      // если пришли исходные значения (для обычных счётчиков) — восстановим их
      if (!FIXED_TYPES.has(selType.value)) {
        const inpSerial = tdSerial.querySelector('input');
        const chkUsed   = tdUsed.querySelector('input[type="checkbox"]');
        const inpInit   = tdInitial.querySelector('input');

        if (inpSerial && serial != null) inpSerial.value = serial || '';
        if (chkUsed) {
          chkUsed.checked = !!used;
          if (inpInit) {
            inpInit.disabled = !chkUsed.checked;
            if (initial != null && initial !== '') inpInit.value = initial;
          }
        }
      } else {
        // для фикс-типов обновим подпись под выбранный тариф
        const label = tdSerial.querySelector('.form-control-plaintext');
        if (label && selTariff.value) {
          label.textContent = selTariff.options[selTariff.selectedIndex].text;
        }
      }

      // События
      selType.addEventListener('change', () => {
        fillTariffs(selType.value, '');
        layoutForType(tr, selType.value);
        // для фикс-типов сразу обновим лейбл тарифа
        if (FIXED_TYPES.has(selType.value)) {
          const label = tdSerial.querySelector('.form-control-plaintext');
          if (label) {
            label.textContent = selTariff.options.length && selTariff.value
              ? selTariff.options[selTariff.selectedIndex].text
              : '—';
          }
        }
      });

      selTariff.addEventListener('change', () => {
        if (FIXED_TYPES.has(selType.value)) {
          const label = tdSerial.querySelector('.form-control-plaintext');
          if (label) {
            label.textContent = selTariff.options.length && selTariff.value
              ? selTariff.options[selTariff.selectedIndex].text
              : '—';
          }
        }
      });
    }

    function collectMeters() {
      const rows = metersTableBody.querySelectorAll('tr');
      const meters = [];
      if (!rows.length) throw new Error('Добавьте хотя бы один счётчик.');

      rows.forEach((row, idx) => {
        const selType   = row.querySelector('td:nth-child(1) select');
        const typeVal   = selType.value;
        const selTariff = row.querySelector('[data-col="tariff"] select');

        const tariffId = selTariff.value;
        if (!tariffId) throw new Error(`Выберите тариф для строки №${idx + 1}.`);

        if (FIXED_TYPES.has(typeVal)) {
          // для SERVICE/RENT не передаем серийник/used/initial
          meters.push({
            meter_type: typeVal,
            serial: '',
            used: false,
            initial: null,
            tariff_id: Number(tariffId),
          });
        } else {
          const inpSerial = row.querySelector('[data-col="serial"] input');
          const chkUsed   = row.querySelector('[data-col="used"] input[type="checkbox"]');
          const inpInit   = row.querySelector('[data-col="initial"] input');

          const used = !!(chkUsed && chkUsed.checked);
          const initialVal = inpInit ? inpInit.value : '';

          if (used) {
            if (initialVal === '') throw new Error(`Укажите опорное значение для счётчика №${idx + 1}.`);
            if (Number(initialVal) < 0) throw new Error(`Опорное значение не может быть отрицательным (строка ${idx + 1}).`);
          }

          meters.push({
            meter_type: typeVal,
            serial: inpSerial ? (inpSerial.value || '') : '',
            used: used,
            initial: used ? Number(initialVal) : null,
            tariff_id: Number(tariffId),
          });
        }
      });

      return meters;
    }

    form.addEventListener('submit', function (e) {
      try {
        const meters = collectMeters();
        document.getElementById('meters_json').value = JSON.stringify(meters);
      } catch (err) {
        e.preventDefault();
        alertBox.textContent = (err && err.message) ? err.message : 'Проверьте корректность формы.';
        alertBox.classList.remove('d-none');
      }
    });

    return {
      openCreate() {
        reset();
        title.textContent = 'Создать резидента';
        form.setAttribute('action', "{{ request.url_for('create_resident') }}");
        document.getElementById('r_status').value = "{{ ResidentStatus.ACTIVE.value }}";
        addMeterRow('ELECTRIC', '', false, '', '');
      },
      async openEdit(id) {
        reset();
        title.textContent = 'Редактировать резидента';
        const updateUrl = "{{ request.url_for('update_resident', resident_id='__ID__') }}".replace('__ID__', String(id));
        form.setAttribute('action', updateUrl);

        const jsonUrl = "{{ request.url_for('get_resident_json', resident_id='__ID__') }}".replace('__ID__', String(id));
        const resp = await fetch(jsonUrl, { headers: { 'Accept': 'application/json' } });
        if (!resp.ok) {
          alertBox.textContent = 'Не удалось загрузить данные резидента.';
          alertBox.classList.remove('d-none');
          return;
        }
        const data = await resp.json();

        document.getElementById('r_block').value = data.block_id;
        document.getElementById('r_unit').value = data.unit_number;
        document.getElementById('r_rtype').value = data.resident_type;
        document.getElementById('r_ctype').value = data.customer_type;
        document.getElementById('r_status').value = data.status;
        document.getElementById('r_name').value = data.owner_full_name || '';
        document.getElementById('r_phone').value = data.owner_phone || '';
        document.getElementById('r_email').value = data.owner_email || '';

        (data.meters || []).forEach(m =>
          addMeterRow(m.meter_type, m.serial, m.used, (m.initial ?? ''), m.tariff_id)
        );
        if ((data.meters || []).length === 0) addMeterRow('ELECTRIC', '', false, '', '');
      },
      addMeterRow() {
        addMeterRow('ELECTRIC', '', false, '', '');
      }
    };
  })();
</script>


{% endblock %}
