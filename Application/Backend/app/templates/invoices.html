{#-----------------------------------------------------------------------------
  Template: app/templates/invoices.html
  Author: Mamedli Ayaz
  Purpose: Список счетов (админ) + массовое выставление по блоку/всем
-----------------------------------------------------------------------------#}
{% extends "base.html" %}
{% block title %}Счета{% endblock %}
{% block content %}

{% set err = request.query_params.get('error') %}
{% set ok  = request.query_params.get('ok') %}
{% set cnt = request.query_params.get('cnt') %}
{% if err %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    Ошибка: {{ err }}
    <button type="button" class="btn btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'issued' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Счёт выставлен/обновлён.
    <button type="button" class="btn btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'canceled' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Счёт отменён.
    <button type="button" class="btn btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% elif ok == 'bulk_issued' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Выставлено счетов: {{ cnt or '0' }}.
    <button type="button" class="btn btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
  </div>
{% endif %}

<h4 class="mb-3">Счета</h4>

{# -------- Массовое выставление -------- #}
<div class="card mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="post" action="{{ request.url_for('invoices_bulk_issue') }}">
      <div class="col-md-4">
        <label class="form-label" for="bulk_block">Блок (для «по блоку»)</label>
        <select id="bulk_block" name="block_id" class="form-select">
          <option value="">— выберите блок —</option>
          {% for b in blocks %}
            <option value="{{ b.id }}">{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="bulk_due">Срок оплаты (due date)</label>
        <input id="bulk_due" name="due_date" type="date" class="form-control">
      </div>
      <div class="col-md-5 d-flex gap-2">
        <button class="btn btn-outline-primary w-100" name="action" value="by_block" type="submit">
          Выставить счёт по блоку
        </button>
        <button class="btn btn-primary w-100" name="action" value="all" type="submit"
                onclick="return confirm('Выставить все черновики во всех блоках?');">
          Выставить все счета
        </button>
      </div>
    </form>
  </div>
</div>

{# -------- Фильтры -------- #}
<div class="card mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get" action="{{ request.url_for('invoices_list') }}">
      <div class="col-md-2">
        <label class="form-label">Год</label>
        <input class="form-control" name="year" type="number" value="{{ year or '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Месяц</label>
        <input class="form-control" name="month" type="number" min="1" max="12" value="{{ month or '' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Резидент</label>
        <select class="form-select" name="resident_id">
          <option value="" {{ 'selected' if not resident_id }}>Все</option>
          {% for r in residents %}
            <option value="{{ r.id }}" {{ 'selected' if resident_id|string == r.id|string }}>
              {{ r.block.name }} / {{ r.unit_number }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Статус</label>
        <select class="form-select" name="status_val">
          <option value="" {{ 'selected' if not status_val }}>Все</option>
          {% for s in InvoiceStatus %}
            <option value="{{ s.value }}" {{ 'selected' if status_val==s.value }}>
              {{ s.value }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Поиск</label>
        <input class="form-control" name="q" value="{{ q or '' }}" placeholder="№ или примечание">
      </div>
      <div class="col-12 d-flex gap-2">
        <button class="btn btn-outline-secondary" type="submit">Фильтр</button>
        {% if year or month or resident_id or status_val or q %}
          <a class="btn btn-outline-warning" href="{{ request.url_for('invoices_list') }}">Очистить</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

{# -------- Таблица -------- #}
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>Период</th>
            <th>Резидент</th>
            <th>№ счета</th>
            <th>Статус</th>
            <th class="text-end">Начислено</th>
            <th>Срок оплаты</th>
            <th class="text-end" style="width:220px;">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in items %}
            <tr>
              <td>{{ inv.period_year }}-{{ "%02d"|format(inv.period_month) }}</td>
              <td>{{ inv.resident.block.name }} / {{ inv.resident.unit_number }}</td>
              <td>{{ inv.number or '—' }}</td>

              {# --- Статус + бейдж «Оплачено / Остаток» --- #}
              <td>
                <div class="d-flex flex-column">
                  <span class="badge bg-secondary-subtle text-secondary-emphasis">{{ inv.status.value }}</span>

                  {% set paid = (paid_map.get(inv.id) if paid_map is defined else 0) | float %}
                  {% set total = (inv.amount_total or 0) | float %}
                  {% set left  = (total - paid) %}
                  {% if total > 0 %}
                    {% if left <= 0 %}
                      <span class="badge bg-success-subtle text-success-emphasis mt-1">
                        Оплачено {{ '%.2f'|format(total) }} / Остаток 0.00
                      </span>
                    {% elif paid > 0 %}
                      <span class="badge bg-warning-subtle text-warning-emphasis mt-1">
                        Оплачено {{ '%.2f'|format(paid) }} / Остаток {{ '%.2f'|format(left) }}
                      </span>
                    {% else %}
                      <span class="badge bg-secondary mt-1">
                        Оплачено 0.00 / Остаток {{ '%.2f'|format(total) }}
                      </span>
                    {% endif %}
                  {% endif %}
                </div>
              </td>

              <td class="text-end text-danger fw-semibold">{{ '%.2f'|format(inv.amount_total) }}</td>
              <td>{{ inv.due_date or '—' }}</td>
              <td class="text-end">
                <div class="d-inline-flex flex-wrap gap-2">
                  <a class="btn btn-sm btn-outline-info" href="{{ request.url_for('invoice_detail', invoice_id=inv.id) }}">
                    Открыть
                  </a>
                  <a class="btn btn-sm btn-outline-secondary" target="_blank"
                     href="{{ request.url_for('invoice_print', invoice_id=inv.id) }}">
                    Печать
                  </a>
                </div>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="7" class="text-secondary">Пока нет счетов</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# -------- Пагинация + per_page -------- #}
    <div class="d-flex align-items-center justify-content-between mt-3 flex-wrap gap-2">
      <nav aria-label="Навигация по страницам">
        <ul class="pagination pagination-sm mb-0">
          {% macro page_url(p) -%}
            {{ request.url_for('invoices_list') }}?page={{ p }}&per_page={{ per_page }}
            {% if year %}&year={{ year }}{% endif %}
            {% if month %}&month={{ month }}{% endif %}
            {% if resident_id %}&resident_id={{ resident_id }}{% endif %}
            {% if status_val %}&status_val={{ status_val }}{% endif %}
            {% if q %}&q={{ q|urlencode }}{% endif %}
          {%- endmacro %}
          <li class="page-item {{ 'disabled' if page<=1 }}">
            <a class="page-link" href="{{ page_url(page-1) }}">«</a>
          </li>
          {% if pages and pages[0] > 1 %}
            <li class="page-item"><a class="page-link" href="{{ page_url(1) }}">1</a></li>
            {% if pages[0] > 2 %}<li class="page-item disabled"><span class="page-link">…</span></li>{% endif %}
          {% endif %}
          {% for p in pages %}
            <li class="page-item {{ 'active' if p==page }}"><a class="page-link" href="{{ page_url(p) }}">{{ p }}</a></li>
          {% endfor %}
          {% if pages and pages[-1] < last_page %}
            {% if pages[-1] < last_page - 1 %}<li class="page-item disabled"><span class="page-link">…</span></li>{% endif %}
            <li class="page-item"><a class="page-link" href="{{ page_url(last_page) }}">{{ last_page }}</a></li>
          {% endif %}
          <li class="page-item {{ 'disabled' if page>=last_page }}">
            <a class="page-link" href="{{ page_url(page+1) }}">»</a>
          </li>
          <li class="page-item disabled ms-2">
            <span class="page-link bg-transparent border-0 text-secondary">
              Стр. {{ page }} из {{ last_page }} · всего {{ total }}
            </span>
          </li>
        </ul>
      </nav>

      {% set PPO = per_page_options if per_page_options is defined and per_page_options else [25, 50, 100] %}
      <form class="d-flex align-items-center gap-2" method="get" action="{{ request.url_for('invoices_list') }}">
        <input type="hidden" name="page" value="1">
        {% if year %}<input type="hidden" name="year" value="{{ year }}">{% endif %}
        {% if month %}<input type="hidden" name="month" value="{{ month }}">{% endif %}
        {% if resident_id %}<input type="hidden" name="resident_id" value="{{ resident_id }}">{% endif %}
        {% if status_val %}<input type="hidden" name="status_val" value="{{ status_val }}">{% endif %}
        {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}
        <label class="text-secondary small mb-0" for="pp">На странице:</label>
        <select id="pp" name="per_page" class="form-select form-select-sm" onchange="this.form.submit()">
          {% for opt in PPO %}
            <option value="{{ opt }}" {{ 'selected' if per_page|int==opt }}>{{ opt }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>
</div>

<script>
  // Автозакрытие тостов
  window.addEventListener('DOMContentLoaded', function () {
    const alerts = document.querySelectorAll('.alert');
    setTimeout(() => alerts.forEach(a => {
      if (a.classList.contains('show')) bootstrap.Alert.getOrCreateInstance(a).close();
    }), 5000);
  });
</script>

{% endblock %}
